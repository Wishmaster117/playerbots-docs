
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://Wishmaster117.github.io/playerbots-docs/diff/">
      
      
        <link rel="prev" href="../core-changes-playerbots-developer/">
      
      
        <link rel="next" href="../roadmap/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>DIFF 2026/02/05 - Documentation Playerbots</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../styles/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#diff-20260205" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Documentation Playerbots" class="md-header__button md-logo" aria-label="Documentation Playerbots" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Documentation Playerbots
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              DIFF 2026/02/05
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/wishmaster117/playerbots-docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Documentation Playerbots" class="md-nav__button md-logo" aria-label="Documentation Playerbots" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Documentation Playerbots
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wishmaster117/playerbots-docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../module-map-and-glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Module map & glossary
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../high-level-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    High-level architecture
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../execution-flows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Major execution flows
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ai-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI architecture
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../gameplay-specific-systems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gameplay systems
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-configs-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    data & configs
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-changes-playerbots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Azerothcore Integration
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-changes-playerbots-changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Azerothcore Changelogs
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-changes-playerbots-developer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Azerothcore Dev Only
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    DIFF 2026/02/05
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    DIFF 2026/02/05
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#full-diff" class="md-nav__link">
    <span class="md-ellipsis">
      
        Full diff
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../roadmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#full-diff" class="md-nav__link">
    <span class="md-ellipsis">
      
        Full diff
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="diff-20260205">DIFF 2026/02/05</h1>
<h2 id="full-diff">Full diff</h2>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/.github/README.md b/.github/README.md</span>
<span class="gh">index 3a9e654d621858..9956881550a4d7 100644</span>
<span class="gd">--- a/.github/README.md</span>
<span class="gi">+++ b/.github/README.md</span>
<span class="gu">@@ -82,7 +82,8 @@ You can check the [authors](https://github.com/azerothcore/azerothcore-wotlk/blo</span>

<span class="w"> </span>## License

<span class="gd">-- The AzerothCore source code is released under the [GNU GPL v2](https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html)</span>
<span class="gi">+- The new AzerothCore source components are released under the [GNU AGPL v3](https://www.gnu.org/licenses/agpl-3.0.en.html)</span>
<span class="gi">+- The old sources based on MaNGOS/TrinityCore are released under the [GNU GPL v2](https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html)</span>

<span class="w"> </span>It&#39;s important to note that AzerothCore is not an official Blizzard Entertainment product, and it is not affiliated with or endorsed by World of Warcraft or Blizzard Entertainment. AzerothCore does not in any case sponsor nor support illegal public servers. If you use this project to run an illegal public server and not for testing and learning it is your own personal choice.

<span class="gh">diff --git a/.github/workflows/codestyle.yml b/.github/workflows/codestyle.yml</span>
<span class="gh">index 643593a0c2107b..4fc3f97efabf07 100644</span>
<span class="gd">--- a/.github/workflows/codestyle.yml</span>
<span class="gi">+++ b/.github/workflows/codestyle.yml</span>
<span class="gu">@@ -14,7 +14,7 @@ jobs:</span>
<span class="w"> </span>  triage:
<span class="w"> </span>    runs-on: ubuntu-latest
<span class="w"> </span>    name: C++
<span class="gd">-    if: github.repository == &#39;azerothcore/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="gi">+    if: github.repository == &#39;mod-playerbots/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="w"> </span>    steps:
<span class="w"> </span>      - uses: actions/checkout@v4
<span class="w"> </span>      - name: Setup python
<span class="gh">diff --git a/.github/workflows/core-build-nopch.yml b/.github/workflows/core-build-nopch.yml</span>
<span class="gh">index 56f0a6a2d835ac..98eb1f20767469 100644</span>
<span class="gd">--- a/.github/workflows/core-build-nopch.yml</span>
<span class="gi">+++ b/.github/workflows/core-build-nopch.yml</span>
<span class="gu">@@ -44,7 +44,7 @@ jobs:</span>
<span class="w"> </span>              CXX: g++-14
<span class="w"> </span>    runs-on: ${{ matrix.os }}
<span class="w"> </span>    name: ${{ matrix.os }}-${{ matrix.compiler.CC }}-nopch
<span class="gd">-    if: github.repository == &#39;azerothcore/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="gi">+    if: github.repository == &#39;mod-playerbots/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="w"> </span>    steps:
<span class="w"> </span>      - uses: actions/checkout@v4
<span class="w"> </span>      - uses: ./.github/actions/linux-build
<span class="gh">diff --git a/.github/workflows/core-build-pch.yml b/.github/workflows/core-build-pch.yml</span>
<span class="gh">index 3ac8cc6fdcd490..ad07eaf2817590 100644</span>
<span class="gd">--- a/.github/workflows/core-build-pch.yml</span>
<span class="gi">+++ b/.github/workflows/core-build-pch.yml</span>
<span class="gu">@@ -39,8 +39,10 @@ jobs:</span>
<span class="w"> </span>              CC: clang-18
<span class="w"> </span>              CXX: clang++-18
<span class="w"> </span>    runs-on: ${{ matrix.os }}
<span class="gd">-    name: ${{ matrix.os }}-${{ matrix.compiler.CC }}-pch</span>
<span class="gd">-    if: github.repository == &#39;azerothcore/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="gi">+    name: ${{ matrix.os }}-${{ matrix.compiler }}-pch</span>
<span class="gi">+    env:</span>
<span class="gi">+      COMPILER: ${{ matrix.compiler }}</span>
<span class="gi">+    if: github.repository == &#39;mod-playerbots/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="w"> </span>    steps:
<span class="w"> </span>      - uses: actions/checkout@v4
<span class="w"> </span>      - uses: ./.github/actions/linux-build
<span class="gh">diff --git a/.github/workflows/core-build-playerbots.yml b/.github/workflows/core-build-playerbots.yml</span>
new file mode 100644
<span class="gh">index 00000000000000..0d7bf98f7b4dc3</span>
<span class="gd">--- /dev/null</span>
<span class="gi">+++ b/.github/workflows/core-build-playerbots.yml</span>
<span class="gu">@@ -0,0 +1,100 @@</span>
<span class="gi">+# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.</span>
<span class="gi">+# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml</span>
<span class="gi">+name: ubuntu-build</span>
<span class="gi">+</span>
<span class="gi">+on:</span>
<span class="gi">+  push:</span>
<span class="gi">+    branches: [ &quot;Playerbot&quot; ]</span>
<span class="gi">+  pull_request:</span>
<span class="gi">+    branches: [ &quot;Playerbot&quot; ]</span>
<span class="gi">+</span>
<span class="gi">+jobs:</span>
<span class="gi">+  build:</span>
<span class="gi">+    strategy:</span>
<span class="gi">+      # Set fail-fast to false to ensure that feedback is delivered for all matrix combinations. Consider changing this to true when your workflow is stable.</span>
<span class="gi">+      fail-fast: false</span>
<span class="gi">+      matrix:</span>
<span class="gi">+        # the result of the matrix will be the combination of all attributes, so we get os*compiler builds</span>
<span class="gi">+        include:</span>
<span class="gi">+          - os: ubuntu-22.04</span>
<span class="gi">+            c_compiler: clang</span>
<span class="gi">+            cpp_compiler: clang++</span>
<span class="gi">+            build_type: Release</span>
<span class="gi">+          - os: ubuntu-22.04</span>
<span class="gi">+            c_compiler: gcc</span>
<span class="gi">+            cpp_compiler: g++</span>
<span class="gi">+            build_type: Release</span>
<span class="gi">+          - os: ubuntu-24.04</span>
<span class="gi">+            c_compiler: gcc</span>
<span class="gi">+            cpp_compiler: g++</span>
<span class="gi">+            build_type: Release</span>
<span class="gi">+            </span>
<span class="gi">+    runs-on: ${{ matrix.os }}</span>
<span class="gi">+    name: ${{ matrix.os }}-${{ matrix.cpp_compiler }}</span>
<span class="gi">+</span>
<span class="gi">+    steps:</span>
<span class="gi">+    - name: Checkout AzerothCore</span>
<span class="gi">+      uses: actions/checkout@v3</span>
<span class="gi">+</span>
<span class="gi">+    - name: Set reusable strings</span>
<span class="gi">+      # Turn repeated input strings (such as the build output directory) into step outputs. These step outputs can be used throughout the workflow file.</span>
<span class="gi">+      id: strings</span>
<span class="gi">+      shell: bash</span>
<span class="gi">+      run: |</span>
<span class="gi">+        echo &quot;build-output-dir=${{ github.workspace }}/build&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;</span>
<span class="gi">+        </span>
<span class="gi">+    # - name: Clone Playerbot Module</span>
<span class="gi">+    #   run: git clone --depth=1 --branch=master https://github.com/mod-playerbots/mod-playerbots.git modules/mod-playerbots</span>
<span class="gi">+</span>
<span class="gi">+    - name: Checkout Playerbot Module</span>
<span class="gi">+      uses: actions/checkout@v3</span>
<span class="gi">+      with:</span>
<span class="gi">+        repository: &#39;mod-playerbots/mod-playerbots&#39;</span>
<span class="gi">+        #ref: &#39;feature/core_update_10_2025&#39; #used on core merge conflicts builds</span>
<span class="gi">+        path: &#39;modules/mod-playerbots&#39;</span>
<span class="gi">+    </span>
<span class="gi">+    - name: Install Requirements</span>
<span class="gi">+      run: sudo apt-get update &amp;&amp; sudo apt-get install git cmake make gcc g++ clang libmysqlclient-dev libssl-dev libbz2-dev libreadline-dev libncurses-dev mysql-server libboost-all-dev</span>
<span class="gi">+      </span>
<span class="gi">+    # - name: Cache</span>
<span class="gi">+    #   uses: actions/cache@v3</span>
<span class="gi">+    #   with:</span>
<span class="gi">+    #     path: var/ccache</span>
<span class="gi">+    #     key: ccache:${{ matrix.os }}:${{ matrix.compiler }}:${{ matrix.modules }}-modules:${{ github.ref }}:${{ github.sha }}</span>
<span class="gi">+    #     restore-keys: |</span>
<span class="gi">+    #       ccache:${{ matrix.os }}:${{ matrix.compiler }}:${{ matrix.modules }}-modules:${{ github.ref }}</span>
<span class="gi">+    #       ccache:${{ matrix.os }}:${{ matrix.compiler }}:${{ matrix.modules }}-modules</span>
<span class="gi">+            </span>
<span class="gi">+    # - name: Configure OS</span>
<span class="gi">+    #   run: source ./acore.sh install-deps</span>
<span class="gi">+    #   env:</span>
<span class="gi">+    #     CONTINUOUS_INTEGRATION: true</span>
<span class="gi">+        </span>
<span class="gi">+    # - name: Create conf/config.sh</span>
<span class="gi">+    #   run: source ./apps/ci/ci-conf-core.sh</span>
<span class="gi">+      </span>
<span class="gi">+    # - name: Process pending sql</span>
<span class="gi">+    #   run: bash bin/acore-db-pendings</span>
<span class="gi">+      </span>
<span class="gi">+    # - name: Build</span>
<span class="gi">+    #   run: source ./apps/ci/ci-compile.sh</span>
<span class="gi">+        </span>
<span class="gi">+    - name: Configure CMake</span>
<span class="gi">+      # Configure CMake in a &#39;build&#39; subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.</span>
<span class="gi">+      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type</span>
<span class="gi">+      run: &gt;</span>
<span class="gi">+        cmake -B ${{ steps.strings.outputs.build-output-dir }}</span>
<span class="gi">+        -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}</span>
<span class="gi">+        -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}</span>
<span class="gi">+        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}</span>
<span class="gi">+        -S ${{ github.workspace }}</span>
<span class="gi">+</span>
<span class="gi">+    - name: Build</span>
<span class="gi">+      # Build your program with the given configuration. Note that --config is needed because the default Windows generator is a multi-config generator (Visual Studio generator).</span>
<span class="gi">+      run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}</span>
<span class="gi">+</span>
<span class="gi">+    # - name: Test</span>
<span class="gi">+    #   working-directory: ${{ steps.strings.outputs.build-output-dir }}</span>
<span class="gi">+    #   # Execute tests defined by the CMake configuration. Note that --build-config is needed because the default Windows generator is a multi-config generator (Visual Studio generator).</span>
<span class="gi">+    #   # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail</span>
<span class="gi">+    #   run: ctest --build-config ${{ matrix.build_type }}</span>
<span class="gh">diff --git a/.github/workflows/core-build.yml b/.github/workflows/core-build.yml</span>
new file mode 100644
<span class="gh">index 00000000000000..7f1c0657238951</span>
<span class="gd">--- /dev/null</span>
<span class="gi">+++ b/.github/workflows/core-build.yml</span>
<span class="gu">@@ -0,0 +1,99 @@</span>
<span class="gi">+# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.</span>
<span class="gi">+# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml</span>
<span class="gi">+name: ubuntu-build</span>
<span class="gi">+</span>
<span class="gi">+on:</span>
<span class="gi">+  push:</span>
<span class="gi">+    branches: [ &quot;Playerbot&quot; ]</span>
<span class="gi">+  pull_request:</span>
<span class="gi">+    branches: [ &quot;Playerbot&quot; ]</span>
<span class="gi">+</span>
<span class="gi">+jobs:</span>
<span class="gi">+  build:</span>
<span class="gi">+    strategy:</span>
<span class="gi">+      # Set fail-fast to false to ensure that feedback is delivered for all matrix combinations. Consider changing this to true when your workflow is stable.</span>
<span class="gi">+      fail-fast: false</span>
<span class="gi">+      matrix:</span>
<span class="gi">+        # the result of the matrix will be the combination of all attributes, so we get os*compiler builds</span>
<span class="gi">+        include:</span>
<span class="gi">+          - os: ubuntu-22.04</span>
<span class="gi">+            c_compiler: clang</span>
<span class="gi">+            cpp_compiler: clang++</span>
<span class="gi">+            build_type: Release</span>
<span class="gi">+          - os: ubuntu-22.04</span>
<span class="gi">+            c_compiler: gcc</span>
<span class="gi">+            cpp_compiler: g++</span>
<span class="gi">+            build_type: Release</span>
<span class="gi">+          - os: ubuntu-24.04</span>
<span class="gi">+            c_compiler: gcc</span>
<span class="gi">+            cpp_compiler: g++</span>
<span class="gi">+            build_type: Release</span>
<span class="gi">+            </span>
<span class="gi">+    runs-on: ${{ matrix.os }}</span>
<span class="gi">+    name: ${{ matrix.os }}-${{ matrix.cpp_compiler }}</span>
<span class="gi">+</span>
<span class="gi">+    steps:</span>
<span class="gi">+    - name: Checkout AzerothCore</span>
<span class="gi">+      uses: actions/checkout@v3</span>
<span class="gi">+</span>
<span class="gi">+    - name: Set reusable strings</span>
<span class="gi">+      # Turn repeated input strings (such as the build output directory) into step outputs. These step outputs can be used throughout the workflow file.</span>
<span class="gi">+      id: strings</span>
<span class="gi">+      shell: bash</span>
<span class="gi">+      run: |</span>
<span class="gi">+        echo &quot;build-output-dir=${{ github.workspace }}/build&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;</span>
<span class="gi">+        </span>
<span class="gi">+    # - name: Clone Playerbot Module</span>
<span class="gi">+    #   run: git clone --depth=1 --branch=master https://github.com/mod-playerbots/mod-playerbots.git modules/mod-playerbots</span>
<span class="gi">+</span>
<span class="gi">+    # - name: Checkout Playerbot Module</span>
<span class="gi">+    #   uses: actions/checkout@v3</span>
<span class="gi">+    #   with:</span>
<span class="gi">+    #     repository: &#39;mod-playerbots/mod-playerbots&#39;</span>
<span class="gi">+    #     path: &#39;modules/mod-playerbots&#39;</span>
<span class="gi">+    </span>
<span class="gi">+    - name: Install Requirements</span>
<span class="gi">+      run: sudo apt-get update &amp;&amp; sudo apt-get install git cmake make gcc g++ clang libmysqlclient-dev libssl-dev libbz2-dev libreadline-dev libncurses-dev mysql-server libboost-all-dev</span>
<span class="gi">+      </span>
<span class="gi">+    # - name: Cache</span>
<span class="gi">+    #   uses: actions/cache@v3</span>
<span class="gi">+    #   with:</span>
<span class="gi">+    #     path: var/ccache</span>
<span class="gi">+    #     key: ccache:${{ matrix.os }}:${{ matrix.compiler }}:${{ matrix.modules }}-modules:${{ github.ref }}:${{ github.sha }}</span>
<span class="gi">+    #     restore-keys: |</span>
<span class="gi">+    #       ccache:${{ matrix.os }}:${{ matrix.compiler }}:${{ matrix.modules }}-modules:${{ github.ref }}</span>
<span class="gi">+    #       ccache:${{ matrix.os }}:${{ matrix.compiler }}:${{ matrix.modules }}-modules</span>
<span class="gi">+            </span>
<span class="gi">+    # - name: Configure OS</span>
<span class="gi">+    #   run: source ./acore.sh install-deps</span>
<span class="gi">+    #   env:</span>
<span class="gi">+    #     CONTINUOUS_INTEGRATION: true</span>
<span class="gi">+        </span>
<span class="gi">+    # - name: Create conf/config.sh</span>
<span class="gi">+    #   run: source ./apps/ci/ci-conf-core.sh</span>
<span class="gi">+      </span>
<span class="gi">+    # - name: Process pending sql</span>
<span class="gi">+    #   run: bash bin/acore-db-pendings</span>
<span class="gi">+      </span>
<span class="gi">+    # - name: Build</span>
<span class="gi">+    #   run: source ./apps/ci/ci-compile.sh</span>
<span class="gi">+        </span>
<span class="gi">+    - name: Configure CMake</span>
<span class="gi">+      # Configure CMake in a &#39;build&#39; subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.</span>
<span class="gi">+      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type</span>
<span class="gi">+      run: &gt;</span>
<span class="gi">+        cmake -B ${{ steps.strings.outputs.build-output-dir }}</span>
<span class="gi">+        -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}</span>
<span class="gi">+        -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}</span>
<span class="gi">+        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}</span>
<span class="gi">+        -S ${{ github.workspace }}</span>
<span class="gi">+</span>
<span class="gi">+    - name: Build</span>
<span class="gi">+      # Build your program with the given configuration. Note that --config is needed because the default Windows generator is a multi-config generator (Visual Studio generator).</span>
<span class="gi">+      run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}</span>
<span class="gi">+</span>
<span class="gi">+    # - name: Test</span>
<span class="gi">+    #   working-directory: ${{ steps.strings.outputs.build-output-dir }}</span>
<span class="gi">+    #   # Execute tests defined by the CMake configuration. Note that --build-config is needed because the default Windows generator is a multi-config generator (Visual Studio generator).</span>
<span class="gi">+    #   # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail</span>
<span class="gi">+    #   run: ctest --build-config ${{ matrix.build_type }}</span>
<span class="gh">diff --git a/.github/workflows/core_modules_build.yml b/.github/workflows/core_modules_build.yml</span>
<span class="gh">index 322c063851189e..3d19433446e8be 100644</span>
<span class="gd">--- a/.github/workflows/core_modules_build.yml</span>
<span class="gi">+++ b/.github/workflows/core_modules_build.yml</span>
<span class="gu">@@ -46,7 +46,7 @@ jobs:</span>
<span class="w"> </span>              CXX: clang++-18
<span class="w"> </span>    runs-on: ${{ matrix.os }}
<span class="w"> </span>    name: ${{ matrix.os }}-${{ matrix.compiler.CC }}-nopch-modules
<span class="gd">-    if: github.repository == &#39;azerothcore/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="gi">+    if: github.repository == &#39;mod-playerbots/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="w"> </span>    steps:
<span class="w"> </span>      - uses: actions/checkout@v4
<span class="w"> </span>        # This script installs a general list of modules to compile with
<span class="gh">diff --git a/.github/workflows/docker_build.yml b/.github/workflows/docker_build.yml</span>
<span class="gh">index e770e0eae6bb01..d6d2f29057330d 100644</span>
<span class="gd">--- a/.github/workflows/docker_build.yml</span>
<span class="gi">+++ b/.github/workflows/docker_build.yml</span>
<span class="gu">@@ -23,13 +23,13 @@ env:</span>
<span class="w"> </span>  COMPOSE_DOCKER_CLI_BUILD: 1
<span class="w"> </span>  DOCKER_BUILDKIT: 1
<span class="w"> </span>  RUNNING_ON_PRIMARY_BRANCH: |
<span class="gd">-    ${{ (github.repository == &#39;azerothcore/azerothcore-wotlk&#39; &amp;&amp; github.ref_name == &#39;master&#39;) &amp;&amp; &#39;true&#39; || &#39;false&#39; }}</span>
<span class="gi">+    ${{ (github.repository == &#39;mod-playerbots/azerothcore-wotlk&#39; &amp;&amp; github.ref_name == &#39;master&#39;) &amp;&amp; &#39;true&#39; || &#39;false&#39; }}</span>

<span class="w"> </span>jobs:
<span class="w"> </span>  build-containers:
<span class="w"> </span>    runs-on: &quot;ubuntu-latest&quot;
<span class="w"> </span>    if: |
<span class="gd">-      github.repository == &#39;azerothcore/azerothcore-wotlk&#39;</span>
<span class="gi">+      github.repository == &#39;mod-playerbots/azerothcore-wotlk&#39;</span>
<span class="w"> </span>      &amp;&amp; !github.event.pull_request.draft
<span class="w"> </span>      &amp;&amp; (github.ref_name == &#39;master&#39; || contains(github.event.pull_request.labels.*.name, &#39;run-build&#39;) || github.event.label.name == &#39;run-build&#39;)
<span class="w"> </span>    steps:
<span class="gh">diff --git a/.github/workflows/macos_build.yml b/.github/workflows/macos_build.yml</span>
<span class="gh">index 09ae976a2262a4..03974bca6ee471 100644</span>
<span class="gd">--- a/.github/workflows/macos_build.yml</span>
<span class="gi">+++ b/.github/workflows/macos_build.yml</span>
<span class="gu">@@ -1,12 +1,9 @@</span>
<span class="w"> </span>name: macos-build
<span class="w"> </span>on:
<span class="w"> </span>  push:
<span class="gd">-    branches:</span>
<span class="gd">-      - &#39;master&#39;</span>
<span class="gi">+    branches: [ &quot;Playerbot&quot; ]</span>
<span class="w"> </span>  pull_request:
<span class="gd">-    types:</span>
<span class="gd">-      - labeled</span>
<span class="gd">-      - synchronize</span>
<span class="gi">+    branches: [ &quot;Playerbot&quot; ]</span>

<span class="w"> </span>concurrency:
<span class="w"> </span>  group: ${{ github.head_ref }} || concat(${{ github.ref_name }}, ${{ github.workflow }})
<span class="gu">@@ -25,10 +22,6 @@ jobs:</span>
<span class="w"> </span>          - macos-14
<span class="w"> </span>    runs-on: ${{ matrix.os }}
<span class="w"> </span>    name: ${{ matrix.os }}
<span class="gd">-    if: |</span>
<span class="gd">-      github.repository == &#39;azerothcore/azerothcore-wotlk&#39;</span>
<span class="gd">-      &amp;&amp; !github.event.pull_request.draft</span>
<span class="gd">-      &amp;&amp; (github.ref == &#39;refs/heads/master&#39; || contains(github.event.pull_request.labels.*.name, &#39;run-build&#39;) || github.event.label.name == &#39;run-build&#39;)</span>
<span class="w"> </span>    steps:
<span class="w"> </span>      - uses: actions/checkout@v4
<span class="w"> </span>      - name: Cache
<span class="gh">diff --git a/.github/workflows/tools_build.yml b/.github/workflows/tools_build.yml</span>
<span class="gh">index dbd8eba50bcbb0..d414f233d23a71 100644</span>
<span class="gd">--- a/.github/workflows/tools_build.yml</span>
<span class="gi">+++ b/.github/workflows/tools_build.yml</span>
<span class="gu">@@ -32,9 +32,11 @@ jobs:</span>
<span class="w"> </span>    runs-on: ${{ matrix.os }}
<span class="w"> </span>    name: ${{ matrix.os }}-${{ matrix.compiler.CC }}
<span class="w"> </span>    if: |
<span class="gd">-      github.repository == &#39;azerothcore/azerothcore-wotlk&#39;</span>
<span class="gd">-      &amp;&amp; !github.event.pull_request.draft</span>
<span class="gd">-      &amp;&amp; (github.ref == &#39;refs/heads/master&#39; || contains(github.event.pull_request.labels.*.name, &#39;run-build&#39;) || github.event.label.name == &#39;run-build&#39;)</span>
<span class="gi">+      github.repository == &#39;mod-playerbots/azerothcore-wotlk&#39; &amp;&amp; !github.event.pull_request.draft</span>
<span class="gi">+      &amp;&amp; (</span>
<span class="gi">+        contains(github.event.pull_request.labels.*.name, &#39;run-build&#39;)</span>
<span class="gi">+        || github.event.label.name == &#39;run-build&#39;</span>
<span class="gi">+      )</span>
<span class="w"> </span>    steps:
<span class="w"> </span>      - uses: actions/checkout@v4
<span class="w"> </span>      - uses: ./.github/actions/linux-build
<span class="gh">diff --git a/.github/workflows/windows_build.yml b/.github/workflows/windows_build.yml</span>
<span class="gh">index c23c87be1ccd99..d5d09551168a16 100644</span>
<span class="gd">--- a/.github/workflows/windows_build.yml</span>
<span class="gi">+++ b/.github/workflows/windows_build.yml</span>
<span class="gu">@@ -1,12 +1,9 @@</span>
<span class="w"> </span>name: windows-build
<span class="w"> </span>on:
<span class="w"> </span>  push:
<span class="gd">-    branches:</span>
<span class="gd">-      - &#39;master&#39;</span>
<span class="gi">+    branches: [ &quot;Playerbot&quot; ]</span>
<span class="w"> </span>  pull_request:
<span class="gd">-    types:</span>
<span class="gd">-      - labeled</span>
<span class="gd">-      - synchronize</span>
<span class="gi">+    branches: [ &quot;Playerbot&quot; ]</span>

<span class="w"> </span>concurrency:
<span class="w"> </span>  # One concurrency group per workflow + ref.
<span class="gu">@@ -29,10 +26,6 @@ jobs:</span>
<span class="w"> </span>    name: ${{ matrix.os }}
<span class="w"> </span>    env:
<span class="w"> </span>      BOOST_ROOT: C:\local\boost_1_82_0
<span class="gd">-    if: |</span>
<span class="gd">-      github.repository == &#39;azerothcore/azerothcore-wotlk&#39;</span>
<span class="gd">-      &amp;&amp; !github.event.pull_request.draft</span>
<span class="gd">-      &amp;&amp; (github.ref == &#39;refs/heads/master&#39; || contains(github.event.pull_request.labels.*.name, &#39;run-build&#39;) || github.event.label.name == &#39;run-build&#39;)</span>
<span class="w"> </span>    steps:
<span class="w"> </span>      - uses: actions/checkout@v4
<span class="w"> </span>      - name: ccache
<span class="gh">diff --git a/.gitignore b/.gitignore</span>
<span class="gh">index 548213a63fcbf5..a25db2997252a4 100644</span>
<span class="gd">--- a/.gitignore</span>
<span class="gi">+++ b/.gitignore</span>
<span class="gu">@@ -58,6 +58,8 @@ CMakeLists.txt.user</span>
<span class="w"> </span>#
<span class="w"> </span>/.settings/
<span class="w"> </span>/.externalToolBuilders/*
<span class="gi">+/.vs</span>
<span class="gi">+/out</span>
<span class="w"> </span># exclude in all levels
<span class="w"> </span>nbproject/
<span class="w"> </span>.sync.ffs_db
<span class="gu">@@ -102,3 +104,5 @@ local.properties</span>
<span class="w"> </span>#  !modules/yourmodule
<span class="w"> </span>#
<span class="w"> </span># ==================
<span class="gi">+.cache</span>
<span class="gi">+compile_commands.json</span>
\ No newline at end of file
<span class="gh">diff --git a/apps/ci/mac/ci-compile.sh b/apps/ci/mac/ci-compile.sh</span>
<span class="gh">index 79507bc9f3c975..10dfbc4b64e14f 100755</span>
<span class="gd">--- a/apps/ci/mac/ci-compile.sh</span>
<span class="gi">+++ b/apps/ci/mac/ci-compile.sh</span>
<span class="gu">@@ -22,8 +22,7 @@ if [ ! -d &quot;$mysql_include_path&quot; ]; then</span>
<span class="w"> </span>fi

<span class="w"> </span>time cmake ../../../ \
<span class="gd">--DTOOLS=1 \</span>
<span class="gd">--DBUILD_TESTING=1 \</span>
<span class="gi">+-DTOOLS_BUILD=all \</span>
<span class="w"> </span>-DSCRIPTS=static \
<span class="w"> </span>-DCMAKE_BUILD_TYPE=Release \
<span class="w"> </span>-DMYSQL_ADD_INCLUDE_PATH=$mysql_include_path \
<span class="gu">@@ -33,9 +32,6 @@ time cmake ../../../ \</span>
<span class="w"> </span>-DOPENSSL_INCLUDE_DIR=&quot;$OPENSSL_ROOT_DIR/include&quot; \
<span class="w"> </span>-DOPENSSL_SSL_LIBRARIES=&quot;$OPENSSL_ROOT_DIR/lib/libssl.dylib&quot; \
<span class="w"> </span>-DOPENSSL_CRYPTO_LIBRARIES=&quot;$OPENSSL_ROOT_DIR/lib/libcrypto.dylib&quot; \
<span class="gd">--DWITH_WARNINGS=1 \</span>
<span class="gd">--DCMAKE_C_FLAGS=&quot;-Werror&quot; \</span>
<span class="gd">--DCMAKE_CXX_FLAGS=&quot;-Werror&quot; \</span>
<span class="w"> </span>-DCMAKE_C_COMPILER_LAUNCHER=ccache \
<span class="w"> </span>-DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
<span class="w"> </span>-DUSE_SCRIPTPCH=0 \
<span class="gh">diff --git a/apps/installer/includes/os_configs/windows.sh b/apps/installer/includes/os_configs/windows.sh</span>
<span class="gh">index cdba50c27fbfa7..ae69640b05c46a 100644</span>
<span class="gd">--- a/apps/installer/includes/os_configs/windows.sh</span>
<span class="gi">+++ b/apps/installer/includes/os_configs/windows.sh</span>
<span class="gu">@@ -24,6 +24,6 @@ fi</span>

<span class="w"> </span>choco install -y --skip-checksums &quot;${INSTALL_ARGS[@]}&quot;  cmake.install -y --installargs &#39;ADD_CMAKE_TO_PATH=System&#39;
<span class="w"> </span>choco install -y --skip-checksums &quot;${INSTALL_ARGS[@]}&quot;  visualstudio2022-workload-nativedesktop
<span class="gd">-choco install -y --skip-checksums &quot;${INSTALL_ARGS[@]}&quot;  openssl --force --version=3.5.4</span>
<span class="gi">+choco install -y --skip-checksums &quot;${INSTALL_ARGS[@]}&quot;  openssl --force --version=3.6.1</span>
<span class="w"> </span>choco install -y --skip-checksums &quot;${INSTALL_ARGS[@]}&quot;  boost-msvc-14.3 --force --version=1.87.0
<span class="w"> </span>choco install -y --skip-checksums &quot;${INSTALL_ARGS[@]}&quot;  mysql --force --version=8.4.6
<span class="gh">diff --git a/deps/boost/CMakeLists.txt b/deps/boost/CMakeLists.txt</span>
<span class="gh">index c41ce041a3b231..78335628360859 100644</span>
<span class="gd">--- a/deps/boost/CMakeLists.txt</span>
<span class="gi">+++ b/deps/boost/CMakeLists.txt</span>
<span class="gu">@@ -32,7 +32,7 @@ else()</span>
<span class="w"> </span>endif()

<span class="w"> </span># Boost.System is header-only since 1.69; do not require it explicitly.
<span class="gd">-find_package(Boost ${BOOST_REQUIRED_VERSION} REQUIRED COMPONENTS filesystem program_options iostreams regex)</span>
<span class="gi">+find_package(Boost ${BOOST_REQUIRED_VERSION} REQUIRED COMPONENTS filesystem program_options iostreams regex thread)</span>

<span class="w"> </span>if(NOT Boost_FOUND)
<span class="w"> </span>  if(NOT DEFINED ENV{Boost_ROOT} AND NOT DEFINED Boost_DIR AND NOT DEFINED BOOST_ROOT AND NOT DEFINED BOOSTROOT)
<span class="gh">diff --git a/doc/changelog/master.md b/doc/changelog/master.md</span>
<span class="gh">index 59b9f7bb9bd6d6..3cd001b8d552f3 100644</span>
<span class="gd">--- a/doc/changelog/master.md</span>
<span class="gi">+++ b/doc/changelog/master.md</span>
<span class="gu">@@ -414,7 +414,7 @@ minimal-dynamic - builds commands and spells dynamically. Now don&#39;t support</span>
<span class="w"> </span>- Example loader script for modules:
<span class="w"> </span>```cpp
<span class="w"> </span>/*
<span class="gd">- * Copyright (C) 2016+ AzerothCore &lt;www.azerothcore.org&gt;</span>
<span class="gi">+ * Copyright (C) 2016+ AzerothCore &lt;www.azerothcore.org&gt;, released under GNU AGPL v3 license: https://github.com/azerothcore/azerothcore-wotlk/blob/master/LICENSE</span>
<span class="w"> </span> */

<span class="w"> </span>// From SC
<span class="gh">diff --git a/docker-compose.yml b/docker-compose.yml</span>
<span class="gh">index 4c6525df0ebc98..f14f6dac879ef3 100644</span>
<span class="gd">--- a/docker-compose.yml</span>
<span class="gi">+++ b/docker-compose.yml</span>
<span class="gu">@@ -75,6 +75,7 @@ services:</span>
<span class="w"> </span>      AC_LOGIN_DATABASE_INFO: &quot;ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_auth&quot;
<span class="w"> </span>      AC_WORLD_DATABASE_INFO: &quot;ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_world&quot;
<span class="w"> </span>      AC_CHARACTER_DATABASE_INFO: &quot;ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_characters&quot;
<span class="gi">+      AC_PLAYERBOTS_DATABASE_INFO: &quot;ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_playerbots&quot;</span>
<span class="w"> </span>    ports:
<span class="w"> </span>      - ${DOCKER_WORLD_EXTERNAL_PORT:-8085}:8085
<span class="w"> </span>      - ${DOCKER_SOAP_EXTERNAL_PORT:-7878}:7878
<span class="gh">diff --git a/modules/CMakeLists.txt b/modules/CMakeLists.txt</span>
<span class="gh">index fd36c5068a3991..a4b8c14c6cb11e 100644</span>
<span class="gd">--- a/modules/CMakeLists.txt</span>
<span class="gi">+++ b/modules/CMakeLists.txt</span>
<span class="gu">@@ -37,6 +37,7 @@ set(&quot;AC_MODULE_LIST&quot; &quot;&quot;)</span>
<span class="w"> </span>set(&quot;AC_SCRIPTS_LIST&quot; &quot;&quot;)
<span class="w"> </span>set(MOD_ALE_FOUND 0)
<span class="w"> </span>set(MOD_ALE_PATH &quot;&quot;)
<span class="gi">+set(MOD_PLAYERBOTS_FOUND 0)</span>

<span class="w"> </span>foreach(include ${AC_ADD_SCRIPTS_INCLUDE})
<span class="w"> </span>  set(&quot;AC_SCRIPTS_INCLUDES&quot; &quot;#include \&quot;${include}\&quot;\n${AC_SCRIPTS_INCLUDES}&quot;)
<span class="gu">@@ -81,6 +82,16 @@ foreach(SOURCE_MODULE ${MODULES_MODULE_LIST})</span>
<span class="w"> </span>    ConfigureALEModule(${SOURCE_MODULE})
<span class="w"> </span>  endif()

<span class="gi">+  if (SOURCE_MODULE MATCHES &quot;mod-playerbots&quot;)</span>
<span class="gi">+    set(MOD_PLAYERBOTS_FOUND 1)</span>
<span class="gi">+    target_compile_options(database</span>
<span class="gi">+      PRIVATE</span>
<span class="gi">+        -DMOD_PLAYERBOTS)</span>
<span class="gi">+    target_compile_options(game-interface</span>
<span class="gi">+      INTERFACE</span>
<span class="gi">+        -DMOD_PLAYERBOTS)</span>
<span class="gi">+  endif()</span>
<span class="gi">+</span>
<span class="w"> </span>  # Build the Graph values
<span class="w"> </span>  if(${MODULE_MODULE_VARIABLE} MATCHES &quot;dynamic&quot;)
<span class="w"> </span>    GetProjectNameOfModuleName(${SOURCE_MODULE} MODULE_SOURCE_PROJECT_NAME)
<span class="gu">@@ -289,6 +300,7 @@ endif()</span>
<span class="w"> </span>target_link_libraries(modules
<span class="w"> </span>  PRIVATE
<span class="w"> </span>    acore-core-interface
<span class="gi">+    mysql</span>
<span class="w"> </span>  PUBLIC
<span class="w"> </span>    game-interface)

<span class="gu">@@ -363,6 +375,12 @@ target_compile_options(modules</span>
<span class="w"> </span>  INTERFACE
<span class="w"> </span>    -DCONFIG_FILE_LIST=$&lt;1:&quot;${CONFIG_LIST}&quot;&gt;)

<span class="gi">+if (MOD_PLAYERBOTS_FOUND)</span>
<span class="gi">+    target_compile_options(modules</span>
<span class="gi">+            PRIVATE</span>
<span class="gi">+            -DMOD_PLAYERBOTS)</span>
<span class="gi">+endif()</span>
<span class="gi">+</span>
<span class="w"> </span>if (MOD_ALE_FOUND)
<span class="w"> </span>  if (APPLE)
<span class="w"> </span>    target_compile_definitions(modules
<span class="gh">diff --git a/src/server/apps/worldserver/Main.cpp b/src/server/apps/worldserver/Main.cpp</span>
<span class="gh">index 511c17e3674c3d..6a08e9689aa622 100644</span>
<span class="gd">--- a/src/server/apps/worldserver/Main.cpp</span>
<span class="gi">+++ b/src/server/apps/worldserver/Main.cpp</span>
<span class="gu">@@ -434,6 +434,11 @@ bool StartDB()</span>
<span class="w"> </span>    if (!loader.Load())
<span class="w"> </span>        return false;

<span class="gi">+    if (!sScriptMgr-&gt;OnDatabasesLoading())</span>
<span class="gi">+    {</span>
<span class="gi">+        return false;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="w"> </span>    ///- Get the realm Id from the configuration file
<span class="w"> </span>    realm.Id.Realm = sConfigMgr-&gt;GetOption&lt;uint32&gt;(&quot;RealmID&quot;, 1);
<span class="w"> </span>    if (!realm.Id.Realm)
<span class="gu">@@ -479,6 +484,8 @@ void StopDB()</span>
<span class="w"> </span>    WorldDatabase.Close();
<span class="w"> </span>    LoginDatabase.Close();

<span class="gi">+    sScriptMgr-&gt;OnDatabasesClosing();</span>
<span class="gi">+</span>
<span class="w"> </span>    MySQL::Library_End();
<span class="w"> </span>}

<span class="gu">@@ -569,6 +576,8 @@ void WorldUpdateLoop()</span>
<span class="w"> </span>    CharacterDatabase.WarnAboutSyncQueries(true);
<span class="w"> </span>    WorldDatabase.WarnAboutSyncQueries(true);

<span class="gi">+    sScriptMgr-&gt;OnDatabaseWarnAboutSyncQueries(true);</span>
<span class="gi">+</span>
<span class="w"> </span>    ///- While we have not World::m_stopEvent, update the world
<span class="w"> </span>    while (!World::IsStopped())
<span class="w"> </span>    {
<span class="gu">@@ -598,6 +607,8 @@ void WorldUpdateLoop()</span>
<span class="w"> </span>#endif
<span class="w"> </span>    }

<span class="gi">+    sScriptMgr-&gt;OnDatabaseWarnAboutSyncQueries(false);</span>
<span class="gi">+</span>
<span class="w"> </span>    LoginDatabase.WarnAboutSyncQueries(false);
<span class="w"> </span>    CharacterDatabase.WarnAboutSyncQueries(false);
<span class="w"> </span>    WorldDatabase.WarnAboutSyncQueries(false);
<span class="gh">diff --git a/src/server/apps/worldserver/worldserver.conf.dist b/src/server/apps/worldserver/worldserver.conf.dist</span>
<span class="gh">index b445450e17b362..01fc64116d376b 100644</span>
<span class="gd">--- a/src/server/apps/worldserver/worldserver.conf.dist</span>
<span class="gi">+++ b/src/server/apps/worldserver/worldserver.conf.dist</span>
<span class="gu">@@ -678,6 +678,7 @@ Allow.IP.Based.Action.Logging = 0</span>

<span class="w"> </span>Appender.Console=1,4,0,&quot;1 9 3 6 5 8&quot;
<span class="w"> </span>Appender.Server=2,5,0,Server.log,w
<span class="gi">+Appender.Playerbots=2,5,0,Playerbots.log,w</span>
<span class="w"> </span># Appender.GM=2,5,15,gm_%s.log
<span class="w"> </span>Appender.Errors=2,2,0,Errors.log,w
<span class="w"> </span># Appender.DB=3,5,0
<span class="gu">@@ -714,6 +715,7 @@ Logger.sql=4,Console Server</span>
<span class="w"> </span>Logger.time.update=4,Console Server
<span class="w"> </span>Logger.module=4,Console Server
<span class="w"> </span>Logger.spells.scripts=2,Console Errors
<span class="gi">+Logger.playerbots=5,Console Playerbots</span>
<span class="w"> </span>#Logger.achievement=4,Console Server
<span class="w"> </span>#Logger.addon=4,Console Server
<span class="w"> </span>#Logger.auctionHouse=4,Console Server
<span class="gh">diff --git a/src/server/database/Database/DatabaseEnv.cpp b/src/server/database/Database/DatabaseEnv.cpp</span>
<span class="gh">index 561e80f4b151cf..56f904d2eb0942 100644</span>
<span class="gd">--- a/src/server/database/Database/DatabaseEnv.cpp</span>
<span class="gi">+++ b/src/server/database/Database/DatabaseEnv.cpp</span>
<span class="gu">@@ -20,3 +20,7 @@</span>
<span class="w"> </span>DatabaseWorkerPool&lt;WorldDatabaseConnection&gt; WorldDatabase;
<span class="w"> </span>DatabaseWorkerPool&lt;CharacterDatabaseConnection&gt; CharacterDatabase;
<span class="w"> </span>DatabaseWorkerPool&lt;LoginDatabaseConnection&gt; LoginDatabase;
<span class="gi">+</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+DatabaseWorkerPool&lt;PlayerbotsDatabaseConnection&gt; PlayerbotsDatabase;</span>
<span class="gi">+#endif</span>
<span class="gh">diff --git a/src/server/database/Database/DatabaseEnv.h b/src/server/database/Database/DatabaseEnv.h</span>
<span class="gh">index 3e0cd2e8613636..7d2b5da775d364 100644</span>
<span class="gd">--- a/src/server/database/Database/DatabaseEnv.h</span>
<span class="gi">+++ b/src/server/database/Database/DatabaseEnv.h</span>
<span class="gu">@@ -25,6 +25,10 @@</span>
<span class="w"> </span>#include &quot;Implementation/LoginDatabase.h&quot;
<span class="w"> </span>#include &quot;Implementation/WorldDatabase.h&quot;

<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+#include &quot;Implementation/PlayerbotsDatabase.h&quot;</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>#include &quot;PreparedStatement.h&quot;
<span class="w"> </span>#include &quot;QueryCallback.h&quot;
<span class="w"> </span>#include &quot;Transaction.h&quot;
<span class="gu">@@ -36,4 +40,9 @@ AC_DATABASE_API extern DatabaseWorkerPool&lt;CharacterDatabaseConnection&gt; Character</span>
<span class="w"> </span>/// Accessor to the realm/login database
<span class="w"> </span>AC_DATABASE_API extern DatabaseWorkerPool&lt;LoginDatabaseConnection&gt; LoginDatabase;

<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+/// Accessor to the playerbots database</span>
<span class="gi">+AC_DATABASE_API extern DatabaseWorkerPool&lt;PlayerbotsDatabaseConnection&gt; PlayerbotsDatabase;</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>#endif
<span class="gh">diff --git a/src/server/database/Database/DatabaseEnvFwd.h b/src/server/database/Database/DatabaseEnvFwd.h</span>
<span class="gh">index b8e5a8882739f1..d6bbaa65e89711 100644</span>
<span class="gd">--- a/src/server/database/Database/DatabaseEnvFwd.h</span>
<span class="gi">+++ b/src/server/database/Database/DatabaseEnvFwd.h</span>
<span class="gu">@@ -32,6 +32,10 @@ class CharacterDatabaseConnection;</span>
<span class="w"> </span>class LoginDatabaseConnection;
<span class="w"> </span>class WorldDatabaseConnection;

<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+class PlayerbotsDatabaseConnection;</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>class PreparedStatementBase;

<span class="w"> </span>template&lt;typename T&gt;
<span class="gu">@@ -41,6 +45,10 @@ using CharacterDatabasePreparedStatement = PreparedStatement&lt;CharacterDatabaseCo</span>
<span class="w"> </span>using LoginDatabasePreparedStatement = PreparedStatement&lt;LoginDatabaseConnection&gt;;
<span class="w"> </span>using WorldDatabasePreparedStatement = PreparedStatement&lt;WorldDatabaseConnection&gt;;

<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+using PlayerbotsDatabasePreparedStatement = PreparedStatement&lt;PlayerbotsDatabaseConnection&gt;;</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>class PreparedResultSet;
<span class="w"> </span>using PreparedQueryResult = std::shared_ptr&lt;PreparedResultSet&gt;;
<span class="w"> </span>using PreparedQueryResultFuture = std::future&lt;PreparedQueryResult&gt;;
<span class="gu">@@ -70,6 +78,10 @@ using CharacterDatabaseTransaction = SQLTransaction&lt;CharacterDatabaseConnection&gt;</span>
<span class="w"> </span>using LoginDatabaseTransaction = SQLTransaction&lt;LoginDatabaseConnection&gt;;
<span class="w"> </span>using WorldDatabaseTransaction = SQLTransaction&lt;WorldDatabaseConnection&gt;;

<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+using PlayerbotsDatabaseTransaction = SQLTransaction&lt;PlayerbotsDatabaseConnection&gt;;</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>class SQLQueryHolderBase;
<span class="w"> </span>using QueryResultHolderFuture = std::future&lt;void&gt;;
<span class="w"> </span>using QueryResultHolderPromise = std::promise&lt;void&gt;;
<span class="gu">@@ -81,6 +93,10 @@ using CharacterDatabaseQueryHolder = SQLQueryHolder&lt;CharacterDatabaseConnection&gt;</span>
<span class="w"> </span>using LoginDatabaseQueryHolder = SQLQueryHolder&lt;LoginDatabaseConnection&gt;;
<span class="w"> </span>using WorldDatabaseQueryHolder = SQLQueryHolder&lt;WorldDatabaseConnection&gt;;

<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+using PlayerbotsDatabaseQueryHolder = SQLQueryHolder&lt;PlayerbotsDatabaseConnection&gt;;</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>class SQLQueryHolderCallback;

<span class="w"> </span>// mysql
<span class="gh">diff --git a/src/server/database/Database/DatabaseLoader.cpp b/src/server/database/Database/DatabaseLoader.cpp</span>
<span class="gh">index c39aa41b936e1c..0328dd49d01b02 100644</span>
<span class="gd">--- a/src/server/database/Database/DatabaseLoader.cpp</span>
<span class="gi">+++ b/src/server/database/Database/DatabaseLoader.cpp</span>
<span class="gu">@@ -238,3 +238,8 @@ template AC_DATABASE_API</span>
<span class="w"> </span>DatabaseLoader&amp; DatabaseLoader::AddDatabase&lt;CharacterDatabaseConnection&gt;(DatabaseWorkerPool&lt;CharacterDatabaseConnection&gt;&amp;, std::string const&amp;);
<span class="w"> </span>template AC_DATABASE_API
<span class="w"> </span>DatabaseLoader&amp; DatabaseLoader::AddDatabase&lt;WorldDatabaseConnection&gt;(DatabaseWorkerPool&lt;WorldDatabaseConnection&gt;&amp;, std::string const&amp;);
<span class="gi">+</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+template AC_DATABASE_API</span>
<span class="gi">+DatabaseLoader&amp; DatabaseLoader::AddDatabase&lt;PlayerbotsDatabaseConnection&gt;(DatabaseWorkerPool&lt;PlayerbotsDatabaseConnection&gt;&amp;, std::string const&amp;);</span>
<span class="gi">+#endif</span>
<span class="gh">diff --git a/src/server/database/Database/DatabaseLoader.h b/src/server/database/Database/DatabaseLoader.h</span>
<span class="gh">index 0f18315e6c51a1..0ef3e82cbbaa76 100644</span>
<span class="gd">--- a/src/server/database/Database/DatabaseLoader.h</span>
<span class="gi">+++ b/src/server/database/Database/DatabaseLoader.h</span>
<span class="gu">@@ -48,8 +48,12 @@ class AC_DATABASE_API DatabaseLoader</span>
<span class="w"> </span>        DATABASE_LOGIN      = 1,
<span class="w"> </span>        DATABASE_CHARACTER  = 2,
<span class="w"> </span>        DATABASE_WORLD      = 4,
<span class="gd">-</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+        DATABASE_PLAYERBOTS = 8,</span>
<span class="gi">+        DATABASE_MASK_ALL   = DATABASE_LOGIN | DATABASE_CHARACTER | DATABASE_WORLD | DATABASE_PLAYERBOTS</span>
<span class="gi">+#else</span>
<span class="w"> </span>        DATABASE_MASK_ALL   = DATABASE_LOGIN | DATABASE_CHARACTER | DATABASE_WORLD
<span class="gi">+#endif</span>
<span class="w"> </span>    };

<span class="w"> </span>    [[nodiscard]] uint32 GetUpdateFlags() const
<span class="gu">@@ -57,6 +61,11 @@ class AC_DATABASE_API DatabaseLoader</span>
<span class="w"> </span>        return _updateFlags;
<span class="w"> </span>    }

<span class="gi">+    void SetUpdateFlags(uint32 newUpdateFlags)</span>
<span class="gi">+    {</span>
<span class="gi">+        _updateFlags |= newUpdateFlags;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="w"> </span>private:
<span class="w"> </span>    bool OpenDatabases();
<span class="w"> </span>    bool PopulateDatabases();
<span class="gu">@@ -73,7 +82,7 @@ class AC_DATABASE_API DatabaseLoader</span>
<span class="w"> </span>    std::string const _logger;
<span class="w"> </span>    std::string_view _modulesList;
<span class="w"> </span>    bool const _autoSetup;
<span class="gd">-    uint32 const _updateFlags;</span>
<span class="gi">+    uint32 _updateFlags;</span>

<span class="w"> </span>    std::queue&lt;Predicate&gt; _open, _populate, _update, _prepare;
<span class="w"> </span>    std::stack&lt;Closer&gt; _close;
<span class="gh">diff --git a/src/server/database/Database/DatabaseWorkerPool.cpp b/src/server/database/Database/DatabaseWorkerPool.cpp</span>
<span class="gh">index ee19a5a48c5559..f539e2a6a64ac6 100644</span>
<span class="gd">--- a/src/server/database/Database/DatabaseWorkerPool.cpp</span>
<span class="gi">+++ b/src/server/database/Database/DatabaseWorkerPool.cpp</span>
<span class="gu">@@ -41,6 +41,10 @@</span>
<span class="w"> </span>#include &lt;sstream&gt;
<span class="w"> </span>#endif

<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+#include &quot;Implementation/PlayerbotsDatabase.h&quot;</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>class PingOperation : public SQLOperation
<span class="w"> </span>{
<span class="w"> </span>    //! Operation for idle delaythreads
<span class="gu">@@ -571,3 +575,7 @@ void DatabaseWorkerPool&lt;T&gt;::ExecuteOrAppend(SQLTransaction&lt;T&gt;&amp; trans, PreparedSt</span>
<span class="w"> </span>template class AC_DATABASE_API DatabaseWorkerPool&lt;LoginDatabaseConnection&gt;;
<span class="w"> </span>template class AC_DATABASE_API DatabaseWorkerPool&lt;WorldDatabaseConnection&gt;;
<span class="w"> </span>template class AC_DATABASE_API DatabaseWorkerPool&lt;CharacterDatabaseConnection&gt;;
<span class="gi">+</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+template class AC_DATABASE_API DatabaseWorkerPool&lt;PlayerbotsDatabaseConnection&gt;;</span>
<span class="gi">+#endif</span>
<span class="gh">diff --git a/src/server/database/Database/Implementation/CharacterDatabase.cpp b/src/server/database/Database/Implementation/CharacterDatabase.cpp</span>
<span class="gh">index 1b8650b4965a9a..25e9b635a105f8 100644</span>
<span class="gd">--- a/src/server/database/Database/Implementation/CharacterDatabase.cpp</span>
<span class="gi">+++ b/src/server/database/Database/Implementation/CharacterDatabase.cpp</span>
<span class="gu">@@ -356,6 +356,7 @@ void CharacterDatabaseConnection::DoPrepareStatements()</span>
<span class="w"> </span>    PrepareStatement(CHAR_UPD_PETITION_NAME, &quot;UPDATE petition SET name = ? WHERE petition_id = ?&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(CHAR_INS_PETITION_SIGNATURE, &quot;INSERT INTO petition_sign (ownerguid, petition_id, playerguid, player_account) VALUES (?, ?, ?, ?)&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(CHAR_UPD_ACCOUNT_ONLINE, &quot;UPDATE characters SET online = 0 WHERE account = ?&quot;, CONNECTION_ASYNC);
<span class="gi">+    PrepareStatement(CHAR_UPD_CHAR_OFFLINE, &quot;UPDATE characters SET online = 0 WHERE guid = ?&quot;, CONNECTION_ASYNC);</span>
<span class="w"> </span>    PrepareStatement(CHAR_INS_GROUP, &quot;INSERT INTO `groups` (guid, leaderGuid, lootMethod, looterGuid, lootThreshold, icon1, icon2, icon3, icon4, icon5, icon6, icon7, icon8, groupType, difficulty, raidDifficulty, masterLooterGuid) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(CHAR_REP_GROUP_MEMBER, &quot;REPLACE INTO group_member (guid, memberGuid, memberFlags, subgroup, roles) VALUES(?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(CHAR_DEL_GROUP_MEMBER, &quot;DELETE FROM group_member WHERE memberGuid = ? AND guid = ?&quot;, CONNECTION_ASYNC);
<span class="gu">@@ -404,7 +405,7 @@ void CharacterDatabaseConnection::DoPrepareStatements()</span>
<span class="w"> </span>    PrepareStatement(CHAR_SEL_CHAR_DEL_INFO_BY_GUID, &quot;SELECT guid, deleteInfos_Name, deleteInfos_Account, deleteDate FROM characters WHERE deleteDate IS NOT NULL AND guid = ?&quot;, CONNECTION_SYNCH);
<span class="w"> </span>    PrepareStatement(CHAR_SEL_CHAR_DEL_INFO_BY_NAME, &quot;SELECT guid, deleteInfos_Name, deleteInfos_Account, deleteDate FROM characters WHERE deleteDate IS NOT NULL AND deleteInfos_Name LIKE CONCAT(&#39;%%&#39;, ?, &#39;%%&#39;)&quot;, CONNECTION_SYNCH);
<span class="w"> </span>    PrepareStatement(CHAR_SEL_CHAR_DEL_INFO, &quot;SELECT guid, deleteInfos_Name, deleteInfos_Account, deleteDate FROM characters WHERE deleteDate IS NOT NULL&quot;, CONNECTION_SYNCH);
<span class="gd">-    PrepareStatement(CHAR_SEL_CHARS_BY_ACCOUNT_ID, &quot;SELECT guid FROM characters WHERE account = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(CHAR_SEL_CHARS_BY_ACCOUNT_ID, &quot;SELECT guid, class, race FROM characters WHERE account = ?&quot;, CONNECTION_SYNCH);</span>
<span class="w"> </span>    PrepareStatement(CHAR_SEL_CHAR_PINFO, &quot;SELECT totaltime, level, money, account, race, class, map, zone, gender, health, playerFlags FROM characters WHERE guid = ?&quot;, CONNECTION_SYNCH);
<span class="w"> </span>    PrepareStatement(CHAR_SEL_PINFO_BANS, &quot;SELECT unbandate, bandate = unbandate, bannedby, banreason FROM character_banned WHERE guid = ? AND active ORDER BY bandate ASC LIMIT 1&quot;, CONNECTION_SYNCH);
<span class="w"> </span>    PrepareStatement(CHAR_SEL_PINFO_MAILS, &quot;SELECT SUM(CASE WHEN (checked &amp; 1) THEN 1 ELSE 0 END) AS &#39;readmail&#39;, COUNT(*) AS &#39;totalmail&#39; FROM mail WHERE `receiver` = ?&quot;, CONNECTION_SYNCH);
<span class="gh">diff --git a/src/server/database/Database/Implementation/CharacterDatabase.h b/src/server/database/Database/Implementation/CharacterDatabase.h</span>
<span class="gh">index 3ead3cf4031f4b..0329464f675ee5 100644</span>
<span class="gd">--- a/src/server/database/Database/Implementation/CharacterDatabase.h</span>
<span class="gi">+++ b/src/server/database/Database/Implementation/CharacterDatabase.h</span>
<span class="gu">@@ -280,6 +280,7 @@ enum CharacterDatabaseStatements : uint32</span>
<span class="w"> </span>    CHAR_UPD_PETITION_NAME,
<span class="w"> </span>    CHAR_INS_PETITION_SIGNATURE,
<span class="w"> </span>    CHAR_UPD_ACCOUNT_ONLINE,
<span class="gi">+    CHAR_UPD_CHAR_OFFLINE,</span>
<span class="w"> </span>    CHAR_INS_GROUP,
<span class="w"> </span>    CHAR_REP_GROUP_MEMBER,
<span class="w"> </span>    CHAR_DEL_GROUP_MEMBER,
<span class="gh">diff --git a/src/server/database/Database/Implementation/LoginDatabase.cpp b/src/server/database/Database/Implementation/LoginDatabase.cpp</span>
<span class="gh">index 1e091b56e45821..069abd66568c2b 100644</span>
<span class="gd">--- a/src/server/database/Database/Implementation/LoginDatabase.cpp</span>
<span class="gi">+++ b/src/server/database/Database/Implementation/LoginDatabase.cpp</span>
<span class="gu">@@ -75,6 +75,7 @@ void LoginDatabaseConnection::DoPrepareStatements()</span>
<span class="w"> </span>    PrepareStatement(LOGIN_DEL_IP_NOT_BANNED, &quot;DELETE FROM ip_banned WHERE ip = ?&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(LOGIN_INS_ACCOUNT_BANNED, &quot;INSERT INTO account_banned VALUES (?, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()+?, ?, ?, 1)&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(LOGIN_UPD_ACCOUNT_NOT_BANNED, &quot;UPDATE account_banned SET active = 0 WHERE id = ? AND active != 0&quot;, CONNECTION_ASYNC);
<span class="gi">+    PrepareStatement(LOGIN_DEL_REALM_CHARACTERS_BY_REALM, &quot;DELETE FROM realmcharacters WHERE acctid = ? AND realmid = ?&quot;, CONNECTION_ASYNC);</span>
<span class="w"> </span>    PrepareStatement(LOGIN_DEL_REALM_CHARACTERS, &quot;DELETE FROM realmcharacters WHERE acctid = ?&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(LOGIN_REP_REALM_CHARACTERS, &quot;REPLACE INTO realmcharacters (numchars, acctid, realmid) VALUES (?, ?, ?)&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(LOGIN_SEL_SUM_REALM_CHARACTERS, &quot;SELECT SUM(numchars) FROM realmcharacters WHERE acctid = ?&quot;, CONNECTION_ASYNC);
<span class="gu">@@ -89,7 +90,7 @@ void LoginDatabaseConnection::DoPrepareStatements()</span>
<span class="w"> </span>    PrepareStatement(LOGIN_UPD_MUTE_TIME_LOGIN, &quot;UPDATE account SET mutetime = ? WHERE id = ?&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(LOGIN_UPD_LAST_IP, &quot;UPDATE account SET last_ip = ? WHERE username = ?&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(LOGIN_UPD_LAST_ATTEMPT_IP, &quot;UPDATE account SET last_attempt_ip = ? WHERE username = ?&quot;, CONNECTION_ASYNC);
<span class="gd">-    PrepareStatement(LOGIN_UPD_ACCOUNT_ONLINE, &quot;UPDATE account SET online = ? WHERE id = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(LOGIN_UPD_ACCOUNT_ONLINE, &quot;UPDATE account SET online = 1 WHERE id = ?&quot;, CONNECTION_ASYNC);</span>
<span class="w"> </span>    PrepareStatement(LOGIN_UPD_UPTIME_PLAYERS, &quot;UPDATE uptime SET uptime = ?, maxplayers = ? WHERE realmid = ? AND starttime = ?&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(LOGIN_DEL_OLD_LOGS, &quot;DELETE FROM logs WHERE (time + ?) &lt; ?&quot;, CONNECTION_ASYNC);
<span class="w"> </span>    PrepareStatement(LOGIN_DEL_ACCOUNT_ACCESS, &quot;DELETE FROM account_access WHERE id = ?&quot;, CONNECTION_ASYNC);
<span class="gh">diff --git a/src/server/database/Database/Implementation/LoginDatabase.h b/src/server/database/Database/Implementation/LoginDatabase.h</span>
<span class="gh">index 563cdf3eb6fb21..4f0129782dee1e 100644</span>
<span class="gd">--- a/src/server/database/Database/Implementation/LoginDatabase.h</span>
<span class="gi">+++ b/src/server/database/Database/Implementation/LoginDatabase.h</span>
<span class="gu">@@ -59,6 +59,7 @@ enum LoginDatabaseStatements : uint32</span>
<span class="w"> </span>    LOGIN_SEL_ACCOUNT_BY_ID,
<span class="w"> </span>    LOGIN_INS_ACCOUNT_BANNED,
<span class="w"> </span>    LOGIN_UPD_ACCOUNT_NOT_BANNED,
<span class="gi">+    LOGIN_DEL_REALM_CHARACTERS_BY_REALM,</span>
<span class="w"> </span>    LOGIN_DEL_REALM_CHARACTERS,
<span class="w"> </span>    LOGIN_REP_REALM_CHARACTERS,
<span class="w"> </span>    LOGIN_SEL_SUM_REALM_CHARACTERS,
<span class="gh">diff --git a/src/server/database/Database/Implementation/PlayerbotsDatabase.cpp b/src/server/database/Database/Implementation/PlayerbotsDatabase.cpp</span>
new file mode 100644
<span class="gh">index 00000000000000..930862e04d887d</span>
<span class="gd">--- /dev/null</span>
<span class="gi">+++ b/src/server/database/Database/Implementation/PlayerbotsDatabase.cpp</span>
<span class="gu">@@ -0,0 +1,129 @@</span>
<span class="gi">+/*</span>
<span class="gi">+ * This file is part of the AzerothCore Project. See AUTHORS file for Copyright information</span>
<span class="gi">+ *</span>
<span class="gi">+ * This program is free software; you can redistribute it and/or modify</span>
<span class="gi">+ * it under the terms of the GNU General Public License as published by</span>
<span class="gi">+ * the Free Software Foundation; either version 2 of the License, or</span>
<span class="gi">+ * (at your option) any later version.</span>
<span class="gi">+ *</span>
<span class="gi">+ * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="gi">+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="gi">+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for</span>
<span class="gi">+ * more details.</span>
<span class="gi">+ *</span>
<span class="gi">+ * You should have received a copy of the GNU General Public License along</span>
<span class="gi">+ * with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="gi">+ */</span>
<span class="gi">+</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+</span>
<span class="gi">+#include &quot;PlayerbotsDatabase.h&quot;</span>
<span class="gi">+#include &quot;MySQLPreparedStatement.h&quot;</span>
<span class="gi">+</span>
<span class="gi">+void PlayerbotsDatabaseConnection::DoPrepareStatements()</span>
<span class="gi">+{</span>
<span class="gi">+    if (!m_reconnecting)</span>
<span class="gi">+        m_stmts.resize(MAX_PLAYERBOTS_STATEMENTS);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_CUSTOM_STRATEGY_BY_OWNER, &quot;SELECT DISTINCT name FROM playerbots_custom_strategy WHERE owner = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_CUSTOM_STRATEGY_BY_OWNER_AND_NAME, &quot;SELECT idx, action_line FROM playerbots_custom_strategy WHERE owner = ? AND name = ? ORDER BY idx&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_CUSTOM_STRATEGY_BY_OWNER_AND_NAME_AND_IDX, &quot;SELECT action_line FROM playerbots_custom_strategy WHERE owner = ? AND name = ? AND idx = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_CUSTOM_STRATEGY, &quot;DELETE FROM playerbots_custom_strategy WHERE name = ? AND owner = ? AND idx = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_UPD_CUSTOM_STRATEGY, &quot;UPDATE playerbots_custom_strategy SET action_line = ? WHERE name = ? AND owner = ? AND idx = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_CUSTOM_STRATEGY, &quot;INSERT INTO playerbots_custom_strategy (name, owner, idx, action_line) VALUES (?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_DB_STORE, &quot;SELECT `key`,`value` FROM `playerbots_db_store` WHERE `guid` = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_DB_STORE, &quot;DELETE FROM `playerbots_db_store` WHERE `guid` = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_DB_STORE, &quot;INSERT INTO `playerbots_db_store` (`guid`, `key`, `value`) VALUES (?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_ENCHANTS, &quot;SELECT class, spec, spellid, slotid FROM playerbots_enchants&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_EQUIP_CACHE, &quot;SELECT clazz, lvl, slot, quality, item FROM playerbots_equip_cache&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_EQUIP_CACHE, &quot;INSERT INTO playerbots_equip_cache (clazz, lvl, slot, quality, item) VALUES (?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_GUILD_TASKS_BY_VALUE, &quot;SELECT `value`, `time`, validIn FROM playerbots_guild_tasks WHERE `value` = ? AND guildid = ? AND `type` = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_GUILD_TASKS_BY_OWNER, &quot;SELECT `value`, `time`, validIn, guildid FROM playerbots_guild_tasks WHERE owner = ? AND `type` = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_GUILD_TASKS_BY_OWNER_AND_TYPE, &quot;SELECT `value`, `time`, validIn FROM playerbots_guild_tasks WHERE owner = ? AND guildid = ? AND `type` = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_GUILD_TASKS_BY_OWNER_DISTINCT, &quot;SELECT DISTINCT guildid FROM playerbots_guild_tasks WHERE owner = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_GUILD_TASKS_BY_OWNER_ORDERED, &quot;SELECT `value`, `time`, validIn, guildid FROM playerbots_guild_tasks WHERE owner = ? AND type = ? ORDER BY guildid&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_GUILD_TASKS, &quot;DELETE FROM playerbots_guild_tasks WHERE owner = ? AND guildid = ? AND `type` = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_GUILD_TASKS, &quot;INSERT INTO playerbots_guild_tasks (owner, guildid, `time`, validIn, `type`, `value`) VALUES (?, ?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_RANDOM_BOTS_VALUE, &quot;SELECT value FROM playerbots_random_bots WHERE event = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_RANDOM_BOTS_BOT, &quot;SELECT `bot` FROM playerbots_random_bots WHERE event = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_RANDOM_BOTS_BY_OWNER_AND_EVENT, &quot;SELECT bot FROM playerbots_random_bots WHERE owner = ? AND event = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_RANDOM_BOTS_BY_OWNER_AND_BOT, &quot;SELECT `event`, `value`, `time`, validIn, `data` FROM playerbots_random_bots WHERE owner = ? AND bot = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_RANDOM_BOTS_BY_EVENT_AND_VALUE, &quot;SELECT bot FROM playerbots_random_bots WHERE event = ? AND value = ?&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_RANDOM_BOTS, &quot;INSERT INTO playerbots_random_bots (owner, bot, `time`, validIn, event, `value`, `data`) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_RANDOM_BOTS, &quot;DELETE FROM playerbots_random_bots&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_RANDOM_BOTS_BY_OWNER, &quot;DELETE FROM playerbots_random_bots WHERE owner = ? AND bot = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_RANDOM_BOTS_BY_OWNER_AND_EVENT, &quot;DELETE FROM playerbots_random_bots WHERE owner = ? AND bot = ? AND event = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_UPD_RANDOM_BOTS, &quot;UPDATE playerbots_random_bots SET validIn = ? WHERE event = ? AND bot = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_RARITY_CACHE, &quot;SELECT item, rarity FROM playerbots_rarity_cache&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_RARITY_CACHE, &quot;INSERT INTO playerbots_rarity_cache (item, rarity) VALUES (?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_RNDITEM_CACHE, &quot;SELECT lvl, type, item FROM playerbots_rnditem_cache&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_RNDITEM_CACHE, &quot;INSERT INTO playerbots_rnditem_cache (lvl, type, item) VALUES (?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_SPEECH, &quot;SELECT name, text, type FROM playerbots_speech&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_SPEECH_PROBABILITY, &quot;SELECT name, probability FROM playerbots_speech_probability&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_TELE_CACHE, &quot;SELECT map_id, x, y, z, level FROM playerbots_tele_cache&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_TELE_CACHE, &quot;INSERT INTO playerbots_tele_cache (level, map_id, x, y, z) VALUES (?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_TRAVELNODE, &quot;SELECT id, name, map_id, x, y, z, linked FROM playerbots_travelnode&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_TRAVELNODE, &quot;INSERT INTO `playerbots_travelnode` (`id`, `name`, `map_id`, `x`, `y`, `z`, `linked`) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_TRAVELNODE, &quot;DELETE FROM playerbots_travelnode&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_TRAVELNODE_LINK, &quot;SELECT node_id, to_node_id,type,object,distance,swim_distance, extra_cost,calculated, max_creature_0,max_creature_1,max_creature_2 FROM playerbots_travelnode_link&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_TRAVELNODE_LINK, &quot;INSERT INTO `playerbots_travelnode_link` (`node_id`, `to_node_id`,`type`,`object`,`distance`,`swim_distance`, `extra_cost`,`calculated`, `max_creature_0`,`max_creature_1`,`max_creature_2`) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_TRAVELNODE_LINK, &quot;DELETE FROM playerbots_travelnode_link&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_TRAVELNODE_PATH, &quot;SELECT node_id, to_node_id, nr, map_id, x, y, z FROM playerbots_travelnode_path order by node_id, to_node_id, nr&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_TRAVELNODE_PATH, &quot;INSERT INTO `playerbots_travelnode_path` (`node_id`, `to_node_id`, `nr`, `map_id`, `x`, `y`, `z`) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_TRAVELNODE_PATH, &quot;DELETE FROM playerbots_travelnode_path&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_TEXT, &quot;SELECT `name`, `text`, `say_type`, `reply_type`, `text_loc1`, `text_loc2`, `text_loc3`, `text_loc4`, `text_loc5`, `text_loc6`, `text_loc7`, `text_loc8` FROM `ai_playerbot_texts`&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(</span>
<span class="gi">+        PLAYERBOTS_SEL_DUNGEON_SUGGESTION,</span>
<span class="gi">+        &quot;SELECT&quot;</span>
<span class="gi">+        &quot;   d.`name`, &quot;</span>
<span class="gi">+        &quot;   d.`difficulty`, &quot;</span>
<span class="gi">+        &quot;   d.`min_level`, &quot;</span>
<span class="gi">+        &quot;   d.`max_level`, &quot;</span>
<span class="gi">+        &quot;   a.`abbrevation`, &quot;</span>
<span class="gi">+        &quot;   s.`strategy` &quot;</span>
<span class="gi">+        &quot;FROM playerbots_dungeon_suggestion_definition d &quot;</span>
<span class="gi">+        &quot;LEFT OUTER JOIN playerbots_dungeon_suggestion_abbrevation a &quot;</span>
<span class="gi">+        &quot;   ON d.slug = a.definition_slug &quot;</span>
<span class="gi">+        &quot;LEFT OUTER JOIN playerbots_dungeon_suggestion_strategy s &quot;</span>
<span class="gi">+        &quot;   ON d.slug = s.definition_slug &quot;</span>
<span class="gi">+        &quot;   AND d.difficulty = s.difficulty &quot;</span>
<span class="gi">+        &quot;WHERE d.expansion &lt;= ?;&quot;,</span>
<span class="gi">+        CONNECTION_SYNCH</span>
<span class="gi">+    );</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_WEIGHTSCALES, &quot;SELECT id, name, class FROM playerbots_weightscales&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_SEL_WEIGHTSCALE_DATA, &quot;SELECT id, field, val FROM playerbots_weightscale_data&quot;, CONNECTION_SYNCH);</span>
<span class="gi">+</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_INS_EQUIP_CACHE_NEW, &quot;INSERT INTO playerbots_item_info_cache (id, quality, slot, source, sourceId, team, faction, factionRepRank, minLevel, &quot;</span>
<span class="gi">+            &quot;scale_1, scale_2, scale_3, scale_4, scale_5, scale_6, scale_7, scale_8, scale_9, scale_10, scale_11, scale_12, scale_13, scale_14, scale_15, &quot;</span>
<span class="gi">+            &quot;scale_16, scale_17, scale_18, scale_19, scale_20, scale_21, scale_22, scale_23, scale_24, scale_25, scale_26, scale_27, scale_28, scale_29, scale_30, scale_31, scale_32) &quot;</span>
<span class="gi">+            &quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+    PrepareStatement(PLAYERBOTS_DEL_EQUIP_CACHE_NEW, &quot;DELETE FROM playerbots_item_info_cache WHERE id = ?&quot;, CONNECTION_ASYNC);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+PlayerbotsDatabaseConnection::PlayerbotsDatabaseConnection(MySQLConnectionInfo&amp; connInfo) : MySQLConnection(connInfo)</span>
<span class="gi">+{</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+PlayerbotsDatabaseConnection::PlayerbotsDatabaseConnection(ProducerConsumerQueue&lt;SQLOperation*&gt;* q, MySQLConnectionInfo&amp; connInfo) : MySQLConnection(q, connInfo)</span>
<span class="gi">+{</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+PlayerbotsDatabaseConnection::~PlayerbotsDatabaseConnection()</span>
<span class="gi">+{</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+#endif</span>
<span class="gh">diff --git a/src/server/database/Database/Implementation/PlayerbotsDatabase.h b/src/server/database/Database/Implementation/PlayerbotsDatabase.h</span>
new file mode 100644
<span class="gh">index 00000000000000..4b826f23764555</span>
<span class="gd">--- /dev/null</span>
<span class="gi">+++ b/src/server/database/Database/Implementation/PlayerbotsDatabase.h</span>
<span class="gu">@@ -0,0 +1,120 @@</span>
<span class="gi">+/*</span>
<span class="gi">+ * This file is part of the AzerothCore Project. See AUTHORS file for Copyright information</span>
<span class="gi">+ *</span>
<span class="gi">+ * This program is free software; you can redistribute it and/or modify</span>
<span class="gi">+ * it under the terms of the GNU General Public License as published by</span>
<span class="gi">+ * the Free Software Foundation; either version 2 of the License, or</span>
<span class="gi">+ * (at your option) any later version.</span>
<span class="gi">+ *</span>
<span class="gi">+ * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="gi">+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="gi">+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for</span>
<span class="gi">+ * more details.</span>
<span class="gi">+ *</span>
<span class="gi">+ * You should have received a copy of the GNU General Public License along</span>
<span class="gi">+ * with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="gi">+ */</span>
<span class="gi">+</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+</span>
<span class="gi">+#ifndef _PlayerbotsDatabase_H</span>
<span class="gi">+#define _PlayerbotsDatabase_H</span>
<span class="gi">+</span>
<span class="gi">+#include &quot;MySQLConnection.h&quot;</span>
<span class="gi">+</span>
<span class="gi">+enum PlayerbotsDatabaseStatements : uint32</span>
<span class="gi">+{</span>
<span class="gi">+    /*  Naming standard for defines:</span>
<span class="gi">+        {DB}_{SEL/INS/UPD/DEL/REP}_{Summary of data changed}</span>
<span class="gi">+        When updating more than one field, consider looking at the calling function</span>
<span class="gi">+        name for a suiting suffix.</span>
<span class="gi">+    */</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_CUSTOM_STRATEGY_BY_OWNER,</span>
<span class="gi">+    PLAYERBOTS_SEL_CUSTOM_STRATEGY_BY_OWNER_AND_NAME,</span>
<span class="gi">+    PLAYERBOTS_SEL_CUSTOM_STRATEGY_BY_OWNER_AND_NAME_AND_IDX,</span>
<span class="gi">+    PLAYERBOTS_DEL_CUSTOM_STRATEGY,</span>
<span class="gi">+    PLAYERBOTS_UPD_CUSTOM_STRATEGY,</span>
<span class="gi">+    PLAYERBOTS_INS_CUSTOM_STRATEGY,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_DB_STORE,</span>
<span class="gi">+    PLAYERBOTS_DEL_DB_STORE,</span>
<span class="gi">+    PLAYERBOTS_INS_DB_STORE,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_ENCHANTS,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_EQUIP_CACHE,</span>
<span class="gi">+    PLAYERBOTS_INS_EQUIP_CACHE,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_GUILD_TASKS_BY_VALUE,</span>
<span class="gi">+    PLAYERBOTS_SEL_GUILD_TASKS_BY_OWNER,</span>
<span class="gi">+    PLAYERBOTS_SEL_GUILD_TASKS_BY_OWNER_AND_TYPE,</span>
<span class="gi">+    PLAYERBOTS_SEL_GUILD_TASKS_BY_OWNER_DISTINCT,</span>
<span class="gi">+    PLAYERBOTS_SEL_GUILD_TASKS_BY_OWNER_ORDERED,</span>
<span class="gi">+    PLAYERBOTS_DEL_GUILD_TASKS,</span>
<span class="gi">+    PLAYERBOTS_INS_GUILD_TASKS,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_RANDOM_BOTS_VALUE,</span>
<span class="gi">+    PLAYERBOTS_SEL_RANDOM_BOTS_BOT,</span>
<span class="gi">+    PLAYERBOTS_SEL_RANDOM_BOTS_BY_OWNER_AND_EVENT,</span>
<span class="gi">+    PLAYERBOTS_SEL_RANDOM_BOTS_BY_OWNER_AND_BOT,</span>
<span class="gi">+    PLAYERBOTS_SEL_RANDOM_BOTS_BY_EVENT_AND_VALUE,</span>
<span class="gi">+    PLAYERBOTS_INS_RANDOM_BOTS,</span>
<span class="gi">+    PLAYERBOTS_DEL_RANDOM_BOTS,</span>
<span class="gi">+    PLAYERBOTS_DEL_RANDOM_BOTS_BY_OWNER,</span>
<span class="gi">+    PLAYERBOTS_DEL_RANDOM_BOTS_BY_OWNER_AND_EVENT,</span>
<span class="gi">+    PLAYERBOTS_UPD_RANDOM_BOTS,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_RARITY_CACHE,</span>
<span class="gi">+    PLAYERBOTS_INS_RARITY_CACHE,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_RNDITEM_CACHE,</span>
<span class="gi">+    PLAYERBOTS_INS_RNDITEM_CACHE,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_SPEECH,</span>
<span class="gi">+    PLAYERBOTS_SEL_SPEECH_PROBABILITY,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_TELE_CACHE,</span>
<span class="gi">+    PLAYERBOTS_INS_TELE_CACHE,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_TEXT,</span>
<span class="gi">+    PLAYERBOTS_SEL_DUNGEON_SUGGESTION,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_TRAVELNODE,</span>
<span class="gi">+    PLAYERBOTS_INS_TRAVELNODE,</span>
<span class="gi">+    PLAYERBOTS_DEL_TRAVELNODE,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_TRAVELNODE_LINK,</span>
<span class="gi">+    PLAYERBOTS_INS_TRAVELNODE_LINK,</span>
<span class="gi">+    PLAYERBOTS_DEL_TRAVELNODE_LINK,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_TRAVELNODE_PATH,</span>
<span class="gi">+    PLAYERBOTS_INS_TRAVELNODE_PATH,</span>
<span class="gi">+    PLAYERBOTS_DEL_TRAVELNODE_PATH,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_SEL_WEIGHTSCALES,</span>
<span class="gi">+    PLAYERBOTS_SEL_WEIGHTSCALE_DATA,</span>
<span class="gi">+</span>
<span class="gi">+    PLAYERBOTS_INS_EQUIP_CACHE_NEW,</span>
<span class="gi">+    PLAYERBOTS_DEL_EQUIP_CACHE_NEW,</span>
<span class="gi">+</span>
<span class="gi">+    MAX_PLAYERBOTS_STATEMENTS</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+class AC_DATABASE_API PlayerbotsDatabaseConnection : public MySQLConnection</span>
<span class="gi">+{</span>
<span class="gi">+public:</span>
<span class="gi">+    typedef PlayerbotsDatabaseStatements Statements;</span>
<span class="gi">+</span>
<span class="gi">+    //- Constructors for sync and async connections</span>
<span class="gi">+    PlayerbotsDatabaseConnection(MySQLConnectionInfo&amp; connInfo);</span>
<span class="gi">+    PlayerbotsDatabaseConnection(ProducerConsumerQueue&lt;SQLOperation*&gt;* q, MySQLConnectionInfo&amp; connInfo);</span>
<span class="gi">+    ~PlayerbotsDatabaseConnection();</span>
<span class="gi">+</span>
<span class="gi">+    //- Loads database type specific prepared statements</span>
<span class="gi">+    void DoPrepareStatements() override;</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="gi">+#endif</span>
<span class="gh">diff --git a/src/server/database/Updater/DBUpdater.cpp b/src/server/database/Updater/DBUpdater.cpp</span>
<span class="gh">index 4e06beb48c6fd9..a583a33a3281f7 100644</span>
<span class="gd">--- a/src/server/database/Updater/DBUpdater.cpp</span>
<span class="gi">+++ b/src/server/database/Updater/DBUpdater.cpp</span>
<span class="gu">@@ -77,10 +77,16 @@ std::string DBUpdater&lt;LoginDatabaseConnection&gt;::GetTableName()</span>
<span class="w"> </span>    return &quot;Auth&quot;;
<span class="w"> </span>}

<span class="gi">+template&lt;&gt;</span>
<span class="gi">+std::string DBUpdater&lt;LoginDatabaseConnection&gt;::GetSourceDirectory()</span>
<span class="gi">+{</span>
<span class="gi">+    return BuiltInConfig::GetSourceDirectory();</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>template&lt;&gt;
<span class="w"> </span>std::string DBUpdater&lt;LoginDatabaseConnection&gt;::GetBaseFilesDirectory()
<span class="w"> </span>{
<span class="gd">-    return BuiltInConfig::GetSourceDirectory() + &quot;/data/sql/base/db_auth/&quot;;</span>
<span class="gi">+    return DBUpdater&lt;LoginDatabaseConnection&gt;::GetSourceDirectory() + &quot;/data/sql/base/db_auth/&quot;;</span>
<span class="w"> </span>}

<span class="w"> </span>template&lt;&gt;
<span class="gu">@@ -93,7 +99,7 @@ bool DBUpdater&lt;LoginDatabaseConnection&gt;::IsEnabled(uint32 const updateMask)</span>
<span class="w"> </span>template&lt;&gt;
<span class="w"> </span>std::string DBUpdater&lt;LoginDatabaseConnection&gt;::GetDBModuleName()
<span class="w"> </span>{
<span class="gd">-    return &quot;db-auth&quot;;</span>
<span class="gi">+    return &quot;auth&quot;;</span>
<span class="w"> </span>}

<span class="w"> </span>// World Database
<span class="gu">@@ -109,10 +115,16 @@ std::string DBUpdater&lt;WorldDatabaseConnection&gt;::GetTableName()</span>
<span class="w"> </span>    return &quot;World&quot;;
<span class="w"> </span>}

<span class="gi">+template&lt;&gt;</span>
<span class="gi">+std::string DBUpdater&lt;WorldDatabaseConnection&gt;::GetSourceDirectory()</span>
<span class="gi">+{</span>
<span class="gi">+    return BuiltInConfig::GetSourceDirectory();</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>template&lt;&gt;
<span class="w"> </span>std::string DBUpdater&lt;WorldDatabaseConnection&gt;::GetBaseFilesDirectory()
<span class="w"> </span>{
<span class="gd">-    return BuiltInConfig::GetSourceDirectory() + &quot;/data/sql/base/db_world/&quot;;</span>
<span class="gi">+    return DBUpdater&lt;WorldDatabaseConnection&gt;::GetSourceDirectory() + &quot;/data/sql/base/db_world/&quot;;</span>
<span class="w"> </span>}

<span class="w"> </span>template&lt;&gt;
<span class="gu">@@ -125,7 +137,7 @@ bool DBUpdater&lt;WorldDatabaseConnection&gt;::IsEnabled(uint32 const updateMask)</span>
<span class="w"> </span>template&lt;&gt;
<span class="w"> </span>std::string DBUpdater&lt;WorldDatabaseConnection&gt;::GetDBModuleName()
<span class="w"> </span>{
<span class="gd">-    return &quot;db-world&quot;;</span>
<span class="gi">+    return &quot;world&quot;;</span>
<span class="w"> </span>}

<span class="w"> </span>// Character Database
<span class="gu">@@ -141,10 +153,16 @@ std::string DBUpdater&lt;CharacterDatabaseConnection&gt;::GetTableName()</span>
<span class="w"> </span>    return &quot;Character&quot;;
<span class="w"> </span>}

<span class="gi">+template&lt;&gt;</span>
<span class="gi">+std::string DBUpdater&lt;CharacterDatabaseConnection&gt;::GetSourceDirectory()</span>
<span class="gi">+{</span>
<span class="gi">+    return BuiltInConfig::GetSourceDirectory();</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>template&lt;&gt;
<span class="w"> </span>std::string DBUpdater&lt;CharacterDatabaseConnection&gt;::GetBaseFilesDirectory()
<span class="w"> </span>{
<span class="gd">-    return BuiltInConfig::GetSourceDirectory() + &quot;/data/sql/base/db_characters/&quot;;</span>
<span class="gi">+    return DBUpdater&lt;CharacterDatabaseConnection&gt;::GetSourceDirectory() + &quot;/data/sql/base/db_characters/&quot;;</span>
<span class="w"> </span>}

<span class="w"> </span>template&lt;&gt;
<span class="gu">@@ -157,9 +175,49 @@ bool DBUpdater&lt;CharacterDatabaseConnection&gt;::IsEnabled(uint32 const updateMask)</span>
<span class="w"> </span>template&lt;&gt;
<span class="w"> </span>std::string DBUpdater&lt;CharacterDatabaseConnection&gt;::GetDBModuleName()
<span class="w"> </span>{
<span class="gd">-    return &quot;db-characters&quot;;</span>
<span class="gi">+    return &quot;characters&quot;;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+// Playerbots Database</span>
<span class="gi">+template&lt;&gt;</span>
<span class="gi">+std::string DBUpdater&lt;PlayerbotsDatabaseConnection&gt;::GetConfigEntry()</span>
<span class="gi">+{</span>
<span class="gi">+    return &quot;Updates.Playerbots&quot;;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+template&lt;&gt;</span>
<span class="gi">+std::string DBUpdater&lt;PlayerbotsDatabaseConnection&gt;::GetTableName()</span>
<span class="gi">+{</span>
<span class="gi">+    return &quot;Playerbots&quot;;</span>
<span class="w"> </span>}

<span class="gi">+template&lt;&gt;</span>
<span class="gi">+std::string DBUpdater&lt;PlayerbotsDatabaseConnection&gt;::GetSourceDirectory()</span>
<span class="gi">+{</span>
<span class="gi">+    return BuiltInConfig::GetSourceDirectory() + &quot;/modules/mod-playerbots&quot;;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+template&lt;&gt;</span>
<span class="gi">+std::string DBUpdater&lt;PlayerbotsDatabaseConnection&gt;::GetBaseFilesDirectory()</span>
<span class="gi">+{</span>
<span class="gi">+    return DBUpdater&lt;PlayerbotsDatabaseConnection&gt;::GetSourceDirectory() + &quot;/data/sql/playerbots/base/&quot;;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+template&lt;&gt;</span>
<span class="gi">+bool DBUpdater&lt;PlayerbotsDatabaseConnection&gt;::IsEnabled(uint32 const updateMask)</span>
<span class="gi">+{</span>
<span class="gi">+    // This way silences warnings under msvc</span>
<span class="gi">+    return (updateMask &amp; DatabaseLoader::DATABASE_PLAYERBOTS) ? true : false;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+template&lt;&gt;</span>
<span class="gi">+std::string DBUpdater&lt;PlayerbotsDatabaseConnection&gt;::GetDBModuleName()</span>
<span class="gi">+{</span>
<span class="gi">+    return &quot;db_playerbot&quot;;</span>
<span class="gi">+}</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>// All
<span class="w"> </span>template&lt;class T&gt;
<span class="w"> </span>BaseLocation DBUpdater&lt;T&gt;::GetBaseLocationType()
<span class="gu">@@ -225,7 +283,7 @@ bool DBUpdater&lt;T&gt;::Update(DatabaseWorkerPool&lt;T&gt;&amp; pool, std::string_view modulesL</span>

<span class="w"> </span>    LOG_INFO(&quot;sql.updates&quot;, &quot;Updating {} database...&quot;, DBUpdater&lt;T&gt;::GetTableName());

<span class="gd">-    Path const sourceDirectory(BuiltInConfig::GetSourceDirectory());</span>
<span class="gi">+    Path const sourceDirectory(DBUpdater&lt;T&gt;::GetSourceDirectory());</span>

<span class="w"> </span>    if (!is_directory(sourceDirectory))
<span class="w"> </span>    {
<span class="gu">@@ -300,7 +358,7 @@ bool DBUpdater&lt;T&gt;::Update(DatabaseWorkerPool&lt;T&gt;&amp; pool, std::vector&lt;std::string&gt;</span>
<span class="w"> </span>        return false;
<span class="w"> </span>    }

<span class="gd">-    Path const sourceDirectory(BuiltInConfig::GetSourceDirectory());</span>
<span class="gi">+    Path const sourceDirectory(DBUpdater&lt;T&gt;::GetSourceDirectory());</span>
<span class="w"> </span>    if (!is_directory(sourceDirectory))
<span class="w"> </span>    {
<span class="w"> </span>        return false;
<span class="gu">@@ -534,3 +592,7 @@ void DBUpdater&lt;T&gt;::ApplyFile(DatabaseWorkerPool&lt;T&gt;&amp; pool, std::string const&amp; hos</span>
<span class="w"> </span>template class AC_DATABASE_API DBUpdater&lt;LoginDatabaseConnection&gt;;
<span class="w"> </span>template class AC_DATABASE_API DBUpdater&lt;WorldDatabaseConnection&gt;;
<span class="w"> </span>template class AC_DATABASE_API DBUpdater&lt;CharacterDatabaseConnection&gt;;
<span class="gi">+</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+template class AC_DATABASE_API DBUpdater&lt;PlayerbotsDatabaseConnection&gt;;</span>
<span class="gi">+#endif</span>
<span class="gh">diff --git a/src/server/database/Updater/DBUpdater.h b/src/server/database/Updater/DBUpdater.h</span>
<span class="gh">index 58ebf332018376..3a0e58709ea692 100644</span>
<span class="gd">--- a/src/server/database/Updater/DBUpdater.h</span>
<span class="gi">+++ b/src/server/database/Updater/DBUpdater.h</span>
<span class="gu">@@ -72,6 +72,7 @@ class AC_DATABASE_API DBUpdater</span>

<span class="w"> </span>    static inline std::string GetConfigEntry();
<span class="w"> </span>    static inline std::string GetTableName();
<span class="gi">+    static std::string GetSourceDirectory();</span>
<span class="w"> </span>    static std::string GetBaseFilesDirectory();
<span class="w"> </span>    static bool IsEnabled(uint32 const updateMask);
<span class="w"> </span>    static BaseLocation GetBaseLocationType();
<span class="gh">diff --git a/src/server/game/Battlegrounds/ArenaTeam.cpp b/src/server/game/Battlegrounds/ArenaTeam.cpp</span>
<span class="gh">index 985193f9d54952..0e4dd3fde0069d 100644</span>
<span class="gd">--- a/src/server/game/Battlegrounds/ArenaTeam.cpp</span>
<span class="gi">+++ b/src/server/game/Battlegrounds/ArenaTeam.cpp</span>
<span class="gu">@@ -1103,3 +1103,22 @@ std::unordered_map&lt;uint8, uint8&gt; ArenaTeam::ArenaReqPlayersForType =</span>
<span class="w"> </span>    { ARENA_TYPE_3v3, 6},
<span class="w"> </span>    { ARENA_TYPE_5v5, 10}
<span class="w"> </span>};
<span class="gi">+</span>
<span class="gi">+void ArenaTeam::SetEmblem(uint32 backgroundColor, uint8 emblemStyle, uint32 emblemColor, uint8 borderStyle, uint32 borderColor)</span>
<span class="gi">+{</span>
<span class="gi">+    BackgroundColor = backgroundColor;</span>
<span class="gi">+    EmblemStyle = emblemStyle;</span>
<span class="gi">+    EmblemColor = emblemColor;</span>
<span class="gi">+    BorderStyle = borderStyle;</span>
<span class="gi">+    BorderColor = borderColor;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ArenaTeam::SetRatingForAll(uint32 rating)</span>
<span class="gi">+{</span>
<span class="gi">+    Stats.Rating = rating;</span>
<span class="gi">+</span>
<span class="gi">+    for (MemberList::iterator itr = Members.begin(); itr != Members.end(); ++itr)</span>
<span class="gi">+    {</span>
<span class="gi">+        itr-&gt;PersonalRating = rating;</span>
<span class="gi">+    }</span>
<span class="gi">+}</span>
<span class="gh">diff --git a/src/server/game/Battlegrounds/ArenaTeam.h b/src/server/game/Battlegrounds/ArenaTeam.h</span>
<span class="gh">index 33c47920e28159..a0ec07397b133d 100644</span>
<span class="gd">--- a/src/server/game/Battlegrounds/ArenaTeam.h</span>
<span class="gi">+++ b/src/server/game/Battlegrounds/ArenaTeam.h</span>
<span class="gu">@@ -217,6 +217,10 @@ class ArenaTeam</span>
<span class="w"> </span>    static std::unordered_map&lt;uint32, uint8&gt; ArenaSlotByType; // Slot -&gt; Type
<span class="w"> </span>    static std::unordered_map&lt;uint8, uint8&gt; ArenaReqPlayersForType; // Type -&gt; Players count

<span class="gi">+    void SetEmblem(uint32 backgroundColor, uint8 emblemStyle, uint32 emblemColor, uint8 borderStyle, uint32 borderColor);</span>
<span class="gi">+    void SetRatingForAll(uint32 rating);</span>
<span class="gi">+</span>
<span class="gi">+</span>
<span class="w"> </span>protected:
<span class="w"> </span>    uint32      TeamId;
<span class="w"> </span>    uint8       Type;
<span class="gh">diff --git a/src/server/game/Battlegrounds/Battleground.h b/src/server/game/Battlegrounds/Battleground.h</span>
<span class="gh">index b22cdc143adccb..6178869f547f1c 100644</span>
<span class="gd">--- a/src/server/game/Battlegrounds/Battleground.h</span>
<span class="gi">+++ b/src/server/game/Battlegrounds/Battleground.h</span>
<span class="gu">@@ -205,6 +205,7 @@ struct BattlegroundObjectInfo</span>

<span class="w"> </span>enum ArenaType : uint8
<span class="w"> </span>{
<span class="gi">+    ARENA_TYPE_NONE                 = 0,</span>
<span class="w"> </span>    ARENA_TYPE_2v2                  = 2,
<span class="w"> </span>    ARENA_TYPE_3v3                  = 3,
<span class="w"> </span>    ARENA_TYPE_5v5                  = 5
<span class="gh">diff --git a/src/server/game/Battlegrounds/Zones/BattlegroundAB.h b/src/server/game/Battlegrounds/Zones/BattlegroundAB.h</span>
<span class="gh">index 72932386a1587b..92e58975e23e7b 100644</span>
<span class="gd">--- a/src/server/game/Battlegrounds/Zones/BattlegroundAB.h</span>
<span class="gi">+++ b/src/server/game/Battlegrounds/Zones/BattlegroundAB.h</span>
<span class="gu">@@ -246,6 +246,18 @@ struct BattlegroundABScore final : public BattlegroundScore</span>
<span class="w"> </span>    uint32 BasesDefended = 0;
<span class="w"> </span>};

<span class="gi">+struct CaptureABPointInfo</span>
<span class="gi">+{</span>
<span class="gi">+    CaptureABPointInfo() : _ownerTeamId(TEAM_NEUTRAL), _iconNone(0), _iconCapture(0), _state(BG_AB_NODE_STATE_NEUTRAL), _captured(false) {}</span>
<span class="gi">+</span>
<span class="gi">+    TeamId _ownerTeamId;</span>
<span class="gi">+    uint32 _iconNone;</span>
<span class="gi">+    uint32 _iconCapture;</span>
<span class="gi">+    uint8  _state;</span>
<span class="gi">+</span>
<span class="gi">+    bool _captured;</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="w"> </span>class AC_GAME_API BattlegroundAB : public Battleground
<span class="w"> </span>{
<span class="w"> </span>public:
<span class="gu">@@ -270,6 +282,9 @@ class AC_GAME_API BattlegroundAB : public Battleground</span>
<span class="w"> </span>    bool IsTeamScores500Disadvantage(TeamId teamId) const { return _teamScores500Disadvantage[teamId]; }

<span class="w"> </span>    TeamId GetPrematureWinner() override;
<span class="gi">+</span>
<span class="gi">+    [[nodiscard]] CaptureABPointInfo const&amp; GetCapturePointInfo(uint32 node) const { return _capturePointInfo[node]; }</span>
<span class="gi">+</span>
<span class="w"> </span>private:
<span class="w"> </span>    void PostUpdateImpl(uint32 diff) override;

<span class="gu">@@ -280,21 +295,7 @@ class AC_GAME_API BattlegroundAB : public Battleground</span>
<span class="w"> </span>    void NodeDeoccupied(uint8 node);
<span class="w"> </span>    void ApplyPhaseMask();

<span class="gd">-    struct CapturePointInfo</span>
<span class="gd">-    {</span>
<span class="gd">-        CapturePointInfo() : _ownerTeamId(TEAM_NEUTRAL), _iconNone(0), _iconCapture(0), _state(BG_AB_NODE_STATE_NEUTRAL), _captured(false)</span>
<span class="gd">-        {</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="gd">-        TeamId _ownerTeamId;</span>
<span class="gd">-        uint32 _iconNone;</span>
<span class="gd">-        uint32 _iconCapture;</span>
<span class="gd">-        uint8 _state;</span>
<span class="gd">-</span>
<span class="gd">-        bool _captured;</span>
<span class="gd">-    };</span>
<span class="gd">-</span>
<span class="gd">-    CapturePointInfo _capturePointInfo[BG_AB_DYNAMIC_NODES_COUNT];</span>
<span class="gi">+    CaptureABPointInfo _capturePointInfo[BG_AB_DYNAMIC_NODES_COUNT];</span>
<span class="w"> </span>    EventMap _bgEvents;
<span class="w"> </span>    uint32 _honorTics;
<span class="w"> </span>    uint32 _reputationTics;
<span class="gh">diff --git a/src/server/game/Battlegrounds/Zones/BattlegroundAV.h b/src/server/game/Battlegrounds/Zones/BattlegroundAV.h</span>
<span class="gh">index 57417dd1db3d46..eec6ff05874d94 100644</span>
<span class="gd">--- a/src/server/game/Battlegrounds/Zones/BattlegroundAV.h</span>
<span class="gi">+++ b/src/server/game/Battlegrounds/Zones/BattlegroundAV.h</span>
<span class="gu">@@ -1791,6 +1791,10 @@ class AC_GAME_API BattlegroundAV : public Battleground</span>

<span class="w"> </span>    TeamId GetPrematureWinner() override;

<span class="gi">+    [[nodiscard]] BG_AV_NodeInfo const&amp; GetAVNodeInfo(uint32 node) const { return m_Nodes[node]; }</span>
<span class="gi">+    [[nodiscard]] bool IsCaptainAlive(uint8 index) const { return m_CaptainAlive[index]; }</span>
<span class="gi">+    [[nodiscard]] TeamId GetMineOwner(uint8 index) const { return m_Mine_Owner[index]; }</span>
<span class="gi">+</span>
<span class="w"> </span>private:
<span class="w"> </span>    void PostUpdateImpl(uint32 diff) override;

<span class="gh">diff --git a/src/server/game/Battlegrounds/Zones/BattlegroundEY.h b/src/server/game/Battlegrounds/Zones/BattlegroundEY.h</span>
<span class="gh">index 2730a060411690..b4da9d7f53fea6 100644</span>
<span class="gd">--- a/src/server/game/Battlegrounds/Zones/BattlegroundEY.h</span>
<span class="gi">+++ b/src/server/game/Battlegrounds/Zones/BattlegroundEY.h</span>
<span class="gu">@@ -346,6 +346,25 @@ struct BattlegroundEYScore final : public BattlegroundScore</span>
<span class="w"> </span>    uint32 FlagCaptures = 0;
<span class="w"> </span>};

<span class="gi">+struct CaptureEYPointInfo</span>
<span class="gi">+{</span>
<span class="gi">+    CaptureEYPointInfo() : _ownerTeamId(TEAM_NEUTRAL), _barStatus(BG_EY_PROGRESS_BAR_STATE_MIDDLE), _areaTrigger(0)</span>
<span class="gi">+    {</span>
<span class="gi">+        _playersCount[TEAM_ALLIANCE] = 0;</span>
<span class="gi">+        _playersCount[TEAM_HORDE] = 0;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    Player* player = nullptr;</span>
<span class="gi">+    TeamId _ownerTeamId;</span>
<span class="gi">+    int8 _barStatus;</span>
<span class="gi">+    uint32 _areaTrigger;</span>
<span class="gi">+    int8 _playersCount[PVP_TEAMS_COUNT];</span>
<span class="gi">+</span>
<span class="gi">+    bool IsUnderControl(TeamId teamId) const { return _ownerTeamId == teamId; }</span>
<span class="gi">+    bool IsUnderControl() const { return _ownerTeamId != TEAM_NEUTRAL; }</span>
<span class="gi">+    bool IsUncontrolled() const { return _ownerTeamId == TEAM_NEUTRAL; }</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="w"> </span>class AC_GAME_API BattlegroundEY : public Battleground
<span class="w"> </span>{
<span class="w"> </span>public:
<span class="gu">@@ -385,6 +404,8 @@ class AC_GAME_API BattlegroundEY : public Battleground</span>
<span class="w"> </span>    bool AllNodesConrolledByTeam(TeamId teamId) const override;
<span class="w"> </span>    TeamId GetPrematureWinner() override;

<span class="gi">+    [[nodiscard]] CaptureEYPointInfo const&amp; GetCapturePointInfo(uint32 node) const { return _capturePointInfo[node]; }</span>
<span class="gi">+</span>
<span class="w"> </span>private:
<span class="w"> </span>    void PostUpdateImpl(uint32 diff) override;

<span class="gu">@@ -400,26 +421,7 @@ class AC_GAME_API BattlegroundEY : public Battleground</span>
<span class="w"> </span>    /* Scorekeeping */
<span class="w"> </span>    void AddPoints(TeamId teamId, uint32 points);

<span class="gd">-    struct CapturePointInfo</span>
<span class="gd">-    {</span>
<span class="gd">-        CapturePointInfo() : _ownerTeamId(TEAM_NEUTRAL), _barStatus(BG_EY_PROGRESS_BAR_STATE_MIDDLE), _areaTrigger(0)</span>
<span class="gd">-        {</span>
<span class="gd">-            _playersCount[TEAM_ALLIANCE] = 0;</span>
<span class="gd">-            _playersCount[TEAM_HORDE] = 0;</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="gd">-        TeamId _ownerTeamId;</span>
<span class="gd">-        int8 _barStatus;</span>
<span class="gd">-        uint32 _areaTrigger;</span>
<span class="gd">-        int8 _playersCount[PVP_TEAMS_COUNT];</span>
<span class="gd">-        Player* player = nullptr;</span>
<span class="gd">-</span>
<span class="gd">-        bool IsUnderControl(TeamId teamId) const { return _ownerTeamId == teamId; }</span>
<span class="gd">-        bool IsUnderControl() const { return _ownerTeamId != TEAM_NEUTRAL; }</span>
<span class="gd">-        bool IsUncontrolled() const { return _ownerTeamId == TEAM_NEUTRAL; }</span>
<span class="gd">-    };</span>
<span class="gd">-</span>
<span class="gd">-    CapturePointInfo _capturePointInfo[EY_POINTS_MAX];</span>
<span class="gi">+    CaptureEYPointInfo _capturePointInfo[EY_POINTS_MAX];</span>
<span class="w"> </span>    EventMap _bgEvents;
<span class="w"> </span>    uint32 _honorTics;
<span class="w"> </span>    uint8 _ownedPointsCount[PVP_TEAMS_COUNT];
<span class="gh">diff --git a/src/server/game/Battlegrounds/Zones/BattlegroundIC.h b/src/server/game/Battlegrounds/Zones/BattlegroundIC.h</span>
<span class="gh">index 9f859ddfe07a06..bc5daf8fc925a8 100644</span>
<span class="gd">--- a/src/server/game/Battlegrounds/Zones/BattlegroundIC.h</span>
<span class="gi">+++ b/src/server/game/Battlegrounds/Zones/BattlegroundIC.h</span>
<span class="gu">@@ -922,6 +922,9 @@ class AC_GAME_API BattlegroundIC : public Battleground</span>
<span class="w"> </span>    bool AllNodesConrolledByTeam(TeamId teamId) const override;  // overwrited
<span class="w"> </span>    bool IsResourceGlutAllowed(TeamId teamId) const;
<span class="w"> </span>    void DoAction(uint32 action, ObjectGuid guid) override;
<span class="gi">+</span>
<span class="gi">+    [[nodiscard]] ICNodePoint const&amp; GetICNodePoint(uint8 index) { return nodePoint[index]; }</span>
<span class="gi">+</span>
<span class="w"> </span>private:
<span class="w"> </span>    uint32 closeFortressDoorsTimer;
<span class="w"> </span>    bool doorsClosed;
<span class="gh">diff --git a/src/server/game/Chat/Channels/ChannelMgr.h b/src/server/game/Chat/Channels/ChannelMgr.h</span>
<span class="gh">index daf595d2f6071f..868f2a1717e1f8 100644</span>
<span class="gd">--- a/src/server/game/Chat/Channels/ChannelMgr.h</span>
<span class="gi">+++ b/src/server/game/Chat/Channels/ChannelMgr.h</span>
<span class="gu">@@ -40,6 +40,7 @@ class ChannelMgr</span>

<span class="w"> </span>    Channel* GetJoinChannel(std::string const&amp; name, uint32 channel_id);
<span class="w"> </span>    Channel* GetChannel(std::string const&amp; name, Player* p, bool pkt = true);
<span class="gi">+    const ChannelMap&amp; GetChannels() const { return channels; }</span>
<span class="w"> </span>    static void LoadChannels();

<span class="w"> </span>    static void LoadChannelRights();
<span class="gh">diff --git a/src/server/game/Chat/Chat.cpp b/src/server/game/Chat/Chat.cpp</span>
<span class="gh">index a0dc7f090d9682..33892e072d837f 100644</span>
<span class="gd">--- a/src/server/game/Chat/Chat.cpp</span>
<span class="gi">+++ b/src/server/game/Chat/Chat.cpp</span>
<span class="gu">@@ -371,6 +371,78 @@ std::size_t ChatHandler::BuildChatPacket(WorldPacket&amp; data, ChatMsg chatType, La</span>
<span class="w"> </span>    return BuildChatPacket(data, chatType, language, senderGUID, receiverGUID, message, chatTag, senderName, receiverName, achievementId, gmMessage, channelName);
<span class="w"> </span>}

<span class="gi">+void ChatHandler::BuildChatPacket(WorldPacket&amp; data, ChatMsg msgtype, std::string_view message, Language language /*= LANG_UNIVERSAL*/, PlayerChatTag chatTag /*= CHAT_TAG_NONE*/,</span>
<span class="gi">+                                  ObjectGuid const&amp; senderGuid /*= ObjectGuid()*/, std::string_view senderName /*= nullptr*/,</span>
<span class="gi">+                                  ObjectGuid const&amp; targetGuid /*= ObjectGuid()*/, std::string_view targetName /*= nullptr*/,</span>
<span class="gi">+                                  std::string_view channelName /*= nullptr*/, uint32 achievementId /*= 0*/)</span>
<span class="gi">+{</span>
<span class="gi">+    const bool isGM = (chatTag &amp; CHAT_TAG_GM) != 0;</span>
<span class="gi">+    bool isAchievement = false;</span>
<span class="gi">+</span>
<span class="gi">+    data.Initialize((isGM &amp;&amp; language != LANG_ADDON) ? SMSG_GM_MESSAGECHAT : SMSG_MESSAGECHAT);</span>
<span class="gi">+    data &lt;&lt; uint8(msgtype);</span>
<span class="gi">+    data &lt;&lt; uint32(language);</span>
<span class="gi">+    data &lt;&lt; ObjectGuid(senderGuid);</span>
<span class="gi">+    data &lt;&lt; uint32(0);                                              // 2.1.0</span>
<span class="gi">+</span>
<span class="gi">+    switch (msgtype)</span>
<span class="gi">+    {</span>
<span class="gi">+        case CHAT_MSG_MONSTER_SAY:</span>
<span class="gi">+        case CHAT_MSG_MONSTER_PARTY:</span>
<span class="gi">+        case CHAT_MSG_MONSTER_YELL:</span>
<span class="gi">+        case CHAT_MSG_MONSTER_WHISPER:</span>
<span class="gi">+        case CHAT_MSG_MONSTER_EMOTE:</span>
<span class="gi">+        case CHAT_MSG_RAID_BOSS_WHISPER:</span>
<span class="gi">+        case CHAT_MSG_RAID_BOSS_EMOTE:</span>
<span class="gi">+        case CHAT_MSG_BATTLENET:</span>
<span class="gi">+        case CHAT_MSG_WHISPER_FOREIGN:</span>
<span class="gi">+            data &lt;&lt; uint32(senderName.size() + 1);</span>
<span class="gi">+            data &lt;&lt; senderName;</span>
<span class="gi">+            data &lt;&lt; ObjectGuid(targetGuid);                         // Unit Target</span>
<span class="gi">+            if (targetGuid &amp;&amp; !targetGuid.IsPlayer() &amp;&amp; !targetGuid.IsPet() &amp;&amp; (msgtype != CHAT_MSG_WHISPER_FOREIGN))</span>
<span class="gi">+            {</span>
<span class="gi">+                data &lt;&lt; uint32(targetName.size() + 1);              // target name length</span>
<span class="gi">+                data &lt;&lt; targetName;                                 // target name</span>
<span class="gi">+            }</span>
<span class="gi">+            break;</span>
<span class="gi">+        case CHAT_MSG_BG_SYSTEM_NEUTRAL:</span>
<span class="gi">+        case CHAT_MSG_BG_SYSTEM_ALLIANCE:</span>
<span class="gi">+        case CHAT_MSG_BG_SYSTEM_HORDE:</span>
<span class="gi">+            data &lt;&lt; ObjectGuid(targetGuid);                         // Unit Target</span>
<span class="gi">+            if (targetGuid &amp;&amp; !targetGuid.IsPlayer())</span>
<span class="gi">+            {</span>
<span class="gi">+                data &lt;&lt; uint32(targetName.size() + 1);              // target name length</span>
<span class="gi">+                data &lt;&lt; targetName;                                 // target name</span>
<span class="gi">+            }</span>
<span class="gi">+            break;</span>
<span class="gi">+        case CHAT_MSG_ACHIEVEMENT:</span>
<span class="gi">+        case CHAT_MSG_GUILD_ACHIEVEMENT:</span>
<span class="gi">+            data &lt;&lt; ObjectGuid(targetGuid);                         // Unit Target</span>
<span class="gi">+            isAchievement = true;</span>
<span class="gi">+            break;</span>
<span class="gi">+        default:</span>
<span class="gi">+            if (isGM)</span>
<span class="gi">+            {</span>
<span class="gi">+                data &lt;&lt; uint32(senderName.size() + 1);</span>
<span class="gi">+                data &lt;&lt; senderName;</span>
<span class="gi">+            }</span>
<span class="gi">+</span>
<span class="gi">+            if (msgtype == CHAT_MSG_CHANNEL)</span>
<span class="gi">+            {</span>
<span class="gi">+                data &lt;&lt; channelName;</span>
<span class="gi">+            }</span>
<span class="gi">+            data &lt;&lt; ObjectGuid(targetGuid);</span>
<span class="gi">+            break;</span>
<span class="gi">+    }</span>
<span class="gi">+    data &lt;&lt; uint32(message.size() + 1);</span>
<span class="gi">+    data &lt;&lt; message;</span>
<span class="gi">+    data &lt;&lt; uint8(chatTag);</span>
<span class="gi">+</span>
<span class="gi">+    if (isAchievement)</span>
<span class="gi">+        data &lt;&lt; uint32(achievementId);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+</span>
<span class="w"> </span>Player* ChatHandler::getSelectedPlayer() const
<span class="w"> </span>{
<span class="w"> </span>    if (!m_session)
<span class="gh">diff --git a/src/server/game/Chat/Chat.h b/src/server/game/Chat/Chat.h</span>
<span class="gh">index e2891a3b836775..ce733b3a57beb6 100644</span>
<span class="gd">--- a/src/server/game/Chat/Chat.h</span>
<span class="gi">+++ b/src/server/game/Chat/Chat.h</span>
<span class="gu">@@ -47,6 +47,13 @@ class AC_GAME_API ChatHandler</span>
<span class="w"> </span>    // Builds chat packet and returns receiver guid position in the packet to substitute in whisper builders
<span class="w"> </span>    static std::size_t BuildChatPacket(WorldPacket&amp; data, ChatMsg chatType, Language language, WorldObject const* sender, WorldObject const* receiver, std::string_view message, uint32 achievementId = 0, std::string const&amp; channelName = &quot;&quot;, LocaleConstant locale = DEFAULT_LOCALE);

<span class="gi">+    // All in one chat message builder</span>
<span class="gi">+    static void BuildChatPacket(</span>
<span class="gi">+            WorldPacket&amp; data, ChatMsg msgtype, std::string_view message, Language language = LANG_UNIVERSAL, PlayerChatTag chatTag = CHAT_TAG_NONE,</span>
<span class="gi">+            ObjectGuid const&amp; senderGuid = ObjectGuid(), std::string_view senderName = {},</span>
<span class="gi">+            ObjectGuid const&amp; targetGuid = ObjectGuid(), std::string_view targetName = {},</span>
<span class="gi">+            std::string_view channelName = {}, uint32 achievementId = 0);</span>
<span class="gi">+</span>
<span class="w"> </span>    static char* LineFromMessage(char*&amp; pos) { char* start = strtok(pos, &quot;\n&quot;); pos = nullptr; return start; }

<span class="w"> </span>    void SendNotification(std::string_view str);
<span class="gh">diff --git a/src/server/game/DataStores/DBCStores.cpp b/src/server/game/DataStores/DBCStores.cpp</span>
<span class="gh">index 7aa7413325292d..7cb68e1e431d8f 100644</span>
<span class="gd">--- a/src/server/game/DataStores/DBCStores.cpp</span>
<span class="gi">+++ b/src/server/game/DataStores/DBCStores.cpp</span>
<span class="gu">@@ -34,11 +34,16 @@ typedef std::map&lt;uint32, uint32&gt; AreaFlagByMapID;</span>
<span class="w"> </span>typedef std::tuple&lt;int16, int8, int32&gt; WMOAreaTableKey;
<span class="w"> </span>typedef std::map&lt;WMOAreaTableKey, WMOAreaTableEntry const*&gt; WMOAreaInfoByTripple;

<span class="gi">+typedef std::multimap&lt;uint32, CharSectionsEntry const*&gt; CharSectionsMap;</span>
<span class="gi">+</span>
<span class="w"> </span>DBCStorage &lt;AreaTableEntry&gt; sAreaTableStore(AreaTableEntryfmt);
<span class="w"> </span>DBCStorage &lt;AreaGroupEntry&gt; sAreaGroupStore(AreaGroupEntryfmt);
<span class="w"> </span>DBCStorage &lt;AreaPOIEntry&gt; sAreaPOIStore(AreaPOIEntryfmt);

<span class="w"> </span>static WMOAreaInfoByTripple sWMOAreaInfoByTripple;
<span class="gi">+static AreaFlagByAreaID sAreaFlagByAreaID;</span>
<span class="gi">+// for instances without generated *.map files</span>
<span class="gi">+static AreaFlagByMapID  sAreaFlagByMapID;</span>

<span class="w"> </span>DBCStorage &lt;AchievementEntry&gt; sAchievementStore(Achievementfmt);
<span class="w"> </span>DBCStorage &lt;AchievementCategoryEntry&gt; sAchievementCategoryStore(AchievementCategoryfmt);
<span class="gu">@@ -49,6 +54,10 @@ DBCStorage &lt;BattlemasterListEntry&gt; sBattlemasterListStore(BattlemasterListEntryf</span>
<span class="w"> </span>DBCStorage &lt;BarberShopStyleEntry&gt; sBarberShopStyleStore(BarberShopStyleEntryfmt);
<span class="w"> </span>DBCStorage &lt;CharStartOutfitEntry&gt; sCharStartOutfitStore(CharStartOutfitEntryfmt);
<span class="w"> </span>std::map&lt;uint32, CharStartOutfitEntry const*&gt; sCharStartOutfitMap;
<span class="gi">+</span>
<span class="gi">+DBCStorage &lt;CharSectionsEntry&gt; sCharSectionsStore(CharSectionsEntryfmt);</span>
<span class="gi">+CharSectionsMap sCharSectionMap;</span>
<span class="gi">+</span>
<span class="w"> </span>DBCStorage &lt;CharTitlesEntry&gt; sCharTitlesStore(CharTitlesEntryfmt);
<span class="w"> </span>DBCStorage &lt;ChatChannelsEntry&gt; sChatChannelsStore(ChatChannelsEntryfmt);
<span class="w"> </span>DBCStorage &lt;ChrClassesEntry&gt; sChrClassesStore(ChrClassesEntryfmt);
<span class="gu">@@ -71,6 +80,10 @@ DBCStorage &lt;DurabilityCostsEntry&gt; sDurabilityCostsStore(DurabilityCostsfmt);</span>
<span class="w"> </span>DBCStorage &lt;EmotesEntry&gt; sEmotesStore(EmotesEntryfmt);
<span class="w"> </span>DBCStorage &lt;EmotesTextEntry&gt; sEmotesTextStore(EmotesTextEntryfmt);

<span class="gi">+typedef std::tuple&lt;uint32, uint32, uint32&gt; EmotesTextSoundKey;</span>
<span class="gi">+static std::map&lt;EmotesTextSoundKey, EmotesTextSoundEntry const*&gt; sEmotesTextSoundMap;</span>
<span class="gi">+DBCStorage &lt;EmotesTextSoundEntry&gt; sEmotesTextSoundStore(EmotesTextSoundEntryfmt);</span>
<span class="gi">+</span>
<span class="w"> </span>typedef std::map&lt;uint32, SimpleFactionsList&gt; FactionTeamMap;
<span class="w"> </span>static FactionTeamMap sFactionTeamMap;
<span class="w"> </span>DBCStorage &lt;FactionEntry&gt; sFactionStore(FactionEntryfmt);
<span class="gu">@@ -280,6 +293,7 @@ void LoadDBCStores(const std::string&amp; dataPath)</span>
<span class="w"> </span>    LOAD_DBC(sBattlemasterListStore,                &quot;BattlemasterList.dbc&quot;,                 &quot;battlemasterlist_dbc&quot;);
<span class="w"> </span>    LOAD_DBC(sBarberShopStyleStore,                 &quot;BarberShopStyle.dbc&quot;,                  &quot;barbershopstyle_dbc&quot;);
<span class="w"> </span>    LOAD_DBC(sCharStartOutfitStore,                 &quot;CharStartOutfit.dbc&quot;,                  &quot;charstartoutfit_dbc&quot;);
<span class="gi">+    LOAD_DBC(sCharSectionsStore,                    &quot;CharSections.dbc&quot;,                     &quot;charsections_dbc&quot;);</span>
<span class="w"> </span>    LOAD_DBC(sCharTitlesStore,                      &quot;CharTitles.dbc&quot;,                       &quot;chartitles_dbc&quot;);
<span class="w"> </span>    LOAD_DBC(sChatChannelsStore,                    &quot;ChatChannels.dbc&quot;,                     &quot;chatchannels_dbc&quot;);
<span class="w"> </span>    LOAD_DBC(sChrClassesStore,                      &quot;ChrClasses.dbc&quot;,                       &quot;chrclasses_dbc&quot;);
<span class="gu">@@ -299,6 +313,7 @@ void LoadDBCStores(const std::string&amp; dataPath)</span>
<span class="w"> </span>    LOAD_DBC(sDurabilityQualityStore,               &quot;DurabilityQuality.dbc&quot;,                &quot;durabilityquality_dbc&quot;);
<span class="w"> </span>    LOAD_DBC(sEmotesStore,                          &quot;Emotes.dbc&quot;,                           &quot;emotes_dbc&quot;);
<span class="w"> </span>    LOAD_DBC(sEmotesTextStore,                      &quot;EmotesText.dbc&quot;,                       &quot;emotestext_dbc&quot;);
<span class="gi">+    LOAD_DBC(sEmotesTextSoundStore,                 &quot;EmotesTextSound.dbc&quot;,                  &quot;emotetextsound_dbc&quot;);</span>
<span class="w"> </span>    LOAD_DBC(sFactionStore,                         &quot;Faction.dbc&quot;,                          &quot;faction_dbc&quot;);
<span class="w"> </span>    LOAD_DBC(sFactionTemplateStore,                 &quot;FactionTemplate.dbc&quot;,                  &quot;factiontemplate_dbc&quot;);
<span class="w"> </span>    LOAD_DBC(sGameObjectArtKitStore,                &quot;GameObjectArtKit.dbc&quot;,                 &quot;gameobjectartkit_dbc&quot;);
<span class="gu">@@ -384,9 +399,26 @@ void LoadDBCStores(const std::string&amp; dataPath)</span>

<span class="w"> </span>#undef LOAD_DBC

<span class="gi">+    for (uint32 i = 0; i &lt; sAreaTableStore.GetNumRows(); ++i)    // areaflag numbered from 0</span>
<span class="gi">+    {</span>
<span class="gi">+        if (AreaTableEntry const* area = sAreaTableStore.LookupEntry(i))</span>
<span class="gi">+        {</span>
<span class="gi">+            // fill AreaId-&gt;DBC records</span>
<span class="gi">+            sAreaFlagByAreaID.insert(AreaFlagByAreaID::value_type(uint16(area-&gt;ID), area-&gt;exploreFlag));</span>
<span class="gi">+</span>
<span class="gi">+            // fill MapId-&gt;DBC records ( skip sub zones and continents )</span>
<span class="gi">+            if (area-&gt;zone == 0 &amp;&amp; area-&gt;mapid != 0 &amp;&amp; area-&gt;mapid != 1 &amp;&amp; area-&gt;mapid != 530)</span>
<span class="gi">+                sAreaFlagByMapID.insert(AreaFlagByMapID::value_type(area-&gt;mapid, area-&gt;exploreFlag));</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="w"> </span>    for (CharStartOutfitEntry const* outfit : sCharStartOutfitStore)
<span class="w"> </span>        sCharStartOutfitMap[outfit-&gt;Race | (outfit-&gt;Class &lt;&lt; 8) | (outfit-&gt;Gender &lt;&lt; 16)] = outfit;

<span class="gi">+    for (CharSectionsEntry const* charSection : sCharSectionsStore)</span>
<span class="gi">+        if (charSection-&gt;Race &amp;&amp; ((1 &lt;&lt; (charSection-&gt;Race - 1)) &amp; RACEMASK_ALL_PLAYABLE) != 0) //ignore Nonplayable races</span>
<span class="gi">+            sCharSectionMap.insert({ charSection-&gt;GenType | (charSection-&gt;Gender &lt;&lt; 8) | (charSection-&gt;Race &lt;&lt; 16), charSection });</span>
<span class="gi">+</span>
<span class="w"> </span>    for (FactionEntry const* faction : sFactionStore)
<span class="w"> </span>    {
<span class="w"> </span>        if (faction-&gt;team)
<span class="gu">@@ -408,6 +440,9 @@ void LoadDBCStores(const std::string&amp; dataPath)</span>
<span class="w"> </span>            std::swap(*(float*)(&amp;info-&gt;maxZ), *(float*)(&amp;info-&gt;minZ));
<span class="w"> </span>    }

<span class="gi">+    for (EmotesTextSoundEntry const* emoteTextSound : sEmotesTextSoundStore)</span>
<span class="gi">+        sEmotesTextSoundMap[EmotesTextSoundKey(emoteTextSound-&gt;EmotesTextId, emoteTextSound-&gt;RaceId, emoteTextSound-&gt;SexId)] = emoteTextSound;</span>
<span class="gi">+</span>
<span class="w"> </span>    // fill data
<span class="w"> </span>    for (MapDifficultyEntry const* entry : sMapDifficultyStore)
<span class="w"> </span>        sMapDifficultyMap[MAKE_PAIR32(entry-&gt;MapId, entry-&gt;Difficulty)] = MapDifficulty(entry-&gt;resetTime, entry-&gt;maxPlayers, entry-&gt;areaTriggerText[0] != &#39;\0&#39;);
<span class="gu">@@ -848,6 +883,18 @@ CharStartOutfitEntry const* GetCharStartOutfitEntry(uint8 race, uint8 class_, ui</span>
<span class="w"> </span>    return itr-&gt;second;
<span class="w"> </span>}

<span class="gi">+CharSectionsEntry const* GetCharSectionEntry(uint8 race, CharSectionType genType, uint8 gender, uint8 type, uint8 color)</span>
<span class="gi">+{</span>
<span class="gi">+    std::pair&lt;CharSectionsMap::const_iterator, CharSectionsMap::const_iterator&gt; eqr = sCharSectionMap.equal_range(uint32(genType) | uint32(gender &lt;&lt; 8) | uint32(race &lt;&lt; 16));</span>
<span class="gi">+    for (CharSectionsMap::const_iterator itr = eqr.first; itr != eqr.second; ++itr)</span>
<span class="gi">+    {</span>
<span class="gi">+        if (itr-&gt;second-&gt;Type == type &amp;&amp; itr-&gt;second-&gt;Color == color)</span>
<span class="gi">+            return itr-&gt;second;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    return nullptr;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>/// Returns LFGDungeonEntry for a specific map and difficulty. Will return first found entry if multiple dungeons use the same map (such as Scarlet Monastery)
<span class="w"> </span>LFGDungeonEntry const* GetLFGDungeon(uint32 mapId, Difficulty difficulty)
<span class="w"> </span>{
<span class="gu">@@ -913,6 +960,12 @@ SkillRaceClassInfoEntry const* GetSkillRaceClassInfo(uint32 skill, uint8 race, u</span>
<span class="w"> </span>    return nullptr;
<span class="w"> </span>}

<span class="gi">+EmotesTextSoundEntry const* FindTextSoundEmoteFor(uint32 emote, uint32 race, uint32 gender)</span>
<span class="gi">+{</span>
<span class="gi">+    auto itr = sEmotesTextSoundMap.find(EmotesTextSoundKey(emote, race, gender));</span>
<span class="gi">+    return itr != sEmotesTextSoundMap.end() ? itr-&gt;second : nullptr;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>const std::vector&lt;SkillLineAbilityEntry const*&gt;&amp; GetSkillLineAbilitiesBySkillLine(uint32 skillLine)
<span class="w"> </span>{
<span class="w"> </span>    auto it = sSkillLineAbilityIndexBySkillLine.find(skillLine);
<span class="gu">@@ -923,3 +976,40 @@ const std::vector&lt;SkillLineAbilityEntry const*&gt;&amp; GetSkillLineAbilitiesBySkillLin</span>
<span class="w"> </span>    }
<span class="w"> </span>    return it-&gt;second;
<span class="w"> </span>}
<span class="gi">+</span>
<span class="gi">+uint32 GetAreaFlagByMapId(uint32 mapid)</span>
<span class="gi">+{</span>
<span class="gi">+    AreaFlagByMapID::iterator i = sAreaFlagByMapID.find(mapid);</span>
<span class="gi">+    if (i == sAreaFlagByMapID.end())</span>
<span class="gi">+        return 0;</span>
<span class="gi">+    return i-&gt;second;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+int32 GetAreaFlagByAreaID(uint32 area_id)</span>
<span class="gi">+{</span>
<span class="gi">+    AreaFlagByAreaID::iterator i = sAreaFlagByAreaID.find(area_id);</span>
<span class="gi">+    if (i == sAreaFlagByAreaID.end())</span>
<span class="gi">+        return -1;</span>
<span class="gi">+</span>
<span class="gi">+    return i-&gt;second;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+AreaTableEntry const* GetAreaEntryByAreaID(uint32 area_id)</span>
<span class="gi">+{</span>
<span class="gi">+    int32 areaflag = GetAreaFlagByAreaID(area_id);</span>
<span class="gi">+    if (areaflag &lt; 0)</span>
<span class="gi">+        return nullptr;</span>
<span class="gi">+</span>
<span class="gi">+    return sAreaTableStore.LookupEntry(areaflag);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+AreaTableEntry const* GetAreaEntryByAreaFlagAndMap(uint32 area_flag, uint32 map_id)</span>
<span class="gi">+{</span>
<span class="gi">+    if (area_flag)</span>
<span class="gi">+        return sAreaTableStore.LookupEntry(area_flag);</span>
<span class="gi">+</span>
<span class="gi">+    if (MapEntry const* mapEntry = sMapStore.LookupEntry(map_id))</span>
<span class="gi">+        return GetAreaEntryByAreaID(mapEntry-&gt;linked_zone);</span>
<span class="gi">+</span>
<span class="gi">+    return nullptr;</span>
<span class="gi">+}</span>
\ No newline at end of file
<span class="gh">diff --git a/src/server/game/DataStores/DBCStores.h b/src/server/game/DataStores/DBCStores.h</span>
<span class="gh">index ec8cb68bbcbe43..011a9cbab766b2 100644</span>
<span class="gd">--- a/src/server/game/DataStores/DBCStores.h</span>
<span class="gi">+++ b/src/server/game/DataStores/DBCStores.h</span>
<span class="gu">@@ -35,6 +35,13 @@ TalentSpellPos const* GetTalentSpellPos(uint32 spellId);</span>

<span class="w"> </span>WMOAreaTableEntry const* GetWMOAreaTableEntryByTripple(int32 rootid, int32 adtid, int32 groupid);

<span class="gi">+</span>
<span class="gi">+// -1 if not found</span>
<span class="gi">+int32 GetAreaFlagByAreaID(uint32 area_id);</span>
<span class="gi">+uint32 GetAreaFlagByMapId(uint32 mapid);</span>
<span class="gi">+AreaTableEntry const* GetAreaEntryByAreaID(uint32 area_id);</span>
<span class="gi">+AreaTableEntry const* GetAreaEntryByAreaFlagAndMap(uint32 area_flag, uint32 map_id);</span>
<span class="gi">+</span>
<span class="w"> </span>uint32 GetVirtualMapForMapAndZone(uint32 mapid, uint32 zoneId);

<span class="w"> </span>enum ContentLevels : uint8
<span class="gu">@@ -63,6 +70,8 @@ PvPDifficultyEntry const* GetBattlegroundBracketById(uint32 mapid, BattlegroundB</span>

<span class="w"> </span>CharStartOutfitEntry const* GetCharStartOutfitEntry(uint8 race, uint8 class_, uint8 gender);

<span class="gi">+CharSectionsEntry const* GetCharSectionEntry(uint8 race, CharSectionType genType, uint8 gender, uint8 type, uint8 color);</span>
<span class="gi">+</span>
<span class="w"> </span>LFGDungeonEntry const* GetLFGDungeon(uint32 mapId, Difficulty difficulty);
<span class="w"> </span>LFGDungeonEntry const* GetZoneLFGDungeonEntry(std::string const&amp; zoneName, LocaleConstant locale);

<span class="gu">@@ -72,6 +81,7 @@ typedef std::unordered_multimap&lt;uint32, SkillRaceClassInfoEntry const*&gt; SkillRac</span>
<span class="w"> </span>typedef std::pair&lt;SkillRaceClassInfoMap::iterator, SkillRaceClassInfoMap::iterator&gt; SkillRaceClassInfoBounds;
<span class="w"> </span>SkillRaceClassInfoEntry const* GetSkillRaceClassInfo(uint32 skill, uint8 race, uint8 class_);

<span class="gi">+EmotesTextSoundEntry const* FindTextSoundEmoteFor(uint32 emote, uint32 race, uint32 gender);</span>
<span class="w"> </span>typedef std::unordered_map&lt;uint32 /* SkillLine */, std::vector&lt;SkillLineAbilityEntry const*&gt; &gt; SkillLineAbilityIndexBySkillLine;
<span class="w"> </span>const std::vector&lt;SkillLineAbilityEntry const*&gt;&amp; GetSkillLineAbilitiesBySkillLine(uint32 skillLine);

<span class="gu">@@ -87,6 +97,7 @@ extern DBCStorage &lt;BarberShopStyleEntry&gt;         sBarberShopStyleStore;</span>
<span class="w"> </span>extern DBCStorage &lt;BattlemasterListEntry&gt;        sBattlemasterListStore;
<span class="w"> </span>extern DBCStorage &lt;ChatChannelsEntry&gt;            sChatChannelsStore;
<span class="w"> </span>extern DBCStorage &lt;CharStartOutfitEntry&gt;         sCharStartOutfitStore;
<span class="gi">+extern DBCStorage &lt;CharSectionsEntry&gt;            sCharSectionsStore;</span>
<span class="w"> </span>extern DBCStorage &lt;CharTitlesEntry&gt;              sCharTitlesStore;
<span class="w"> </span>extern DBCStorage &lt;ChrClassesEntry&gt;              sChrClassesStore;
<span class="w"> </span>extern DBCStorage &lt;ChrRacesEntry&gt;                sChrRacesStore;
<span class="gu">@@ -105,6 +116,7 @@ extern DBCStorage &lt;DurabilityCostsEntry&gt;         sDurabilityCostsStore;</span>
<span class="w"> </span>extern DBCStorage &lt;DurabilityQualityEntry&gt;       sDurabilityQualityStore;
<span class="w"> </span>extern DBCStorage &lt;EmotesEntry&gt;                  sEmotesStore;
<span class="w"> </span>extern DBCStorage &lt;EmotesTextEntry&gt;              sEmotesTextStore;
<span class="gi">+extern DBCStorage &lt;EmotesTextSoundEntry&gt;         sEmotesTextSoundStore;</span>
<span class="w"> </span>extern DBCStorage &lt;FactionEntry&gt;                 sFactionStore;
<span class="w"> </span>extern DBCStorage &lt;FactionTemplateEntry&gt;         sFactionTemplateStore;
<span class="w"> </span>extern DBCStorage &lt;GameObjectArtKitEntry&gt;        sGameObjectArtKitStore;
<span class="gh">diff --git a/src/server/game/DungeonFinding/LFGMgr.h b/src/server/game/DungeonFinding/LFGMgr.h</span>
<span class="gh">index 644504567a805d..3d451e8eb0d1b6 100644</span>
<span class="gd">--- a/src/server/game/DungeonFinding/LFGMgr.h</span>
<span class="gi">+++ b/src/server/game/DungeonFinding/LFGMgr.h</span>
<span class="gu">@@ -584,6 +584,7 @@ namespace lfg</span>
<span class="w"> </span>        [[nodiscard]] bool IsTesting() const { return m_Testing; }

<span class="w"> </span>        void SetDungeon(ObjectGuid guid, uint32 dungeon);
<span class="gi">+        LFGDungeonData const* GetLFGDungeon(uint32 id);</span>

<span class="w"> </span>    private:
<span class="w"> </span>        TeamId GetTeam(ObjectGuid guid);
<span class="gu">@@ -596,7 +597,6 @@ namespace lfg</span>
<span class="w"> </span>        void SetCanOverrideRBState(ObjectGuid guid, bool val);
<span class="w"> </span>        void GetCompatibleDungeons(LfgDungeonSet&amp; dungeons, LfgGuidSet const&amp; players, LfgLockPartyMap&amp; lockMap, uint32 randomDungeonId = 0);
<span class="w"> </span>        void _SaveToDB(ObjectGuid guid);
<span class="gd">-        LFGDungeonData const* GetLFGDungeon(uint32 id);</span>

<span class="w"> </span>        // Proposals
<span class="w"> </span>        void RemoveProposal(LfgProposalContainer::iterator itProposal, LfgUpdateType type);
<span class="gh">diff --git a/src/server/game/DungeonFinding/LFGQueue.cpp b/src/server/game/DungeonFinding/LFGQueue.cpp</span>
<span class="gh">index aae5df67aa2afe..6e7f99a32252b5 100644</span>
<span class="gd">--- a/src/server/game/DungeonFinding/LFGQueue.cpp</span>
<span class="gi">+++ b/src/server/game/DungeonFinding/LFGQueue.cpp</span>
<span class="gu">@@ -25,6 +25,7 @@</span>
<span class="w"> </span>#include &quot;Log.h&quot;
<span class="w"> </span>#include &quot;ObjectMgr.h&quot;
<span class="w"> </span>#include &quot;Player.h&quot;
<span class="gi">+#include &quot;ScriptMgr.h&quot;</span>
<span class="w"> </span>#include &quot;World.h&quot;

<span class="w"> </span>namespace lfg
<span class="gu">@@ -411,6 +412,11 @@ namespace lfg</span>
<span class="w"> </span>        if (!sLFGMgr-&gt;AllQueued(check)) // can&#39;t create proposal
<span class="w"> </span>            return LFG_COMPATIBILITY_PENDING;

<span class="gi">+        if (!sScriptMgr-&gt;OnPlayerbotCheckLFGQueue(proposal.queues))</span>
<span class="gi">+        {</span>
<span class="gi">+            return LFG_INCOMPATIBLES_HAS_IGNORES;</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="w"> </span>        // Create a new proposal
<span class="w"> </span>        proposal.cancelTime = GameTime::GetGameTime().count() + LFG_TIME_PROPOSAL;
<span class="w"> </span>        proposal.state = LFG_PROPOSAL_INITIATING;
<span class="gh">diff --git a/src/server/game/Entities/Creature/Creature.cpp b/src/server/game/Entities/Creature/Creature.cpp</span>
<span class="gh">index dd2ab4992dccee..851bf23dbaca3e 100644</span>
<span class="gd">--- a/src/server/game/Entities/Creature/Creature.cpp</span>
<span class="gi">+++ b/src/server/game/Entities/Creature/Creature.cpp</span>
<span class="gu">@@ -1373,7 +1373,7 @@ void Creature::SaveToDB(uint32 mapid, uint8 spawnMask, uint32 phaseMask)</span>
<span class="w"> </span>        m_spawnId = sObjectMgr-&gt;GenerateCreatureSpawnId();

<span class="w"> </span>    CreatureData&amp; data = sObjectMgr-&gt;NewOrExistCreatureData(m_spawnId);
<span class="gd">-</span>
<span class="gi">+    data.spawnId = m_spawnId;  // mod_playerbots</span>
<span class="w"> </span>    uint32 displayId = GetNativeDisplayId();
<span class="w"> </span>    uint32 npcflag = GetNpcFlags();
<span class="w"> </span>    uint32 unit_flags = GetUnitFlags();
<span class="gh">diff --git a/src/server/game/Entities/Creature/CreatureData.h b/src/server/game/Entities/Creature/CreatureData.h</span>
<span class="gh">index f1f3d6f02ed012..e1022f1226fc55 100644</span>
<span class="gd">--- a/src/server/game/Entities/Creature/CreatureData.h</span>
<span class="gi">+++ b/src/server/game/Entities/Creature/CreatureData.h</span>
<span class="gu">@@ -365,6 +365,7 @@ typedef std::unordered_map&lt;uint32, EquipmentInfoContainerInternal&gt; EquipmentInfo</span>
<span class="w"> </span>struct CreatureData
<span class="w"> </span>{
<span class="w"> </span>    CreatureData() = default;
<span class="gi">+    ObjectGuid::LowType spawnId{ 0 };                          // mod_playerbots</span>
<span class="w"> </span>    uint32 id1{0};                                             // entry in creature_template
<span class="w"> </span>    uint32 id2{0};                                             // entry in creature_template
<span class="w"> </span>    uint32 id3{0};                                             // entry in creature_template
<span class="gh">diff --git a/src/server/game/Entities/Item/Item.cpp b/src/server/game/Entities/Item/Item.cpp</span>
<span class="gh">index 9aea0ea74308f9..9c0c27fb770b09 100644</span>
<span class="gd">--- a/src/server/game/Entities/Item/Item.cpp</span>
<span class="gi">+++ b/src/server/game/Entities/Item/Item.cpp</span>
<span class="gu">@@ -1084,7 +1084,7 @@ void Item::SendTimeUpdate(Player* owner)</span>
<span class="w"> </span>    owner-&gt;SendDirectMessage(&amp;data);
<span class="w"> </span>}

<span class="gd">-Item* Item::CreateItem(uint32 item, uint32 count, Player const* player, bool clone, uint32 randomPropertyId)</span>
<span class="gi">+Item* Item::CreateItem(uint32 item, uint32 count, Player const* player, bool clone, uint32 randomPropertyId, bool temp)</span>
<span class="w"> </span>{
<span class="w"> </span>    if (count &lt; 1)
<span class="w"> </span>        return nullptr;                                        //don&#39;t create item at zero count
<span class="gu">@@ -1098,7 +1098,8 @@ Item* Item::CreateItem(uint32 item, uint32 count, Player const* player, bool clo</span>
<span class="w"> </span>        ASSERT_NODEBUGINFO(count != 0 &amp;&amp; &quot;pProto-&gt;Stackable == 0 but checked at loading already&quot;);

<span class="w"> </span>        Item* pItem = NewItemOrBag(pProto);
<span class="gd">-        if (pItem-&gt;Create(sObjectMgr-&gt;GetGenerator&lt;HighGuid::Item&gt;().Generate(), item, player))</span>
<span class="gi">+        uint32 guid = temp ? 0xFFFFFFFF : sObjectMgr-&gt;GetGenerator&lt;HighGuid::Item&gt;().Generate();</span>
<span class="gi">+        if (pItem-&gt;Create(guid, item, player))</span>
<span class="w"> </span>        {
<span class="w"> </span>            pItem-&gt;SetCount(count);
<span class="w"> </span>            if (!clone)
<span class="gu">@@ -1276,10 +1277,15 @@ void Item::ClearSoulboundTradeable(Player* currentOwner)</span>

<span class="w"> </span>bool Item::CheckSoulboundTradeExpire()
<span class="w"> </span>{
<span class="gd">-    // called from owner&#39;s update - GetOwner() MUST be valid</span>
<span class="gd">-    if (GetUInt32Value(ITEM_FIELD_CREATE_PLAYED_TIME) + 2 * HOUR &lt; GetOwner()-&gt;GetTotalPlayedTime())</span>
<span class="gi">+    // we have to check the owner for mod_playerbots since bots programically call methods like DestroyItem, </span>
<span class="gi">+    // MoveItemToMail, DestroyItemCount which do not handle soulboundTradeable clearing.</span>
<span class="gi">+    Player* owner = GetOwner();</span>
<span class="gi">+    if (!owner)</span>
<span class="gi">+        return true; // remove from tradeable list</span>
<span class="gi">+    </span>
<span class="gi">+    if (GetUInt32Value(ITEM_FIELD_CREATE_PLAYED_TIME) + 2 * HOUR &lt; owner-&gt;GetTotalPlayedTime())</span>
<span class="w"> </span>    {
<span class="gd">-        ClearSoulboundTradeable(GetOwner());</span>
<span class="gi">+        ClearSoulboundTradeable(owner);</span>
<span class="w"> </span>        return true; // remove from tradeable list
<span class="w"> </span>    }

<span class="gh">diff --git a/src/server/game/Entities/Item/Item.h b/src/server/game/Entities/Item/Item.h</span>
<span class="gh">index 51289594b98b59..e333a4ba772dfe 100644</span>
<span class="gd">--- a/src/server/game/Entities/Item/Item.h</span>
<span class="gi">+++ b/src/server/game/Entities/Item/Item.h</span>
<span class="gu">@@ -219,7 +219,7 @@ bool ItemCanGoIntoBag(ItemTemplate const* proto, ItemTemplate const* pBagProto);</span>
<span class="w"> </span>class Item : public Object
<span class="w"> </span>{
<span class="w"> </span>public:
<span class="gd">-    static Item* CreateItem(uint32 item, uint32 count, Player const* player = nullptr, bool clone = false, uint32 randomPropertyId = 0);</span>
<span class="gi">+    static Item* CreateItem(uint32 item, uint32 count, Player const* player = nullptr, bool clone = false, uint32 randomPropertyId = 0, bool temp = false);</span>
<span class="w"> </span>    Item* CloneItem(uint32 count, Player const* player = nullptr) const;

<span class="w"> </span>    Item();
<span class="gh">diff --git a/src/server/game/Entities/Item/ItemTemplate.h b/src/server/game/Entities/Item/ItemTemplate.h</span>
<span class="gh">index b41616c1120fec..dca51af799512f 100644</span>
<span class="gd">--- a/src/server/game/Entities/Item/ItemTemplate.h</span>
<span class="gi">+++ b/src/server/game/Entities/Item/ItemTemplate.h</span>
<span class="gu">@@ -251,7 +251,7 @@ enum SocketColor</span>

<span class="w"> </span>#define SOCKET_COLOR_ALL (SOCKET_COLOR_META | SOCKET_COLOR_RED | SOCKET_COLOR_YELLOW | SOCKET_COLOR_BLUE)

<span class="gd">-enum InventoryType</span>
<span class="gi">+enum InventoryType : uint32</span>
<span class="w"> </span>{
<span class="w"> </span>    INVTYPE_NON_EQUIP                           = 0,
<span class="w"> </span>    INVTYPE_HEAD                                = 1,
<span class="gu">@@ -818,6 +818,8 @@ struct ItemTemplate</span>
<span class="w"> </span>    [[nodiscard]] bool IsWeaponVellum() const { return Class == ITEM_CLASS_TRADE_GOODS &amp;&amp; SubClass == ITEM_SUBCLASS_WEAPON_ENCHANTMENT; }
<span class="w"> </span>    [[nodiscard]] bool IsArmorVellum() const { return Class == ITEM_CLASS_TRADE_GOODS &amp;&amp; SubClass == ITEM_SUBCLASS_ARMOR_ENCHANTMENT; }
<span class="w"> </span>    [[nodiscard]] bool IsConjuredConsumable() const { return Class == ITEM_CLASS_CONSUMABLE &amp;&amp; HasFlag(ITEM_FLAG_CONJURED); }
<span class="gi">+    [[nodiscard]] bool IsWeapon() const { return Class == ITEM_CLASS_WEAPON; }</span>
<span class="gi">+    [[nodiscard]] bool IsRangedWeapon() const { return IsWeapon() &amp;&amp; (InventoryType == INVTYPE_RANGED || InventoryType == INVTYPE_THROWN || InventoryType == INVTYPE_RANGEDRIGHT); }</span>

<span class="w"> </span>    [[nodiscard]] bool HasStat(ItemModType stat) const;
<span class="w"> </span>    [[nodiscard]] bool HasSpellPowerStat() const;
<span class="gh">diff --git a/src/server/game/Entities/Player/Player.cpp b/src/server/game/Entities/Player/Player.cpp</span>
<span class="gh">index ff26ef061923ef..82e67db4e1a1d0 100644</span>
<span class="gd">--- a/src/server/game/Entities/Player/Player.cpp</span>
<span class="gi">+++ b/src/server/game/Entities/Player/Player.cpp</span>
<span class="gu">@@ -4922,6 +4922,15 @@ void Player::CleanupChannels()</span>
<span class="w"> </span>    }
<span class="w"> </span>}

<span class="gi">+// Playerbot helper if bot talks in a different locale</span>
<span class="gi">+bool Player::IsInChannel(const Channel* c)</span>
<span class="gi">+{</span>
<span class="gi">+    return std::any_of(m_channels.begin(), m_channels.end(), [c](const Channel* chan)</span>
<span class="gi">+    {</span>
<span class="gi">+        return c-&gt;GetChannelId() == chan-&gt;GetChannelId();</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>void Player::ClearChannelWatch()
<span class="w"> </span>{
<span class="w"> </span>    for (JoinedChannelsList::iterator itr = m_channels.begin(); itr != m_channels.end(); ++itr)
<span class="gh">diff --git a/src/server/game/Entities/Player/Player.h b/src/server/game/Entities/Player/Player.h</span>
<span class="gh">index 92b42d7358b9bb..b570441cbd7e5c 100644</span>
<span class="gd">--- a/src/server/game/Entities/Player/Player.h</span>
<span class="gi">+++ b/src/server/game/Entities/Player/Player.h</span>
<span class="gu">@@ -656,7 +656,7 @@ enum PlayerSlots</span>

<span class="w"> </span>#define INVENTORY_SLOT_BAG_0    255

<span class="gd">-enum EquipmentSlots                                         // 19 slots</span>
<span class="gi">+enum EquipmentSlots : uint32                                // 19 slots</span>
<span class="w"> </span>{
<span class="w"> </span>    EQUIPMENT_SLOT_START        = 0,
<span class="w"> </span>    EQUIPMENT_SLOT_HEAD         = 0,
<span class="gu">@@ -1295,6 +1295,7 @@ class Player : public Unit, public GridObject&lt;Player&gt;</span>
<span class="w"> </span>    InventoryResult CanUseItem(Item* pItem, bool not_loading = true) const;
<span class="w"> </span>    [[nodiscard]] bool HasItemTotemCategory(uint32 TotemCategory) const;
<span class="w"> </span>    bool IsTotemCategoryCompatiableWith(ItemTemplate const* pProto, uint32 requiredTotemCategoryId) const;
<span class="gi">+    InventoryResult BotCanUseItem(ItemTemplate const* pItem) const;</span>
<span class="w"> </span>    InventoryResult CanUseItem(ItemTemplate const* pItem) const;
<span class="w"> </span>    [[nodiscard]] InventoryResult CanUseAmmo(uint32 item) const;
<span class="w"> </span>    InventoryResult CanRollForItemInLFG(ItemTemplate const* item, WorldObject const* lootedObject) const;
<span class="gu">@@ -2054,10 +2055,13 @@ class Player : public Unit, public GridObject&lt;Player&gt;</span>
<span class="w"> </span>    }
<span class="w"> </span>    bool IsMirrorTimerActive(MirrorTimerType type) { return m_MirrorTimer[type] == getMaxTimer(type); }

<span class="gi">+    void SetMovement(PlayerMovementType pType);</span>
<span class="gi">+</span>
<span class="w"> </span>    bool CanJoinConstantChannelInZone(ChatChannelsEntry const* channel, AreaTableEntry const* zone);

<span class="w"> </span>    void JoinedChannel(Channel* c);
<span class="w"> </span>    void LeftChannel(Channel* c);
<span class="gi">+    bool IsInChannel(const Channel* c);</span>
<span class="w"> </span>    void CleanupChannels();
<span class="w"> </span>    void ClearChannelWatch();
<span class="w"> </span>    void UpdateLFGChannel();
<span class="gu">@@ -2638,6 +2642,8 @@ class Player : public Unit, public GridObject&lt;Player&gt;</span>

<span class="w"> </span>    void SendSystemMessage(std::string_view msg, bool escapeCharacters = false);

<span class="gi">+    void ResetSpeakTimers();</span>
<span class="gi">+</span>
<span class="w"> </span>    std::string GetDebugInfo() const override;

<span class="w"> </span>    bool IsExpectingChangeTransport() const { return _expectingChangeTransport; }
<span class="gh">diff --git a/src/server/game/Entities/Player/PlayerStorage.cpp b/src/server/game/Entities/Player/PlayerStorage.cpp</span>
<span class="gh">index e8117aa58ea901..b7932bbc3f53d4 100644</span>
<span class="gd">--- a/src/server/game/Entities/Player/PlayerStorage.cpp</span>
<span class="gi">+++ b/src/server/game/Entities/Player/PlayerStorage.cpp</span>
<span class="gu">@@ -908,6 +908,31 @@ bool Player::IsTotemCategoryCompatiableWith(ItemTemplate const* pProto, uint32 r</span>
<span class="w"> </span>    return true;
<span class="w"> </span>}

<span class="gi">+InventoryResult Player::BotCanUseItem(ItemTemplate const* proto) const</span>
<span class="gi">+{</span>
<span class="gi">+    if (proto-&gt;Class == ITEM_CLASS_ARMOR &amp;&amp; proto-&gt;SubClass == ITEM_SUBCLASS_ARMOR_IDOL &amp;&amp; !IsClass(CLASS_DRUID, CLASS_CONTEXT_EQUIP_RELIC))</span>
<span class="gi">+    {</span>
<span class="gi">+        return EQUIP_ERR_YOU_CAN_NEVER_USE_THAT_ITEM;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    if (proto-&gt;Class == ITEM_CLASS_ARMOR &amp;&amp; proto-&gt;SubClass == ITEM_SUBCLASS_ARMOR_TOTEM &amp;&amp; !IsClass(CLASS_SHAMAN, CLASS_CONTEXT_EQUIP_RELIC))</span>
<span class="gi">+    {</span>
<span class="gi">+        return EQUIP_ERR_YOU_CAN_NEVER_USE_THAT_ITEM;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    if (proto-&gt;Class == ITEM_CLASS_ARMOR &amp;&amp; proto-&gt;SubClass == ITEM_SUBCLASS_ARMOR_LIBRAM &amp;&amp; !IsClass(CLASS_PALADIN, CLASS_CONTEXT_EQUIP_RELIC))</span>
<span class="gi">+    {</span>
<span class="gi">+        return EQUIP_ERR_YOU_CAN_NEVER_USE_THAT_ITEM;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    if (proto-&gt;Class == ITEM_CLASS_ARMOR &amp;&amp; proto-&gt;SubClass == ITEM_SUBCLASS_ARMOR_SIGIL &amp;&amp; !IsClass(CLASS_DEATH_KNIGHT, CLASS_CONTEXT_EQUIP_RELIC))</span>
<span class="gi">+    {</span>
<span class="gi">+        return EQUIP_ERR_YOU_CAN_NEVER_USE_THAT_ITEM;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    return CanUseItem(proto);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>InventoryResult Player::CanStoreItem_InSpecificSlot(uint8 bag, uint8 slot, ItemPosCountVec&amp; dest, ItemTemplate const* pProto, uint32&amp; count, bool swap, Item* pSrcItem) const
<span class="w"> </span>{
<span class="w"> </span>    Item* pItem2 = GetItemByPos(bag, slot);
<span class="gh">diff --git a/src/server/game/Entities/Player/PlayerUpdates.cpp b/src/server/game/Entities/Player/PlayerUpdates.cpp</span>
<span class="gh">index b0c7a85218ec76..ba8c9257620fe5 100644</span>
<span class="gd">--- a/src/server/game/Entities/Player/PlayerUpdates.cpp</span>
<span class="gi">+++ b/src/server/game/Entities/Player/PlayerUpdates.cpp</span>
<span class="gu">@@ -430,6 +430,7 @@ void Player::Update(uint32 p_time)</span>
<span class="w"> </span>        m_delayed_unit_relocation_timer = 0;
<span class="w"> </span>        RemoveFromNotify(NOTIFY_VISIBILITY_CHANGED);
<span class="w"> </span>    }
<span class="gi">+    sScriptMgr-&gt;OnPlayerAfterUpdate(this, p_time);</span>
<span class="w"> </span>}

<span class="w"> </span>void Player::UpdateMirrorTimers()
<span class="gh">diff --git a/src/server/game/Entities/Unit/Unit.cpp b/src/server/game/Entities/Unit/Unit.cpp</span>
<span class="gh">index f87548d1801a4d..dd6aef12c4b763 100644</span>
<span class="gd">--- a/src/server/game/Entities/Unit/Unit.cpp</span>
<span class="gi">+++ b/src/server/game/Entities/Unit/Unit.cpp</span>
<span class="gu">@@ -10410,6 +10410,11 @@ ReputationRank Unit::GetFactionReactionTo(FactionTemplateEntry const* factionTem</span>
<span class="w"> </span>        }
<span class="w"> </span>    }

<span class="gi">+    return GetFactionReactionTo(factionTemplateEntry, targetFactionTemplateEntry);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+ReputationRank Unit::GetFactionReactionTo(FactionTemplateEntry const* factionTemplateEntry, FactionTemplateEntry const* targetFactionTemplateEntry)</span>
<span class="gi">+{</span>
<span class="w"> </span>    // common faction based check
<span class="w"> </span>    if (factionTemplateEntry-&gt;IsHostileTo(*targetFactionTemplateEntry))
<span class="w"> </span>        return REP_HOSTILE;
<span class="gu">@@ -10419,6 +10424,7 @@ ReputationRank Unit::GetFactionReactionTo(FactionTemplateEntry const* factionTem</span>
<span class="w"> </span>        return REP_FRIENDLY;
<span class="w"> </span>    if (factionTemplateEntry-&gt;factionFlags &amp; FACTION_TEMPLATE_FLAG_HATES_ALL_EXCEPT_FRIENDS)
<span class="w"> </span>        return REP_HOSTILE;
<span class="gi">+</span>
<span class="w"> </span>    // neutral by default
<span class="w"> </span>    return REP_NEUTRAL;
<span class="w"> </span>}
<span class="gu">@@ -15984,6 +15990,11 @@ void Unit::CleanupBeforeRemoveFromMap(bool finalCleanup)</span>
<span class="w"> </span>    if (IsInWorld()) // not in world and not being removed atm
<span class="w"> </span>        RemoveFromWorld();

<span class="gi">+    // Added for mod_playerbots crash fixes; cancel and remove pending events before aura/spellmod cleanup.</span>
<span class="gi">+    // Without this SpellEvent may be cancelled later during EventProcessor destruction after auras/spellmods </span>
<span class="gi">+    // are already removed and leading to invalid access in Player::RestoreSpellMods on logout.</span>
<span class="gi">+    m_Events.KillAllEvents(false);</span>
<span class="gi">+</span>
<span class="w"> </span>    ASSERT(GetGUID());

<span class="w"> </span>    // A unit may be in removelist and not in world, but it is still in grid
<span class="gu">@@ -18234,6 +18245,8 @@ void Unit::Kill(Unit* killer, Unit* victim, bool durabilityLoss, WeaponAttackTyp</span>
<span class="w"> </span>            }
<span class="w"> </span>        }

<span class="gi">+        sScriptMgr-&gt;OnPlayerbotCheckKillTask(player, victim);</span>
<span class="gi">+</span>
<span class="w"> </span>        // Dungeon specific stuff, only applies to players killing creatures
<span class="w"> </span>        if (creature-&gt;GetInstanceId())
<span class="w"> </span>        {
<span class="gu">@@ -19178,11 +19191,23 @@ void Unit::SendPlaySpellVisual(uint32 id)</span>
<span class="w"> </span>    SendMessageToSet(&amp;data, true);
<span class="w"> </span>}

<span class="gi">+void Unit::SendPlaySpellVisual(ObjectGuid guid, uint32 id)</span>
<span class="gi">+{</span>
<span class="gi">+    WorldPacket data(SMSG_PLAY_SPELL_VISUAL, 8 + 4);</span>
<span class="gi">+    data &lt;&lt; guid;</span>
<span class="gi">+    data &lt;&lt; uint32(id); // SpellVisualKit.dbc index</span>
<span class="gi">+    SendMessageToSet(&amp;data, true);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>void Unit::SendPlaySpellImpact(ObjectGuid guid, uint32 id)
<span class="w"> </span>{
<span class="w"> </span>    WorldPacket data(SMSG_PLAY_SPELL_IMPACT, 8 + 4);
<span class="w"> </span>    data &lt;&lt; guid;       // target
<span class="w"> </span>    data &lt;&lt; uint32(id); // SpellVisualKit.dbc index
<span class="gi">+</span>
<span class="gi">+    if (IsPlayer())</span>
<span class="gi">+        ToPlayer()-&gt;SendDirectMessage(&amp;data);</span>
<span class="gi">+    else</span>
<span class="w"> </span>    SendMessageToSet(&amp;data, true);
<span class="w"> </span>}

<span class="gh">diff --git a/src/server/game/Entities/Unit/Unit.h b/src/server/game/Entities/Unit/Unit.h</span>
<span class="gh">index 1590c2721fdb1c..9aa5cb1fd1bd45 100644</span>
<span class="gd">--- a/src/server/game/Entities/Unit/Unit.h</span>
<span class="gi">+++ b/src/server/game/Entities/Unit/Unit.h</span>
<span class="gu">@@ -1851,6 +1851,7 @@ class Unit : public WorldObject</span>
<span class="w"> </span>    // Reputations system
<span class="w"> </span>    ReputationRank GetReactionTo(Unit const* target, bool checkOriginalFaction = false) const;
<span class="w"> </span>    ReputationRank GetFactionReactionTo(FactionTemplateEntry const* factionTemplateEntry, Unit const* target) const;
<span class="gi">+    static ReputationRank GetFactionReactionTo(FactionTemplateEntry const* factionTemplateEntry, FactionTemplateEntry const* targetFactionTemplateEntry);</span>

<span class="w"> </span>    // Shared vision
<span class="w"> </span>    SharedVisionList const&amp; GetSharedVisionList() { return m_sharedVision; }
<span class="gu">@@ -2008,6 +2009,7 @@ class Unit : public WorldObject</span>
<span class="w"> </span>    void SendComboPoints();

<span class="w"> </span>    void SendPlaySpellVisual(uint32 id);
<span class="gi">+    void SendPlaySpellVisual(ObjectGuid guid, uint32 id);</span>
<span class="w"> </span>    void SendPlaySpellImpact(ObjectGuid guid, uint32 id);

<span class="w"> </span>    void SendPetActionFeedback(uint8 msg) const;
<span class="gh">diff --git a/src/server/game/Entities/Vehicle/VehicleDefines.h b/src/server/game/Entities/Vehicle/VehicleDefines.h</span>
<span class="gh">index 1aa25458194ad4..86822d05e81a10 100644</span>
<span class="gd">--- a/src/server/game/Entities/Vehicle/VehicleDefines.h</span>
<span class="gi">+++ b/src/server/game/Entities/Vehicle/VehicleDefines.h</span>
<span class="gu">@@ -45,6 +45,7 @@ enum VehicleFlags</span>
<span class="w"> </span>    VEHICLE_FLAG_CUSTOM_PITCH                    = 0x00000040,           // If set use pitchMin and pitchMax from DBC, otherwise pitchMin = -pi/2, pitchMax = pi/2
<span class="w"> </span>    VEHICLE_FLAG_ADJUST_AIM_ANGLE                = 0x00000400,           // Lua_IsVehicleAimAngleAdjustable
<span class="w"> </span>    VEHICLE_FLAG_ADJUST_AIM_POWER                = 0x00000800,           // Lua_IsVehicleAimPowerAdjustable
<span class="gi">+    VEHICLE_FLAG_FIXED_POSITION                  = 0x00200000            // Used for cannons, when they should be rooted (mod_playerbots, not sure this is still valid since its only used my playerbot)</span>
<span class="w"> </span>};

<span class="w"> </span>enum VehicleSpells
<span class="gh">diff --git a/src/server/game/Globals/ObjectMgr.h b/src/server/game/Globals/ObjectMgr.h</span>
<span class="gh">index 4ac1e33b664629..37bf94b7d73d6b 100644</span>
<span class="gd">--- a/src/server/game/Globals/ObjectMgr.h</span>
<span class="gi">+++ b/src/server/game/Globals/ObjectMgr.h</span>
<span class="gu">@@ -867,6 +867,7 @@ class ObjectMgr</span>
<span class="w"> </span>        return nullptr;
<span class="w"> </span>    }

<span class="gi">+    [[nodiscard]] AreaTriggerTeleportContainer const&amp; GetAllAreaTriggerTeleports() const { return _areaTriggerTeleportStore; }</span>
<span class="w"> </span>    [[nodiscard]] AreaTriggerTeleport const* GetAreaTriggerTeleport(uint32 trigger) const
<span class="w"> </span>    {
<span class="w"> </span>        AreaTriggerTeleportContainer::const_iterator itr = _areaTriggerTeleportStore.find(trigger);
<span class="gh">diff --git a/src/server/game/Groups/Group.cpp b/src/server/game/Groups/Group.cpp</span>
<span class="gh">index d2338ca813b95e..9242668a96eb61 100644</span>
<span class="gd">--- a/src/server/game/Groups/Group.cpp</span>
<span class="gi">+++ b/src/server/game/Groups/Group.cpp</span>
<span class="gu">@@ -350,14 +350,21 @@ bool Group::AddLeaderInvite(Player* player)</span>

<span class="w"> </span>void Group::RemoveInvite(Player* player)
<span class="w"> </span>{
<span class="gd">-    if (player)</span>
<span class="gd">-    {</span>
<span class="gd">-        if (!m_invitees.empty())</span>
<span class="gd">-            m_invitees.erase(player);</span>
<span class="gd">-        player-&gt;SetGroupInvite(nullptr);</span>
<span class="gd">-    }</span>
<span class="gi">+    if (!player)</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    // mod_playerbots: double invite hack workaround</span>
<span class="gi">+    if (player-&gt;GetGroupInvite() != this)</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    auto itr = m_invitees.find(player);</span>
<span class="gi">+    if (itr != m_invitees.end())</span>
<span class="gi">+        m_invitees.erase(itr);</span>
<span class="gi">+</span>
<span class="gi">+    player-&gt;SetGroupInvite(nullptr);</span>
<span class="w"> </span>}

<span class="gi">+</span>
<span class="w"> </span>void Group::RemoveAllInvites()
<span class="w"> </span>{
<span class="w"> </span>    for (InvitesList::iterator itr = m_invitees.begin(); itr != m_invitees.end(); ++itr)
<span class="gh">diff --git a/src/server/game/Groups/Group.h b/src/server/game/Groups/Group.h</span>
<span class="gh">index c4a9b926277aba..b9cdb1e3550d3a 100644</span>
<span class="gd">--- a/src/server/game/Groups/Group.h</span>
<span class="gi">+++ b/src/server/game/Groups/Group.h</span>
<span class="gu">@@ -262,6 +262,9 @@ class Group</span>
<span class="w"> </span>    void SetGroupMemberFlag(ObjectGuid guid, bool apply, GroupMemberFlags flag);
<span class="w"> </span>    void RemoveUniqueGroupMemberFlag(GroupMemberFlags flag);

<span class="gi">+    //mod_playerbots</span>
<span class="gi">+    ObjectGuid const GetTargetIcon(uint8 id) const { return m_targetIcons[id]; }</span>
<span class="gi">+</span>
<span class="w"> </span>    Difficulty GetDifficulty(bool isRaid) const;
<span class="w"> </span>    Difficulty GetDungeonDifficulty() const;
<span class="w"> </span>    Difficulty GetRaidDifficulty() const;
<span class="gu">@@ -300,6 +303,8 @@ class Group</span>
<span class="w"> </span>    bool CountRollVote(ObjectGuid playerGUID, ObjectGuid Guid, uint8 Choise);
<span class="w"> </span>    void EndRoll(Loot* loot, Map* allowedMap);

<span class="gi">+    Rolls GetRolls() const { return RollId; }</span>
<span class="gi">+</span>
<span class="w"> </span>    // related to disenchant rolls
<span class="w"> </span>    void ResetMaxEnchantingLevel();

<span class="gh">diff --git a/src/server/game/Guilds/Guild.cpp b/src/server/game/Guilds/Guild.cpp</span>
<span class="gh">index d38838121584be..86b3cc83295e09 100644</span>
<span class="gd">--- a/src/server/game/Guilds/Guild.cpp</span>
<span class="gi">+++ b/src/server/game/Guilds/Guild.cpp</span>
<span class="gu">@@ -44,48 +44,48 @@ std::string _GetGuildEventString(GuildEvents event)</span>
<span class="w"> </span>{
<span class="w"> </span>    switch (event)
<span class="w"> </span>    {
<span class="gd">-        case GE_PROMOTION:</span>
<span class="gd">-            return &quot;Member promotion&quot;;</span>
<span class="gd">-        case GE_DEMOTION:</span>
<span class="gd">-            return &quot;Member demotion&quot;;</span>
<span class="gd">-        case GE_MOTD:</span>
<span class="gd">-            return &quot;Guild MOTD&quot;;</span>
<span class="gd">-        case GE_JOINED:</span>
<span class="gd">-            return &quot;Member joined&quot;;</span>
<span class="gd">-        case GE_LEFT:</span>
<span class="gd">-            return &quot;Member left&quot;;</span>
<span class="gd">-        case GE_REMOVED:</span>
<span class="gd">-            return &quot;Member removed&quot;;</span>
<span class="gd">-        case GE_LEADER_IS:</span>
<span class="gd">-            return &quot;Leader is&quot;;</span>
<span class="gd">-        case GE_LEADER_CHANGED:</span>
<span class="gd">-            return &quot;Leader changed&quot;;</span>
<span class="gd">-        case GE_DISBANDED:</span>
<span class="gd">-            return &quot;Guild disbanded&quot;;</span>
<span class="gd">-        case GE_TABARDCHANGE:</span>
<span class="gd">-            return &quot;Tabard change&quot;;</span>
<span class="gd">-        case GE_RANK_UPDATED:</span>
<span class="gd">-            return &quot;Rank updated&quot;;</span>
<span class="gd">-        case GE_RANK_DELETED:</span>
<span class="gd">-            return &quot;Rank deleted&quot;;</span>
<span class="gd">-        case GE_SIGNED_ON:</span>
<span class="gd">-            return &quot;Member signed on&quot;;</span>
<span class="gd">-        case GE_SIGNED_OFF:</span>
<span class="gd">-            return &quot;Member signed off&quot;;</span>
<span class="gd">-        case GE_GUILDBANKBAGSLOTS_CHANGED:</span>
<span class="gd">-            return &quot;Bank bag slots changed&quot;;</span>
<span class="gd">-        case GE_BANK_TAB_PURCHASED:</span>
<span class="gd">-            return &quot;Bank tab purchased&quot;;</span>
<span class="gd">-        case GE_BANK_TAB_UPDATED:</span>
<span class="gd">-            return &quot;Bank tab updated&quot;;</span>
<span class="gd">-        case GE_BANK_MONEY_SET:</span>
<span class="gd">-            return &quot;Bank money set&quot;;</span>
<span class="gd">-        case GE_BANK_TAB_AND_MONEY_UPDATED:</span>
<span class="gd">-            return &quot;Bank and money updated&quot;;</span>
<span class="gd">-        case GE_BANK_TEXT_CHANGED:</span>
<span class="gd">-            return &quot;Bank tab text changed&quot;;</span>
<span class="gd">-        default:</span>
<span class="gd">-            break;</span>
<span class="gi">+    case GE_PROMOTION:</span>
<span class="gi">+        return &quot;Member promotion&quot;;</span>
<span class="gi">+    case GE_DEMOTION:</span>
<span class="gi">+        return &quot;Member demotion&quot;;</span>
<span class="gi">+    case GE_MOTD:</span>
<span class="gi">+        return &quot;Guild MOTD&quot;;</span>
<span class="gi">+    case GE_JOINED:</span>
<span class="gi">+        return &quot;Member joined&quot;;</span>
<span class="gi">+    case GE_LEFT:</span>
<span class="gi">+        return &quot;Member left&quot;;</span>
<span class="gi">+    case GE_REMOVED:</span>
<span class="gi">+        return &quot;Member removed&quot;;</span>
<span class="gi">+    case GE_LEADER_IS:</span>
<span class="gi">+        return &quot;Leader is&quot;;</span>
<span class="gi">+    case GE_LEADER_CHANGED:</span>
<span class="gi">+        return &quot;Leader changed&quot;;</span>
<span class="gi">+    case GE_DISBANDED:</span>
<span class="gi">+        return &quot;Guild disbanded&quot;;</span>
<span class="gi">+    case GE_TABARDCHANGE:</span>
<span class="gi">+        return &quot;Tabard change&quot;;</span>
<span class="gi">+    case GE_RANK_UPDATED:</span>
<span class="gi">+        return &quot;Rank updated&quot;;</span>
<span class="gi">+    case GE_RANK_DELETED:</span>
<span class="gi">+        return &quot;Rank deleted&quot;;</span>
<span class="gi">+    case GE_SIGNED_ON:</span>
<span class="gi">+        return &quot;Member signed on&quot;;</span>
<span class="gi">+    case GE_SIGNED_OFF:</span>
<span class="gi">+        return &quot;Member signed off&quot;;</span>
<span class="gi">+    case GE_GUILDBANKBAGSLOTS_CHANGED:</span>
<span class="gi">+        return &quot;Bank bag slots changed&quot;;</span>
<span class="gi">+    case GE_BANK_TAB_PURCHASED:</span>
<span class="gi">+        return &quot;Bank tab purchased&quot;;</span>
<span class="gi">+    case GE_BANK_TAB_UPDATED:</span>
<span class="gi">+        return &quot;Bank tab updated&quot;;</span>
<span class="gi">+    case GE_BANK_MONEY_SET:</span>
<span class="gi">+        return &quot;Bank money set&quot;;</span>
<span class="gi">+    case GE_BANK_TAB_AND_MONEY_UPDATED:</span>
<span class="gi">+        return &quot;Bank and money updated&quot;;</span>
<span class="gi">+    case GE_BANK_TEXT_CHANGED:</span>
<span class="gi">+        return &quot;Bank tab text changed&quot;;</span>
<span class="gi">+    default:</span>
<span class="gi">+        break;</span>
<span class="w"> </span>    }
<span class="w"> </span>    return &quot;&lt;None&gt;&quot;;
<span class="w"> </span>}
<span class="gu">@@ -94,20 +94,20 @@ inline uint32 _GetGuildBankTabPrice(uint8 tabId)</span>
<span class="w"> </span>{
<span class="w"> </span>    switch (tabId)
<span class="w"> </span>    {
<span class="gd">-        case 0:</span>
<span class="gd">-            return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_0);</span>
<span class="gd">-        case 1:</span>
<span class="gd">-            return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_1);</span>
<span class="gd">-        case 2:</span>
<span class="gd">-            return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_2);</span>
<span class="gd">-        case 3:</span>
<span class="gd">-            return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_3);</span>
<span class="gd">-        case 4:</span>
<span class="gd">-            return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_4);</span>
<span class="gd">-        case 5:</span>
<span class="gd">-            return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_5);</span>
<span class="gd">-        default:</span>
<span class="gd">-            return 0;</span>
<span class="gi">+    case 0:</span>
<span class="gi">+        return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_0);</span>
<span class="gi">+    case 1:</span>
<span class="gi">+        return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_1);</span>
<span class="gi">+    case 2:</span>
<span class="gi">+        return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_2);</span>
<span class="gi">+    case 3:</span>
<span class="gi">+        return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_3);</span>
<span class="gi">+    case 4:</span>
<span class="gi">+        return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_4);</span>
<span class="gi">+    case 5:</span>
<span class="gi">+        return sWorld-&gt;getIntConfig(CONFIG_GUILD_BANK_TAB_COST_5);</span>
<span class="gi">+    default:</span>
<span class="gi">+        return 0;</span>
<span class="w"> </span>    }
<span class="w"> </span>}

<span class="gu">@@ -134,8 +134,9 @@ void Guild::SendSaveEmblemResult(WorldSession* session, GuildEmblemError errCode</span>
<span class="w"> </span>// LogHolder
<span class="w"> </span>template &lt;typename Entry&gt;
<span class="w"> </span>Guild::LogHolder&lt;Entry&gt;::LogHolder()
<span class="gd">-        : m_maxRecords(sWorld-&gt;getIntConfig(std::is_same_v&lt;Entry, BankEventLogEntry&gt; ? CONFIG_GUILD_BANK_EVENT_LOG_COUNT : CONFIG_GUILD_EVENT_LOG_COUNT)), m_nextGUID(uint32(GUILD_EVENT_LOG_GUID_UNDEFINED))</span>
<span class="gd">-{ }</span>
<span class="gi">+    : m_maxRecords(sWorld-&gt;getIntConfig(std::is_same_v&lt;Entry, BankEventLogEntry&gt; ? CONFIG_GUILD_BANK_EVENT_LOG_COUNT : CONFIG_GUILD_EVENT_LOG_COUNT)), m_nextGUID(uint32(GUILD_EVENT_LOG_GUID_UNDEFINED))</span>
<span class="gi">+{</span>
<span class="gi">+}</span>

<span class="w"> </span>template &lt;typename Entry&gt; template &lt;typename... Ts&gt;
<span class="w"> </span>void Guild::LogHolder&lt;Entry&gt;::LoadEvent(Ts&amp;&amp;... args)
<span class="gu">@@ -173,7 +174,8 @@ inline uint32 Guild::LogHolder&lt;Entry&gt;::GetNextGUID()</span>
<span class="w"> </span>}

<span class="w"> </span>Guild::LogEntry::LogEntry(uint32 guildId, ObjectGuid::LowType guid) :
<span class="gd">-    m_guildId(guildId), m_guid(guid), m_timestamp(GameTime::GetGameTime().count()) { }</span>
<span class="gi">+    m_guildId(guildId), m_guid(guid), m_timestamp(GameTime::GetGameTime().count()) {</span>
<span class="gi">+}</span>

<span class="w"> </span>// EventLogEntry
<span class="w"> </span>void Guild::EventLogEntry::SaveToDB(CharacterDatabaseTransaction trans) const
<span class="gu">@@ -185,12 +187,12 @@ void Guild::EventLogEntry::SaveToDB(CharacterDatabaseTransaction trans) const</span>

<span class="w"> </span>    uint8 index = 0;
<span class="w"> </span>    stmt = CharacterDatabase.GetPreparedStatement(CHAR_INS_GUILD_EVENTLOG);
<span class="gd">-    stmt-&gt;SetData(  index, m_guildId);</span>
<span class="gi">+    stmt-&gt;SetData(index, m_guildId);</span>
<span class="w"> </span>    stmt-&gt;SetData(++index, m_guid);
<span class="gd">-    stmt-&gt;SetData (++index, uint8(m_eventType));</span>
<span class="gi">+    stmt-&gt;SetData(++index, uint8(m_eventType));</span>
<span class="w"> </span>    stmt-&gt;SetData(++index, m_playerGuid1.GetCounter());
<span class="w"> </span>    stmt-&gt;SetData(++index, m_playerGuid2.GetCounter());
<span class="gd">-    stmt-&gt;SetData (++index, m_newRank);</span>
<span class="gi">+    stmt-&gt;SetData(++index, m_newRank);</span>
<span class="w"> </span>    stmt-&gt;SetData(++index, m_timestamp);
<span class="w"> </span>    CharacterDatabase.ExecuteOrAppend(trans, stmt);
<span class="w"> </span>}
<span class="gu">@@ -215,21 +217,21 @@ void Guild::BankEventLogEntry::SaveToDB(CharacterDatabaseTransaction trans) cons</span>
<span class="w"> </span>    uint8 index = 0;

<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_DEL_GUILD_BANK_EVENTLOG);
<span class="gd">-    stmt-&gt;SetData(  index, m_guildId);</span>
<span class="gi">+    stmt-&gt;SetData(index, m_guildId);</span>
<span class="w"> </span>    stmt-&gt;SetData(++index, m_guid);
<span class="gd">-    stmt-&gt;SetData (++index, m_bankTabId);</span>
<span class="gi">+    stmt-&gt;SetData(++index, m_bankTabId);</span>
<span class="w"> </span>    CharacterDatabase.ExecuteOrAppend(trans, stmt);

<span class="w"> </span>    index = 0;
<span class="w"> </span>    stmt = CharacterDatabase.GetPreparedStatement(CHAR_INS_GUILD_BANK_EVENTLOG);
<span class="gd">-    stmt-&gt;SetData(  index, m_guildId);</span>
<span class="gi">+    stmt-&gt;SetData(index, m_guildId);</span>
<span class="w"> </span>    stmt-&gt;SetData(++index, m_guid);
<span class="gd">-    stmt-&gt;SetData (++index, m_bankTabId);</span>
<span class="gd">-    stmt-&gt;SetData (++index, uint8(m_eventType));</span>
<span class="gi">+    stmt-&gt;SetData(++index, m_bankTabId);</span>
<span class="gi">+    stmt-&gt;SetData(++index, uint8(m_eventType));</span>
<span class="w"> </span>    stmt-&gt;SetData(++index, m_playerGuid.GetCounter());
<span class="w"> </span>    stmt-&gt;SetData(++index, m_itemOrMoney);
<span class="w"> </span>    stmt-&gt;SetData(++index, m_itemStackCount);
<span class="gd">-    stmt-&gt;SetData (++index, m_destTabId);</span>
<span class="gi">+    stmt-&gt;SetData(++index, m_destTabId);</span>
<span class="w"> </span>    stmt-&gt;SetData(++index, m_timestamp);
<span class="w"> </span>    CharacterDatabase.ExecuteOrAppend(trans, stmt);
<span class="w"> </span>}
<span class="gu">@@ -243,19 +245,19 @@ void Guild::BankEventLogEntry::WritePacket(WorldPackets::Guild::GuildBankLogQuer</span>

<span class="w"> </span>    switch (m_eventType)
<span class="w"> </span>    {
<span class="gd">-        case GUILD_BANK_LOG_DEPOSIT_ITEM:</span>
<span class="gd">-        case GUILD_BANK_LOG_WITHDRAW_ITEM:</span>
<span class="gd">-            bankLogEntry.ItemID = int32(m_itemOrMoney);</span>
<span class="gd">-            bankLogEntry.Count = int32(m_itemStackCount);</span>
<span class="gd">-            break;</span>
<span class="gd">-        case GUILD_BANK_LOG_MOVE_ITEM:</span>
<span class="gd">-        case GUILD_BANK_LOG_MOVE_ITEM2:</span>
<span class="gd">-            bankLogEntry.ItemID = int32(m_itemOrMoney);</span>
<span class="gd">-            bankLogEntry.Count = int32(m_itemStackCount);</span>
<span class="gd">-            bankLogEntry.OtherTab = int8(m_destTabId);</span>
<span class="gd">-            break;</span>
<span class="gd">-        default:</span>
<span class="gd">-            bankLogEntry.Money = uint32(m_itemOrMoney);</span>
<span class="gi">+    case GUILD_BANK_LOG_DEPOSIT_ITEM:</span>
<span class="gi">+    case GUILD_BANK_LOG_WITHDRAW_ITEM:</span>
<span class="gi">+        bankLogEntry.ItemID = int32(m_itemOrMoney);</span>
<span class="gi">+        bankLogEntry.Count = int32(m_itemStackCount);</span>
<span class="gi">+        break;</span>
<span class="gi">+    case GUILD_BANK_LOG_MOVE_ITEM:</span>
<span class="gi">+    case GUILD_BANK_LOG_MOVE_ITEM2:</span>
<span class="gi">+        bankLogEntry.ItemID = int32(m_itemOrMoney);</span>
<span class="gi">+        bankLogEntry.Count = int32(m_itemStackCount);</span>
<span class="gi">+        bankLogEntry.OtherTab = int8(m_destTabId);</span>
<span class="gi">+        break;</span>
<span class="gi">+    default:</span>
<span class="gi">+        bankLogEntry.Money = uint32(m_itemOrMoney);</span>
<span class="w"> </span>    }

<span class="w"> </span>    packet.Entry.push_back(bankLogEntry);
<span class="gu">@@ -264,10 +266,10 @@ void Guild::BankEventLogEntry::WritePacket(WorldPackets::Guild::GuildBankLogQuer</span>
<span class="w"> </span>// RankInfo
<span class="w"> </span>void Guild::RankInfo::LoadFromDB(Field* fields)
<span class="w"> </span>{
<span class="gd">-    m_rankId            = fields[1].Get&lt;uint8&gt;();</span>
<span class="gd">-    m_name              = fields[2].Get&lt;std::string&gt;();</span>
<span class="gd">-    m_rights            = fields[3].Get&lt;uint32&gt;();</span>
<span class="gd">-    m_bankMoneyPerDay   = fields[4].Get&lt;uint32&gt;();</span>
<span class="gi">+    m_rankId = fields[1].Get&lt;uint8&gt;();</span>
<span class="gi">+    m_name = fields[2].Get&lt;std::string&gt;();</span>
<span class="gi">+    m_rights = fields[3].Get&lt;uint32&gt;();</span>
<span class="gi">+    m_bankMoneyPerDay = fields[4].Get&lt;uint32&gt;();</span>
<span class="w"> </span>    if (m_rankId == GR_GUILDMASTER)                     // Prevent loss of leader rights
<span class="w"> </span>        m_rights |= GR_RIGHT_ALL;
<span class="w"> </span>}
<span class="gu">@@ -276,7 +278,7 @@ void Guild::RankInfo::SaveToDB(CharacterDatabaseTransaction trans) const</span>
<span class="w"> </span>{
<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_INS_GUILD_RANK);
<span class="w"> </span>    stmt-&gt;SetData(0, m_guildId);
<span class="gd">-    stmt-&gt;SetData (1, m_rankId);</span>
<span class="gi">+    stmt-&gt;SetData(1, m_rankId);</span>
<span class="w"> </span>    stmt-&gt;SetData(2, m_name);
<span class="w"> </span>    stmt-&gt;SetData(3, m_rights);
<span class="w"> </span>    stmt-&gt;SetData(4, m_bankMoneyPerDay);
<span class="gu">@@ -317,7 +319,7 @@ void Guild::RankInfo::SetName(std::string_view name)</span>

<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_UPD_GUILD_RANK_NAME);
<span class="w"> </span>    stmt-&gt;SetData(0, m_name);
<span class="gd">-    stmt-&gt;SetData (1, m_rankId);</span>
<span class="gi">+    stmt-&gt;SetData(1, m_rankId);</span>
<span class="w"> </span>    stmt-&gt;SetData(2, m_guildId);
<span class="w"> </span>    CharacterDatabase.Execute(stmt);
<span class="w"> </span>}
<span class="gu">@@ -334,7 +336,7 @@ void Guild::RankInfo::SetRights(uint32 rights)</span>

<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_UPD_GUILD_RANK_RIGHTS);
<span class="w"> </span>    stmt-&gt;SetData(0, m_rights);
<span class="gd">-    stmt-&gt;SetData (1, m_rankId);</span>
<span class="gi">+    stmt-&gt;SetData(1, m_rankId);</span>
<span class="w"> </span>    stmt-&gt;SetData(2, m_guildId);
<span class="w"> </span>    CharacterDatabase.Execute(stmt);
<span class="w"> </span>}
<span class="gu">@@ -351,7 +353,7 @@ void Guild::RankInfo::SetBankMoneyPerDay(uint32 money)</span>

<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_UPD_GUILD_RANK_BANK_MONEY);
<span class="w"> </span>    stmt-&gt;SetData(0, money);
<span class="gd">-    stmt-&gt;SetData (1, m_rankId);</span>
<span class="gi">+    stmt-&gt;SetData(1, m_rankId);</span>
<span class="w"> </span>    stmt-&gt;SetData(2, m_guildId);
<span class="w"> </span>    CharacterDatabase.Execute(stmt);
<span class="w"> </span>}
<span class="gu">@@ -368,9 +370,9 @@ void Guild::RankInfo::SetBankTabSlotsAndRights(GuildBankRightsAndSlots rightsAnd</span>
<span class="w"> </span>    {
<span class="w"> </span>        CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_INS_GUILD_BANK_RIGHT);
<span class="w"> </span>        stmt-&gt;SetData(0, m_guildId);
<span class="gd">-        stmt-&gt;SetData (1, guildBR.GetTabId());</span>
<span class="gd">-        stmt-&gt;SetData (2, m_rankId);</span>
<span class="gd">-        stmt-&gt;SetData (3, guildBR.GetRights());</span>
<span class="gi">+        stmt-&gt;SetData(1, guildBR.GetTabId());</span>
<span class="gi">+        stmt-&gt;SetData(2, m_rankId);</span>
<span class="gi">+        stmt-&gt;SetData(3, guildBR.GetRights());</span>
<span class="w"> </span>        stmt-&gt;SetData(4, guildBR.GetSlots());
<span class="w"> </span>        CharacterDatabase.Execute(stmt);
<span class="w"> </span>    }
<span class="gu">@@ -409,8 +411,8 @@ bool Guild::BankTab::LoadItemFromDB(Field* fields)</span>

<span class="w"> </span>        CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_DEL_NONEXISTENT_GUILD_BANK_ITEM);
<span class="w"> </span>        stmt-&gt;SetData(0, m_guildId);
<span class="gd">-        stmt-&gt;SetData (1, m_tabId);</span>
<span class="gd">-        stmt-&gt;SetData (2, slotId);</span>
<span class="gi">+        stmt-&gt;SetData(1, m_tabId);</span>
<span class="gi">+        stmt-&gt;SetData(2, slotId);</span>
<span class="w"> </span>        CharacterDatabase.Execute(stmt);

<span class="w"> </span>        delete pItem;
<span class="gu">@@ -448,7 +450,7 @@ void Guild::BankTab::SetInfo(std::string_view name, std::string_view icon)</span>
<span class="w"> </span>    stmt-&gt;SetData(0, m_name);
<span class="w"> </span>    stmt-&gt;SetData(1, m_icon);
<span class="w"> </span>    stmt-&gt;SetData(2, m_guildId);
<span class="gd">-    stmt-&gt;SetData (3, m_tabId);</span>
<span class="gi">+    stmt-&gt;SetData(3, m_tabId);</span>
<span class="w"> </span>    CharacterDatabase.Execute(stmt);
<span class="w"> </span>}

<span class="gu">@@ -463,7 +465,7 @@ void Guild::BankTab::SetText(std::string_view text)</span>
<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_UPD_GUILD_BANK_TAB_TEXT);
<span class="w"> </span>    stmt-&gt;SetData(0, m_text);
<span class="w"> </span>    stmt-&gt;SetData(1, m_guildId);
<span class="gd">-    stmt-&gt;SetData (2, m_tabId);</span>
<span class="gi">+    stmt-&gt;SetData(2, m_tabId);</span>
<span class="w"> </span>    CharacterDatabase.Execute(stmt);
<span class="w"> </span>}

<span class="gu">@@ -478,16 +480,16 @@ bool Guild::BankTab::SetItem(CharacterDatabaseTransaction trans, uint8 slotId, I</span>

<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_DEL_GUILD_BANK_ITEM);
<span class="w"> </span>    stmt-&gt;SetData(0, m_guildId);
<span class="gd">-    stmt-&gt;SetData (1, m_tabId);</span>
<span class="gd">-    stmt-&gt;SetData (2, slotId);</span>
<span class="gi">+    stmt-&gt;SetData(1, m_tabId);</span>
<span class="gi">+    stmt-&gt;SetData(2, slotId);</span>
<span class="w"> </span>    CharacterDatabase.ExecuteOrAppend(trans, stmt);

<span class="w"> </span>    if (item)
<span class="w"> </span>    {
<span class="w"> </span>        stmt = CharacterDatabase.GetPreparedStatement(CHAR_INS_GUILD_BANK_ITEM);
<span class="w"> </span>        stmt-&gt;SetData(0, m_guildId);
<span class="gd">-        stmt-&gt;SetData (1, m_tabId);</span>
<span class="gd">-        stmt-&gt;SetData (2, slotId);</span>
<span class="gi">+        stmt-&gt;SetData(1, m_tabId);</span>
<span class="gi">+        stmt-&gt;SetData(2, slotId);</span>
<span class="w"> </span>        stmt-&gt;SetData(3, item-&gt;GetGUID().GetCounter());
<span class="w"> </span>        CharacterDatabase.ExecuteOrAppend(trans, stmt);

<span class="gu">@@ -508,7 +510,7 @@ void Guild::BankTab::SendText(Guild const* guild, WorldSession* session) const</span>
<span class="w"> </span>    if (session)
<span class="w"> </span>    {
<span class="w"> </span>        LOG_DEBUG(&quot;guild&quot;, &quot;MSG_QUERY_GUILD_BANK_TEXT [{}]: Tabid: {}, Text: {}&quot;
<span class="gd">-                       , session-&gt;GetPlayerInfo(), m_tabId, m_text);</span>
<span class="gi">+            , session-&gt;GetPlayerInfo(), m_tabId, m_text);</span>
<span class="w"> </span>        session-&gt;SendPacket(textQuery.Write());
<span class="w"> </span>    }
<span class="w"> </span>    else
<span class="gu">@@ -521,21 +523,21 @@ void Guild::BankTab::SendText(Guild const* guild, WorldSession* session) const</span>
<span class="w"> </span>// Member
<span class="w"> </span>void Guild::Member::SetStats(Player* player)
<span class="w"> </span>{
<span class="gd">-    m_name      = player-&gt;GetName();</span>
<span class="gd">-    m_level     = player-&gt;GetLevel();</span>
<span class="gd">-    m_class     = player-&gt;getClass();</span>
<span class="gd">-    m_gender    = player-&gt;getGender();</span>
<span class="gd">-    m_zoneId    = player-&gt;GetZoneId();</span>
<span class="gi">+    m_name = player-&gt;GetName();</span>
<span class="gi">+    m_level = player-&gt;GetLevel();</span>
<span class="gi">+    m_class = player-&gt;getClass();</span>
<span class="gi">+    m_gender = player-&gt;getGender();</span>
<span class="gi">+    m_zoneId = player-&gt;GetZoneId();</span>
<span class="w"> </span>    m_accountId = player-&gt;GetSession()-&gt;GetAccountId();
<span class="w"> </span>}

<span class="w"> </span>void Guild::Member::SetStats(std::string_view name, uint8 level, uint8 _class, uint8 gender, uint32 zoneId, uint32 accountId)
<span class="w"> </span>{
<span class="gd">-    m_name      = name;</span>
<span class="gd">-    m_level     = level;</span>
<span class="gd">-    m_class     = _class;</span>
<span class="gd">-    m_gender    = gender;</span>
<span class="gd">-    m_zoneId    = zoneId;</span>
<span class="gi">+    m_name = name;</span>
<span class="gi">+    m_level = level;</span>
<span class="gi">+    m_class = _class;</span>
<span class="gi">+    m_gender = gender;</span>
<span class="gi">+    m_zoneId = zoneId;</span>
<span class="w"> </span>    m_accountId = accountId;
<span class="w"> </span>}

<span class="gu">@@ -574,7 +576,7 @@ void Guild::Member::ChangeRank(uint8 newRank)</span>
<span class="w"> </span>        player-&gt;SetRank(newRank);

<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_UPD_GUILD_MEMBER_RANK);
<span class="gd">-    stmt-&gt;SetData (0, newRank);</span>
<span class="gi">+    stmt-&gt;SetData(0, newRank);</span>
<span class="w"> </span>    stmt-&gt;SetData(1, m_guid.GetCounter());
<span class="w"> </span>    CharacterDatabase.Execute(stmt);
<span class="w"> </span>}
<span class="gu">@@ -589,7 +591,7 @@ void Guild::Member::SaveToDB(CharacterDatabaseTransaction trans) const</span>
<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_INS_GUILD_MEMBER);
<span class="w"> </span>    stmt-&gt;SetData(0, m_guildId);
<span class="w"> </span>    stmt-&gt;SetData(1, m_guid.GetCounter());
<span class="gd">-    stmt-&gt;SetData (2, m_rankId);</span>
<span class="gi">+    stmt-&gt;SetData(2, m_rankId);</span>
<span class="w"> </span>    stmt-&gt;SetData(3, m_publicNote);
<span class="w"> </span>    stmt-&gt;SetData(4, m_officerNote);
<span class="w"> </span>    CharacterDatabase.ExecuteOrAppend(trans, stmt);
<span class="gu">@@ -600,18 +602,18 @@ void Guild::Member::SaveToDB(CharacterDatabaseTransaction trans) const</span>
<span class="w"> </span>// In this case member has to be removed from guild.
<span class="w"> </span>bool Guild::Member::LoadFromDB(Field* fields)
<span class="w"> </span>{
<span class="gd">-    m_publicNote  = fields[3].Get&lt;std::string&gt;();</span>
<span class="gi">+    m_publicNote = fields[3].Get&lt;std::string&gt;();</span>
<span class="w"> </span>    m_officerNote = fields[4].Get&lt;std::string&gt;();

<span class="w"> </span>    for (uint8 i = 0; i &lt;= GUILD_BANK_MAX_TABS; ++i)
<span class="w"> </span>        m_bankWithdraw[i] = fields[5 + i].Get&lt;uint32&gt;();

<span class="w"> </span>    SetStats(fields[12].Get&lt;std::string&gt;(),
<span class="gd">-             fields[13].Get&lt;uint8&gt;(),                         // characters.level</span>
<span class="gd">-             fields[14].Get&lt;uint8&gt;(),                         // characters.class</span>
<span class="gd">-             fields[15].Get&lt;uint8&gt;(),                         // characters.gender</span>
<span class="gd">-             fields[16].Get&lt;uint16&gt;(),                        // characters.zone</span>
<span class="gd">-             fields[17].Get&lt;uint32&gt;());                       // characters.account</span>
<span class="gi">+        fields[13].Get&lt;uint8&gt;(),                         // characters.level</span>
<span class="gi">+        fields[14].Get&lt;uint8&gt;(),                         // characters.class</span>
<span class="gi">+        fields[15].Get&lt;uint8&gt;(),                         // characters.gender</span>
<span class="gi">+        fields[16].Get&lt;uint16&gt;(),                        // characters.zone</span>
<span class="gi">+        fields[17].Get&lt;uint32&gt;());                       // characters.account</span>
<span class="w"> </span>    m_logoutTime = fields[18].Get&lt;uint32&gt;();                  // characters.logout_time

<span class="w"> </span>    if (!CheckStats())
<span class="gu">@@ -691,11 +693,11 @@ void EmblemInfo::ReadPacket(WorldPackets::Guild::SaveGuildEmblem&amp; packet)</span>

<span class="w"> </span>void EmblemInfo::LoadFromDB(Field* fields)
<span class="w"> </span>{
<span class="gd">-    m_style             = fields[3].Get&lt;uint8&gt;();</span>
<span class="gd">-    m_color             = fields[4].Get&lt;uint8&gt;();</span>
<span class="gd">-    m_borderStyle       = fields[5].Get&lt;uint8&gt;();</span>
<span class="gd">-    m_borderColor       = fields[6].Get&lt;uint8&gt;();</span>
<span class="gd">-    m_backgroundColor   = fields[7].Get&lt;uint8&gt;();</span>
<span class="gi">+    m_style = fields[3].Get&lt;uint8&gt;();</span>
<span class="gi">+    m_color = fields[4].Get&lt;uint8&gt;();</span>
<span class="gi">+    m_borderStyle = fields[5].Get&lt;uint8&gt;();</span>
<span class="gi">+    m_borderColor = fields[6].Get&lt;uint8&gt;();</span>
<span class="gi">+    m_backgroundColor = fields[7].Get&lt;uint8&gt;();</span>
<span class="w"> </span>}

<span class="w"> </span>void EmblemInfo::SaveToDB(uint32 guildId) const
<span class="gu">@@ -747,8 +749,8 @@ void Guild::MoveItemData::LogAction(MoveItemData* pFrom) const</span>
<span class="w"> </span>    ASSERT(pFrom-&gt;GetItem());

<span class="w"> </span>    sScriptMgr-&gt;OnGuildItemMove(m_pGuild, m_pPlayer, pFrom-&gt;GetItem(),
<span class="gd">-                                pFrom-&gt;IsBank(), pFrom-&gt;GetContainer(), pFrom-&gt;GetSlotId(),</span>
<span class="gd">-                                IsBank(), GetContainer(), GetSlotId());</span>
<span class="gi">+        pFrom-&gt;IsBank(), pFrom-&gt;GetContainer(), pFrom-&gt;GetSlotId(),</span>
<span class="gi">+        IsBank(), GetContainer(), GetSlotId());</span>
<span class="w"> </span>}

<span class="w"> </span>inline void Guild::MoveItemData::CopySlots(SlotIds&amp; ids) const
<span class="gu">@@ -808,7 +810,7 @@ void Guild::PlayerMoveItemData::LogBankEvent(CharacterDatabaseTransaction trans,</span>
<span class="w"> </span>    ASSERT(pFrom);
<span class="w"> </span>    // Bank -&gt; Char
<span class="w"> </span>    m_pGuild-&gt;_LogBankEvent(trans, GUILD_BANK_LOG_WITHDRAW_ITEM, pFrom-&gt;GetContainer(), m_pPlayer-&gt;GetGUID(),
<span class="gd">-                            pFrom-&gt;GetItem()-&gt;GetEntry(), count);</span>
<span class="gi">+        pFrom-&gt;GetItem()-&gt;GetEntry(), count);</span>
<span class="w"> </span>}

<span class="w"> </span>inline InventoryResult Guild::PlayerMoveItemData::CanStore(Item* pItem, bool swap)
<span class="gu">@@ -829,7 +831,7 @@ bool Guild::BankMoveItemData::HasStoreRights(MoveItemData* pOther) const</span>
<span class="w"> </span>    // Do not check rights if item is being swapped within the same bank tab
<span class="w"> </span>    if (pOther-&gt;IsBank() &amp;&amp; pOther-&gt;GetContainer() == m_container)
<span class="w"> </span>        return true;
<span class="gd">-    return m_pGuild-&gt;_MemberHasTabRights(m_pPlayer-&gt;GetGUID(), m_container, GUILD_BANK_RIGHT_DEPOSIT_ITEM);</span>
<span class="gi">+    return m_pGuild-&gt;MemberHasTabRights(m_pPlayer-&gt;GetGUID(), m_container, GUILD_BANK_RIGHT_DEPOSIT_ITEM);</span>
<span class="w"> </span>}

<span class="w"> </span>bool Guild::BankMoveItemData::HasWithdrawRights(MoveItemData* pOther) const
<span class="gu">@@ -881,7 +883,7 @@ Item* Guild::BankMoveItemData::StoreItem(CharacterDatabaseTransaction trans, Ite</span>
<span class="w"> </span>        ++itr;

<span class="w"> </span>        LOG_DEBUG(&quot;guild&quot;, &quot;GUILD STORAGE: StoreItem tab = {}, slot = {}, item = {}, count = {}&quot;,
<span class="gd">-                       m_container, m_slotId, pItem-&gt;GetEntry(), pItem-&gt;GetCount());</span>
<span class="gi">+            m_container, m_slotId, pItem-&gt;GetEntry(), pItem-&gt;GetCount());</span>
<span class="w"> </span>        pLastItem = _StoreItem(trans, pTab, pItem, pos, itr != m_vec.end());
<span class="w"> </span>    }
<span class="w"> </span>    return pLastItem;
<span class="gu">@@ -893,11 +895,11 @@ void Guild::BankMoveItemData::LogBankEvent(CharacterDatabaseTransaction trans, M</span>
<span class="w"> </span>    if (pFrom-&gt;IsBank())
<span class="w"> </span>        // Bank -&gt; Bank
<span class="w"> </span>        m_pGuild-&gt;_LogBankEvent(trans, GUILD_BANK_LOG_MOVE_ITEM, pFrom-&gt;GetContainer(), m_pPlayer-&gt;GetGUID(),
<span class="gd">-                                pFrom-&gt;GetItem()-&gt;GetEntry(), count, m_container);</span>
<span class="gi">+            pFrom-&gt;GetItem()-&gt;GetEntry(), count, m_container);</span>
<span class="w"> </span>    else
<span class="w"> </span>        // Char -&gt; Bank
<span class="w"> </span>        m_pGuild-&gt;_LogBankEvent(trans, GUILD_BANK_LOG_DEPOSIT_ITEM, m_container, m_pPlayer-&gt;GetGUID(),
<span class="gd">-                                pFrom-&gt;GetItem()-&gt;GetEntry(), count);</span>
<span class="gi">+            pFrom-&gt;GetItem()-&gt;GetEntry(), count);</span>
<span class="w"> </span>}

<span class="w"> </span>void Guild::BankMoveItemData::LogAction(MoveItemData* pFrom) const
<span class="gu">@@ -984,7 +986,7 @@ void Guild::BankMoveItemData::CanStoreItemInTab(Item* pItem, uint8 skipSlotId, b</span>
<span class="w"> </span>InventoryResult Guild::BankMoveItemData::CanStore(Item* pItem, bool swap)
<span class="w"> </span>{
<span class="w"> </span>    LOG_DEBUG(&quot;guild&quot;, &quot;GUILD STORAGE: CanStore() tab = {}, slot = {}, item = {}, count = {}&quot;,
<span class="gd">-                   m_container, m_slotId, pItem-&gt;GetEntry(), pItem-&gt;GetCount());</span>
<span class="gi">+        m_container, m_slotId, pItem-&gt;GetEntry(), pItem-&gt;GetCount());</span>
<span class="w"> </span>    uint32 count = pItem-&gt;GetCount();
<span class="w"> </span>    // Soulbound items cannot be moved
<span class="w"> </span>    if (pItem-&gt;IsSoulBound())
<span class="gu">@@ -1031,7 +1033,7 @@ InventoryResult Guild::BankMoveItemData::CanStore(Item* pItem, bool swap)</span>
<span class="w"> </span>}

<span class="w"> </span>// Guild
<span class="gd">-Guild::Guild():</span>
<span class="gi">+Guild::Guild() :</span>
<span class="w"> </span>    m_id(0),
<span class="w"> </span>    m_createdDate(0),
<span class="w"> </span>    m_accountsNumber(0),
<span class="gu">@@ -1065,7 +1067,7 @@ bool Guild::Create(Player* pLeader, std::string_view name)</span>
<span class="w"> </span>    m_createdDate = GameTime::GetGameTime().count();

<span class="w"> </span>    LOG_DEBUG(&quot;guild&quot;, &quot;GUILD: creating guild [{}] for leader {} ({})&quot;,
<span class="gd">-              m_name, pLeader-&gt;GetName(), m_leaderGuid.ToString());</span>
<span class="gi">+        m_name, pLeader-&gt;GetName(), m_leaderGuid.ToString());</span>

<span class="w"> </span>    CharacterDatabaseTransaction trans = CharacterDatabase.BeginTransaction();

<span class="gu">@@ -1075,7 +1077,7 @@ bool Guild::Create(Player* pLeader, std::string_view name)</span>

<span class="w"> </span>    uint8 index = 0;
<span class="w"> </span>    stmt = CharacterDatabase.GetPreparedStatement(CHAR_INS_GUILD);
<span class="gd">-    stmt-&gt;SetData(  index, m_id);</span>
<span class="gi">+    stmt-&gt;SetData(index, m_id);</span>
<span class="w"> </span>    stmt-&gt;SetData(++index, m_name);
<span class="w"> </span>    stmt-&gt;SetData(++index, m_leaderGuid.GetCounter());
<span class="w"> </span>    stmt-&gt;SetData(++index, m_info);
<span class="gu">@@ -1161,15 +1163,15 @@ void Guild::UpdateMemberData(Player* player, uint8 dataid, uint32 value)</span>
<span class="w"> </span>    {
<span class="w"> </span>        switch (dataid)
<span class="w"> </span>        {
<span class="gd">-            case GUILD_MEMBER_DATA_ZONEID:</span>
<span class="gd">-                member-&gt;SetZoneID(value);</span>
<span class="gd">-                break;</span>
<span class="gd">-            case GUILD_MEMBER_DATA_LEVEL:</span>
<span class="gd">-                member-&gt;SetLevel(value);</span>
<span class="gd">-                break;</span>
<span class="gd">-            default:</span>
<span class="gd">-                LOG_ERROR(&quot;guild&quot;, &quot;Guild::UpdateMemberData: Called with incorrect DATAID {} (value {})&quot;, dataid, value);</span>
<span class="gd">-                return;</span>
<span class="gi">+        case GUILD_MEMBER_DATA_ZONEID:</span>
<span class="gi">+            member-&gt;SetZoneID(value);</span>
<span class="gi">+            break;</span>
<span class="gi">+        case GUILD_MEMBER_DATA_LEVEL:</span>
<span class="gi">+            member-&gt;SetLevel(value);</span>
<span class="gi">+            break;</span>
<span class="gi">+        default:</span>
<span class="gi">+            LOG_ERROR(&quot;guild&quot;, &quot;Guild::UpdateMemberData: Called with incorrect DATAID {} (value {})&quot;, dataid, value);</span>
<span class="gi">+            return;</span>
<span class="w"> </span>        }
<span class="w"> </span>        //HandleRoster();
<span class="w"> </span>    }
<span class="gu">@@ -1207,7 +1209,7 @@ void Guild::HandleRoster(WorldSession* session)</span>
<span class="w"> </span>    roster.RankData.reserve(m_ranks.size());
<span class="w"> </span>    for (RankInfo const&amp; rank : m_ranks)
<span class="w"> </span>    {
<span class="gd">-        WorldPackets::Guild::GuildRankData&amp; rankData =  roster.RankData.emplace_back();</span>
<span class="gi">+        WorldPackets::Guild::GuildRankData&amp; rankData = roster.RankData.emplace_back();</span>

<span class="w"> </span>        rankData.Flags = rank.GetRights();
<span class="w"> </span>        rankData.WithdrawGoldLimit = rank.GetBankMoneyPerDay();
<span class="gu">@@ -1218,7 +1220,7 @@ void Guild::HandleRoster(WorldSession* session)</span>
<span class="w"> </span>        }
<span class="w"> </span>    }

<span class="gd">-    bool sendOfficerNote = _HasRankRight(session-&gt;GetPlayer(), GR_RIGHT_VIEWOFFNOTE);</span>
<span class="gi">+    bool sendOfficerNote = HasRankRight(session-&gt;GetPlayer(), GR_RIGHT_VIEWOFFNOTE);</span>
<span class="w"> </span>    roster.MemberData.reserve(m_members.size());
<span class="w"> </span>    for (auto const&amp; [guid, member] : m_members)
<span class="w"> </span>    {
<span class="gu">@@ -1275,7 +1277,7 @@ void Guild::HandleSetMOTD(WorldSession* session, std::string_view motd)</span>
<span class="w"> </span>        return;

<span class="w"> </span>    // Player must have rights to set MOTD
<span class="gd">-    if (!_HasRankRight(session-&gt;GetPlayer(), GR_RIGHT_SETMOTD))</span>
<span class="gi">+    if (!HasRankRight(session-&gt;GetPlayer(), GR_RIGHT_SETMOTD))</span>
<span class="w"> </span>        SendCommandResult(session, GUILD_COMMAND_EDIT_MOTD, ERR_GUILD_PERMISSIONS);
<span class="w"> </span>    else
<span class="w"> </span>    {
<span class="gu">@@ -1298,7 +1300,7 @@ void Guild::HandleSetInfo(WorldSession* session, std::string_view info)</span>
<span class="w"> </span>        return;

<span class="w"> </span>    // Player must have rights to set guild&#39;s info
<span class="gd">-    if (_HasRankRight(session-&gt;GetPlayer(), GR_RIGHT_MODIFY_GUILD_INFO))</span>
<span class="gi">+    if (HasRankRight(session-&gt;GetPlayer(), GR_RIGHT_MODIFY_GUILD_INFO))</span>
<span class="w"> </span>    {
<span class="w"> </span>        m_info = info;

<span class="gu">@@ -1331,6 +1333,12 @@ void Guild::HandleSetEmblem(WorldSession* session, const EmblemInfo&amp; emblemInfo)</span>
<span class="w"> </span>    }
<span class="w"> </span>}

<span class="gi">+void Guild::HandleSetEmblem(EmblemInfo const&amp; emblemInfo)</span>
<span class="gi">+{</span>
<span class="gi">+    m_emblemInfo = emblemInfo;</span>
<span class="gi">+    m_emblemInfo.SaveToDB(m_id);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>void Guild::HandleSetLeader(WorldSession* session, std::string_view name)
<span class="w"> </span>{
<span class="w"> </span>    Player* player = session-&gt;GetPlayer();
<span class="gu">@@ -1356,7 +1364,7 @@ void Guild::HandleSetBankTabInfo(WorldSession* session, uint8 tabId, std::string</span>
<span class="w"> </span>    if (!tab)
<span class="w"> </span>    {
<span class="w"> </span>        LOG_ERROR(&quot;guild&quot;, &quot;Guild::HandleSetBankTabInfo: Player {} trying to change bank tab info from unexisting tab {}.&quot;,
<span class="gd">-                       session-&gt;GetPlayerInfo(), tabId);</span>
<span class="gi">+            session-&gt;GetPlayerInfo(), tabId);</span>
<span class="w"> </span>        return;
<span class="w"> </span>    }

<span class="gu">@@ -1367,7 +1375,7 @@ void Guild::HandleSetBankTabInfo(WorldSession* session, uint8 tabId, std::string</span>
<span class="w"> </span>void Guild::HandleSetMemberNote(WorldSession* session, std::string_view name, std::string_view note, bool isPublic)
<span class="w"> </span>{
<span class="w"> </span>    // Player must have rights to set public/officer note
<span class="gd">-    if (!_HasRankRight(session-&gt;GetPlayer(), isPublic ? GR_RIGHT_EPNOTE : GR_RIGHT_EOFFNOTE))</span>
<span class="gi">+    if (!HasRankRight(session-&gt;GetPlayer(), isPublic ? GR_RIGHT_EPNOTE : GR_RIGHT_EOFFNOTE))</span>
<span class="w"> </span>        SendCommandResult(session, GUILD_COMMAND_PUBLIC_NOTE, ERR_GUILD_PERMISSIONS);
<span class="w"> </span>    else if (Member* member = GetMember(name))
<span class="w"> </span>    {
<span class="gu">@@ -1400,6 +1408,29 @@ void Guild::HandleSetRankInfo(WorldSession* session, uint8 rankId, std::string_v</span>
<span class="w"> </span>    }
<span class="w"> </span>}

<span class="gi">+void Guild::HandleSetRankInfo(uint8 rankId, uint32 rights, std::string_view name, uint32 moneyPerDay)</span>
<span class="gi">+{</span>
<span class="gi">+    if (RankInfo* rankInfo = GetRankInfo(rankId))</span>
<span class="gi">+    {</span>
<span class="gi">+        if (!name.empty())</span>
<span class="gi">+        {</span>
<span class="gi">+            rankInfo-&gt;SetName(name);</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        if (rights &gt; 0)</span>
<span class="gi">+        {</span>
<span class="gi">+            rankInfo-&gt;SetRights(rights);</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        if (moneyPerDay &gt; 0)</span>
<span class="gi">+        {</span>
<span class="gi">+            _SetRankBankMoneyPerDay(rankId, moneyPerDay);</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        _BroadcastEvent(GE_RANK_UPDATED, ObjectGuid::Empty, std::to_string(rankId), rankInfo-&gt;GetName(), std::to_string(m_ranks.size()));</span>
<span class="gi">+    }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>void Guild::HandleBuyBankTab(WorldSession* session, uint8 tabId)
<span class="w"> </span>{
<span class="w"> </span>    Player* player = session-&gt;GetPlayer();
<span class="gu">@@ -1470,7 +1501,7 @@ void Guild::HandleInviteMember(WorldSession* session, std::string const&amp; name)</span>
<span class="w"> </span>        return;
<span class="w"> </span>    }
<span class="w"> </span>    // Inviting player must have rights to invite
<span class="gd">-    if (!_HasRankRight(player, GR_RIGHT_INVITE))</span>
<span class="gi">+    if (!HasRankRight(player, GR_RIGHT_INVITE))</span>
<span class="w"> </span>    {
<span class="w"> </span>        SendCommandResult(session, GUILD_COMMAND_INVITE, ERR_GUILD_PERMISSIONS);
<span class="w"> </span>        return;
<span class="gu">@@ -1541,7 +1572,7 @@ void Guild::HandleRemoveMember(WorldSession* session, std::string_view name)</span>
<span class="w"> </span>{
<span class="w"> </span>    Player* player = session-&gt;GetPlayer();
<span class="w"> </span>    // Player must have rights to remove members
<span class="gd">-    if (!_HasRankRight(player, GR_RIGHT_REMOVE))</span>
<span class="gi">+    if (!HasRankRight(player, GR_RIGHT_REMOVE))</span>
<span class="w"> </span>        SendCommandResult(session, GUILD_COMMAND_REMOVE, ERR_GUILD_PERMISSIONS);
<span class="w"> </span>    else if (Member* member = GetMember(name))
<span class="w"> </span>    {
<span class="gu">@@ -1574,7 +1605,7 @@ void Guild::HandleUpdateMemberRank(WorldSession* session, std::string_view name,</span>
<span class="w"> </span>    Player* player = session-&gt;GetPlayer();
<span class="w"> </span>    GuildCommandType type = demote ? GUILD_COMMAND_DEMOTE : GUILD_COMMAND_PROMOTE;
<span class="w"> </span>    // Player must have rights to promote
<span class="gd">-    if (!_HasRankRight(player, demote ? GR_RIGHT_DEMOTE : GR_RIGHT_PROMOTE))</span>
<span class="gi">+    if (!HasRankRight(player, demote ? GR_RIGHT_DEMOTE : GR_RIGHT_PROMOTE))</span>
<span class="w"> </span>        SendCommandResult(session, type, ERR_GUILD_PERMISSIONS);
<span class="w"> </span>    // Promoted player must be a member of guild
<span class="w"> </span>    else if (Member* member = GetMember(name))
<span class="gu">@@ -1708,7 +1739,7 @@ bool Guild::HandleMemberWithdrawMoney(WorldSession* session, uint32 amount, bool</span>
<span class="w"> </span>    if (uint32(_GetMemberRemainingMoney(*member)) &lt; amount)   // Check if we have enough slot/money today
<span class="w"> </span>        return false;

<span class="gd">-    if (!(_GetRankRights(member-&gt;GetRankId()) &amp; GR_RIGHT_WITHDRAW_REPAIR) &amp;&amp; repair)</span>
<span class="gi">+    if (!(GetRankRights(member-&gt;GetRankId()) &amp; GR_RIGHT_WITHDRAW_REPAIR) &amp;&amp; repair)</span>
<span class="w"> </span>        return false;

<span class="w"> </span>    // Call script after validation and before money transfer.
<span class="gu">@@ -1850,7 +1881,7 @@ void Guild::SendPermissions(WorldSession* session)</span>
<span class="w"> </span>    WorldPackets::Guild::GuildPermissionsQueryResults queryResult;
<span class="w"> </span>    queryResult.RankID = rankId;
<span class="w"> </span>    queryResult.WithdrawGoldLimit = _GetRankBankMoneyPerDay(rankId);
<span class="gd">-    queryResult.Flags = _GetRankRights(rankId);</span>
<span class="gi">+    queryResult.Flags = GetRankRights(rankId);</span>
<span class="w"> </span>    queryResult.NumTabs = _GetPurchasedTabsSize();

<span class="w"> </span>    for (uint8 tabId = 0; tabId &lt; GUILD_BANK_MAX_TABS; ++tabId)
<span class="gu">@@ -1902,14 +1933,14 @@ void Guild::SendLoginInfo(WorldSession* session)</span>
<span class="w"> </span>// Loading methods
<span class="w"> </span>bool Guild::LoadFromDB(Field* fields)
<span class="w"> </span>{
<span class="gd">-    m_id            = fields[0].Get&lt;uint32&gt;();</span>
<span class="gd">-    m_name          = fields[1].Get&lt;std::string&gt;();</span>
<span class="gd">-    m_leaderGuid    = ObjectGuid::Create&lt;HighGuid::Player&gt;(fields[2].Get&lt;uint32&gt;());</span>
<span class="gi">+    m_id = fields[0].Get&lt;uint32&gt;();</span>
<span class="gi">+    m_name = fields[1].Get&lt;std::string&gt;();</span>
<span class="gi">+    m_leaderGuid = ObjectGuid::Create&lt;HighGuid::Player&gt;(fields[2].Get&lt;uint32&gt;());</span>
<span class="w"> </span>    m_emblemInfo.LoadFromDB(fields);
<span class="gd">-    m_info          = fields[8].Get&lt;std::string&gt;();</span>
<span class="gd">-    m_motd          = fields[9].Get&lt;std::string&gt;();</span>
<span class="gd">-    m_createdDate   = time_t(fields[10].Get&lt;uint32&gt;());</span>
<span class="gd">-    m_bankMoney     = fields[11].Get&lt;uint64&gt;();</span>
<span class="gi">+    m_info = fields[8].Get&lt;std::string&gt;();</span>
<span class="gi">+    m_motd = fields[9].Get&lt;std::string&gt;();</span>
<span class="gi">+    m_createdDate = time_t(fields[10].Get&lt;uint32&gt;());</span>
<span class="gi">+    m_bankMoney = fields[11].Get&lt;uint64&gt;();</span>

<span class="w"> </span>    uint8 purchasedTabs = uint8(fields[12].Get&lt;uint64&gt;());
<span class="w"> </span>    if (purchasedTabs &gt; GUILD_BANK_MAX_TABS)
<span class="gu">@@ -1968,13 +1999,13 @@ bool Guild::LoadEventLogFromDB(Field* fields)</span>
<span class="w"> </span>    if (m_eventLog.CanInsert())
<span class="w"> </span>    {
<span class="w"> </span>        m_eventLog.LoadEvent(
<span class="gd">-                                  m_id,                                                         // guild id</span>
<span class="gd">-                                  fields[1].Get&lt;uint32&gt;(),                                        // guid</span>
<span class="gd">-                                  time_t(fields[6].Get&lt;uint32&gt;()),                                // timestamp</span>
<span class="gd">-                                  GuildEventLogTypes(fields[2].Get&lt;uint8&gt;()),                     // event type</span>
<span class="gd">-                                  ObjectGuid::Create&lt;HighGuid::Player&gt;(fields[3].Get&lt;uint32&gt;()),  // player guid 1</span>
<span class="gd">-                                  ObjectGuid::Create&lt;HighGuid::Player&gt;(fields[4].Get&lt;uint32&gt;()),  // player guid 2</span>
<span class="gd">-                                  fields[5].Get&lt;uint8&gt;());                                       // rank</span>
<span class="gi">+            m_id,                                                         // guild id</span>
<span class="gi">+            fields[1].Get&lt;uint32&gt;(),                                        // guid</span>
<span class="gi">+            time_t(fields[6].Get&lt;uint32&gt;()),                                // timestamp</span>
<span class="gi">+            GuildEventLogTypes(fields[2].Get&lt;uint8&gt;()),                     // event type</span>
<span class="gi">+            ObjectGuid::Create&lt;HighGuid::Player&gt;(fields[3].Get&lt;uint32&gt;()),  // player guid 1</span>
<span class="gi">+            ObjectGuid::Create&lt;HighGuid::Player&gt;(fields[4].Get&lt;uint32&gt;()),  // player guid 2</span>
<span class="gi">+            fields[5].Get&lt;uint8&gt;());                                       // rank</span>
<span class="w"> </span>        return true;
<span class="w"> </span>    }
<span class="w"> </span>    return false;
<span class="gu">@@ -2006,15 +2037,15 @@ bool Guild::LoadBankEventLogFromDB(Field* fields)</span>
<span class="w"> </span>                return false;
<span class="w"> </span>            }
<span class="w"> </span>            bankLog.LoadEvent(
<span class="gd">-                                m_id,                                                       // guild id</span>
<span class="gd">-                                guid,                                                       // guid</span>
<span class="gd">-                                time_t(fields[8].Get&lt;uint32&gt;()),                              // timestamp</span>
<span class="gd">-                                dbTabId,                                                    // tab id</span>
<span class="gd">-                                eventType,                                                  // event type</span>
<span class="gd">-                                ObjectGuid::Create&lt;HighGuid::Player&gt;(fields[4].Get&lt;uint32&gt;()), // player guid</span>
<span class="gd">-                                fields[5].Get&lt;uint32&gt;(),                                      // item or money</span>
<span class="gd">-                                fields[6].Get&lt;uint16&gt;(),                                      // itam stack count</span>
<span class="gd">-                                fields[7].Get&lt;uint8&gt;());                                     // dest tab id</span>
<span class="gi">+                m_id,                                                       // guild id</span>
<span class="gi">+                guid,                                                       // guid</span>
<span class="gi">+                time_t(fields[8].Get&lt;uint32&gt;()),                              // timestamp</span>
<span class="gi">+                dbTabId,                                                    // tab id</span>
<span class="gi">+                eventType,                                                  // event type</span>
<span class="gi">+                ObjectGuid::Create&lt;HighGuid::Player&gt;(fields[4].Get&lt;uint32&gt;()), // player guid</span>
<span class="gi">+                fields[5].Get&lt;uint32&gt;(),                                      // item or money</span>
<span class="gi">+                fields[6].Get&lt;uint16&gt;(),                                      // itam stack count</span>
<span class="gi">+                fields[7].Get&lt;uint8&gt;());                                     // dest tab id</span>
<span class="w"> </span>        }
<span class="w"> </span>    }
<span class="w"> </span>    return true;
<span class="gu">@@ -2035,7 +2066,7 @@ bool Guild::LoadBankItemFromDB(Field* fields)</span>
<span class="w"> </span>    if (tabId &gt;= _GetPurchasedTabsSize())
<span class="w"> </span>    {
<span class="w"> </span>        LOG_ERROR(&quot;guild&quot;, &quot;Invalid tab for item (GUID: {}, id: #{}) in guild bank, skipped.&quot;,
<span class="gd">-                       fields[14].Get&lt;uint32&gt;(), fields[15].Get&lt;uint32&gt;());</span>
<span class="gi">+            fields[14].Get&lt;uint32&gt;(), fields[15].Get&lt;uint32&gt;());</span>
<span class="w"> </span>        return false;
<span class="w"> </span>    }
<span class="w"> </span>    return m_bankTabs[tabId].LoadItemFromDB(fields);
<span class="gu">@@ -2116,13 +2147,13 @@ bool Guild::Validate()</span>
<span class="w"> </span>// Broadcasts
<span class="w"> </span>void Guild::BroadcastToGuild(WorldSession* session, bool officerOnly, std::string_view msg, uint32 language) const
<span class="w"> </span>{
<span class="gd">-    if (session &amp;&amp; session-&gt;GetPlayer() &amp;&amp; _HasRankRight(session-&gt;GetPlayer(), officerOnly ? GR_RIGHT_OFFCHATSPEAK : GR_RIGHT_GCHATSPEAK))</span>
<span class="gi">+    if (session &amp;&amp; session-&gt;GetPlayer() &amp;&amp; HasRankRight(session-&gt;GetPlayer(), officerOnly ? GR_RIGHT_OFFCHATSPEAK : GR_RIGHT_GCHATSPEAK))</span>
<span class="w"> </span>    {
<span class="w"> </span>        WorldPacket data;
<span class="w"> </span>        ChatHandler::BuildChatPacket(data, officerOnly ? CHAT_MSG_OFFICER : CHAT_MSG_GUILD, Language(language), session-&gt;GetPlayer(), nullptr, msg);
<span class="w"> </span>        for (auto const&amp; [guid, member] : m_members)
<span class="w"> </span>            if (Player* player = member.FindPlayer())
<span class="gd">-                if (_HasRankRight(player, officerOnly ? GR_RIGHT_OFFCHATLISTEN : GR_RIGHT_GCHATLISTEN) &amp;&amp; !player-&gt;GetSocial()-&gt;HasIgnore(session-&gt;GetPlayer()-&gt;GetGUID()))</span>
<span class="gi">+                if (HasRankRight(player, officerOnly ? GR_RIGHT_OFFCHATLISTEN : GR_RIGHT_GCHATLISTEN) &amp;&amp; !player-&gt;GetSocial()-&gt;HasIgnore(session-&gt;GetPlayer()-&gt;GetGUID()))</span>
<span class="w"> </span>                    player-&gt;SendDirectMessage(&amp;data);
<span class="w"> </span>    }
<span class="w"> </span>}
<span class="gu">@@ -2177,11 +2208,19 @@ void Guild::MassInviteToEvent(WorldSession* session, uint32 minLevel, uint32 max</span>
<span class="w"> </span>// Members handling
<span class="w"> </span>bool Guild::AddMember(ObjectGuid guid, uint8 rankId)
<span class="w"> </span>{
<span class="gi">+    Player* leader = nullptr;</span>
<span class="gi">+    if (this-&gt;GetLeaderGUID())</span>
<span class="gi">+    {</span>
<span class="gi">+        leader = ObjectAccessor::FindConnectedPlayer(this-&gt;GetLeaderGUID());</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="w"> </span>    Player* player = ObjectAccessor::FindConnectedPlayer(guid);
<span class="gi">+</span>
<span class="w"> </span>    // Player cannot be in guild
<span class="w"> </span>    if (player)
<span class="w"> </span>    {
<span class="gd">-        if (player-&gt;GetGuildId() != 0)</span>
<span class="gi">+        if (player-&gt;GetGuildId() != 0 ||</span>
<span class="gi">+            (!sWorld-&gt;getBoolConfig(CONFIG_ALLOW_TWO_SIDE_INTERACTION_GUILD) &amp;&amp; (leader &amp;&amp; leader-&gt;GetTeamId() != player-&gt;GetTeamId())))</span>
<span class="w"> </span>            return false;
<span class="w"> </span>    }
<span class="w"> </span>    else if (sCharacterCache-&gt;GetCharacterGuildIdByGuid(guid) != 0)
<span class="gu">@@ -2346,7 +2385,7 @@ bool Guild::ChangeMemberRank(ObjectGuid guid, uint8 newRank)</span>
<span class="w"> </span>void Guild::SwapItems(Player* player, uint8 tabId, uint8 slotId, uint8 destTabId, uint8 destSlotId, uint32 splitedAmount)
<span class="w"> </span>{
<span class="w"> </span>    if (tabId &gt;= _GetPurchasedTabsSize() || slotId &gt;= GUILD_BANK_MAX_SLOTS ||
<span class="gd">-            destTabId &gt;= _GetPurchasedTabsSize() || destSlotId &gt;= GUILD_BANK_MAX_SLOTS)</span>
<span class="gi">+        destTabId &gt;= _GetPurchasedTabsSize() || destSlotId &gt;= GUILD_BANK_MAX_SLOTS)</span>
<span class="w"> </span>        return;

<span class="w"> </span>    if (tabId == destTabId &amp;&amp; slotId == destSlotId)
<span class="gu">@@ -2390,12 +2429,12 @@ void Guild::_CreateNewBankTab()</span>

<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_DEL_GUILD_BANK_TAB);
<span class="w"> </span>    stmt-&gt;SetData(0, m_id);
<span class="gd">-    stmt-&gt;SetData (1, tabId);</span>
<span class="gi">+    stmt-&gt;SetData(1, tabId);</span>
<span class="w"> </span>    trans-&gt;Append(stmt);

<span class="w"> </span>    stmt = CharacterDatabase.GetPreparedStatement(CHAR_INS_GUILD_BANK_TAB);
<span class="w"> </span>    stmt-&gt;SetData(0, m_id);
<span class="gd">-    stmt-&gt;SetData (1, tabId);</span>
<span class="gi">+    stmt-&gt;SetData(1, tabId);</span>
<span class="w"> </span>    trans-&gt;Append(stmt);

<span class="w"> </span>    ++tabId;
<span class="gu">@@ -2415,10 +2454,10 @@ void Guild::_CreateDefaultGuildRanks(LocaleConstant loc)</span>
<span class="w"> </span>    stmt-&gt;SetData(0, m_id);
<span class="w"> </span>    CharacterDatabase.Execute(stmt);

<span class="gd">-    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_MASTER,   loc), GR_RIGHT_ALL);</span>
<span class="gd">-    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_OFFICER,  loc), GR_RIGHT_ALL);</span>
<span class="gd">-    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_VETERAN,  loc), GR_RIGHT_GCHATLISTEN | GR_RIGHT_GCHATSPEAK);</span>
<span class="gd">-    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_MEMBER,   loc), GR_RIGHT_GCHATLISTEN | GR_RIGHT_GCHATSPEAK);</span>
<span class="gi">+    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_MASTER, loc), GR_RIGHT_ALL);</span>
<span class="gi">+    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_OFFICER, loc), GR_RIGHT_ALL);</span>
<span class="gi">+    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_VETERAN, loc), GR_RIGHT_GCHATLISTEN | GR_RIGHT_GCHATSPEAK);</span>
<span class="gi">+    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_MEMBER, loc), GR_RIGHT_GCHATLISTEN | GR_RIGHT_GCHATSPEAK);</span>
<span class="w"> </span>    _CreateRank(sObjectMgr-&gt;GetAcoreString(LANG_GUILD_INITIATE, loc), GR_RIGHT_GCHATLISTEN | GR_RIGHT_GCHATSPEAK);
<span class="w"> </span>}

<span class="gu">@@ -2525,7 +2564,7 @@ inline std::string Guild::_GetRankName(uint8 rankId) const</span>
<span class="w"> </span>    return &quot;&lt;unknown&gt;&quot;;
<span class="w"> </span>}

<span class="gd">-inline uint32 Guild::_GetRankRights(uint8 rankId) const</span>
<span class="gi">+uint32 Guild::GetRankRights(uint8 rankId) const</span>
<span class="w"> </span>{
<span class="w"> </span>    if (const RankInfo* rankInfo = GetRankInfo(rankId))
<span class="w"> </span>        return rankInfo-&gt;GetRights();
<span class="gu">@@ -2574,7 +2613,7 @@ inline int32 Guild::_GetMemberRemainingMoney(Member const&amp; member) const</span>
<span class="w"> </span>    if (rankId == GR_GUILDMASTER)
<span class="w"> </span>        return static_cast&lt;int32&gt;(GUILD_WITHDRAW_MONEY_UNLIMITED);

<span class="gd">-    if ((_GetRankRights(rankId) &amp; (GR_RIGHT_WITHDRAW_REPAIR | GR_RIGHT_WITHDRAW_GOLD)) != 0)</span>
<span class="gi">+    if ((GetRankRights(rankId) &amp; (GR_RIGHT_WITHDRAW_REPAIR | GR_RIGHT_WITHDRAW_GOLD)) != 0)</span>
<span class="w"> </span>    {
<span class="w"> </span>        int32 remaining = _GetRankBankMoneyPerDay(rankId) - member.GetBankWithdrawValue(GUILD_BANK_MAX_TABS);
<span class="w"> </span>        if (remaining &gt; 0)
<span class="gu">@@ -2589,12 +2628,12 @@ inline void Guild::_UpdateMemberWithdrawSlots(CharacterDatabaseTransaction trans</span>
<span class="w"> </span>    {
<span class="w"> </span>        uint8 rankId = member-&gt;GetRankId();
<span class="w"> </span>        if (rankId != GR_GUILDMASTER
<span class="gd">-                &amp;&amp; member-&gt;GetBankWithdrawValue(tabId) &lt; _GetRankBankTabSlotsPerDay(rankId, tabId))</span>
<span class="gi">+            &amp;&amp; member-&gt;GetBankWithdrawValue(tabId) &lt; _GetRankBankTabSlotsPerDay(rankId, tabId))</span>
<span class="w"> </span>            member-&gt;UpdateBankWithdrawValue(trans, tabId, 1);
<span class="w"> </span>    }
<span class="w"> </span>}

<span class="gd">-inline bool Guild::_MemberHasTabRights(ObjectGuid guid, uint8 tabId, uint32 rights) const</span>
<span class="gi">+bool Guild::MemberHasTabRights(ObjectGuid guid, uint8 tabId, uint32 rights) const</span>
<span class="w"> </span>{
<span class="w"> </span>    if (const Member* member = GetMember(guid))
<span class="w"> </span>    {
<span class="gu">@@ -2606,6 +2645,19 @@ inline bool Guild::_MemberHasTabRights(ObjectGuid guid, uint8 tabId, uint32 righ</span>
<span class="w"> </span>    return false;
<span class="w"> </span>}

<span class="gi">+bool Guild::HasRankRight(Player* player, uint32 right) const</span>
<span class="gi">+{</span>
<span class="gi">+    if (player)</span>
<span class="gi">+    {</span>
<span class="gi">+        if (Member const* member = GetMember(player-&gt;GetGUID()))</span>
<span class="gi">+        {</span>
<span class="gi">+            return (GetRankRights(member-&gt;GetRankId()) &amp; right) != GR_RIGHT_EMPTY;</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    return false;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>// Add new event log record
<span class="w"> </span>inline void Guild::_LogEvent(GuildEventLogTypes eventType, ObjectGuid playerGuid1, ObjectGuid playerGuid2, uint8 newRank)
<span class="w"> </span>{
<span class="gu">@@ -2751,7 +2803,7 @@ bool Guild::_DoItemsMove(MoveItemData* pSrc, MoveItemData* pDest, bool sendError</span>
<span class="w"> </span>void Guild::_SendBankContent(WorldSession* session, uint8 tabId, bool sendAllSlots) const
<span class="w"> </span>{
<span class="w"> </span>    ObjectGuid guid = session-&gt;GetPlayer()-&gt;GetGUID();
<span class="gd">-    if (!_MemberHasTabRights(guid, tabId, GUILD_BANK_RIGHT_VIEW_TAB))</span>
<span class="gi">+    if (!MemberHasTabRights(guid, tabId, GUILD_BANK_RIGHT_VIEW_TAB))</span>
<span class="w"> </span>        return;

<span class="w"> </span>    _SendBankList(session, tabId, sendAllSlots);
<span class="gu">@@ -2800,7 +2852,7 @@ void Guild::_SendBankContentUpdate(uint8 tabId, SlotIds slots) const</span>
<span class="w"> </span>}

<span class="w"> </span>void Guild::_BroadcastEvent(GuildEvents guildEvent, ObjectGuid guid,
<span class="gd">-                            Optional&lt;std::string_view&gt; param1 /*= {}*/, Optional&lt;std::string_view&gt; param2 /*= {}*/, Optional&lt;std::string_view&gt; param3 /*= {}*/) const</span>
<span class="gi">+    Optional&lt;std::string_view&gt; param1 /*= {}*/, Optional&lt;std::string_view&gt; param2 /*= {}*/, Optional&lt;std::string_view&gt; param3 /*= {}*/) const</span>
<span class="w"> </span>{
<span class="w"> </span>    WorldPackets::Guild::GuildEvent event;
<span class="w"> </span>    event.Type = guildEvent;
<span class="gu">@@ -2823,7 +2875,7 @@ void Guild::_BroadcastEvent(GuildEvents guildEvent, ObjectGuid guid,</span>
<span class="w"> </span>    LOG_DEBUG(&quot;guild&quot;, &quot;SMSG_GUILD_EVENT [Broadcast] Event: {}&quot;, guildEvent);
<span class="w"> </span>}

<span class="gd">-void Guild::_SendBankList(WorldSession* session /* = nullptr*/, uint8 tabId /*= 0*/, bool sendAllSlots /*= false*/, SlotIds *slots /*= nullptr*/) const</span>
<span class="gi">+void Guild::_SendBankList(WorldSession* session /* = nullptr*/, uint8 tabId /*= 0*/, bool sendAllSlots /*= false*/, SlotIds* slots /*= nullptr*/) const</span>
<span class="w"> </span>{
<span class="w"> </span>    if (!sScriptMgr-&gt;CanGuildSendBankList(this, session, tabId, sendAllSlots))
<span class="w"> </span>        return;
<span class="gu">@@ -2849,47 +2901,47 @@ void Guild::_SendBankList(WorldSession* session /* = nullptr*/, uint8 tabId /*=</span>
<span class="w"> </span>    if (BankTab const* tab = GetBankTab(tabId))
<span class="w"> </span>    {
<span class="w"> </span>        auto fillItems = [&amp;](auto begin, auto end, bool skipEmpty)
<span class="gd">-        {</span>
<span class="gd">-            for (auto itr = begin; itr != end; ++itr)</span>
<span class="w"> </span>            {
<span class="gd">-                if (Item* tabItem = tab-&gt;GetItem(*itr))</span>
<span class="gi">+                for (auto itr = begin; itr != end; ++itr)</span>
<span class="w"> </span>                {
<span class="gd">-                    WorldPackets::Guild::GuildBankItemInfo itemInfo;</span>
<span class="gd">-</span>
<span class="gd">-                    itemInfo.Slot = *itr;</span>
<span class="gd">-                    itemInfo.ItemID = tabItem-&gt;GetEntry();</span>
<span class="gd">-                    itemInfo.Count = int32(tabItem-&gt;GetCount());</span>
<span class="gd">-                    itemInfo.Charges = int32(std::abs(tabItem-&gt;GetSpellCharges()));</span>
<span class="gd">-                    itemInfo.EnchantmentID = int32(tabItem-&gt;GetEnchantmentId(PERM_ENCHANTMENT_SLOT));</span>
<span class="gd">-                    itemInfo.Flags = tabItem-&gt;GetInt32Value(ITEM_FIELD_FLAGS);</span>
<span class="gd">-                    itemInfo.RandomPropertiesID = tabItem-&gt;GetItemRandomPropertyId();</span>
<span class="gd">-                    itemInfo.RandomPropertiesSeed = int32(tabItem-&gt;GetItemSuffixFactor());</span>
<span class="gd">-</span>
<span class="gd">-                    for (uint32 socketSlot = 0; socketSlot &lt; MAX_GEM_SOCKETS; ++socketSlot)</span>
<span class="gi">+                    if (Item* tabItem = tab-&gt;GetItem(*itr))</span>
<span class="w"> </span>                    {
<span class="gd">-                        if (uint32 enchId = tabItem-&gt;GetEnchantmentId(EnchantmentSlot(SOCK_ENCHANTMENT_SLOT + socketSlot)))</span>
<span class="gi">+                        WorldPackets::Guild::GuildBankItemInfo itemInfo;</span>
<span class="gi">+</span>
<span class="gi">+                        itemInfo.Slot = *itr;</span>
<span class="gi">+                        itemInfo.ItemID = tabItem-&gt;GetEntry();</span>
<span class="gi">+                        itemInfo.Count = int32(tabItem-&gt;GetCount());</span>
<span class="gi">+                        itemInfo.Charges = int32(std::abs(tabItem-&gt;GetSpellCharges()));</span>
<span class="gi">+                        itemInfo.EnchantmentID = int32(tabItem-&gt;GetEnchantmentId(PERM_ENCHANTMENT_SLOT));</span>
<span class="gi">+                        itemInfo.Flags = tabItem-&gt;GetInt32Value(ITEM_FIELD_FLAGS);</span>
<span class="gi">+                        itemInfo.RandomPropertiesID = tabItem-&gt;GetItemRandomPropertyId();</span>
<span class="gi">+                        itemInfo.RandomPropertiesSeed = int32(tabItem-&gt;GetItemSuffixFactor());</span>
<span class="gi">+</span>
<span class="gi">+                        for (uint32 socketSlot = 0; socketSlot &lt; MAX_GEM_SOCKETS; ++socketSlot)</span>
<span class="w"> </span>                        {
<span class="gd">-                            WorldPackets::Guild::GuildBankSocketEnchant gem;</span>
<span class="gd">-                            gem.SocketIndex = socketSlot;</span>
<span class="gd">-                            gem.SocketEnchantID = int32(enchId);</span>
<span class="gd">-                            itemInfo.SocketEnchant.push_back(gem);</span>
<span class="gi">+                            if (uint32 enchId = tabItem-&gt;GetEnchantmentId(EnchantmentSlot(SOCK_ENCHANTMENT_SLOT + socketSlot)))</span>
<span class="gi">+                            {</span>
<span class="gi">+                                WorldPackets::Guild::GuildBankSocketEnchant gem;</span>
<span class="gi">+                                gem.SocketIndex = socketSlot;</span>
<span class="gi">+                                gem.SocketEnchantID = int32(enchId);</span>
<span class="gi">+                                itemInfo.SocketEnchant.push_back(gem);</span>
<span class="gi">+                            }</span>
<span class="w"> </span>                        }
<span class="gd">-                    }</span>

<span class="gd">-                    packet.ItemInfo.push_back(itemInfo);</span>
<span class="gd">-                }</span>
<span class="gd">-                else if (!skipEmpty)</span>
<span class="gd">-                {</span>
<span class="gd">-                    WorldPackets::Guild::GuildBankItemInfo itemInfo;</span>
<span class="gi">+                        packet.ItemInfo.push_back(itemInfo);</span>
<span class="gi">+                    }</span>
<span class="gi">+                    else if (!skipEmpty)</span>
<span class="gi">+                    {</span>
<span class="gi">+                        WorldPackets::Guild::GuildBankItemInfo itemInfo;</span>

<span class="gd">-                    itemInfo.Slot = *itr;</span>
<span class="gd">-                    itemInfo.ItemID = 0;</span>
<span class="gi">+                        itemInfo.Slot = *itr;</span>
<span class="gi">+                        itemInfo.ItemID = 0;</span>

<span class="gd">-                    packet.ItemInfo.push_back(itemInfo);</span>
<span class="gi">+                        packet.ItemInfo.push_back(itemInfo);</span>
<span class="gi">+                    }</span>
<span class="w"> </span>                }
<span class="gd">-            }</span>

<span class="gd">-        };</span>
<span class="gi">+            };</span>

<span class="w"> </span>        if (sendAllSlots)
<span class="w"> </span>            fillItems(boost::make_counting_iterator(uint8(0)), boost::make_counting_iterator(uint8(GUILD_BANK_MAX_SLOTS)), true);
<span class="gu">@@ -2904,7 +2956,7 @@ void Guild::_SendBankList(WorldSession* session /* = nullptr*/, uint8 tabId /*=</span>

<span class="w"> </span>        session-&gt;SendPacket(packet.Write());
<span class="w"> </span>        LOG_DEBUG(&quot;guild&quot;, &quot;SMSG_GUILD_BANK_LIST [{}]: TabId: {}, FullSlots: {}, slots: {}&quot;,
<span class="gd">-                     session-&gt;GetPlayerInfo(), tabId, sendAllSlots, packet.WithdrawalsRemaining);</span>
<span class="gi">+            session-&gt;GetPlayerInfo(), tabId, sendAllSlots, packet.WithdrawalsRemaining);</span>
<span class="w"> </span>    }
<span class="w"> </span>    else
<span class="w"> </span>    {
<span class="gu">@@ -2914,7 +2966,7 @@ void Guild::_SendBankList(WorldSession* session /* = nullptr*/, uint8 tabId /*=</span>
<span class="w"> </span>            if (!member.ShouldReceiveBankPartialUpdatePackets())
<span class="w"> </span>                continue;

<span class="gd">-            if (!_MemberHasTabRights(member.GetGUID(), tabId, GUILD_BANK_RIGHT_VIEW_TAB))</span>
<span class="gi">+            if (!MemberHasTabRights(member.GetGUID(), tabId, GUILD_BANK_RIGHT_VIEW_TAB))</span>
<span class="w"> </span>                continue;

<span class="w"> </span>            Player* player = member.FindPlayer();
<span class="gu">@@ -2924,7 +2976,7 @@ void Guild::_SendBankList(WorldSession* session /* = nullptr*/, uint8 tabId /*=</span>
<span class="w"> </span>            packet.SetWithdrawalsRemaining(_GetMemberRemainingSlots(member, tabId));
<span class="w"> </span>            player-&gt;SendDirectMessage(packet.GetRawPacket());
<span class="w"> </span>            LOG_DEBUG(&quot;guild&quot;, &quot;SMSG_GUILD_BANK_LIST [{}]: TabId: {}, FullSlots: {}, slots: {}&quot;
<span class="gd">-                    , player-&gt;GetName(), tabId, sendAllSlots, packet.WithdrawalsRemaining);</span>
<span class="gi">+                , player-&gt;GetName(), tabId, sendAllSlots, packet.WithdrawalsRemaining);</span>
<span class="w"> </span>        }
<span class="w"> </span>    }
<span class="w"> </span>}
<span class="gh">diff --git a/src/server/game/Guilds/Guild.h b/src/server/game/Guilds/Guild.h</span>
<span class="gh">index ab5d47295d28a3..ceb935e86f61e7 100644</span>
<span class="gd">--- a/src/server/game/Guilds/Guild.h</span>
<span class="gi">+++ b/src/server/game/Guilds/Guild.h</span>
<span class="gu">@@ -39,16 +39,16 @@ namespace WorldPackets</span>

<span class="w"> </span>enum GuildMisc
<span class="w"> </span>{
<span class="gd">-    GUILD_BANK_MAX_TABS                 = 6,                    // send by client for money log also</span>
<span class="gd">-    GUILD_BANK_MAX_SLOTS                = 98,</span>
<span class="gd">-    GUILD_BANK_MONEY_LOGS_TAB           = 100,                  // used for money log in DB</span>
<span class="gd">-    GUILD_RANKS_MIN_COUNT               = 5,</span>
<span class="gd">-    GUILD_RANKS_MAX_COUNT               = 10,</span>
<span class="gd">-    GUILD_RANK_NONE                     = 0xFF,</span>
<span class="gd">-    GUILD_WITHDRAW_MONEY_UNLIMITED      = 0xFFFFFFFF,</span>
<span class="gd">-    GUILD_WITHDRAW_SLOT_UNLIMITED       = 0xFFFFFFFF,</span>
<span class="gd">-    GUILD_EVENT_LOG_GUID_UNDEFINED      = 0xFFFFFFFF,</span>
<span class="gd">-    TAB_UNDEFINED                       = 0xFF,</span>
<span class="gi">+    GUILD_BANK_MAX_TABS = 6,                    // send by client for money log also</span>
<span class="gi">+    GUILD_BANK_MAX_SLOTS = 98,</span>
<span class="gi">+    GUILD_BANK_MONEY_LOGS_TAB = 100,                  // used for money log in DB</span>
<span class="gi">+    GUILD_RANKS_MIN_COUNT = 5,</span>
<span class="gi">+    GUILD_RANKS_MAX_COUNT = 10,</span>
<span class="gi">+    GUILD_RANK_NONE = 0xFF,</span>
<span class="gi">+    GUILD_WITHDRAW_MONEY_UNLIMITED = 0xFFFFFFFF,</span>
<span class="gi">+    GUILD_WITHDRAW_SLOT_UNLIMITED = 0xFFFFFFFF,</span>
<span class="gi">+    GUILD_EVENT_LOG_GUID_UNDEFINED = 0xFFFFFFFF,</span>
<span class="gi">+    TAB_UNDEFINED = 0xFF,</span>
<span class="w"> </span>};

<span class="w"> </span>constexpr uint64 GUILD_BANK_MONEY_LIMIT = UI64LIT(0x7FFFFFFFFFFFF);
<span class="gu">@@ -62,183 +62,185 @@ enum GuildMemberData</span>
<span class="w"> </span>enum GuildDefaultRanks
<span class="w"> </span>{
<span class="w"> </span>    // These ranks can be modified, but they cannot be deleted
<span class="gd">-    GR_GUILDMASTER  = 0,</span>
<span class="gd">-    GR_OFFICER      = 1,</span>
<span class="gd">-    GR_VETERAN      = 2,</span>
<span class="gd">-    GR_MEMBER       = 3,</span>
<span class="gd">-    GR_INITIATE     = 4</span>
<span class="gd">-                      // When promoting member server does: rank--</span>
<span class="gd">-                      // When demoting member server does: rank++</span>
<span class="gi">+    GR_GUILDMASTER = 0,</span>
<span class="gi">+    GR_OFFICER = 1,</span>
<span class="gi">+    GR_VETERAN = 2,</span>
<span class="gi">+    GR_MEMBER = 3,</span>
<span class="gi">+    GR_INITIATE = 4</span>
<span class="gi">+    // When promoting member server does: rank--</span>
<span class="gi">+    // When demoting member server does: rank++</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildRankRights
<span class="w"> </span>{
<span class="gd">-    GR_RIGHT_EMPTY                      = 0x00000040,</span>
<span class="gd">-    GR_RIGHT_GCHATLISTEN                = GR_RIGHT_EMPTY | 0x00000001,</span>
<span class="gd">-    GR_RIGHT_GCHATSPEAK                 = GR_RIGHT_EMPTY | 0x00000002,</span>
<span class="gd">-    GR_RIGHT_OFFCHATLISTEN              = GR_RIGHT_EMPTY | 0x00000004,</span>
<span class="gd">-    GR_RIGHT_OFFCHATSPEAK               = GR_RIGHT_EMPTY | 0x00000008,</span>
<span class="gd">-    GR_RIGHT_INVITE                     = GR_RIGHT_EMPTY | 0x00000010,</span>
<span class="gd">-    GR_RIGHT_REMOVE                     = GR_RIGHT_EMPTY | 0x00000020,</span>
<span class="gd">-    GR_RIGHT_PROMOTE                    = GR_RIGHT_EMPTY | 0x00000080,</span>
<span class="gd">-    GR_RIGHT_DEMOTE                     = GR_RIGHT_EMPTY | 0x00000100,</span>
<span class="gd">-    GR_RIGHT_SETMOTD                    = GR_RIGHT_EMPTY | 0x00001000,</span>
<span class="gd">-    GR_RIGHT_EPNOTE                     = GR_RIGHT_EMPTY | 0x00002000,</span>
<span class="gd">-    GR_RIGHT_VIEWOFFNOTE                = GR_RIGHT_EMPTY | 0x00004000,</span>
<span class="gd">-    GR_RIGHT_EOFFNOTE                   = GR_RIGHT_EMPTY | 0x00008000,</span>
<span class="gd">-    GR_RIGHT_MODIFY_GUILD_INFO          = GR_RIGHT_EMPTY | 0x00010000,</span>
<span class="gd">-    GR_RIGHT_WITHDRAW_GOLD_LOCK         = 0x00020000,                   // remove money withdraw capacity</span>
<span class="gd">-    GR_RIGHT_WITHDRAW_REPAIR            = 0x00040000,                   // withdraw for repair</span>
<span class="gd">-    GR_RIGHT_WITHDRAW_GOLD              = 0x00080000,                   // withdraw gold</span>
<span class="gd">-    GR_RIGHT_CREATE_GUILD_EVENT         = 0x00100000,                   // wotlk</span>
<span class="gd">-    GR_RIGHT_ALL                        = 0x001DF1FF</span>
<span class="gi">+    GR_RIGHT_EMPTY = 0x00000040,</span>
<span class="gi">+    GR_RIGHT_GCHATLISTEN = GR_RIGHT_EMPTY | 0x00000001,</span>
<span class="gi">+    GR_RIGHT_GCHATSPEAK = GR_RIGHT_EMPTY | 0x00000002,</span>
<span class="gi">+    GR_RIGHT_OFFCHATLISTEN = GR_RIGHT_EMPTY | 0x00000004,</span>
<span class="gi">+    GR_RIGHT_OFFCHATSPEAK = GR_RIGHT_EMPTY | 0x00000008,</span>
<span class="gi">+    GR_RIGHT_INVITE = GR_RIGHT_EMPTY | 0x00000010,</span>
<span class="gi">+    GR_RIGHT_REMOVE = GR_RIGHT_EMPTY | 0x00000020,</span>
<span class="gi">+    GR_RIGHT_PROMOTE = GR_RIGHT_EMPTY | 0x00000080,</span>
<span class="gi">+    GR_RIGHT_DEMOTE = GR_RIGHT_EMPTY | 0x00000100,</span>
<span class="gi">+    GR_RIGHT_SETMOTD = GR_RIGHT_EMPTY | 0x00001000,</span>
<span class="gi">+    GR_RIGHT_EPNOTE = GR_RIGHT_EMPTY | 0x00002000,</span>
<span class="gi">+    GR_RIGHT_VIEWOFFNOTE = GR_RIGHT_EMPTY | 0x00004000,</span>
<span class="gi">+    GR_RIGHT_EOFFNOTE = GR_RIGHT_EMPTY | 0x00008000,</span>
<span class="gi">+    GR_RIGHT_MODIFY_GUILD_INFO = GR_RIGHT_EMPTY | 0x00010000,</span>
<span class="gi">+    GR_RIGHT_WITHDRAW_GOLD_LOCK = 0x00020000,                   // remove money withdraw capacity</span>
<span class="gi">+    GR_RIGHT_WITHDRAW_REPAIR = 0x00040000,                   // withdraw for repair</span>
<span class="gi">+    GR_RIGHT_WITHDRAW_GOLD = 0x00080000,                   // withdraw gold</span>
<span class="gi">+    GR_RIGHT_CREATE_GUILD_EVENT = 0x00100000,                   // wotlk</span>
<span class="gi">+    GR_RIGHT_ALL = 0x001DF1FF</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildCommandType
<span class="w"> </span>{
<span class="gd">-    GUILD_COMMAND_CREATE                = 0,</span>
<span class="gd">-    GUILD_COMMAND_INVITE                = 1,</span>
<span class="gd">-    GUILD_COMMAND_QUIT                  = 3,</span>
<span class="gd">-    GUILD_COMMAND_ROSTER                = 5,</span>
<span class="gd">-    GUILD_COMMAND_PROMOTE               = 6,</span>
<span class="gd">-    GUILD_COMMAND_DEMOTE                = 7,</span>
<span class="gd">-    GUILD_COMMAND_REMOVE                = 8,</span>
<span class="gd">-    GUILD_COMMAND_CHANGE_LEADER         = 10,</span>
<span class="gd">-    GUILD_COMMAND_EDIT_MOTD             = 11,</span>
<span class="gd">-    GUILD_COMMAND_GUILD_CHAT            = 13,</span>
<span class="gd">-    GUILD_COMMAND_FOUNDER               = 14,</span>
<span class="gd">-    GUILD_COMMAND_CHANGE_RANK           = 16,</span>
<span class="gd">-    GUILD_COMMAND_PUBLIC_NOTE           = 19,</span>
<span class="gd">-    GUILD_COMMAND_VIEW_TAB              = 21,</span>
<span class="gd">-    GUILD_COMMAND_MOVE_ITEM             = 22,</span>
<span class="gd">-    GUILD_COMMAND_REPAIR                = 25,</span>
<span class="gi">+    GUILD_COMMAND_CREATE = 0,</span>
<span class="gi">+    GUILD_COMMAND_INVITE = 1,</span>
<span class="gi">+    GUILD_COMMAND_QUIT = 3,</span>
<span class="gi">+    GUILD_COMMAND_ROSTER = 5,</span>
<span class="gi">+    GUILD_COMMAND_PROMOTE = 6,</span>
<span class="gi">+    GUILD_COMMAND_DEMOTE = 7,</span>
<span class="gi">+    GUILD_COMMAND_REMOVE = 8,</span>
<span class="gi">+    GUILD_COMMAND_CHANGE_LEADER = 10,</span>
<span class="gi">+    GUILD_COMMAND_EDIT_MOTD = 11,</span>
<span class="gi">+    GUILD_COMMAND_GUILD_CHAT = 13,</span>
<span class="gi">+    GUILD_COMMAND_FOUNDER = 14,</span>
<span class="gi">+    GUILD_COMMAND_CHANGE_RANK = 16,</span>
<span class="gi">+    GUILD_COMMAND_PUBLIC_NOTE = 19,</span>
<span class="gi">+    GUILD_COMMAND_VIEW_TAB = 21,</span>
<span class="gi">+    GUILD_COMMAND_MOVE_ITEM = 22,</span>
<span class="gi">+    GUILD_COMMAND_REPAIR = 25,</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildCommandError
<span class="w"> </span>{
<span class="gd">-    ERR_GUILD_COMMAND_SUCCESS           = 0,</span>
<span class="gd">-    ERR_GUILD_INTERNAL                  = 1,</span>
<span class="gd">-    ERR_ALREADY_IN_GUILD                = 2,</span>
<span class="gd">-    ERR_ALREADY_IN_GUILD_S              = 3,</span>
<span class="gd">-    ERR_INVITED_TO_GUILD                = 4,</span>
<span class="gd">-    ERR_ALREADY_INVITED_TO_GUILD_S      = 5,</span>
<span class="gd">-    ERR_GUILD_NAME_INVALID              = 6,</span>
<span class="gd">-    ERR_GUILD_NAME_EXISTS_S             = 7,</span>
<span class="gd">-    ERR_GUILD_LEADER_LEAVE              = 8,</span>
<span class="gd">-    ERR_GUILD_PERMISSIONS               = 8,</span>
<span class="gd">-    ERR_GUILD_PLAYER_NOT_IN_GUILD       = 9,</span>
<span class="gd">-    ERR_GUILD_PLAYER_NOT_IN_GUILD_S     = 10,</span>
<span class="gd">-    ERR_GUILD_PLAYER_NOT_FOUND_S        = 11,</span>
<span class="gd">-    ERR_GUILD_NOT_ALLIED                = 12,</span>
<span class="gd">-    ERR_GUILD_RANK_TOO_HIGH_S           = 13,</span>
<span class="gd">-    ERR_GUILD_RANK_TOO_LOW_S            = 14,</span>
<span class="gd">-    ERR_GUILD_RANKS_LOCKED              = 17,</span>
<span class="gd">-    ERR_GUILD_RANK_IN_USE               = 18,</span>
<span class="gd">-    ERR_GUILD_IGNORING_YOU_S            = 19,</span>
<span class="gd">-    ERR_GUILD_UNK1                      = 20, // Forces roster update</span>
<span class="gd">-    ERR_GUILD_WITHDRAW_LIMIT            = 25,</span>
<span class="gd">-    ERR_GUILD_NOT_ENOUGH_MONEY          = 26,</span>
<span class="gd">-    ERR_GUILD_BANK_FULL                 = 28,</span>
<span class="gd">-    ERR_GUILD_ITEM_NOT_FOUND            = 29,</span>
<span class="gi">+    ERR_GUILD_COMMAND_SUCCESS = 0,</span>
<span class="gi">+    ERR_GUILD_INTERNAL = 1,</span>
<span class="gi">+    ERR_ALREADY_IN_GUILD = 2,</span>
<span class="gi">+    ERR_ALREADY_IN_GUILD_S = 3,</span>
<span class="gi">+    ERR_INVITED_TO_GUILD = 4,</span>
<span class="gi">+    ERR_ALREADY_INVITED_TO_GUILD_S = 5,</span>
<span class="gi">+    ERR_GUILD_NAME_INVALID = 6,</span>
<span class="gi">+    ERR_GUILD_NAME_EXISTS_S = 7,</span>
<span class="gi">+    ERR_GUILD_LEADER_LEAVE = 8,</span>
<span class="gi">+    ERR_GUILD_PERMISSIONS = 8,</span>
<span class="gi">+    ERR_GUILD_PLAYER_NOT_IN_GUILD = 9,</span>
<span class="gi">+    ERR_GUILD_PLAYER_NOT_IN_GUILD_S = 10,</span>
<span class="gi">+    ERR_GUILD_PLAYER_NOT_FOUND_S = 11,</span>
<span class="gi">+    ERR_GUILD_NOT_ALLIED = 12,</span>
<span class="gi">+    ERR_GUILD_RANK_TOO_HIGH_S = 13,</span>
<span class="gi">+    ERR_GUILD_RANK_TOO_LOW_S = 14,</span>
<span class="gi">+    ERR_GUILD_RANKS_LOCKED = 17,</span>
<span class="gi">+    ERR_GUILD_RANK_IN_USE = 18,</span>
<span class="gi">+    ERR_GUILD_IGNORING_YOU_S = 19,</span>
<span class="gi">+    ERR_GUILD_UNK1 = 20, // Forces roster update</span>
<span class="gi">+    ERR_GUILD_WITHDRAW_LIMIT = 25,</span>
<span class="gi">+    ERR_GUILD_NOT_ENOUGH_MONEY = 26,</span>
<span class="gi">+    ERR_GUILD_BANK_FULL = 28,</span>
<span class="gi">+    ERR_GUILD_ITEM_NOT_FOUND = 29,</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildEvents
<span class="w"> </span>{
<span class="gd">-    GE_PROMOTION                        = 0,</span>
<span class="gd">-    GE_DEMOTION                         = 1,</span>
<span class="gd">-    GE_MOTD                             = 2,</span>
<span class="gd">-    GE_JOINED                           = 3,</span>
<span class="gd">-    GE_LEFT                             = 4,</span>
<span class="gd">-    GE_REMOVED                          = 5,</span>
<span class="gd">-    GE_LEADER_IS                        = 6,</span>
<span class="gd">-    GE_LEADER_CHANGED                   = 7,</span>
<span class="gd">-    GE_DISBANDED                        = 8,</span>
<span class="gd">-    GE_TABARDCHANGE                     = 9,</span>
<span class="gd">-    GE_RANK_UPDATED                     = 10,</span>
<span class="gd">-    GE_RANK_DELETED                     = 11,</span>
<span class="gd">-    GE_SIGNED_ON                        = 12,</span>
<span class="gd">-    GE_SIGNED_OFF                       = 13,</span>
<span class="gd">-    GE_GUILDBANKBAGSLOTS_CHANGED        = 14,   /// @todo: Sent when items are moved in gbank - all players with bank open will send tab query</span>
<span class="gd">-    GE_BANK_TAB_PURCHASED               = 15,</span>
<span class="gd">-    GE_BANK_TAB_UPDATED                 = 16,</span>
<span class="gd">-    GE_BANK_MONEY_SET                   = 17,</span>
<span class="gd">-    GE_BANK_TAB_AND_MONEY_UPDATED       = 18,</span>
<span class="gd">-    GE_BANK_TEXT_CHANGED                = 19,</span>
<span class="gi">+    GE_PROMOTION = 0,</span>
<span class="gi">+    GE_DEMOTION = 1,</span>
<span class="gi">+    GE_MOTD = 2,</span>
<span class="gi">+    GE_JOINED = 3,</span>
<span class="gi">+    GE_LEFT = 4,</span>
<span class="gi">+    GE_REMOVED = 5,</span>
<span class="gi">+    GE_LEADER_IS = 6,</span>
<span class="gi">+    GE_LEADER_CHANGED = 7,</span>
<span class="gi">+    GE_DISBANDED = 8,</span>
<span class="gi">+    GE_TABARDCHANGE = 9,</span>
<span class="gi">+    GE_RANK_UPDATED = 10,</span>
<span class="gi">+    GE_RANK_DELETED = 11,</span>
<span class="gi">+    GE_SIGNED_ON = 12,</span>
<span class="gi">+    GE_SIGNED_OFF = 13,</span>
<span class="gi">+    GE_GUILDBANKBAGSLOTS_CHANGED = 14,   /// @todo: Sent when items are moved in gbank - all players with bank open will send tab query</span>
<span class="gi">+    GE_BANK_TAB_PURCHASED = 15,</span>
<span class="gi">+    GE_BANK_TAB_UPDATED = 16,</span>
<span class="gi">+    GE_BANK_MONEY_SET = 17,</span>
<span class="gi">+    GE_BANK_TAB_AND_MONEY_UPDATED = 18,</span>
<span class="gi">+    GE_BANK_TEXT_CHANGED = 19,</span>
<span class="w"> </span>};

<span class="w"> </span>enum PetitionTurns
<span class="w"> </span>{
<span class="gd">-    PETITION_TURN_OK                    = 0,</span>
<span class="gd">-    PETITION_TURN_ALREADY_IN_GUILD      = 2,</span>
<span class="gd">-    PETITION_TURN_NEED_MORE_SIGNATURES  = 4</span>
<span class="gi">+    PETITION_TURN_OK = 0,</span>
<span class="gi">+    PETITION_TURN_ALREADY_IN_GUILD = 2,</span>
<span class="gi">+    PETITION_TURN_NEED_MORE_SIGNATURES = 4</span>
<span class="w"> </span>};

<span class="w"> </span>enum PetitionSigns
<span class="w"> </span>{
<span class="gd">-    PETITION_SIGN_OK                    = 0,</span>
<span class="gd">-    PETITION_SIGN_ALREADY_SIGNED        = 1,</span>
<span class="gd">-    PETITION_SIGN_ALREADY_IN_GUILD      = 2,</span>
<span class="gd">-    PETITION_SIGN_CANT_SIGN_OWN         = 3,</span>
<span class="gd">-    PETITION_SIGN_NOT_SERVER            = 4</span>
<span class="gi">+    PETITION_SIGN_OK = 0,</span>
<span class="gi">+    PETITION_SIGN_ALREADY_SIGNED = 1,</span>
<span class="gi">+    PETITION_SIGN_ALREADY_IN_GUILD = 2,</span>
<span class="gi">+    PETITION_SIGN_CANT_SIGN_OWN = 3,</span>
<span class="gi">+    PETITION_SIGN_NOT_SERVER = 4</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildBankRights
<span class="w"> </span>{
<span class="gd">-    GUILD_BANK_RIGHT_VIEW_TAB           = 0x01,</span>
<span class="gd">-    GUILD_BANK_RIGHT_PUT_ITEM           = 0x02,</span>
<span class="gd">-    GUILD_BANK_RIGHT_UPDATE_TEXT        = 0x04,</span>
<span class="gi">+    GUILD_BANK_RIGHT_VIEW_TAB = 0x01,</span>
<span class="gi">+    GUILD_BANK_RIGHT_PUT_ITEM = 0x02,</span>
<span class="gi">+    GUILD_BANK_RIGHT_UPDATE_TEXT = 0x04,</span>

<span class="gd">-    GUILD_BANK_RIGHT_DEPOSIT_ITEM       = GUILD_BANK_RIGHT_VIEW_TAB | GUILD_BANK_RIGHT_PUT_ITEM,</span>
<span class="gd">-    GUILD_BANK_RIGHT_FULL               = 0xFF</span>
<span class="gi">+    GUILD_BANK_RIGHT_DEPOSIT_ITEM = GUILD_BANK_RIGHT_VIEW_TAB | GUILD_BANK_RIGHT_PUT_ITEM,</span>
<span class="gi">+    GUILD_BANK_RIGHT_FULL = 0xFF</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildBankEventLogTypes
<span class="w"> </span>{
<span class="gd">-    GUILD_BANK_LOG_DEPOSIT_ITEM         = 1,</span>
<span class="gd">-    GUILD_BANK_LOG_WITHDRAW_ITEM        = 2,</span>
<span class="gd">-    GUILD_BANK_LOG_MOVE_ITEM            = 3,</span>
<span class="gd">-    GUILD_BANK_LOG_DEPOSIT_MONEY        = 4,</span>
<span class="gd">-    GUILD_BANK_LOG_WITHDRAW_MONEY       = 5,</span>
<span class="gd">-    GUILD_BANK_LOG_REPAIR_MONEY         = 6,</span>
<span class="gd">-    GUILD_BANK_LOG_MOVE_ITEM2           = 7,</span>
<span class="gd">-    GUILD_BANK_LOG_UNK1                 = 8,</span>
<span class="gd">-    GUILD_BANK_LOG_BUY_SLOT             = 9</span>
<span class="gi">+    GUILD_BANK_LOG_DEPOSIT_ITEM = 1,</span>
<span class="gi">+    GUILD_BANK_LOG_WITHDRAW_ITEM = 2,</span>
<span class="gi">+    GUILD_BANK_LOG_MOVE_ITEM = 3,</span>
<span class="gi">+    GUILD_BANK_LOG_DEPOSIT_MONEY = 4,</span>
<span class="gi">+    GUILD_BANK_LOG_WITHDRAW_MONEY = 5,</span>
<span class="gi">+    GUILD_BANK_LOG_REPAIR_MONEY = 6,</span>
<span class="gi">+    GUILD_BANK_LOG_MOVE_ITEM2 = 7,</span>
<span class="gi">+    GUILD_BANK_LOG_UNK1 = 8,</span>
<span class="gi">+    GUILD_BANK_LOG_BUY_SLOT = 9</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildEventLogTypes
<span class="w"> </span>{
<span class="gd">-    GUILD_EVENT_LOG_INVITE_PLAYER       = 1,</span>
<span class="gd">-    GUILD_EVENT_LOG_JOIN_GUILD          = 2,</span>
<span class="gd">-    GUILD_EVENT_LOG_PROMOTE_PLAYER      = 3,</span>
<span class="gd">-    GUILD_EVENT_LOG_DEMOTE_PLAYER       = 4,</span>
<span class="gd">-    GUILD_EVENT_LOG_UNINVITE_PLAYER     = 5,</span>
<span class="gd">-    GUILD_EVENT_LOG_LEAVE_GUILD         = 6</span>
<span class="gi">+    GUILD_EVENT_LOG_INVITE_PLAYER = 1,</span>
<span class="gi">+    GUILD_EVENT_LOG_JOIN_GUILD = 2,</span>
<span class="gi">+    GUILD_EVENT_LOG_PROMOTE_PLAYER = 3,</span>
<span class="gi">+    GUILD_EVENT_LOG_DEMOTE_PLAYER = 4,</span>
<span class="gi">+    GUILD_EVENT_LOG_UNINVITE_PLAYER = 5,</span>
<span class="gi">+    GUILD_EVENT_LOG_LEAVE_GUILD = 6</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildEmblemError
<span class="w"> </span>{
<span class="gd">-    ERR_GUILDEMBLEM_SUCCESS               = 0,</span>
<span class="gi">+    ERR_GUILDEMBLEM_SUCCESS = 0,</span>
<span class="w"> </span>    ERR_GUILDEMBLEM_INVALID_TABARD_COLORS = 1,
<span class="gd">-    ERR_GUILDEMBLEM_NOGUILD               = 2,</span>
<span class="gd">-    ERR_GUILDEMBLEM_NOTGUILDMASTER        = 3,</span>
<span class="gd">-    ERR_GUILDEMBLEM_NOTENOUGHMONEY        = 4,</span>
<span class="gd">-    ERR_GUILDEMBLEM_INVALIDVENDOR         = 5</span>
<span class="gi">+    ERR_GUILDEMBLEM_NOGUILD = 2,</span>
<span class="gi">+    ERR_GUILDEMBLEM_NOTGUILDMASTER = 3,</span>
<span class="gi">+    ERR_GUILDEMBLEM_NOTENOUGHMONEY = 4,</span>
<span class="gi">+    ERR_GUILDEMBLEM_INVALIDVENDOR = 5</span>
<span class="w"> </span>};

<span class="w"> </span>enum GuildMemberFlags
<span class="w"> </span>{
<span class="gd">-    GUILDMEMBER_STATUS_NONE             = 0x0000,</span>
<span class="gd">-    GUILDMEMBER_STATUS_ONLINE           = 0x0001,</span>
<span class="gd">-    GUILDMEMBER_STATUS_AFK              = 0x0002,</span>
<span class="gd">-    GUILDMEMBER_STATUS_DND              = 0x0004,</span>
<span class="gd">-    GUILDMEMBER_STATUS_MOBILE           = 0x0008, // remote chat from mobile app</span>
<span class="gi">+    GUILDMEMBER_STATUS_NONE = 0x0000,</span>
<span class="gi">+    GUILDMEMBER_STATUS_ONLINE = 0x0001,</span>
<span class="gi">+    GUILDMEMBER_STATUS_AFK = 0x0002,</span>
<span class="gi">+    GUILDMEMBER_STATUS_DND = 0x0004,</span>
<span class="gi">+    GUILDMEMBER_STATUS_MOBILE = 0x0008, // remote chat from mobile app</span>
<span class="w"> </span>};

<span class="w"> </span>// Emblem info
<span class="w"> </span>class EmblemInfo
<span class="w"> </span>{
<span class="w"> </span>public:
<span class="gd">-    EmblemInfo() : m_style(0), m_color(0), m_borderStyle(0), m_borderColor(0), m_backgroundColor(0) { }</span>
<span class="gi">+    EmblemInfo(uint32 /*style*/ = 0, uint32 /*color*/ = 0, uint32 /*borderStyle*/ = 0, uint32 /*borderColor*/ = 0, uint32 /*backgroundColor*/ = 0) :</span>
<span class="gi">+        m_style(0), m_color(0), m_borderStyle(0), m_borderColor(0), m_backgroundColor(0) {</span>
<span class="gi">+    }</span>

<span class="w"> </span>    void LoadFromDB(Field* fields);
<span class="w"> </span>    void SaveToDB(uint32 guildId) const;
<span class="gu">@@ -262,9 +264,9 @@ class EmblemInfo</span>
<span class="w"> </span>class GuildBankRightsAndSlots
<span class="w"> </span>{
<span class="w"> </span>public:
<span class="gd">-    GuildBankRightsAndSlots() : tabId(TAB_UNDEFINED), rights(0), slots(0) { }</span>
<span class="gd">-    GuildBankRightsAndSlots(uint8 _tabId) : tabId(_tabId), rights(0), slots(0) { }</span>
<span class="gd">-    GuildBankRightsAndSlots(uint8 _tabId, uint8 _rights, uint32 _slots) : tabId(_tabId), rights(_rights), slots(_slots) { }</span>
<span class="gi">+    GuildBankRightsAndSlots() : tabId(TAB_UNDEFINED), rights(0), slots(0) {}</span>
<span class="gi">+    GuildBankRightsAndSlots(uint8 _tabId) : tabId(_tabId), rights(0), slots(0) {}</span>
<span class="gi">+    GuildBankRightsAndSlots(uint8 _tabId, uint8 _rights, uint32 _slots) : tabId(_tabId), rights(_rights), slots(_slots) {}</span>

<span class="w"> </span>    void SetGuildMasterValues()
<span class="w"> </span>    {
<span class="gu">@@ -295,7 +297,7 @@ class Guild</span>
<span class="w"> </span>    class Member
<span class="w"> </span>    {
<span class="w"> </span>    public:
<span class="gd">-        Member(uint32 guildId, ObjectGuid guid, uint8 rankId):</span>
<span class="gi">+        Member(uint32 guildId, ObjectGuid guid, uint8 rankId) :</span>
<span class="w"> </span>            m_guildId(guildId),
<span class="w"> </span>            m_guid(guid),
<span class="w"> </span>            m_zoneId(0),
<span class="gu">@@ -403,8 +405,8 @@ class Guild</span>
<span class="w"> </span>    {
<span class="w"> </span>    public:
<span class="w"> </span>        LogEntry(uint32 guildId, ObjectGuid::LowType guid);
<span class="gd">-        LogEntry(uint32 guildId, ObjectGuid::LowType guid, time_t timestamp) : m_guildId(guildId), m_guid(guid), m_timestamp(timestamp) { }</span>
<span class="gd">-        virtual ~LogEntry() { }</span>
<span class="gi">+        LogEntry(uint32 guildId, ObjectGuid::LowType guid, time_t timestamp) : m_guildId(guildId), m_guid(guid), m_timestamp(timestamp) {}</span>
<span class="gi">+        virtual ~LogEntry() {}</span>

<span class="w"> </span>        ObjectGuid::LowType GetGUID() const { return m_guid; }
<span class="w"> </span>        uint64 GetTimestamp() const { return m_timestamp; }
<span class="gu">@@ -422,12 +424,14 @@ class Guild</span>
<span class="w"> </span>    {
<span class="w"> </span>    public:
<span class="w"> </span>        EventLogEntry(uint32 guildId, ObjectGuid::LowType guid, GuildEventLogTypes eventType, ObjectGuid playerGuid1, ObjectGuid playerGuid2, uint8 newRank) :
<span class="gd">-            LogEntry(guildId, guid), m_eventType(eventType), m_playerGuid1(playerGuid1), m_playerGuid2(playerGuid2), m_newRank(newRank) { }</span>
<span class="gi">+            LogEntry(guildId, guid), m_eventType(eventType), m_playerGuid1(playerGuid1), m_playerGuid2(playerGuid2), m_newRank(newRank) {</span>
<span class="gi">+        }</span>

<span class="w"> </span>        EventLogEntry(uint32 guildId, ObjectGuid::LowType guid, time_t timestamp, GuildEventLogTypes eventType, ObjectGuid playerGuid1, ObjectGuid playerGuid2, uint8 newRank) :
<span class="gd">-            LogEntry(guildId, guid, timestamp), m_eventType(eventType), m_playerGuid1(playerGuid1), m_playerGuid2(playerGuid2), m_newRank(newRank) { }</span>
<span class="gi">+            LogEntry(guildId, guid, timestamp), m_eventType(eventType), m_playerGuid1(playerGuid1), m_playerGuid2(playerGuid2), m_newRank(newRank) {</span>
<span class="gi">+        }</span>

<span class="gd">-        ~EventLogEntry() override { }</span>
<span class="gi">+        ~EventLogEntry() override {}</span>

<span class="w"> </span>        void SaveToDB(CharacterDatabaseTransaction trans) const override;
<span class="w"> </span>        void WritePacket(WorldPackets::Guild::GuildEventLogQueryResults&amp; packet) const;
<span class="gu">@@ -458,13 +462,15 @@ class Guild</span>

<span class="w"> </span>        BankEventLogEntry(uint32 guildId, ObjectGuid::LowType guid, GuildBankEventLogTypes eventType, uint8 tabId, ObjectGuid playerGuid, uint32 itemOrMoney, uint16 itemStackCount, uint8 destTabId) :
<span class="w"> </span>            LogEntry(guildId, guid), m_eventType(eventType), m_bankTabId(tabId), m_playerGuid(playerGuid),
<span class="gd">-            m_itemOrMoney(itemOrMoney), m_itemStackCount(itemStackCount), m_destTabId(destTabId) { }</span>
<span class="gi">+            m_itemOrMoney(itemOrMoney), m_itemStackCount(itemStackCount), m_destTabId(destTabId) {</span>
<span class="gi">+        }</span>

<span class="w"> </span>        BankEventLogEntry(uint32 guildId, ObjectGuid::LowType guid, time_t timestamp, uint8 tabId, GuildBankEventLogTypes eventType, ObjectGuid playerGuid, uint32 itemOrMoney, uint16 itemStackCount, uint8 destTabId) :
<span class="w"> </span>            LogEntry(guildId, guid, timestamp), m_eventType(eventType), m_bankTabId(tabId), m_playerGuid(playerGuid),
<span class="gd">-            m_itemOrMoney(itemOrMoney), m_itemStackCount(itemStackCount), m_destTabId(destTabId) { }</span>
<span class="gi">+            m_itemOrMoney(itemOrMoney), m_itemStackCount(itemStackCount), m_destTabId(destTabId) {</span>
<span class="gi">+        }</span>

<span class="gd">-        ~BankEventLogEntry() override { }</span>
<span class="gi">+        ~BankEventLogEntry() override {}</span>

<span class="w"> </span>        void SaveToDB(CharacterDatabaseTransaction trans) const override;
<span class="w"> </span>        void WritePacket(WorldPackets::Guild::GuildBankLogQueryResults&amp; packet) const;
<span class="gu">@@ -509,11 +515,12 @@ class Guild</span>
<span class="w"> </span>    class RankInfo
<span class="w"> </span>    {
<span class="w"> </span>    public:
<span class="gd">-        RankInfo(): m_guildId(0), m_rankId(GUILD_RANK_NONE), m_rights(GR_RIGHT_EMPTY), m_bankMoneyPerDay(0) { }</span>
<span class="gd">-        RankInfo(uint32 guildId) : m_guildId(guildId), m_rankId(GUILD_RANK_NONE), m_rights(GR_RIGHT_EMPTY), m_bankMoneyPerDay(0) { }</span>
<span class="gi">+        RankInfo() : m_guildId(0), m_rankId(GUILD_RANK_NONE), m_rights(GR_RIGHT_EMPTY), m_bankMoneyPerDay(0) {}</span>
<span class="gi">+        RankInfo(uint32 guildId) : m_guildId(guildId), m_rankId(GUILD_RANK_NONE), m_rights(GR_RIGHT_EMPTY), m_bankMoneyPerDay(0) {}</span>
<span class="w"> </span>        RankInfo(uint32 guildId, uint8 rankId, std::string_view name, uint32 rights, uint32 money) :
<span class="w"> </span>            m_guildId(guildId), m_rankId(rankId), m_name(name), m_rights(rights),
<span class="gd">-            m_bankMoneyPerDay(rankId != GR_GUILDMASTER ? money : GUILD_WITHDRAW_MONEY_UNLIMITED) { }</span>
<span class="gi">+            m_bankMoneyPerDay(rankId != GR_GUILDMASTER ? money : GUILD_WITHDRAW_MONEY_UNLIMITED) {</span>
<span class="gi">+        }</span>

<span class="w"> </span>        void LoadFromDB(Field* fields);
<span class="w"> </span>        void SaveToDB(CharacterDatabaseTransaction trans) const;
<span class="gu">@@ -572,7 +579,7 @@ class Guild</span>
<span class="w"> </span>        std::string const&amp; GetIcon() const { return m_icon; }
<span class="w"> </span>        std::string const&amp; GetText() const { return m_text; }

<span class="gd">-        inline Item* GetItem(uint8 slotId) const { return slotId &lt; GUILD_BANK_MAX_SLOTS ?  m_items[slotId] : nullptr; }</span>
<span class="gi">+        inline Item* GetItem(uint8 slotId) const { return slotId &lt; GUILD_BANK_MAX_SLOTS ? m_items[slotId] : nullptr; }</span>
<span class="w"> </span>        bool SetItem(CharacterDatabaseTransaction trans, uint8 slotId, Item* pItem);

<span class="w"> </span>    private:
<span class="gu">@@ -590,8 +597,9 @@ class Guild</span>
<span class="w"> </span>    {
<span class="w"> </span>    public:
<span class="w"> </span>        MoveItemData(Guild* guild, Player* player, uint8 container, uint8 slotId) : m_pGuild(guild), m_pPlayer(player),
<span class="gd">-            m_container(container), m_slotId(slotId), m_pItem(nullptr), m_pClonedItem(nullptr) { }</span>
<span class="gd">-        virtual ~MoveItemData() { }</span>
<span class="gi">+            m_container(container), m_slotId(slotId), m_pItem(nullptr), m_pClonedItem(nullptr) {</span>
<span class="gi">+        }</span>
<span class="gi">+        virtual ~MoveItemData() {}</span>

<span class="w"> </span>        virtual bool IsBank() const = 0;
<span class="w"> </span>        // Initializes item pointer. Returns true, if item exists, false otherwise.
<span class="gu">@@ -637,7 +645,8 @@ class Guild</span>
<span class="w"> </span>    {
<span class="w"> </span>    public:
<span class="w"> </span>        PlayerMoveItemData(Guild* guild, Player* player, uint8 container, uint8 slotId) :
<span class="gd">-            MoveItemData(guild, player, container, slotId) { }</span>
<span class="gi">+            MoveItemData(guild, player, container, slotId) {</span>
<span class="gi">+        }</span>

<span class="w"> </span>        bool IsBank() const override { return false; }
<span class="w"> </span>        bool InitItem() override;
<span class="gu">@@ -652,7 +661,8 @@ class Guild</span>
<span class="w"> </span>    {
<span class="w"> </span>    public:
<span class="w"> </span>        BankMoveItemData(Guild* guild, Player* player, uint8 container, uint8 slotId) :
<span class="gd">-            MoveItemData(guild, player, container, slotId) { }</span>
<span class="gi">+            MoveItemData(guild, player, container, slotId) {</span>
<span class="gi">+        }</span>

<span class="w"> </span>        bool IsBank() const override { return true; }
<span class="w"> </span>        bool InitItem() override;
<span class="gu">@@ -696,11 +706,13 @@ class Guild</span>
<span class="w"> </span>    void HandleQuery(WorldSession* session);
<span class="w"> </span>    void HandleSetMOTD(WorldSession* session, std::string_view motd);
<span class="w"> </span>    void HandleSetInfo(WorldSession* session, std::string_view info);
<span class="gd">-    void HandleSetEmblem(WorldSession* session, const EmblemInfo&amp; emblemInfo);</span>
<span class="gi">+    void HandleSetEmblem(WorldSession* session, EmblemInfo const&amp; emblemInfo);</span>
<span class="gi">+    void HandleSetEmblem(EmblemInfo const&amp; emblemInfo);</span>
<span class="w"> </span>    void HandleSetLeader(WorldSession* session, std::string_view name);
<span class="w"> </span>    void HandleSetBankTabInfo(WorldSession* session, uint8 tabId, std::string_view name, std::string_view icon);
<span class="w"> </span>    void HandleSetMemberNote(WorldSession* session, std::string_view name, std::string_view note, bool isPublic);
<span class="w"> </span>    void HandleSetRankInfo(WorldSession* session, uint8 rankId, std::string_view name, uint32 rights, uint32 moneyPerDay, std::array&lt;GuildBankRightsAndSlots, GUILD_BANK_MAX_TABS&gt; const&amp; rightsAndSlots);
<span class="gi">+    void HandleSetRankInfo(uint8 rankId, uint32 rights = 0, std::string_view name = &quot;&quot;, uint32 moneyPerDay = 0);</span>
<span class="w"> </span>    void HandleBuyBankTab(WorldSession* session, uint8 tabId);
<span class="w"> </span>    void HandleInviteMember(WorldSession* session, std::string const&amp; name);
<span class="w"> </span>    void HandleAcceptMember(WorldSession* session);
<span class="gu">@@ -779,6 +791,10 @@ class Guild</span>
<span class="w"> </span>    [[nodiscard]] bool ModifyBankMoney(CharacterDatabaseTransaction trans, const uint64&amp; amount, bool add) { return _ModifyBankMoney(trans, amount, add); }
<span class="w"> </span>    [[nodiscard]] uint32 GetMemberSize() const { return m_members.size(); }

<span class="gi">+    bool MemberHasTabRights(ObjectGuid guid, uint8 tabId, uint32 rights) const;</span>
<span class="gi">+    bool HasRankRight(Player* player, uint32 right) const;</span>
<span class="gi">+    uint32 GetRankRights(uint8 rankId) const;</span>
<span class="gi">+</span>
<span class="w"> </span>protected:
<span class="w"> </span>    uint32 m_id;
<span class="w"> </span>    std::string m_name;
<span class="gu">@@ -803,13 +819,6 @@ class Guild</span>
<span class="w"> </span>    inline uint8 _GetRanksSize() const { return uint8(m_ranks.size()); }
<span class="w"> </span>    inline const RankInfo* GetRankInfo(uint8 rankId) const { return rankId &lt; _GetRanksSize() ? &amp;m_ranks[rankId] : nullptr; }
<span class="w"> </span>    inline RankInfo* GetRankInfo(uint8 rankId) { return rankId &lt; _GetRanksSize() ? &amp;m_ranks[rankId] : nullptr; }
<span class="gd">-    inline bool _HasRankRight(Player* player, uint32 right) const</span>
<span class="gd">-    {</span>
<span class="gd">-        if (player)</span>
<span class="gd">-            if (Member const* member = GetMember(player-&gt;GetGUID()))</span>
<span class="gd">-                return (_GetRankRights(member-&gt;GetRankId()) &amp; right) != GR_RIGHT_EMPTY;</span>
<span class="gd">-        return false;</span>
<span class="gd">-    }</span>

<span class="w"> </span>    inline uint8 _GetLowestRankId() const { return uint8(m_ranks.size() - 1); }

<span class="gu">@@ -840,7 +849,6 @@ class Guild</span>
<span class="w"> </span>    void _SetRankBankMoneyPerDay(uint8 rankId, uint32 moneyPerDay);
<span class="w"> </span>    void _SetRankBankTabRightsAndSlots(uint8 rankId, GuildBankRightsAndSlots rightsAndSlots, bool saveToDB = true);
<span class="w"> </span>    int8 _GetRankBankTabRights(uint8 rankId, uint8 tabId) const;
<span class="gd">-    uint32 _GetRankRights(uint8 rankId) const;</span>
<span class="w"> </span>    int32 _GetRankBankMoneyPerDay(uint8 rankId) const;
<span class="w"> </span>    int32 _GetRankBankTabSlotsPerDay(uint8 rankId, uint8 tabId) const;
<span class="w"> </span>    std::string _GetRankName(uint8 rankId) const;
<span class="gu">@@ -848,7 +856,6 @@ class Guild</span>
<span class="w"> </span>    int32 _GetMemberRemainingSlots(Member const&amp; member, uint8 tabId) const;
<span class="w"> </span>    int32 _GetMemberRemainingMoney(Member const&amp; member) const;
<span class="w"> </span>    void _UpdateMemberWithdrawSlots(CharacterDatabaseTransaction trans, ObjectGuid guid, uint8 tabId);
<span class="gd">-    bool _MemberHasTabRights(ObjectGuid guid, uint8 tabId, uint32 rights) const;</span>

<span class="w"> </span>    void _LogEvent(GuildEventLogTypes eventType, ObjectGuid playerGuid1, ObjectGuid playerGuid2 = ObjectGuid::Empty, uint8 newRank = 0);
<span class="w"> </span>    void _LogBankEvent(CharacterDatabaseTransaction trans, GuildBankEventLogTypes eventType, uint8 tabId, ObjectGuid playerGuid, uint32 itemOrMoney, uint16 itemStackCount = 0, uint8 destTabId = 0);
<span class="gh">diff --git a/src/server/game/Handlers/CharacterHandler.cpp b/src/server/game/Handlers/CharacterHandler.cpp</span>
<span class="gh">index eeff0d3d6488d3..97c8815d972718 100644</span>
<span class="gd">--- a/src/server/game/Handlers/CharacterHandler.cpp</span>
<span class="gi">+++ b/src/server/game/Handlers/CharacterHandler.cpp</span>
<span class="gu">@@ -60,19 +60,9 @@</span>
<span class="w"> </span>#include &quot;WorldSession.h&quot;
<span class="w"> </span>#include &quot;WorldSessionMgr.h&quot;

<span class="gd">-class LoginQueryHolder : public CharacterDatabaseQueryHolder</span>
<span class="gi">+LoginQueryHolder::LoginQueryHolder(uint32 accountId, ObjectGuid guid) : m_accountId(accountId), m_guid(guid)</span>
<span class="w"> </span>{
<span class="gd">-private:</span>
<span class="gd">-    uint32 m_accountId;</span>
<span class="gd">-    ObjectGuid m_guid;</span>
<span class="gd">-public:</span>
<span class="gd">-    LoginQueryHolder(uint32 accountId, ObjectGuid guid)</span>
<span class="gd">-        : m_accountId(accountId), m_guid(guid) { }</span>
<span class="gd">-</span>
<span class="gd">-    ObjectGuid GetGuid() const { return m_guid; }</span>
<span class="gd">-    uint32 GetAccountId() const { return m_accountId; }</span>
<span class="gd">-    bool Initialize();</span>
<span class="gd">-};</span>
<span class="gi">+}</span>

<span class="w"> </span>bool LoginQueryHolder::Initialize()
<span class="w"> </span>{
<span class="gu">@@ -274,15 +264,15 @@ void WorldSession::HandleCharCreateOpcode(WorldPacket&amp; recvData)</span>
<span class="w"> </span>    std::shared_ptr&lt;CharacterCreateInfo&gt; createInfo = std::make_shared&lt;CharacterCreateInfo&gt;();

<span class="w"> </span>    recvData &gt;&gt; createInfo-&gt;Name
<span class="gd">-             &gt;&gt; createInfo-&gt;Race</span>
<span class="gd">-             &gt;&gt; createInfo-&gt;Class</span>
<span class="gd">-             &gt;&gt; createInfo-&gt;Gender</span>
<span class="gd">-             &gt;&gt; createInfo-&gt;Skin</span>
<span class="gd">-             &gt;&gt; createInfo-&gt;Face</span>
<span class="gd">-             &gt;&gt; createInfo-&gt;HairStyle</span>
<span class="gd">-             &gt;&gt; createInfo-&gt;HairColor</span>
<span class="gd">-             &gt;&gt; createInfo-&gt;FacialHair</span>
<span class="gd">-             &gt;&gt; createInfo-&gt;OutfitId;</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;Race</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;Class</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;Gender</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;Skin</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;Face</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;HairStyle</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;HairColor</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;FacialHair</span>
<span class="gi">+        &gt;&gt; createInfo-&gt;OutfitId;</span>

<span class="w"> </span>    if (AccountMgr::IsPlayerAccount(GetSecurity()))
<span class="w"> </span>    {
<span class="gu">@@ -381,228 +371,233 @@ void WorldSession::HandleCharCreateOpcode(WorldPacket&amp; recvData)</span>
<span class="w"> </span>    stmt-&gt;SetData(0, createInfo-&gt;Name);

<span class="w"> </span>    _queryProcessor.AddCallback(CharacterDatabase.AsyncQuery(stmt)
<span class="gd">-    .WithChainingPreparedCallback([this](QueryCallback&amp; queryCallback, PreparedQueryResult result)</span>
<span class="gd">-    {</span>
<span class="gd">-        if (result)</span>
<span class="gd">-        {</span>
<span class="gd">-            SendCharCreate(CHAR_CREATE_NAME_IN_USE);</span>
<span class="gd">-            return;</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="gd">-        LoginDatabasePreparedStatement* stmt = LoginDatabase.GetPreparedStatement(LOGIN_SEL_SUM_REALM_CHARACTERS);</span>
<span class="gd">-        stmt-&gt;SetData(0, GetAccountId());</span>
<span class="gd">-        queryCallback.SetNextQuery(LoginDatabase.AsyncQuery(stmt));</span>
<span class="gd">-    })</span>
<span class="gd">-    .WithChainingPreparedCallback([this](QueryCallback&amp; queryCallback, PreparedQueryResult result)</span>
<span class="gd">-    {</span>
<span class="gd">-        uint64 acctCharCount = 0;</span>
<span class="gd">-        if (result)</span>
<span class="gd">-        {</span>
<span class="gd">-            Field* fields = result-&gt;Fetch();</span>
<span class="gd">-            acctCharCount = uint64(fields[0].Get&lt;double&gt;());</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="gd">-        if (acctCharCount &gt;= static_cast&lt;uint64&gt;(sWorld-&gt;getIntConfig(CONFIG_CHARACTERS_PER_ACCOUNT)))</span>
<span class="gd">-        {</span>
<span class="gd">-            SendCharCreate(CHAR_CREATE_ACCOUNT_LIMIT);</span>
<span class="gd">-            return;</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="gd">-        CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_SEL_SUM_CHARS);</span>
<span class="gd">-        stmt-&gt;SetData(0, GetAccountId());</span>
<span class="gd">-        queryCallback.SetNextQuery(CharacterDatabase.AsyncQuery(stmt));</span>
<span class="gd">-    })</span>
<span class="gd">-    .WithChainingPreparedCallback([this, createInfo](QueryCallback&amp; queryCallback, PreparedQueryResult result)</span>
<span class="gd">-    {</span>
<span class="gd">-        if (result)</span>
<span class="gd">-        {</span>
<span class="gd">-            Field* fields = result-&gt;Fetch();</span>
<span class="gd">-            createInfo-&gt;CharCount = uint8(fields[0].Get&lt;uint64&gt;()); // SQL&#39;s COUNT() returns uint64 but it will always be less than uint8.Max</span>
<span class="gd">-</span>
<span class="gd">-            if (createInfo-&gt;CharCount &gt;= sWorld-&gt;getIntConfig(CONFIG_CHARACTERS_PER_REALM))</span>
<span class="gi">+        .WithChainingPreparedCallback([this](QueryCallback&amp; queryCallback, PreparedQueryResult result)</span>
<span class="w"> </span>            {
<span class="gd">-                SendCharCreate(CHAR_CREATE_SERVER_LIMIT);</span>
<span class="gd">-                return;</span>
<span class="gd">-            }</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="gd">-        bool allowTwoSideAccounts = !sWorld-&gt;IsPvPRealm() || sWorld-&gt;getBoolConfig(CONFIG_ALLOW_TWO_SIDE_ACCOUNTS) || !AccountMgr::IsPlayerAccount(GetSecurity());</span>
<span class="gd">-        uint32 skipCinematics = sWorld-&gt;getIntConfig(CONFIG_SKIP_CINEMATICS);</span>
<span class="gi">+                if (result)</span>
<span class="gi">+                {</span>
<span class="gi">+                    SendCharCreate(CHAR_CREATE_NAME_IN_USE);</span>
<span class="gi">+                    return;</span>
<span class="gi">+                }</span>

<span class="gd">-        std::function&lt;void(PreparedQueryResult)&gt; finalizeCharacterCreation = [this, createInfo](PreparedQueryResult result)</span>
<span class="gd">-        {</span>
<span class="gd">-            if (!sScriptMgr-&gt;CanAccountCreateCharacter(GetAccountId(), createInfo-&gt;Race, createInfo-&gt;Class))</span>
<span class="gd">-            {</span>
<span class="gd">-                SendCharCreate(CHAR_CREATE_DISABLED);</span>
<span class="gd">-                return;</span>
<span class="gd">-            }</span>
<span class="gd">-            bool haveSameRace = false;</span>
<span class="gd">-            uint32 heroicReqLevel = sWorld-&gt;getIntConfig(CONFIG_CHARACTER_CREATING_MIN_LEVEL_FOR_HEROIC_CHARACTER);</span>
<span class="gd">-            bool hasHeroicReqLevel = (heroicReqLevel == 0);</span>
<span class="gd">-            bool allowTwoSideAccounts = !sWorld-&gt;IsPvPRealm() || sWorld-&gt;getBoolConfig(CONFIG_ALLOW_TWO_SIDE_ACCOUNTS) || !AccountMgr::IsPlayerAccount(GetSecurity());</span>
<span class="gd">-            uint32 skipCinematics = sWorld-&gt;getIntConfig(CONFIG_SKIP_CINEMATICS);</span>
<span class="gd">-            bool checkDeathKnightReqs = AccountMgr::IsPlayerAccount(GetSecurity()) &amp;&amp; createInfo-&gt;Class == CLASS_DEATH_KNIGHT;</span>
<span class="gd">-</span>
<span class="gd">-            if (result)</span>
<span class="gi">+                LoginDatabasePreparedStatement* stmt = LoginDatabase.GetPreparedStatement(LOGIN_SEL_SUM_REALM_CHARACTERS);</span>
<span class="gi">+                stmt-&gt;SetData(0, GetAccountId());</span>
<span class="gi">+                queryCallback.SetNextQuery(LoginDatabase.AsyncQuery(stmt));</span>
<span class="gi">+            })</span>
<span class="gi">+        .WithChainingPreparedCallback([this](QueryCallback&amp; queryCallback, PreparedQueryResult result)</span>
<span class="w"> </span>            {
<span class="gd">-                TeamId teamId = Player::TeamIdForRace(createInfo-&gt;Race);</span>
<span class="gd">-                uint32 freeDeathKnightSlots = sWorld-&gt;getIntConfig(CONFIG_HEROIC_CHARACTERS_PER_REALM);</span>
<span class="gd">-</span>
<span class="gd">-                Field* field = result-&gt;Fetch();</span>
<span class="gd">-                uint8 accRace = field[1].Get&lt;uint8&gt;();</span>
<span class="gd">-</span>
<span class="gd">-                if (checkDeathKnightReqs)</span>
<span class="gi">+                uint64 acctCharCount = 0;</span>
<span class="gi">+                if (result)</span>
<span class="w"> </span>                {
<span class="gd">-                    uint8 accClass = field[2].Get&lt;uint8&gt;();</span>
<span class="gd">-                    if (accClass == CLASS_DEATH_KNIGHT)</span>
<span class="gd">-                    {</span>
<span class="gd">-                        if (freeDeathKnightSlots &gt; 0)</span>
<span class="gd">-                            --freeDeathKnightSlots;</span>
<span class="gd">-</span>
<span class="gd">-                        if (freeDeathKnightSlots == 0)</span>
<span class="gd">-                        {</span>
<span class="gd">-                            SendCharCreate(CHAR_CREATE_UNIQUE_CLASS_LIMIT);</span>
<span class="gd">-                            return;</span>
<span class="gd">-                        }</span>
<span class="gd">-                    }</span>
<span class="gi">+                    Field* fields = result-&gt;Fetch();</span>
<span class="gi">+                    acctCharCount = uint64(fields[0].Get&lt;double&gt;());</span>
<span class="gi">+                }</span>

<span class="gd">-                    if (!hasHeroicReqLevel)</span>
<span class="gd">-                    {</span>
<span class="gd">-                        uint8 accLevel = field[0].Get&lt;uint8&gt;();</span>
<span class="gd">-                        if (accLevel &gt;= heroicReqLevel)</span>
<span class="gd">-                            hasHeroicReqLevel = true;</span>
<span class="gd">-                    }</span>
<span class="gi">+                if (acctCharCount &gt;= static_cast&lt;uint64&gt;(sWorld-&gt;getIntConfig(CONFIG_CHARACTERS_PER_ACCOUNT)))</span>
<span class="gi">+                {</span>
<span class="gi">+                    SendCharCreate(CHAR_CREATE_ACCOUNT_LIMIT);</span>
<span class="gi">+                    return;</span>
<span class="w"> </span>                }

<span class="gd">-                // need to check team only for first character</span>
<span class="gd">-                /// @todo what to if account already has characters of both races?</span>
<span class="gd">-                if (!allowTwoSideAccounts)</span>
<span class="gi">+                CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_SEL_SUM_CHARS);</span>
<span class="gi">+                stmt-&gt;SetData(0, GetAccountId());</span>
<span class="gi">+                queryCallback.SetNextQuery(CharacterDatabase.AsyncQuery(stmt));</span>
<span class="gi">+            })</span>
<span class="gi">+        .WithChainingPreparedCallback([this, createInfo](QueryCallback&amp; queryCallback, PreparedQueryResult result)</span>
<span class="gi">+            {</span>
<span class="gi">+                if (result)</span>
<span class="w"> </span>                {
<span class="gd">-                    uint32 accTeam = 0;</span>
<span class="gd">-                    if (accRace &gt; 0)</span>
<span class="gd">-                        accTeam = Player::TeamIdForRace(accRace);</span>
<span class="gi">+                    Field* fields = result-&gt;Fetch();</span>
<span class="gi">+                    createInfo-&gt;CharCount = uint8(fields[0].Get&lt;uint64&gt;()); // SQL&#39;s COUNT() returns uint64 but it will always be less than uint8.Max</span>

<span class="gd">-                    if (accTeam != teamId)</span>
<span class="gi">+                    if (createInfo-&gt;CharCount &gt;= sWorld-&gt;getIntConfig(CONFIG_CHARACTERS_PER_REALM))</span>
<span class="w"> </span>                    {
<span class="gd">-                        SendCharCreate(CHAR_CREATE_PVP_TEAMS_VIOLATION);</span>
<span class="gi">+                        SendCharCreate(CHAR_CREATE_SERVER_LIMIT);</span>
<span class="w"> </span>                        return;
<span class="w"> </span>                    }
<span class="w"> </span>                }

<span class="gd">-                // search same race for cinematic or same class if need</span>
<span class="gd">-                /// @todo check if cinematic already shown? (already logged in?; cinematic field)</span>
<span class="gd">-                while ((skipCinematics == 1 &amp;&amp; !haveSameRace) || createInfo-&gt;Class == CLASS_DEATH_KNIGHT)</span>
<span class="gd">-                {</span>
<span class="gd">-                    if (!result-&gt;NextRow())</span>
<span class="gd">-                        break;</span>
<span class="gd">-</span>
<span class="gd">-                    field = result-&gt;Fetch();</span>
<span class="gd">-                    accRace = field[1].Get&lt;uint8&gt;();</span>
<span class="gd">-</span>
<span class="gd">-                    if (!haveSameRace)</span>
<span class="gd">-                        haveSameRace = createInfo-&gt;Race == accRace;</span>
<span class="gi">+                bool allowTwoSideAccounts = !sWorld-&gt;IsPvPRealm() || sWorld-&gt;getBoolConfig(CONFIG_ALLOW_TWO_SIDE_ACCOUNTS) || !AccountMgr::IsPlayerAccount(GetSecurity());</span>
<span class="gi">+                uint32 skipCinematics = sWorld-&gt;getIntConfig(CONFIG_SKIP_CINEMATICS);</span>

<span class="gd">-                    if (checkDeathKnightReqs)</span>
<span class="gi">+                std::function&lt;void(PreparedQueryResult)&gt; finalizeCharacterCreation = [this, createInfo](PreparedQueryResult result)</span>
<span class="w"> </span>                    {
<span class="gd">-                        uint8 acc_class = field[2].Get&lt;uint8&gt;();</span>
<span class="gd">-                        if (acc_class == CLASS_DEATH_KNIGHT)</span>
<span class="gi">+                        if (!sScriptMgr-&gt;CanAccountCreateCharacter(GetAccountId(), createInfo-&gt;Race, createInfo-&gt;Class))</span>
<span class="gi">+                        {</span>
<span class="gi">+                            SendCharCreate(CHAR_CREATE_DISABLED);</span>
<span class="gi">+                            return;</span>
<span class="gi">+                        }</span>
<span class="gi">+                        bool haveSameRace = false;</span>
<span class="gi">+                        uint32 heroicReqLevel = sWorld-&gt;getIntConfig(CONFIG_CHARACTER_CREATING_MIN_LEVEL_FOR_HEROIC_CHARACTER);</span>
<span class="gi">+                        bool hasHeroicReqLevel = (heroicReqLevel == 0);</span>
<span class="gi">+                        bool allowTwoSideAccounts = !sWorld-&gt;IsPvPRealm() || sWorld-&gt;getBoolConfig(CONFIG_ALLOW_TWO_SIDE_ACCOUNTS) || !AccountMgr::IsPlayerAccount(GetSecurity());</span>
<span class="gi">+                        uint32 skipCinematics = sWorld-&gt;getIntConfig(CONFIG_SKIP_CINEMATICS);</span>
<span class="gi">+                        bool checkDeathKnightReqs = AccountMgr::IsPlayerAccount(GetSecurity()) &amp;&amp; createInfo-&gt;Class == CLASS_DEATH_KNIGHT;</span>
<span class="gi">+</span>
<span class="gi">+                        if (result)</span>
<span class="w"> </span>                        {
<span class="gd">-                            if (freeDeathKnightSlots &gt; 0)</span>
<span class="gd">-                                --freeDeathKnightSlots;</span>
<span class="gi">+                            TeamId teamId = Player::TeamIdForRace(createInfo-&gt;Race);</span>
<span class="gi">+                            uint32 freeDeathKnightSlots = sWorld-&gt;getIntConfig(CONFIG_HEROIC_CHARACTERS_PER_REALM);</span>
<span class="gi">+</span>
<span class="gi">+                            Field* field = result-&gt;Fetch();</span>
<span class="gi">+                            uint8 accRace = field[1].Get&lt;uint8&gt;();</span>
<span class="gi">+</span>
<span class="gi">+                            if (checkDeathKnightReqs)</span>
<span class="gi">+                            {</span>
<span class="gi">+                                uint8 accClass = field[2].Get&lt;uint8&gt;();</span>
<span class="gi">+                                if (accClass == CLASS_DEATH_KNIGHT)</span>
<span class="gi">+                                {</span>
<span class="gi">+                                    if (freeDeathKnightSlots &gt; 0)</span>
<span class="gi">+                                        --freeDeathKnightSlots;</span>
<span class="gi">+</span>
<span class="gi">+                                    if (freeDeathKnightSlots == 0)</span>
<span class="gi">+                                    {</span>
<span class="gi">+                                        SendCharCreate(CHAR_CREATE_UNIQUE_CLASS_LIMIT);</span>
<span class="gi">+                                        return;</span>
<span class="gi">+                                    }</span>
<span class="gi">+                                }</span>
<span class="gi">+</span>
<span class="gi">+                                if (!hasHeroicReqLevel)</span>
<span class="gi">+                                {</span>
<span class="gi">+                                    uint8 accLevel = field[0].Get&lt;uint8&gt;();</span>
<span class="gi">+                                    if (accLevel &gt;= heroicReqLevel)</span>
<span class="gi">+                                        hasHeroicReqLevel = true;</span>
<span class="gi">+                                }</span>
<span class="gi">+                            }</span>
<span class="gi">+</span>
<span class="gi">+                            // need to check team only for first character</span>
<span class="gi">+                            /// @todo what to if account already has characters of both races?</span>
<span class="gi">+                            if (!allowTwoSideAccounts)</span>
<span class="gi">+                            {</span>
<span class="gi">+                                uint32 accTeam = 0;</span>
<span class="gi">+                                if (accRace &gt; 0)</span>
<span class="gi">+                                    accTeam = Player::TeamIdForRace(accRace);</span>
<span class="gi">+</span>
<span class="gi">+                                if (accTeam != teamId)</span>
<span class="gi">+                                {</span>
<span class="gi">+                                    SendCharCreate(CHAR_CREATE_PVP_TEAMS_VIOLATION);</span>
<span class="gi">+                                    return;</span>
<span class="gi">+                                }</span>
<span class="gi">+                            }</span>

<span class="gd">-                            if (freeDeathKnightSlots == 0)</span>
<span class="gi">+                            // search same race for cinematic or same class if need</span>
<span class="gi">+                            /// @todo check if cinematic already shown? (already logged in?; cinematic field)</span>
<span class="gi">+                            while ((skipCinematics == 1 &amp;&amp; !haveSameRace) || createInfo-&gt;Class == CLASS_DEATH_KNIGHT)</span>
<span class="w"> </span>                            {
<span class="gd">-                                SendCharCreate(CHAR_CREATE_UNIQUE_CLASS_LIMIT);</span>
<span class="gd">-                                return;</span>
<span class="gi">+                                if (!result-&gt;NextRow())</span>
<span class="gi">+                                    break;</span>
<span class="gi">+</span>
<span class="gi">+                                field = result-&gt;Fetch();</span>
<span class="gi">+                                accRace = field[1].Get&lt;uint8&gt;();</span>
<span class="gi">+</span>
<span class="gi">+                                if (!haveSameRace)</span>
<span class="gi">+                                    haveSameRace = createInfo-&gt;Race == accRace;</span>
<span class="gi">+</span>
<span class="gi">+                                if (checkDeathKnightReqs)</span>
<span class="gi">+                                {</span>
<span class="gi">+                                    uint8 acc_class = field[2].Get&lt;uint8&gt;();</span>
<span class="gi">+                                    if (acc_class == CLASS_DEATH_KNIGHT)</span>
<span class="gi">+                                    {</span>
<span class="gi">+                                        if (freeDeathKnightSlots &gt; 0)</span>
<span class="gi">+                                            --freeDeathKnightSlots;</span>
<span class="gi">+</span>
<span class="gi">+                                        if (freeDeathKnightSlots == 0)</span>
<span class="gi">+                                        {</span>
<span class="gi">+                                            SendCharCreate(CHAR_CREATE_UNIQUE_CLASS_LIMIT);</span>
<span class="gi">+                                            return;</span>
<span class="gi">+                                        }</span>
<span class="gi">+                                    }</span>
<span class="gi">+</span>
<span class="gi">+                                    if (!hasHeroicReqLevel)</span>
<span class="gi">+                                    {</span>
<span class="gi">+                                        uint8 acc_level = field[0].Get&lt;uint8&gt;();</span>
<span class="gi">+                                        if (acc_level &gt;= heroicReqLevel)</span>
<span class="gi">+                                            hasHeroicReqLevel = true;</span>
<span class="gi">+                                    }</span>
<span class="gi">+                                }</span>
<span class="w"> </span>                            }
<span class="w"> </span>                        }

<span class="gd">-                        if (!hasHeroicReqLevel)</span>
<span class="gi">+                        if (checkDeathKnightReqs &amp;&amp; !hasHeroicReqLevel)</span>
<span class="w"> </span>                        {
<span class="gd">-                            uint8 acc_level = field[0].Get&lt;uint8&gt;();</span>
<span class="gd">-                            if (acc_level &gt;= heroicReqLevel)</span>
<span class="gd">-                                hasHeroicReqLevel = true;</span>
<span class="gi">+                            SendCharCreate(CHAR_CREATE_LEVEL_REQUIREMENT);</span>
<span class="gi">+                            return;</span>
<span class="w"> </span>                        }
<span class="gd">-                    }</span>
<span class="gd">-                }</span>
<span class="gd">-            }</span>

<span class="gd">-            if (checkDeathKnightReqs &amp;&amp; !hasHeroicReqLevel)</span>
<span class="gd">-            {</span>
<span class="gd">-                SendCharCreate(CHAR_CREATE_LEVEL_REQUIREMENT);</span>
<span class="gd">-                return;</span>
<span class="gd">-            }</span>
<span class="gi">+                        // Check name uniqueness in the same step as saving to database</span>
<span class="gi">+                        if (sCharacterCache-&gt;GetCharacterGuidByName(createInfo-&gt;Name))</span>
<span class="gi">+                        {</span>
<span class="gi">+                            SendCharCreate(CHAR_CREATE_NAME_IN_USE);</span>
<span class="gi">+                            return;</span>
<span class="gi">+                        }</span>

<span class="gd">-            // Check name uniqueness in the same step as saving to database</span>
<span class="gd">-            if (sCharacterCache-&gt;GetCharacterGuidByName(createInfo-&gt;Name))</span>
<span class="gd">-            {</span>
<span class="gd">-                SendCharCreate(CHAR_CREATE_NAME_IN_USE);</span>
<span class="gd">-                return;</span>
<span class="gd">-            }</span>
<span class="gi">+                        std::shared_ptr&lt;Player&gt; newChar(new Player(this), [](Player* ptr)</span>
<span class="gi">+                            {</span>
<span class="gi">+                                // Only when player is created correctly do clean</span>
<span class="gi">+                                if (ptr-&gt;HasAtLoginFlag(AT_LOGIN_FIRST))</span>
<span class="gi">+                                {</span>
<span class="gi">+                                    ptr-&gt;CleanupsBeforeDelete();</span>
<span class="gi">+                                }</span>
<span class="gi">+                                delete ptr;</span>
<span class="gi">+                            });</span>
<span class="gi">+</span>
<span class="gi">+                        newChar-&gt;GetMotionMaster()-&gt;Initialize();</span>
<span class="gi">+                        if (!newChar-&gt;Create(sObjectMgr-&gt;GetGenerator&lt;HighGuid::Player&gt;().Generate(), createInfo.get()))</span>
<span class="gi">+                        {</span>
<span class="gi">+                            // Player not create (race/class/etc problem?)</span>
<span class="gi">+                            SendCharCreate(CHAR_CREATE_ERROR);</span>
<span class="gi">+                            return;</span>
<span class="gi">+                        }</span>

<span class="gd">-            std::shared_ptr&lt;Player&gt; newChar(new Player(this), [](Player* ptr)</span>
<span class="gd">-            {</span>
<span class="gd">-                // Only when player is created correctly do clean</span>
<span class="gd">-                if (ptr-&gt;HasAtLoginFlag(AT_LOGIN_FIRST))</span>
<span class="gd">-                {</span>
<span class="gd">-                    ptr-&gt;CleanupsBeforeDelete();</span>
<span class="gd">-                }</span>
<span class="gd">-                delete ptr;</span>
<span class="gd">-            });</span>
<span class="gi">+                        if ((haveSameRace &amp;&amp; skipCinematics == 1) || skipCinematics == 2)</span>
<span class="gi">+                            newChar-&gt;setCinematic(1);                         // not show intro</span>

<span class="gd">-            newChar-&gt;GetMotionMaster()-&gt;Initialize();</span>
<span class="gd">-            if (!newChar-&gt;Create(sObjectMgr-&gt;GetGenerator&lt;HighGuid::Player&gt;().Generate(), createInfo.get()))</span>
<span class="gd">-            {</span>
<span class="gd">-                // Player not create (race/class/etc problem?)</span>
<span class="gd">-                SendCharCreate(CHAR_CREATE_ERROR);</span>
<span class="gd">-                return;</span>
<span class="gd">-            }</span>
<span class="gi">+                        newChar-&gt;SetAtLoginFlag(AT_LOGIN_FIRST);              // First login</span>

<span class="gd">-            if ((haveSameRace &amp;&amp; skipCinematics == 1) || skipCinematics == 2)</span>
<span class="gd">-                newChar-&gt;setCinematic(1);                         // not show intro</span>
<span class="gi">+                        CharacterDatabaseTransaction characterTransaction = CharacterDatabase.BeginTransaction();</span>
<span class="gi">+                        LoginDatabaseTransaction trans = LoginDatabase.BeginTransaction();</span>

<span class="gd">-            newChar-&gt;SetAtLoginFlag(AT_LOGIN_FIRST);              // First login</span>
<span class="gi">+                        // Player created, save it now</span>
<span class="gi">+                        newChar-&gt;SaveToDB(characterTransaction, true, false);</span>
<span class="gi">+                        createInfo-&gt;CharCount++;</span>

<span class="gd">-            CharacterDatabaseTransaction characterTransaction = CharacterDatabase.BeginTransaction();</span>
<span class="gd">-            LoginDatabaseTransaction trans = LoginDatabase.BeginTransaction();</span>
<span class="gi">+                        LoginDatabasePreparedStatement* stmt = LoginDatabase.GetPreparedStatement(LOGIN_DEL_REALM_CHARACTERS_BY_REALM);</span>
<span class="gi">+                        stmt-&gt;SetData(0, GetAccountId());</span>
<span class="gi">+                        stmt-&gt;SetData(1, realm.Id.Realm);</span>
<span class="gi">+                        trans-&gt;Append(stmt);</span>

<span class="gd">-            // Player created, save it now</span>
<span class="gd">-            newChar-&gt;SaveToDB(characterTransaction, true, false);</span>
<span class="gd">-            createInfo-&gt;CharCount++;</span>
<span class="gi">+                        stmt = LoginDatabase.GetPreparedStatement(LOGIN_REP_REALM_CHARACTERS);</span>
<span class="gi">+                        stmt-&gt;SetData(0, createInfo-&gt;CharCount);</span>
<span class="gi">+                        stmt-&gt;SetData(1, GetAccountId());</span>
<span class="gi">+                        stmt-&gt;SetData(2, realm.Id.Realm);</span>
<span class="gi">+                        trans-&gt;Append(stmt);</span>

<span class="gd">-            LoginDatabasePreparedStatement* stmt = LoginDatabase.GetPreparedStatement(LOGIN_REP_REALM_CHARACTERS);</span>
<span class="gd">-            stmt-&gt;SetData(0, createInfo-&gt;CharCount);</span>
<span class="gd">-            stmt-&gt;SetData(1, GetAccountId());</span>
<span class="gd">-            stmt-&gt;SetData(2, realm.Id.Realm);</span>
<span class="gd">-            trans-&gt;Append(stmt);</span>
<span class="gi">+                        LoginDatabase.CommitTransaction(trans);</span>

<span class="gd">-            LoginDatabase.CommitTransaction(trans);</span>
<span class="gi">+                        AddTransactionCallback(CharacterDatabase.AsyncCommitTransaction(characterTransaction)).AfterComplete([this, newChar = std::move(newChar)](bool success)</span>
<span class="gi">+                            {</span>
<span class="gi">+                                if (success)</span>
<span class="gi">+                                {</span>
<span class="gi">+                                    LOG_INFO(&quot;entities.player.character&quot;, &quot;Account: {} (IP: {}) Create Character: {} {}&quot;, GetAccountId(), GetRemoteAddress(), newChar-&gt;GetName(), newChar-&gt;GetGUID().ToString());</span>
<span class="gi">+                                    sScriptMgr-&gt;OnPlayerCreate(newChar.get());</span>
<span class="gi">+                                    sCharacterCache-&gt;AddCharacterCacheEntry(newChar-&gt;GetGUID(), GetAccountId(), newChar-&gt;GetName(), newChar-&gt;getGender(), newChar-&gt;getRace(), newChar-&gt;getClass(), newChar-&gt;GetLevel());</span>
<span class="gi">+                                    SendCharCreate(CHAR_CREATE_SUCCESS);</span>
<span class="gi">+                                }</span>
<span class="gi">+                                else</span>
<span class="gi">+                                    SendCharCreate(CHAR_CREATE_ERROR);</span>
<span class="gi">+                            });</span>
<span class="gi">+                    };</span>

<span class="gd">-            AddTransactionCallback(CharacterDatabase.AsyncCommitTransaction(characterTransaction)).AfterComplete([this, newChar = std::move(newChar)](bool success)</span>
<span class="gd">-            {</span>
<span class="gd">-                if (success)</span>
<span class="gi">+                if (allowTwoSideAccounts &amp;&amp; !skipCinematics &amp;&amp; createInfo-&gt;Class != CLASS_DEATH_KNIGHT)</span>
<span class="w"> </span>                {
<span class="gd">-                    LOG_INFO(&quot;entities.player.character&quot;, &quot;Account: {} (IP: {}) Create Character: {} {}&quot;, GetAccountId(), GetRemoteAddress(), newChar-&gt;GetName(), newChar-&gt;GetGUID().ToString());</span>
<span class="gd">-                    sScriptMgr-&gt;OnPlayerCreate(newChar.get());</span>
<span class="gd">-                    sCharacterCache-&gt;AddCharacterCacheEntry(newChar-&gt;GetGUID(), GetAccountId(), newChar-&gt;GetName(), newChar-&gt;getGender(), newChar-&gt;getRace(), newChar-&gt;getClass(), newChar-&gt;GetLevel());</span>
<span class="gd">-                    SendCharCreate(CHAR_CREATE_SUCCESS);</span>
<span class="gi">+                    finalizeCharacterCreation(PreparedQueryResult(nullptr));</span>
<span class="gi">+                    return;</span>
<span class="w"> </span>                }
<span class="gd">-                else</span>
<span class="gd">-                    SendCharCreate(CHAR_CREATE_ERROR);</span>
<span class="gd">-            });</span>
<span class="gd">-        };</span>

<span class="gd">-        if (allowTwoSideAccounts &amp;&amp; !skipCinematics &amp;&amp; createInfo-&gt;Class != CLASS_DEATH_KNIGHT)</span>
<span class="gd">-        {</span>
<span class="gd">-            finalizeCharacterCreation(PreparedQueryResult(nullptr));</span>
<span class="gd">-            return;</span>
<span class="gd">-        }</span>
<span class="gd">-</span>
<span class="gd">-        CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_SEL_CHAR_CREATE_INFO);</span>
<span class="gd">-        stmt-&gt;SetData(0, GetAccountId());</span>
<span class="gd">-        stmt-&gt;SetData(1, (skipCinematics == 1 || createInfo-&gt;Class == CLASS_DEATH_KNIGHT) ? 10 : 1);</span>
<span class="gd">-        queryCallback.WithPreparedCallback(std::move(finalizeCharacterCreation)).SetNextQuery(CharacterDatabase.AsyncQuery(stmt));</span>
<span class="gd">-    }));</span>
<span class="gi">+                CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_SEL_CHAR_CREATE_INFO);</span>
<span class="gi">+                stmt-&gt;SetData(0, GetAccountId());</span>
<span class="gi">+                stmt-&gt;SetData(1, (skipCinematics == 1 || createInfo-&gt;Class == CLASS_DEATH_KNIGHT) ? 10 : 1);</span>
<span class="gi">+                queryCallback.WithPreparedCallback(std::move(finalizeCharacterCreation)).SetNextQuery(CharacterDatabase.AsyncQuery(stmt));</span>
<span class="gi">+            }));</span>
<span class="w"> </span>}

<span class="w"> </span>void WorldSession::HandleCharDeleteOpcode(WorldPacket&amp; recvData)
<span class="gu">@@ -780,13 +775,14 @@ void WorldSession::HandlePlayerLoginOpcode(WorldPacket&amp; recvData)</span>

<span class="w"> </span>    m_playerLoading = true;
<span class="w"> </span>    AddQueryHolderCallback(CharacterDatabase.DelayQueryHolder(holder)).AfterComplete([this](SQLQueryHolderBase const&amp; holder)
<span class="gd">-    {</span>
<span class="gd">-        HandlePlayerLoginFromDB(static_cast&lt;LoginQueryHolder const&amp;&gt;(holder));</span>
<span class="gd">-    });</span>
<span class="gi">+        {</span>
<span class="gi">+            HandlePlayerLoginFromDB(static_cast&lt;LoginQueryHolder const&amp;&gt;(holder));</span>
<span class="gi">+        });</span>
<span class="w"> </span>}

<span class="w"> </span>void WorldSession::HandlePlayerLoginFromDB(LoginQueryHolder const&amp; holder)
<span class="w"> </span>{
<span class="gi">+    m_playerLoading = true;</span>
<span class="w"> </span>    ObjectGuid playerGuid = holder.GetGuid();

<span class="w"> </span>    Player* pCurrChar = new Player(this);
<span class="gu">@@ -904,8 +900,7 @@ void WorldSession::HandlePlayerLoginFromDB(LoginQueryHolder const&amp; holder)</span>
<span class="w"> </span>    CharacterDatabase.Execute(stmt);

<span class="w"> </span>    LoginDatabasePreparedStatement* loginStmt = LoginDatabase.GetPreparedStatement(LOGIN_UPD_ACCOUNT_ONLINE);
<span class="gd">-    loginStmt-&gt;SetData(0, realm.Id.Realm);</span>
<span class="gd">-    loginStmt-&gt;SetData(1, GetAccountId());</span>
<span class="gi">+    loginStmt-&gt;SetData(0, GetAccountId());</span>
<span class="w"> </span>    LoginDatabase.Execute(loginStmt);

<span class="w"> </span>    pCurrChar-&gt;SetInGameTime(GameTime::GetGameTimeMS().count());
<span class="gu">@@ -956,7 +951,7 @@ void WorldSession::HandlePlayerLoginFromDB(LoginQueryHolder const&amp; holder)</span>
<span class="w"> </span>    if (sWorld-&gt;IsFFAPvPRealm() &amp;&amp; !pCurrChar-&gt;IsGameMaster() &amp;&amp; !pCurrChar-&gt;HasPlayerFlag(PLAYER_FLAGS_RESTING))
<span class="w"> </span>        if (!pCurrChar-&gt;HasByteFlag(UNIT_FIELD_BYTES_2, 1, UNIT_BYTE2_FLAG_FFA_PVP))
<span class="w"> </span>        {
<span class="gd">-            sScriptMgr-&gt;OnPlayerFfaPvpStateUpdate(pCurrChar,true);</span>
<span class="gi">+            sScriptMgr-&gt;OnPlayerFfaPvpStateUpdate(pCurrChar, true);</span>
<span class="w"> </span>            pCurrChar-&gt;SetByteFlag(UNIT_FIELD_BYTES_2, 1, UNIT_BYTE2_FLAG_FFA_PVP);
<span class="w"> </span>        }

<span class="gu">@@ -983,10 +978,10 @@ void WorldSession::HandlePlayerLoginFromDB(LoginQueryHolder const&amp; holder)</span>
<span class="w"> </span>    {
<span class="w"> </span>        // If we process the check while players are loading they won&#39;t be notified of the changes.
<span class="w"> </span>        pCurrChar-&gt;m_Events.AddEventAtOffset([pCurrChar]
<span class="gd">-        {</span>
<span class="gd">-            pCurrChar-&gt;RemoveAtLoginFlag(AT_LOGIN_CHECK_ACHIEVS, true);</span>
<span class="gd">-            pCurrChar-&gt;CheckAllAchievementCriteria();</span>
<span class="gd">-        }, 1s);</span>
<span class="gi">+            {</span>
<span class="gi">+                pCurrChar-&gt;RemoveAtLoginFlag(AT_LOGIN_CHECK_ACHIEVS, true);</span>
<span class="gi">+                pCurrChar-&gt;CheckAllAchievementCriteria();</span>
<span class="gi">+            }, 1s);</span>
<span class="w"> </span>    }

<span class="w"> </span>    bool firstLogin = pCurrChar-&gt;HasAtLoginFlag(AT_LOGIN_FIRST);
<span class="gu">@@ -1013,25 +1008,25 @@ void WorldSession::HandlePlayerLoginFromDB(LoginQueryHolder const&amp; holder)</span>
<span class="w"> </span>            ReputationMgr&amp; repMgr = pCurrChar-&gt;GetReputationMgr();

<span class="w"> </span>            auto SendFullReputation = [&amp;repMgr](std::initializer_list&lt;uint32&gt; factionsList)
<span class="gd">-            {</span>
<span class="gd">-                for (auto const&amp; itr : factionsList)</span>
<span class="w"> </span>                {
<span class="gd">-                    repMgr.SetOneFactionReputation(sFactionStore.LookupEntry(itr), 42999.f, false);</span>
<span class="gd">-                }</span>
<span class="gd">-            };</span>
<span class="gi">+                    for (auto const&amp; itr : factionsList)</span>
<span class="gi">+                    {</span>
<span class="gi">+                        repMgr.SetOneFactionReputation(sFactionStore.LookupEntry(itr), 42999.f, false);</span>
<span class="gi">+                    }</span>
<span class="gi">+                };</span>

<span class="w"> </span>            SendFullReputation({ 942, 935, 936, 1011, 970, 967, 989, 932, 934, 1038, 1077, 1106, 1104, 1090, 1098, 1156, 1073, 1105, 1119, 1091 });

<span class="w"> </span>            switch (pCurrChar-&gt;GetFaction())
<span class="w"> </span>            {
<span class="gd">-                case ALLIANCE:</span>
<span class="gd">-                    SendFullReputation({ 72, 47, 69, 930, 730, 978, 54, 946, 1037, 1068, 1126, 1094, 1050 });</span>
<span class="gd">-                    break;</span>
<span class="gd">-                case HORDE:</span>
<span class="gd">-                    SendFullReputation({ 76, 68, 81, 911, 729, 941, 530, 947, 1052, 1067, 1124, 1064, 1085 });</span>
<span class="gd">-                    break;</span>
<span class="gd">-                default:</span>
<span class="gd">-                    break;</span>
<span class="gi">+            case ALLIANCE:</span>
<span class="gi">+                SendFullReputation({ 72, 47, 69, 930, 730, 978, 54, 946, 1037, 1068, 1126, 1094, 1050 });</span>
<span class="gi">+                break;</span>
<span class="gi">+            case HORDE:</span>
<span class="gi">+                SendFullReputation({ 76, 68, 81, 911, 729, 941, 530, 947, 1052, 1067, 1124, 1064, 1085 });</span>
<span class="gi">+                break;</span>
<span class="gi">+            default:</span>
<span class="gi">+                break;</span>
<span class="w"> </span>            }

<span class="w"> </span>            repMgr.SendStates();
<span class="gu">@@ -1050,7 +1045,7 @@ void WorldSession::HandlePlayerLoginFromDB(LoginQueryHolder const&amp; holder)</span>

<span class="w"> </span>    std::string IP_str = GetRemoteAddress();
<span class="w"> </span>    LOG_INFO(&quot;entities.player&quot;, &quot;Account: {} (IP: {}) Login Character:[{}] ({}) Level: {}&quot;,
<span class="gd">-                  GetAccountId(), IP_str, pCurrChar-&gt;GetName(), pCurrChar-&gt;GetGUID().ToString(), pCurrChar-&gt;GetLevel());</span>
<span class="gi">+        GetAccountId(), IP_str, pCurrChar-&gt;GetName(), pCurrChar-&gt;GetGUID().ToString(), pCurrChar-&gt;GetLevel());</span>

<span class="w"> </span>    if (!pCurrChar-&gt;IsStandState() &amp;&amp; !pCurrChar-&gt;HasUnitState(UNIT_STATE_STUNNED))
<span class="w"> </span>        pCurrChar-&gt;SetStandState(UNIT_STAND_STATE_STAND);
<span class="gu">@@ -1345,7 +1340,7 @@ void WorldSession::HandleCharRenameOpcode(WorldPacket&amp; recvData)</span>
<span class="w"> </span>    std::shared_ptr&lt;CharacterRenameInfo&gt; renameInfo = std::make_shared&lt;CharacterRenameInfo&gt;();

<span class="w"> </span>    recvData &gt;&gt; renameInfo-&gt;Guid
<span class="gd">-             &gt;&gt; renameInfo-&gt;Name;</span>
<span class="gi">+        &gt;&gt; renameInfo-&gt;Name;</span>

<span class="w"> </span>    // prevent character rename to invalid name
<span class="w"> </span>    if (!normalizePlayerName(renameInfo-&gt;Name))
<span class="gu">@@ -1642,12 +1637,12 @@ void WorldSession::HandleCharCustomize(WorldPacket&amp; recvData)</span>
<span class="w"> </span>    }

<span class="w"> </span>    recvData &gt;&gt; customizeInfo-&gt;Name
<span class="gd">-             &gt;&gt; customizeInfo-&gt;Gender</span>
<span class="gd">-             &gt;&gt; customizeInfo-&gt;Skin</span>
<span class="gd">-             &gt;&gt; customizeInfo-&gt;HairColor</span>
<span class="gd">-             &gt;&gt; customizeInfo-&gt;HairStyle</span>
<span class="gd">-             &gt;&gt; customizeInfo-&gt;FacialHair</span>
<span class="gd">-             &gt;&gt; customizeInfo-&gt;Face;</span>
<span class="gi">+        &gt;&gt; customizeInfo-&gt;Gender</span>
<span class="gi">+        &gt;&gt; customizeInfo-&gt;Skin</span>
<span class="gi">+        &gt;&gt; customizeInfo-&gt;HairColor</span>
<span class="gi">+        &gt;&gt; customizeInfo-&gt;HairStyle</span>
<span class="gi">+        &gt;&gt; customizeInfo-&gt;FacialHair</span>
<span class="gi">+        &gt;&gt; customizeInfo-&gt;Face;</span>

<span class="w"> </span>    CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_SEL_CHAR_CUSTOMIZE_INFO);
<span class="w"> </span>    stmt-&gt;SetData(0, customizeInfo-&gt;Guid.GetCounter());
<span class="gu">@@ -1779,10 +1774,10 @@ void WorldSession::HandleEquipmentSetSave(WorldPacket&amp; recvData)</span>

<span class="w"> </span>    EquipmentSet eqSet;

<span class="gd">-    eqSet.Guid      = setGuid;</span>
<span class="gd">-    eqSet.Name      = name;</span>
<span class="gd">-    eqSet.IconName  = iconName;</span>
<span class="gd">-    eqSet.state     = EQUIPMENT_SET_NEW;</span>
<span class="gi">+    eqSet.Guid = setGuid;</span>
<span class="gi">+    eqSet.Name = name;</span>
<span class="gi">+    eqSet.IconName = iconName;</span>
<span class="gi">+    eqSet.state = EQUIPMENT_SET_NEW;</span>

<span class="w"> </span>    for (uint32 i = 0; i &lt; EQUIPMENT_SLOT_END; ++i)
<span class="w"> </span>    {
<span class="gu">@@ -1937,13 +1932,13 @@ void WorldSession::HandleCharFactionOrRaceChange(WorldPacket&amp; recvData)</span>
<span class="w"> </span>    }

<span class="w"> </span>    recvData &gt;&gt; factionChangeInfo-&gt;Name
<span class="gd">-             &gt;&gt; factionChangeInfo-&gt;Gender</span>
<span class="gd">-             &gt;&gt; factionChangeInfo-&gt;Skin</span>
<span class="gd">-             &gt;&gt; factionChangeInfo-&gt;HairColor</span>
<span class="gd">-             &gt;&gt; factionChangeInfo-&gt;HairStyle</span>
<span class="gd">-             &gt;&gt; factionChangeInfo-&gt;FacialHair</span>
<span class="gd">-             &gt;&gt; factionChangeInfo-&gt;Face</span>
<span class="gd">-             &gt;&gt; factionChangeInfo-&gt;Race;</span>
<span class="gi">+        &gt;&gt; factionChangeInfo-&gt;Gender</span>
<span class="gi">+        &gt;&gt; factionChangeInfo-&gt;Skin</span>
<span class="gi">+        &gt;&gt; factionChangeInfo-&gt;HairColor</span>
<span class="gi">+        &gt;&gt; factionChangeInfo-&gt;HairStyle</span>
<span class="gi">+        &gt;&gt; factionChangeInfo-&gt;FacialHair</span>
<span class="gi">+        &gt;&gt; factionChangeInfo-&gt;Face</span>
<span class="gi">+        &gt;&gt; factionChangeInfo-&gt;Race;</span>

<span class="w"> </span>    // pussywizard:
<span class="w"> </span>    if (ObjectAccessor::FindConnectedPlayer(factionChangeInfo-&gt;Guid) || sWorldSessionMgr-&gt;FindOfflineSessionForCharacterGUID(factionChangeInfo-&gt;Guid.GetCounter()))
<span class="gu">@@ -2221,16 +2216,16 @@ void WorldSession::HandleCharFactionOrRaceChangeCallback(std::shared_ptr&lt;Charact</span>
<span class="w"> </span>                for (auto const&amp; itr : sTaxiPathSetBySource)
<span class="w"> </span>                {
<span class="w"> </span>                    auto FillTaxiMask = [&amp;](uint8 field, uint32 mask)
<span class="gd">-                    {</span>
<span class="gd">-                        if (playerClass == CLASS_DEATH_KNIGHT)</span>
<span class="gd">-                        {</span>
<span class="gd">-                            newTaxiMask[field] |= uint32(mask | (sDeathKnightTaxiNodesMask[field] &amp; mask));</span>
<span class="gd">-                        }</span>
<span class="gd">-                        else</span>
<span class="w"> </span>                        {
<span class="gd">-                            newTaxiMask[field] |= mask;</span>
<span class="gd">-                        }</span>
<span class="gd">-                    };</span>
<span class="gi">+                            if (playerClass == CLASS_DEATH_KNIGHT)</span>
<span class="gi">+                            {</span>
<span class="gi">+                                newTaxiMask[field] |= uint32(mask | (sDeathKnightTaxiNodesMask[field] &amp; mask));</span>
<span class="gi">+                            }</span>
<span class="gi">+                            else</span>
<span class="gi">+                            {</span>
<span class="gi">+                                newTaxiMask[field] |= mask;</span>
<span class="gi">+                            }</span>
<span class="gi">+                        };</span>

<span class="w"> </span>                    uint32 nodeId = itr.first;
<span class="w"> </span>                    uint8 field = (uint8)((nodeId - 1) / 32);
<span class="gh">diff --git a/src/server/game/Handlers/ChatHandler.cpp b/src/server/game/Handlers/ChatHandler.cpp</span>
<span class="gh">index f191dc05ae2ae7..23417e1aaf9f50 100644</span>
<span class="gd">--- a/src/server/game/Handlers/ChatHandler.cpp</span>
<span class="gi">+++ b/src/server/game/Handlers/ChatHandler.cpp</span>
<span class="gu">@@ -335,10 +335,13 @@ void WorldSession::HandleMessagechatOpcode(WorldPacket&amp; recvData)</span>
<span class="w"> </span>            msg.erase(end, msg.end());
<span class="w"> </span>        }

<span class="gd">-        // Validate hyperlinks</span>
<span class="gd">-        if (!ValidateHyperlinksAndMaybeKick(msg))</span>
<span class="gi">+        // mod_playerbots: skip validation for playerbots module</span>
<span class="gi">+        auto playerbotsHyperlink = msg.find(&quot;Hfound:&quot;) != std::string::npos;</span>
<span class="gi">+        if (!playerbotsHyperlink)</span>
<span class="w"> </span>        {
<span class="gd">-            return;</span>
<span class="gi">+            // Validate hyperlinks</span>
<span class="gi">+            if (!ValidateHyperlinksAndMaybeKick(msg))</span>
<span class="gi">+                return;</span>
<span class="w"> </span>        }
<span class="w"> </span>    }

<span class="gh">diff --git a/src/server/game/Handlers/PetitionsHandler.cpp b/src/server/game/Handlers/PetitionsHandler.cpp</span>
<span class="gh">index 7ce5870153c617..464a9e06c6effd 100644</span>
<span class="gd">--- a/src/server/game/Handlers/PetitionsHandler.cpp</span>
<span class="gi">+++ b/src/server/game/Handlers/PetitionsHandler.cpp</span>
<span class="gu">@@ -482,6 +482,8 @@ void WorldSession::HandlePetitionSignOpcode(WorldPacket&amp; recvData)</span>
<span class="w"> </span>            break;
<span class="w"> </span>        }

<span class="gi">+    sScriptMgr-&gt;OnPlayerbotCheckPetitionAccount(_player, found);</span>
<span class="gi">+</span>
<span class="w"> </span>    if (found)
<span class="w"> </span>    {
<span class="w"> </span>        WorldPacket data(SMSG_PETITION_SIGN_RESULTS, (8 + 8 + 4));
<span class="gh">diff --git a/src/server/game/Maps/Map.cpp b/src/server/game/Maps/Map.cpp</span>
<span class="gh">index 0ea47ff8ab666c..6b82c16b811cf6 100644</span>
<span class="gd">--- a/src/server/game/Maps/Map.cpp</span>
<span class="gi">+++ b/src/server/game/Maps/Map.cpp</span>
<span class="gu">@@ -1722,6 +1722,13 @@ void Map::SendObjectUpdates()</span>
<span class="w"> </span>    WorldPacket packet;                                     // here we allocate a std::vector with a size of 0x10000
<span class="w"> </span>    for (UpdateDataMapType::iterator iter = update_players.begin(); iter != update_players.end(); ++iter)
<span class="w"> </span>    {
<span class="gi">+        if (!sScriptMgr-&gt;OnPlayerbotCheckUpdatesToSend(iter-&gt;first))</span>
<span class="gi">+        {</span>
<span class="gi">+            iter-&gt;second.Clear();</span>
<span class="gi">+            continue;</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+</span>
<span class="w"> </span>        iter-&gt;second.BuildPacket(packet);
<span class="w"> </span>        iter-&gt;first-&gt;SendDirectMessage(&amp;packet);
<span class="w"> </span>        packet.clear();                                     // clean the string
<span class="gh">diff --git a/src/server/game/Misc/GameGraveyard.cpp b/src/server/game/Misc/GameGraveyard.cpp</span>
<span class="gh">index e497a92457b7b2..318632e2192047 100644</span>
<span class="gd">--- a/src/server/game/Misc/GameGraveyard.cpp</span>
<span class="gi">+++ b/src/server/game/Misc/GameGraveyard.cpp</span>
<span class="gu">@@ -119,6 +119,11 @@ GraveyardStruct const* Graveyard::GetClosestGraveyard(Player* player, TeamId tea</span>
<span class="w"> </span>    uint32 areaId = 0;
<span class="w"> </span>    player-&gt;GetZoneAndAreaId(zoneId, areaId);

<span class="gi">+    return GetClosestGraveyard(mapId, x, y, z, teamId, areaId, zoneId, player-&gt;getClass() == CLASS_DEATH_KNIGHT);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+GraveyardStruct const* Graveyard::GetClosestGraveyard(uint32 mapId, float x, float y, float z, TeamId teamId, uint32 areaId, uint32 zoneId, bool isDeathKnight)</span>
<span class="gi">+{</span>
<span class="w"> </span>    if (!zoneId &amp;&amp; !areaId)
<span class="w"> </span>    {
<span class="w"> </span>        if (z &gt; -500)
<span class="gu">@@ -202,7 +207,7 @@ GraveyardStruct const* Graveyard::GetClosestGraveyard(Player* player, TeamId tea</span>
<span class="w"> </span>            GRAVEYARD_ARCHERUS  = 1405
<span class="w"> </span>        };

<span class="gd">-        if (!player-&gt;IsClass(CLASS_DEATH_KNIGHT, CLASS_CONTEXT_GRAVEYARD) &amp;&amp; (graveyardLink.safeLocId == GRAVEYARD_EBON_HOLD || graveyardLink.safeLocId == GRAVEYARD_ARCHERUS))</span>
<span class="gi">+        if (!isDeathKnight &amp;&amp; (graveyardLink.safeLocId == GRAVEYARD_EBON_HOLD || graveyardLink.safeLocId == GRAVEYARD_ARCHERUS))</span>
<span class="w"> </span>        {
<span class="w"> </span>            continue;
<span class="w"> </span>        }
<span class="gh">diff --git a/src/server/game/Misc/GameGraveyard.h b/src/server/game/Misc/GameGraveyard.h</span>
<span class="gh">index 1ba22d1f728236..741dd0ea83be89 100644</span>
<span class="gd">--- a/src/server/game/Misc/GameGraveyard.h</span>
<span class="gi">+++ b/src/server/game/Misc/GameGraveyard.h</span>
<span class="gu">@@ -57,6 +57,7 @@ class Graveyard</span>
<span class="w"> </span>    GraveyardStruct const* GetGraveyard(const std::string&amp; name) const;
<span class="w"> </span>    GraveyardStruct const* GetDefaultGraveyard(TeamId teamId);
<span class="w"> </span>    GraveyardStruct const* GetClosestGraveyard(Player* player, TeamId teamId, bool nearCorpse = false);
<span class="gi">+    GraveyardStruct const* GetClosestGraveyard(uint32 mapId, float x, float y, float z, TeamId teamId, uint32 areaId, uint32 zoneId, bool isDeathKnight);</span>
<span class="w"> </span>    GraveyardData const* FindGraveyardData(uint32 id, uint32 zone);
<span class="w"> </span>    GraveyardContainer const&amp; GetGraveyardData() const { return _graveyardStore; }
<span class="w"> </span>    bool AddGraveyardLink(uint32 id, uint32 zoneId, TeamId teamId, bool persist = true);
<span class="gh">diff --git a/src/server/game/Movement/MotionMaster.cpp b/src/server/game/Movement/MotionMaster.cpp</span>
<span class="gh">index 8e4f91c16cea83..71d21d48a0c0e6 100644</span>
<span class="gd">--- a/src/server/game/Movement/MotionMaster.cpp</span>
<span class="gi">+++ b/src/server/game/Movement/MotionMaster.cpp</span>
<span class="gu">@@ -923,6 +923,48 @@ void MotionMaster::MoveRotate(uint32 time, RotateDirection direction)</span>
<span class="w"> </span>    Mutate(new RotateMovementGenerator(time, direction), MOTION_SLOT_ACTIVE);
<span class="w"> </span>}

<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+void MotionMaster::MoveKnockbackFromForPlayer(float srcX, float srcY, float speedXY, float speedZ)</span>
<span class="gi">+{</span>
<span class="gi">+    if (speedXY &lt;= 0.1f)</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    Position dest = _owner-&gt;GetPosition();</span>
<span class="gi">+    float moveTimeHalf = speedZ / Movement::gravity;</span>
<span class="gi">+    float dist = 2 * moveTimeHalf * speedXY;</span>
<span class="gi">+    float max_height = -Movement::computeFallElevation(moveTimeHalf, false, -speedZ);</span>
<span class="gi">+</span>
<span class="gi">+    // Use a mmap raycast to get a valid destination.</span>
<span class="gi">+    _owner-&gt;MovePositionToFirstCollision(dest, dist, _owner-&gt;GetRelativeAngle(srcX, srcY) + float(M_PI));</span>
<span class="gi">+</span>
<span class="gi">+    Movement::MoveSplineInit init(_owner);</span>
<span class="gi">+    init.MoveTo(dest.GetPositionX(), dest.GetPositionY(), dest.GetPositionZ());</span>
<span class="gi">+    init.SetParabolic(max_height, 0);</span>
<span class="gi">+    init.SetOrientationFixed(true);</span>
<span class="gi">+    init.SetVelocity(speedXY);</span>
<span class="gi">+    Mutate(new EffectMovementGenerator(init, 0), MOTION_SLOT_CONTROLLED);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+// Similar to MovePoint except setting orientationInversed</span>
<span class="gi">+void MotionMaster::MovePointBackwards(uint32 id, float x, float y, float z, bool generatePath, bool forceDestination, MovementSlot slot, float orientation /* = 0.0f*/)</span>
<span class="gi">+{</span>
<span class="gi">+    if (_owner-&gt;HasUnitFlag(UNIT_FLAG_DISABLE_MOVE))</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    if (_owner-&gt;IsPlayer())</span>
<span class="gi">+    {</span>
<span class="gi">+        LOG_DEBUG(&quot;movement.motionmaster&quot;, &quot;Player ({}) targeted point (Id: {} X: {} Y: {} Z: {})&quot;, _owner-&gt;GetGUID().ToString(), id, x, y, z);</span>
<span class="gi">+        Mutate(new PointMovementGenerator&lt;Player&gt;(id, x, y, z, FORCED_MOVEMENT_NONE, 0.0f, orientation, nullptr, generatePath, forceDestination, std::nullopt, ObjectGuid::Empty, true), slot);</span>
<span class="gi">+    }</span>
<span class="gi">+    else</span>
<span class="gi">+    {</span>
<span class="gi">+        LOG_DEBUG(&quot;movement.motionmaster&quot;, &quot;Creature ({}) targeted point (ID: {} X: {} Y: {} Z: {})&quot;, _owner-&gt;GetGUID().ToString(), id, x, y, z);</span>
<span class="gi">+        Mutate(new PointMovementGenerator&lt;Creature&gt;(id, x, y, z, FORCED_MOVEMENT_NONE, 0.0f, orientation, nullptr, generatePath, forceDestination, std::nullopt, ObjectGuid::Empty, true), slot);</span>
<span class="gi">+    }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="w"> </span>void MotionMaster::propagateSpeedChange()
<span class="w"> </span>{
<span class="w"> </span>    /*Impl::container_type::iterator it = Impl::c.begin();
<span class="gh">diff --git a/src/server/game/Movement/MotionMaster.h b/src/server/game/Movement/MotionMaster.h</span>
<span class="gh">index 4ac140260feef0..e4b2d2c20ce282 100644</span>
<span class="gd">--- a/src/server/game/Movement/MotionMaster.h</span>
<span class="gi">+++ b/src/server/game/Movement/MotionMaster.h</span>
<span class="gu">@@ -262,7 +262,10 @@ class MotionMaster //: private std::stack&lt;MovementGenerator *&gt;</span>
<span class="w"> </span>    void MoveDistract(uint32 time);
<span class="w"> </span>    void MoveWaypoint(uint32 path_id, bool repeatable, PathSource pathSource = PathSource::WAYPOINT_MGR);
<span class="w"> </span>    void MoveRotate(uint32 time, RotateDirection direction);
<span class="gd">-</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+    void MoveKnockbackFromForPlayer(float srcX, float srcY, float speedXY, float speedZ);</span>
<span class="gi">+    void MovePointBackwards(uint32 id, float x, float y, float z, bool generatePath = true, bool forceDestination = true, MovementSlot slot = MOTION_SLOT_ACTIVE, float orientation = 0.0f);</span>
<span class="gi">+#endif</span>
<span class="w"> </span>    [[nodiscard]] MovementGeneratorType GetCurrentMovementGeneratorType() const;
<span class="w"> </span>    [[nodiscard]] MovementGeneratorType GetMotionSlotType(int slot) const;
<span class="w"> </span>    bool HasMovementGeneratorType(MovementGeneratorType type) const;
<span class="gh">diff --git a/src/server/game/Movement/MovementGenerators/PointMovementGenerator.cpp b/src/server/game/Movement/MovementGenerators/PointMovementGenerator.cpp</span>
<span class="gh">index 66ba79be5940c2..4851b52f61cb6b 100644</span>
<span class="gd">--- a/src/server/game/Movement/MovementGenerators/PointMovementGenerator.cpp</span>
<span class="gi">+++ b/src/server/game/Movement/MovementGenerators/PointMovementGenerator.cpp</span>
<span class="gu">@@ -47,6 +47,11 @@ void PointMovementGenerator&lt;T&gt;::DoInitialize(T* unit)</span>

<span class="w"> </span>    i_recalculateSpeed = false;
<span class="w"> </span>    Movement::MoveSplineInit init(unit);
<span class="gi">+</span>
<span class="gi">+    // mod-playerbots</span>
<span class="gi">+    if (_reverseOrientation)</span>
<span class="gi">+        init.SetOrientationInversed();</span>
<span class="gi">+</span>
<span class="w"> </span>    if (m_precomputedPath.size() &gt; 2) // pussywizard: for charge
<span class="w"> </span>        init.MovebyPath(m_precomputedPath);
<span class="w"> </span>    else if (_generatePath)
<span class="gh">diff --git a/src/server/game/Scripting/ScriptDefines/DatabaseScript.cpp b/src/server/game/Scripting/ScriptDefines/DatabaseScript.cpp</span>
<span class="gh">index df84d21564ea97..e2831a9d1a2b04 100644</span>
<span class="gd">--- a/src/server/game/Scripting/ScriptDefines/DatabaseScript.cpp</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptDefines/DatabaseScript.cpp</span>
<span class="gu">@@ -19,6 +19,21 @@</span>
<span class="w"> </span>#include &quot;ScriptMgr.h&quot;
<span class="w"> </span>#include &quot;ScriptMgrMacros.h&quot;

<span class="gi">+bool ScriptMgr::OnDatabasesLoading()</span>
<span class="gi">+{</span>
<span class="gi">+    auto ret = IsValidBoolScript&lt;DatabaseScript&gt;([&amp;](DatabaseScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        return !script-&gt;OnDatabasesLoading();</span>
<span class="gi">+    });</span>
<span class="gi">+</span>
<span class="gi">+    if (ret &amp;&amp; *ret)</span>
<span class="gi">+    {</span>
<span class="gi">+        return false;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    return true;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>void ScriptMgr::OnAfterDatabasesLoaded(uint32 updateFlags)
<span class="w"> </span>{
<span class="w"> </span>    CALL_ENABLED_HOOKS(DatabaseScript, DATABASEHOOK_ON_AFTER_DATABASES_LOADED, script-&gt;OnAfterDatabasesLoaded(updateFlags));
<span class="gu">@@ -29,6 +44,46 @@ void ScriptMgr::OnAfterDatabaseLoadCreatureTemplates(std::vector&lt;CreatureTemplat</span>
<span class="w"> </span>    CALL_ENABLED_HOOKS(DatabaseScript, DATABASEHOOK_ON_AFTER_DATABASE_LOAD_CREATURETEMPLATES, script-&gt;OnAfterDatabaseLoadCreatureTemplates(creatureTemplates));
<span class="w"> </span>}

<span class="gi">+void ScriptMgr::OnDatabasesKeepAlive()</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;DatabaseScript&gt;([&amp;](DatabaseScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnDatabasesKeepAlive();</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnDatabasesClosing()</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;DatabaseScript&gt;([&amp;](DatabaseScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnDatabasesClosing();</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnDatabaseWarnAboutSyncQueries(bool apply)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;DatabaseScript&gt;([&amp;](DatabaseScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnDatabaseWarnAboutSyncQueries(apply);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnDatabaseSelectIndexLogout(Player* player, uint32&amp; statementIndex, uint32&amp; statementParam)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;DatabaseScript&gt;([&amp;](DatabaseScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnDatabaseSelectIndexLogout(player, statementIndex, statementParam);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnDatabaseGetDBRevision(std::string&amp; revision)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;DatabaseScript&gt;([&amp;](DatabaseScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnDatabaseGetDBRevision(revision);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>DatabaseScript::DatabaseScript(const char* name, std::vector&lt;uint16&gt; enabledHooks)
<span class="w"> </span>    : ScriptObject(name, DATABASEHOOK_END)
<span class="w"> </span>{
<span class="gh">diff --git a/src/server/game/Scripting/ScriptDefines/DatabaseScript.h b/src/server/game/Scripting/ScriptDefines/DatabaseScript.h</span>
<span class="gh">index 708f0a986417f5..21b55ee8b4bc80 100644</span>
<span class="gd">--- a/src/server/game/Scripting/ScriptDefines/DatabaseScript.h</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptDefines/DatabaseScript.h</span>
<span class="gu">@@ -52,6 +52,13 @@ class DatabaseScript : public ScriptObject</span>
<span class="w"> </span>     */
<span class="w"> </span>    virtual void OnAfterDatabaseLoadCreatureTemplates(std::vector&lt;CreatureTemplate*&gt; /*creatureTemplates*/) { }

<span class="gi">+    [[nodiscard]] virtual bool OnDatabasesLoading() { return true; }</span>
<span class="gi">+    virtual void OnDatabasesKeepAlive() { }</span>
<span class="gi">+    virtual void OnDatabasesClosing() { }</span>
<span class="gi">+    virtual void OnDatabaseWarnAboutSyncQueries(bool /*apply*/) { }</span>
<span class="gi">+    virtual void OnDatabaseSelectIndexLogout(Player* /*player*/, uint32&amp; /*statementIndex*/, uint32&amp; /*statementParam*/) { }</span>
<span class="gi">+    virtual void OnDatabaseGetDBRevision(std::string&amp; /*revision*/) { }</span>
<span class="gi">+</span>
<span class="w"> </span>};

<span class="w"> </span>#endif
<span class="gh">diff --git a/src/server/game/Scripting/ScriptDefines/PlayerScript.cpp b/src/server/game/Scripting/ScriptDefines/PlayerScript.cpp</span>
<span class="gh">index 62439d2840ac51..c2afb5804171d3 100644</span>
<span class="gd">--- a/src/server/game/Scripting/ScriptDefines/PlayerScript.cpp</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptDefines/PlayerScript.cpp</span>
<span class="gu">@@ -194,11 +194,17 @@ void ScriptMgr::OnPlayerBeforeUpdate(Player* player, uint32 p_time)</span>
<span class="w"> </span>    CALL_ENABLED_HOOKS(PlayerScript, PLAYERHOOK_ON_BEFORE_UPDATE, script-&gt;OnPlayerBeforeUpdate(player, p_time));
<span class="w"> </span>}

<span class="gi">+void ScriptMgr::OnPlayerAfterUpdate(Player* player, uint32 p_time)</span>
<span class="gi">+{</span>
<span class="gi">+    CALL_ENABLED_HOOKS(PlayerScript, PLAYERHOOK_ON_AFTER_UPDATE, script-&gt;OnPlayerAfterUpdate(player, p_time));</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>void ScriptMgr::OnPlayerUpdate(Player* player, uint32 p_time)
<span class="w"> </span>{
<span class="w"> </span>    CALL_ENABLED_HOOKS(PlayerScript, PLAYERHOOK_ON_UPDATE, script-&gt;OnPlayerUpdate(player, p_time));
<span class="w"> </span>}

<span class="gi">+</span>
<span class="w"> </span>void ScriptMgr::OnPlayerLogin(Player* player)
<span class="w"> </span>{
<span class="w"> </span>    CALL_ENABLED_HOOKS(PlayerScript, PLAYERHOOK_ON_LOGIN, script-&gt;OnPlayerLogin(player));
<span class="gh">diff --git a/src/server/game/Scripting/ScriptDefines/PlayerScript.h b/src/server/game/Scripting/ScriptDefines/PlayerScript.h</span>
<span class="gh">index 5ee56e7ac62450..8177dea2cb05af 100644</span>
<span class="gd">--- a/src/server/game/Scripting/ScriptDefines/PlayerScript.h</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptDefines/PlayerScript.h</span>
<span class="gu">@@ -45,6 +45,7 @@ enum PlayerHook</span>
<span class="w"> </span>    PLAYERHOOK_ON_AFTER_SPEC_SLOT_CHANGED,
<span class="w"> </span>    PLAYERHOOK_ON_BEFORE_UPDATE,
<span class="w"> </span>    PLAYERHOOK_ON_UPDATE,
<span class="gi">+    PLAYERHOOK_ON_AFTER_UPDATE,</span>
<span class="w"> </span>    PLAYERHOOK_ON_MONEY_CHANGED,
<span class="w"> </span>    PLAYERHOOK_ON_BEFORE_LOOT_MONEY,
<span class="w"> </span>    PLAYERHOOK_ON_GIVE_EXP,
<span class="gu">@@ -55,7 +56,12 @@ enum PlayerHook</span>
<span class="w"> </span>    PLAYERHOOK_ON_DUEL_REQUEST,
<span class="w"> </span>    PLAYERHOOK_ON_DUEL_START,
<span class="w"> </span>    PLAYERHOOK_ON_DUEL_END,
<span class="gi">+    PLAYERHOOK_ON_CHAT,</span>
<span class="w"> </span>    PLAYERHOOK_ON_BEFORE_SEND_CHAT_MESSAGE,
<span class="gi">+    PLAYERHOOK_ON_CHAT_WITH_RECEIVER,</span>
<span class="gi">+    PLAYERHOOK_ON_CHAT_WITH_GROUP,</span>
<span class="gi">+    PLAYERHOOK_ON_CHAT_WITH_GUILD,</span>
<span class="gi">+    PLAYERHOOK_ON_CHAT_WITH_CHANNEL,</span>
<span class="w"> </span>    PLAYERHOOK_ON_EMOTE,
<span class="w"> </span>    PLAYERHOOK_ON_TEXT_EMOTE,
<span class="w"> </span>    PLAYERHOOK_ON_SPELL_CAST,
<span class="gu">@@ -263,6 +269,7 @@ class PlayerScript : public ScriptObject</span>

<span class="w"> </span>    // Called for player::update
<span class="w"> </span>    virtual void OnPlayerBeforeUpdate(Player* /*player*/, uint32 /*p_time*/) { }
<span class="gi">+    virtual void OnPlayerAfterUpdate(Player* /*player*/, uint32 /*p_time*/) { }</span>
<span class="w"> </span>    virtual void OnPlayerUpdate(Player* /*player*/, uint32 /*p_time*/) { }

<span class="w"> </span>    // Called when a player&#39;s money is modified (before the modification is done)
<span class="gh">diff --git a/src/server/game/Scripting/ScriptDefines/PlayerbotsScript.cpp b/src/server/game/Scripting/ScriptDefines/PlayerbotsScript.cpp</span>
new file mode 100644
<span class="gh">index 00000000000000..22379a1fba02b5</span>
<span class="gd">--- /dev/null</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptDefines/PlayerbotsScript.cpp</span>
<span class="gu">@@ -0,0 +1,105 @@</span>
<span class="gi">+/*</span>
<span class="gi">+ * This file is part of the AzerothCore Project. See AUTHORS file for Copyright information</span>
<span class="gi">+ *</span>
<span class="gi">+ * This program is free software; you can redistribute it and/or modify</span>
<span class="gi">+ * it under the terms of the GNU General Public License as published by</span>
<span class="gi">+ * the Free Software Foundation; either version 2 of the License, or</span>
<span class="gi">+ * (at your option) any later version.</span>
<span class="gi">+ *</span>
<span class="gi">+ * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="gi">+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="gi">+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for</span>
<span class="gi">+ * more details.</span>
<span class="gi">+ *</span>
<span class="gi">+ * You should have received a copy of the GNU General Public License along</span>
<span class="gi">+ * with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="gi">+ */</span>
<span class="gi">+</span>
<span class="gi">+#include &quot;ScriptMgr.h&quot;</span>
<span class="gi">+#include &quot;ScriptMgrMacros.h&quot;</span>
<span class="gi">+</span>
<span class="gi">+bool ScriptMgr::OnPlayerbotCheckLFGQueue(lfg::Lfg5Guids const&amp; guidsList)</span>
<span class="gi">+{</span>
<span class="gi">+    auto ret = IsValidBoolScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        return !script-&gt;OnPlayerbotCheckLFGQueue(guidsList);</span>
<span class="gi">+    });</span>
<span class="gi">+</span>
<span class="gi">+    if (ret &amp;&amp; *ret)</span>
<span class="gi">+    {</span>
<span class="gi">+        return false;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    return true;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnPlayerbotCheckKillTask(Player* player, Unit* victim)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnPlayerbotCheckKillTask(player, victim);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnPlayerbotCheckPetitionAccount(Player* player, bool&amp; found)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnPlayerbotCheckPetitionAccount(player, found);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+bool ScriptMgr::OnPlayerbotCheckUpdatesToSend(Player* player)</span>
<span class="gi">+{</span>
<span class="gi">+    auto ret = IsValidBoolScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        return !script-&gt;OnPlayerbotCheckUpdatesToSend(player);</span>
<span class="gi">+    });</span>
<span class="gi">+</span>
<span class="gi">+    if (ret &amp;&amp; *ret)</span>
<span class="gi">+    {</span>
<span class="gi">+        return false;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    return true;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnPlayerbotPacketSent(Player* player, WorldPacket const* packet)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnPlayerbotPacketSent(player, packet);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnPlayerbotUpdate(uint32 diff)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnPlayerbotUpdate(diff);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnPlayerbotUpdateSessions(Player* player)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnPlayerbotUpdateSessions(player);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnPlayerbotLogout(Player* player)</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnPlayerbotLogout(player);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ScriptMgr::OnPlayerbotLogoutBots()</span>
<span class="gi">+{</span>
<span class="gi">+    ExecuteScript&lt;PlayerbotScript&gt;([&amp;](PlayerbotScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnPlayerbotLogoutBots();</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gh">diff --git a/src/server/game/Scripting/ScriptDefines/ServerScript.cpp b/src/server/game/Scripting/ScriptDefines/ServerScript.cpp</span>
<span class="gh">index 74d49c5552b405..7c531081c60efa 100644</span>
<span class="gd">--- a/src/server/game/Scripting/ScriptDefines/ServerScript.cpp</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptDefines/ServerScript.cpp</span>
<span class="gu">@@ -43,6 +43,15 @@ void ScriptMgr::OnSocketClose(std::shared_ptr&lt;WorldSocket&gt; const&amp; socket)</span>
<span class="w"> </span>    CALL_ENABLED_HOOKS(ServerScript, SERVERHOOK_ON_SOCKET_CLOSE, script-&gt;OnSocketClose(socket));
<span class="w"> </span>}

<span class="gi">+void ScriptMgr::OnPacketReceived(WorldSession* session, WorldPacket const&amp; packet)</span>
<span class="gi">+{</span>
<span class="gi">+    WorldPacket copy(packet);</span>
<span class="gi">+    ExecuteScript&lt;ServerScript&gt;([&amp;](ServerScript* script)</span>
<span class="gi">+    {</span>
<span class="gi">+        script-&gt;OnPacketReceived(session, copy);</span>
<span class="gi">+    });</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>bool ScriptMgr::CanPacketSend(WorldSession* session, WorldPacket const&amp; packet)
<span class="w"> </span>{
<span class="w"> </span>    ASSERT(session);
<span class="gh">diff --git a/src/server/game/Scripting/ScriptDefines/ServerScript.h b/src/server/game/Scripting/ScriptDefines/ServerScript.h</span>
<span class="gh">index 5125f231705e5f..ed5fd07cd24f8c 100644</span>
<span class="gd">--- a/src/server/game/Scripting/ScriptDefines/ServerScript.h</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptDefines/ServerScript.h</span>
<span class="gu">@@ -70,6 +70,8 @@ class ServerScript : public ScriptObject</span>
<span class="w"> </span>     * @return True if you want to continue receive the packet, false if you want to disallow receive the packet
<span class="w"> </span>     */
<span class="w"> </span>    [[nodiscard]] virtual bool CanPacketReceive(WorldSession* /*session*/, WorldPacket&amp; /*packet*/) { return true; }
<span class="gi">+</span>
<span class="gi">+    virtual void OnPacketReceived(WorldSession* /*session*/, WorldPacket const&amp; /*packet*/) { }</span>
<span class="w"> </span>};

<span class="w"> </span>#endif
<span class="gh">diff --git a/src/server/game/Scripting/ScriptMgr.cpp b/src/server/game/Scripting/ScriptMgr.cpp</span>
<span class="gh">index 34ad17546d7a4f..0d99f7fd05a246 100644</span>
<span class="gd">--- a/src/server/game/Scripting/ScriptMgr.cpp</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptMgr.cpp</span>
<span class="gu">@@ -58,6 +58,11 @@ ScriptMgr* ScriptMgr::instance()</span>
<span class="w"> </span>    return &amp;instance;
<span class="w"> </span>}

<span class="gi">+PlayerbotScript::PlayerbotScript(const char* name) : ScriptObject(name)</span>
<span class="gi">+{</span>
<span class="gi">+    ScriptRegistry&lt;PlayerbotScript&gt;::AddScript(this);</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>void ScriptMgr::Initialize()
<span class="w"> </span>{
<span class="w"> </span>    LOG_INFO(&quot;server.loading&quot;, &quot;&gt; Loading C++ scripts&quot;);
<span class="gu">@@ -143,6 +148,7 @@ void ScriptMgr::Unload()</span>
<span class="w"> </span>    SCR_CLEAR&lt;OutdoorPvPScript&gt;();
<span class="w"> </span>    SCR_CLEAR&lt;PetScript&gt;();
<span class="w"> </span>    SCR_CLEAR&lt;PlayerScript&gt;();
<span class="gi">+    SCR_CLEAR&lt;PlayerbotScript&gt;();</span>
<span class="w"> </span>    SCR_CLEAR&lt;ServerScript&gt;();
<span class="w"> </span>    SCR_CLEAR&lt;SpellSC&gt;();
<span class="w"> </span>    SCR_CLEAR&lt;SpellScriptLoader&gt;();
<span class="gu">@@ -227,6 +233,7 @@ void ScriptMgr::CheckIfScriptsInDatabaseExist()</span>
<span class="w"> </span>                !ScriptRegistry&lt;ArenaScript&gt;::GetScriptById(sid) &amp;&amp;
<span class="w"> </span>                !ScriptRegistry&lt;GroupScript&gt;::GetScriptById(sid) &amp;&amp;
<span class="w"> </span>                !ScriptRegistry&lt;DatabaseScript&gt;::GetScriptById(sid) &amp;&amp;
<span class="gi">+                !ScriptRegistry&lt;PlayerbotScript&gt;::GetScriptById(sid) &amp;&amp;</span>
<span class="w"> </span>                !ScriptRegistry&lt;TicketScript&gt;::GetScriptById(sid))
<span class="w"> </span>                {
<span class="w"> </span>                    LOG_ERROR(&quot;sql.sql&quot;, &quot;Script named &#39;{}&#39; is assigned in the database, but has no code!&quot;, scriptName);
<span class="gh">diff --git a/src/server/game/Scripting/ScriptMgr.h b/src/server/game/Scripting/ScriptMgr.h</span>
<span class="gh">index 056a44a576ed61..4e839a465f0793 100644</span>
<span class="gd">--- a/src/server/game/Scripting/ScriptMgr.h</span>
<span class="gi">+++ b/src/server/game/Scripting/ScriptMgr.h</span>
<span class="gu">@@ -105,7 +105,26 @@ namespace Acore::ChatCommands</span>

<span class="w"> </span>*/

<span class="gd">-// Manages registration, loading, and execution of scripts.</span>
<span class="gi">+class PlayerbotScript : public ScriptObject</span>
<span class="gi">+{</span>
<span class="gi">+protected:</span>
<span class="gi">+</span>
<span class="gi">+    PlayerbotScript(const char* name);</span>
<span class="gi">+</span>
<span class="gi">+public:</span>
<span class="gi">+    bool IsDatabaseBound() const { return false; }</span>
<span class="gi">+</span>
<span class="gi">+    [[nodiscard]] virtual bool OnPlayerbotCheckLFGQueue(lfg::Lfg5Guids const&amp; /*guidsList*/) { return true; }</span>
<span class="gi">+    virtual void OnPlayerbotCheckKillTask(Player* /*player*/, Unit* /*victim*/) { }</span>
<span class="gi">+    virtual void OnPlayerbotCheckPetitionAccount(Player* /*player*/, bool&amp; /*found*/) { }</span>
<span class="gi">+    [[nodiscard]] virtual bool OnPlayerbotCheckUpdatesToSend(Player* /*player*/) { return true; }</span>
<span class="gi">+    virtual void OnPlayerbotPacketSent(Player* /*player*/, WorldPacket const* /*packet*/) { }</span>
<span class="gi">+    virtual void OnPlayerbotUpdate(uint32 /*diff*/) { }</span>
<span class="gi">+    virtual void OnPlayerbotUpdateSessions(Player* /*player*/) { }</span>
<span class="gi">+    virtual void OnPlayerbotLogout(Player* /*player*/) { }</span>
<span class="gi">+    virtual void OnPlayerbotLogoutBots() { }</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="w"> </span>class ScriptMgr
<span class="w"> </span>{
<span class="w"> </span>    friend class ScriptObject;
<span class="gu">@@ -158,6 +177,7 @@ class ScriptMgr</span>
<span class="w"> </span>    void OnSocketOpen(std::shared_ptr&lt;WorldSocket&gt; const&amp; socket);
<span class="w"> </span>    void OnSocketClose(std::shared_ptr&lt;WorldSocket&gt; const&amp; socket);
<span class="w"> </span>    bool CanPacketReceive(WorldSession* session, WorldPacket const&amp; packet);
<span class="gi">+    void OnPacketReceived(WorldSession* session, WorldPacket const&amp; packet);</span>
<span class="w"> </span>    bool CanPacketSend(WorldSession* session, WorldPacket const&amp; packet);

<span class="w"> </span>public: /* WorldScript */
<span class="gu">@@ -298,6 +318,7 @@ class ScriptMgr</span>
<span class="w"> </span>    void OnPlayerReleasedGhost(Player* player);
<span class="w"> </span>    void OnPlayerSendInitialPacketsBeforeAddToMap(Player* player, WorldPacket&amp; data);
<span class="w"> </span>    void OnPlayerBeforeUpdate(Player* player, uint32 p_time);
<span class="gi">+    void OnPlayerAfterUpdate(Player* player, uint32 diff);</span>
<span class="w"> </span>    void OnPlayerUpdate(Player* player, uint32 p_time);
<span class="w"> </span>    void OnPlayerPVPKill(Player* killer, Player* killed);
<span class="w"> </span>    void OnPlayerPVPFlagChange(Player* player, bool state);
<span class="gu">@@ -679,8 +700,14 @@ class ScriptMgr</span>

<span class="w"> </span>public: /* DatabaseScript */

<span class="gi">+    bool OnDatabasesLoading();</span>
<span class="w"> </span>    void OnAfterDatabasesLoaded(uint32 updateFlags);
<span class="w"> </span>    void OnAfterDatabaseLoadCreatureTemplates(std::vector&lt;CreatureTemplate*&gt; creatureTemplateStore);
<span class="gi">+    void OnDatabasesKeepAlive();</span>
<span class="gi">+    void OnDatabasesClosing();</span>
<span class="gi">+    void OnDatabaseWarnAboutSyncQueries(bool apply);</span>
<span class="gi">+    void OnDatabaseSelectIndexLogout(Player* player, uint32&amp; statementIndex, uint32&amp; statementParam);</span>
<span class="gi">+    void OnDatabaseGetDBRevision(std::string&amp; revision);</span>

<span class="w"> </span>public: /* WorldObjectScript */

<span class="gu">@@ -698,6 +725,18 @@ class ScriptMgr</span>

<span class="w"> </span>    void OnLootMoney(Player* player, uint32 gold);

<span class="gi">+public: /* PlayerbotScript */</span>
<span class="gi">+    </span>
<span class="gi">+    bool OnPlayerbotCheckLFGQueue(lfg::Lfg5Guids const&amp; guidsList);</span>
<span class="gi">+    void OnPlayerbotCheckKillTask(Player* player, Unit* victim);</span>
<span class="gi">+    void OnPlayerbotCheckPetitionAccount(Player* player, bool&amp; found);</span>
<span class="gi">+    bool OnPlayerbotCheckUpdatesToSend(Player* player);</span>
<span class="gi">+    void OnPlayerbotPacketSent(Player* player, WorldPacket const* packet);</span>
<span class="gi">+    void OnPlayerbotUpdate(uint32 diff);</span>
<span class="gi">+    void OnPlayerbotUpdateSessions(Player* player);</span>
<span class="gi">+    void OnPlayerbotLogout(Player* player);</span>
<span class="gi">+    void OnPlayerbotLogoutBots();</span>
<span class="gi">+</span>
<span class="w"> </span>public: /* TicketScript */

<span class="w"> </span>    void OnTicketCreate(GmTicket* ticket);
<span class="gh">diff --git a/src/server/game/Server/WorldSession.cpp b/src/server/game/Server/WorldSession.cpp</span>
<span class="gh">index 254328b80910fc..8a212f54669986 100644</span>
<span class="gd">--- a/src/server/game/Server/WorldSession.cpp</span>
<span class="gi">+++ b/src/server/game/Server/WorldSession.cpp</span>
<span class="gu">@@ -105,7 +105,7 @@ bool WorldSessionFilter::Process(WorldPacket* packet)</span>

<span class="w"> </span>/// WorldSession constructor
<span class="w"> </span>WorldSession::WorldSession(uint32 id, std::string&amp;&amp; name, uint32 accountFlags, std::shared_ptr&lt;WorldSocket&gt; sock, AccountTypes sec, uint8 expansion,
<span class="gd">-    time_t mute_time, LocaleConstant locale, uint32 recruiter, bool isARecruiter, bool skipQueue, uint32 TotalTime) :</span>
<span class="gi">+    time_t mute_time, LocaleConstant locale, uint32 recruiter, bool isARecruiter, bool skipQueue, uint32 TotalTime, bool isBot) :</span>
<span class="w"> </span>    m_muteTime(mute_time),
<span class="w"> </span>    m_timeOutTime(0),
<span class="w"> </span>    AntiDOS(this),
<span class="gu">@@ -137,7 +137,8 @@ WorldSession::WorldSession(uint32 id, std::string&amp;&amp; name, uint32 accountFlags, s</span>
<span class="w"> </span>    _timeSyncClockDeltaQueue(6),
<span class="w"> </span>    _timeSyncClockDelta(0),
<span class="w"> </span>    _pendingTimeSyncRequests(),
<span class="gd">-    _orderCounter(0)</span>
<span class="gi">+    _orderCounter(0),</span>
<span class="gi">+    _isBot(isBot)</span>
<span class="w"> </span>{
<span class="w"> </span>    memset(m_Tutorials, 0, sizeof(m_Tutorials));

<span class="gu">@@ -153,6 +154,10 @@ WorldSession::WorldSession(uint32 id, std::string&amp;&amp; name, uint32 accountFlags, s</span>
<span class="w"> </span>        ResetTimeOutTime(false);
<span class="w"> </span>        LoginDatabase.Execute(&quot;UPDATE account SET online = 1 WHERE id = {};&quot;, GetAccountId()); // One-time query
<span class="w"> </span>    }
<span class="gi">+    else if (isBot)</span>
<span class="gi">+    {</span>
<span class="gi">+        m_Address = &quot;bot&quot;;</span>
<span class="gi">+    }</span>
<span class="w"> </span>}

<span class="w"> </span>/// WorldSession destructor
<span class="gu">@@ -251,6 +256,14 @@ ObjectGuid::LowType WorldSession::GetGuidLow() const</span>
<span class="w"> </span>/// Send a packet to the client
<span class="w"> </span>void WorldSession::SendPacket(WorldPacket const* packet)
<span class="w"> </span>{
<span class="gi">+    if (packet-&gt;GetOpcode() == NULL_OPCODE)</span>
<span class="gi">+    {</span>
<span class="gi">+        LOG_ERROR(&quot;network.opcode&quot;, &quot;{} send NULL_OPCODE&quot;, GetPlayerInfo());</span>
<span class="gi">+        return;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    sScriptMgr-&gt;OnPlayerbotPacketSent(GetPlayer(), packet);</span>
<span class="gi">+</span>
<span class="w"> </span>    if (!m_Socket)
<span class="w"> </span>        return;

<span class="gu">@@ -401,6 +414,9 @@ bool WorldSession::Update(uint32 diff, PacketFilter&amp; updater)</span>

<span class="w"> </span>                        opHandle-&gt;Call(this, *packet);
<span class="w"> </span>                        LogUnprocessedTail(packet);
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+                        sScriptMgr-&gt;OnPacketReceived(this, *packet);</span>
<span class="gi">+#endif</span>
<span class="w"> </span>                    }

<span class="w"> </span>                    // lag can cause STATUS_LOGGEDIN opcodes to arrive after the player started a transfer
<span class="gu">@@ -419,6 +435,9 @@ bool WorldSession::Update(uint32 diff, PacketFilter&amp; updater)</span>

<span class="w"> </span>                        opHandle-&gt;Call(this, *packet);
<span class="w"> </span>                        LogUnprocessedTail(packet);
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+                        sScriptMgr-&gt;OnPacketReceived(this, *packet);</span>
<span class="gi">+#endif</span>
<span class="w"> </span>                    }
<span class="w"> </span>                    break;
<span class="w"> </span>                case STATUS_TRANSFER:
<span class="gu">@@ -429,6 +448,9 @@ bool WorldSession::Update(uint32 diff, PacketFilter&amp; updater)</span>

<span class="w"> </span>                        opHandle-&gt;Call(this, *packet);
<span class="w"> </span>                        LogUnprocessedTail(packet);
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+                        sScriptMgr-&gt;OnPacketReceived(this, *packet);</span>
<span class="gi">+#endif</span>
<span class="w"> </span>                    }
<span class="w"> </span>                    break;
<span class="w"> </span>                case STATUS_AUTHED:
<span class="gu">@@ -445,6 +467,9 @@ bool WorldSession::Update(uint32 diff, PacketFilter&amp; updater)</span>

<span class="w"> </span>                    opHandle-&gt;Call(this, *packet);
<span class="w"> </span>                    LogUnprocessedTail(packet);
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+                    sScriptMgr-&gt;OnPacketReceived(this, *packet);</span>
<span class="gi">+#endif</span>
<span class="w"> </span>                    break;
<span class="w"> </span>                case STATUS_NEVER:
<span class="w"> </span>                    LOG_ERROR(&quot;network.opcode&quot;, &quot;Received not allowed opcode {} from {}&quot;,
<span class="gu">@@ -533,6 +558,8 @@ bool WorldSession::Update(uint32 diff, PacketFilter&amp; updater)</span>
<span class="w"> </span>    //logout procedure should happen only in World::UpdateSessions() method!!!
<span class="w"> </span>    if (updater.ProcessUnsafe())
<span class="w"> </span>    {
<span class="gi">+        sScriptMgr-&gt;OnPlayerbotUpdateSessions(GetPlayer());</span>
<span class="gi">+</span>
<span class="w"> </span>        if (m_Socket &amp;&amp; m_Socket-&gt;IsOpen() &amp;&amp; _warden)
<span class="w"> </span>        {
<span class="w"> </span>            _warden-&gt;Update(diff);
<span class="gu">@@ -625,6 +652,8 @@ void WorldSession::LogoutPlayer(bool save)</span>
<span class="w"> </span>        if (ObjectGuid lguid = _player-&gt;GetLootGUID())
<span class="w"> </span>            DoLootRelease(lguid);

<span class="gi">+        sScriptMgr-&gt;OnPlayerbotLogout(_player);</span>
<span class="gi">+</span>
<span class="w"> </span>        ///- If the player just died before logging out, make him appear as a ghost
<span class="w"> </span>        //FIXME: logout must be delayed in case lost connection with client in time of combat
<span class="w"> </span>        if (_player-&gt;GetDeathTimer())
<span class="gu">@@ -757,6 +786,10 @@ void WorldSession::LogoutPlayer(bool save)</span>
<span class="w"> </span>        LOG_INFO(&quot;entities.player&quot;, &quot;Account: {} (IP: {}) Logout Character:[{}] ({}) Level: {}&quot;,
<span class="w"> </span>            GetAccountId(), GetRemoteAddress(), _player-&gt;GetName(), _player-&gt;GetGUID().ToString(), _player-&gt;GetLevel());

<span class="gi">+        uint32 statementIndex = CHAR_UPD_ACCOUNT_ONLINE;</span>
<span class="gi">+        uint32 statementParam = GetAccountId();</span>
<span class="gi">+        sScriptMgr-&gt;OnDatabaseSelectIndexLogout(_player, statementIndex, statementParam);</span>
<span class="gi">+</span>
<span class="w"> </span>        //! Remove the player from the world
<span class="w"> </span>        // the player may not be in the world when logging out
<span class="w"> </span>        // e.g if he got disconnected during a transfer to another map
<span class="gu">@@ -776,8 +809,8 @@ void WorldSession::LogoutPlayer(bool save)</span>
<span class="w"> </span>        LOG_DEBUG(&quot;network&quot;, &quot;SESSION: Sent SMSG_LOGOUT_COMPLETE Message&quot;);

<span class="w"> </span>        //! Since each account can only have one online character at any given time, ensure all characters for active account are marked as offline
<span class="gd">-        CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CHAR_UPD_ACCOUNT_ONLINE);</span>
<span class="gd">-        stmt-&gt;SetData(0, GetAccountId());</span>
<span class="gi">+        CharacterDatabasePreparedStatement* stmt = CharacterDatabase.GetPreparedStatement(CharacterDatabaseStatements(statementIndex));</span>
<span class="gi">+        stmt-&gt;SetData(0, statementParam);</span>
<span class="w"> </span>        CharacterDatabase.Execute(stmt);
<span class="w"> </span>    }

<span class="gu">@@ -1516,3 +1549,8 @@ void WorldSession::SetPacketLogging(bool state)</span>
<span class="w"> </span>    if (m_Socket)
<span class="w"> </span>        m_Socket-&gt;SetPacketLogging(state);
<span class="w"> </span>}
<span class="gi">+</span>
<span class="gi">+LockedQueue&lt;WorldPacket*&gt;&amp; WorldSession::GetPacketQueue()</span>
<span class="gi">+{</span>
<span class="gi">+    return _recvQueue;</span>
<span class="gi">+}</span>
<span class="gh">diff --git a/src/server/game/Server/WorldSession.h b/src/server/game/Server/WorldSession.h</span>
<span class="gh">index 6a1c554ca2fe96..283a301b2ce4af 100644</span>
<span class="gd">--- a/src/server/game/Server/WorldSession.h</span>
<span class="gi">+++ b/src/server/game/Server/WorldSession.h</span>
<span class="gu">@@ -29,6 +29,7 @@</span>
<span class="w"> </span>#include &quot;Common.h&quot;
<span class="w"> </span>#include &quot;DatabaseEnv.h&quot;
<span class="w"> </span>#include &quot;GossipDef.h&quot;
<span class="gi">+#include &quot;QueryHolder.h&quot;</span>
<span class="w"> </span>#include &quot;Packet.h&quot;
<span class="w"> </span>#include &quot;SharedDefines.h&quot;
<span class="w"> </span>#include &quot;World.h&quot;
<span class="gu">@@ -40,7 +41,6 @@ class Creature;</span>
<span class="w"> </span>class GameObject;
<span class="w"> </span>class InstanceSave;
<span class="w"> </span>class Item;
<span class="gd">-class LoginQueryHolder;</span>
<span class="w"> </span>class LoadPetFromDBQueryHolder;
<span class="w"> </span>class Object;
<span class="w"> </span>class Pet;
<span class="gu">@@ -270,6 +270,20 @@ enum CharterTypes</span>
<span class="w"> </span>    ARENA_TEAM_CHARTER_5v5_TYPE                   = 5
<span class="w"> </span>};

<span class="gi">+class LoginQueryHolder : public CharacterDatabaseQueryHolder</span>
<span class="gi">+{</span>
<span class="gi">+    private:</span>
<span class="gi">+        uint32 m_accountId;</span>
<span class="gi">+        ObjectGuid m_guid;</span>
<span class="gi">+</span>
<span class="gi">+    public:</span>
<span class="gi">+        LoginQueryHolder(uint32 accountId, ObjectGuid guid);</span>
<span class="gi">+</span>
<span class="gi">+        ObjectGuid GetGuid() const { return m_guid; }</span>
<span class="gi">+        uint32 GetAccountId() const { return m_accountId; }</span>
<span class="gi">+        bool Initialize();</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="w"> </span>//class to deal with packet processing
<span class="w"> </span>//allows to determine if next packet is safe to be processed
<span class="w"> </span>class PacketFilter
<span class="gu">@@ -314,6 +328,11 @@ class CharacterCreateInfo</span>
<span class="w"> </span>    friend class WorldSession;
<span class="w"> </span>    friend class Player;

<span class="gi">+public:</span>
<span class="gi">+    CharacterCreateInfo(std::string const name = &quot;&quot;, uint8 _race = 0, uint8 _class = 0, uint8 gender = 0, uint8 skin = 0, uint8 face = 0,</span>
<span class="gi">+        uint8 hairStyle = 0, uint8 hairColor = 0, uint8 facialHair = 0)</span>
<span class="gi">+        : Name(name), Race(_race), Class(_class), Gender(gender), Skin(skin), Face(face), HairStyle(hairStyle), HairColor(hairColor), FacialHair(facialHair) { }</span>
<span class="gi">+</span>
<span class="w"> </span>protected:
<span class="w"> </span>    /// User specified variables
<span class="w"> </span>    std::string Name;
<span class="gu">@@ -374,7 +393,7 @@ struct PacketCounter</span>
<span class="w"> </span>class WorldSession
<span class="w"> </span>{
<span class="w"> </span>public:
<span class="gd">-    WorldSession(uint32 id, std::string&amp;&amp; name, uint32 accountFlags, std::shared_ptr&lt;WorldSocket&gt; sock, AccountTypes sec, uint8 expansion, time_t mute_time, LocaleConstant locale, uint32 recruiter, bool isARecruiter, bool skipQueue, uint32 TotalTime);</span>
<span class="gi">+    WorldSession(uint32 id, std::string&amp;&amp; name, uint32 accountFlags, std::shared_ptr&lt;WorldSocket&gt; sock, AccountTypes sec, uint8 expansion, time_t mute_time, LocaleConstant locale, uint32 recruiter, bool isARecruiter, bool skipQueue, uint32 TotalTime, bool is_bot = false);</span>
<span class="w"> </span>    ~WorldSession();

<span class="w"> </span>    uint32 GetAccountFlags() const { return _accountFlags; }
<span class="gu">@@ -1132,6 +1151,8 @@ class WorldSession</span>
<span class="w"> </span>    void SetKicked(bool val) { _kicked = val; }
<span class="w"> </span>    bool IsSocketClosed() const;

<span class="gi">+    void SetAddress(std::string const&amp; address) { m_Address = address; }</span>
<span class="gi">+</span>
<span class="w"> </span>    /*
<span class="w"> </span>     * CALLBACKS
<span class="w"> </span>     */
<span class="gu">@@ -1145,6 +1166,13 @@ class WorldSession</span>

<span class="w"> </span>    void SetPacketLogging(bool state);

<span class="gi">+    LockedQueue&lt;WorldPacket*&gt;&amp; GetPacketQueue();</span>
<span class="gi">+</span>
<span class="gi">+    [[nodiscard]] bool IsBot() const</span>
<span class="gi">+    {</span>
<span class="gi">+        return _isBot;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="w"> </span>private:
<span class="w"> </span>    void ProcessQueryCallbacks();

<span class="gu">@@ -1257,6 +1285,8 @@ class WorldSession</span>

<span class="w"> </span>    uint32 _orderCounter;

<span class="gi">+    bool _isBot;</span>
<span class="gi">+</span>
<span class="w"> </span>    WorldSession(WorldSession const&amp; right) = delete;
<span class="w"> </span>    WorldSession&amp; operator=(WorldSession const&amp; right) = delete;
<span class="w"> </span>};
<span class="gh">diff --git a/src/server/game/Server/WorldSessionMgr.cpp b/src/server/game/Server/WorldSessionMgr.cpp</span>
<span class="gh">index b430996692a3b2..91256db9b92ca7 100644</span>
<span class="gd">--- a/src/server/game/Server/WorldSessionMgr.cpp</span>
<span class="gi">+++ b/src/server/game/Server/WorldSessionMgr.cpp</span>
<span class="gu">@@ -20,6 +20,7 @@</span>
<span class="w"> </span>#include &quot;GameTime.h&quot;
<span class="w"> </span>#include &quot;Metric.h&quot;
<span class="w"> </span>#include &quot;Player.h&quot;
<span class="gi">+#include &quot;ScriptMgr.h&quot;</span>
<span class="w"> </span>#include &quot;World.h&quot;
<span class="w"> </span>#include &quot;WorldSession.h&quot;
<span class="w"> </span>#include &quot;WorldSessionMgr.h&quot;
<span class="gu">@@ -190,6 +191,10 @@ void WorldSessionMgr::KickAll()</span>
<span class="w"> </span>    // pussywizard: kick offline sessions
<span class="w"> </span>    for (SessionMap::const_iterator itr = _offlineSessions.begin(); itr != _offlineSessions.end(); ++itr)
<span class="w"> </span>        itr-&gt;second-&gt;KickPlayer(&quot;KickAll offline sessions&quot;);
<span class="gi">+</span>
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+    sScriptMgr-&gt;OnPlayerbotLogoutBots();</span>
<span class="gi">+#endif</span>
<span class="w"> </span>}

<span class="w"> </span>/// Kick (and save) all players with security level less `sec`
<span class="gh">diff --git a/src/server/game/World/IWorld.h b/src/server/game/World/IWorld.h</span>
<span class="gh">index 03e70e55c1ed38..dc6c60681ba976 100644</span>
<span class="gd">--- a/src/server/game/World/IWorld.h</span>
<span class="gi">+++ b/src/server/game/World/IWorld.h</span>
<span class="gu">@@ -22,6 +22,7 @@</span>
<span class="w"> </span>#include &quot;Common.h&quot;
<span class="w"> </span>#include &quot;Duration.h&quot;
<span class="w"> </span>#include &quot;ObjectGuid.h&quot;
<span class="gi">+#include &quot;QueryHolder.h&quot;</span>
<span class="w"> </span>#include &quot;SharedDefines.h&quot;
<span class="w"> </span>#include &quot;WorldConfig.h&quot;
<span class="w"> </span>#include &lt;unordered_map&gt;
<span class="gu">@@ -104,12 +105,16 @@ class IWorld</span>
<span class="w"> </span>    [[nodiscard]] virtual LocaleConstant GetAvailableDbcLocale(LocaleConstant locale) const = 0;
<span class="w"> </span>    virtual void LoadDBVersion() = 0;
<span class="w"> </span>    [[nodiscard]] virtual char const* GetDBVersion() const = 0;
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+    [[nodiscard]] virtual char const* GetPlayerbotsDBRevision() const = 0;</span>
<span class="gi">+#endif</span>
<span class="w"> </span>    virtual void UpdateAreaDependentAuras() = 0;
<span class="w"> </span>    [[nodiscard]] virtual uint32 GetCleaningFlags() const = 0;
<span class="w"> </span>    virtual void   SetCleaningFlags(uint32 flags) = 0;
<span class="w"> </span>    virtual void   ResetEventSeasonalQuests(uint16 event_id) = 0;
<span class="w"> </span>    [[nodiscard]] virtual std::string const&amp; GetRealmName() const = 0;
<span class="w"> </span>    virtual void SetRealmName(std::string name) = 0;
<span class="gi">+    virtual SQLQueryHolderCallback&amp; AddQueryHolderCallback(SQLQueryHolderCallback&amp;&amp; callback) = 0;</span>
<span class="w"> </span>};

<span class="w"> </span>#endif //AZEROTHCORE_IWORLD_H
<span class="gh">diff --git a/src/server/game/World/World.cpp b/src/server/game/World/World.cpp</span>
<span class="gh">index e1de134a213c80..d072bd56f7c968 100644</span>
<span class="gd">--- a/src/server/game/World/World.cpp</span>
<span class="gi">+++ b/src/server/game/World/World.cpp</span>
<span class="gu">@@ -67,6 +67,7 @@</span>
<span class="w"> </span>#include &quot;ObjectMgr.h&quot;
<span class="w"> </span>#include &quot;Opcodes.h&quot;
<span class="w"> </span>#include &quot;OutdoorPvPMgr.h&quot;
<span class="gi">+#include &quot;QueryHolder.h&quot;</span>
<span class="w"> </span>#include &quot;PetitionMgr.h&quot;
<span class="w"> </span>#include &quot;Player.h&quot;
<span class="w"> </span>#include &quot;PlayerDump.h&quot;
<span class="gu">@@ -1171,6 +1172,8 @@ void World::Update(uint32 diff)</span>
<span class="w"> </span>        ResetGuildCap();
<span class="w"> </span>    }

<span class="gi">+    sScriptMgr-&gt;OnPlayerbotUpdate(diff);</span>
<span class="gi">+</span>
<span class="w"> </span>    {
<span class="w"> </span>        // pussywizard: handle expired auctions, auctions expired when realm was offline are also handled here (not during loading when many required things aren&#39;t loaded yet)
<span class="w"> </span>        METRIC_TIMER(&quot;world_update_time&quot;, METRIC_TAG(&quot;type&quot;, &quot;Update expired auctions&quot;));
<span class="gu">@@ -1290,6 +1293,7 @@ void World::Update(uint32 diff)</span>
<span class="w"> </span>        CharacterDatabase.KeepAlive();
<span class="w"> </span>        LoginDatabase.KeepAlive();
<span class="w"> </span>        WorldDatabase.KeepAlive();
<span class="gi">+        sScriptMgr-&gt;OnDatabasesKeepAlive();</span>
<span class="w"> </span>    }

<span class="w"> </span>    {
<span class="gu">@@ -1456,6 +1460,7 @@ void World::_UpdateGameTime()</span>
<span class="w"> </span>void World::ShutdownServ(uint32 time, uint32 options, uint8 exitcode, std::string const&amp; reason)
<span class="w"> </span>{
<span class="w"> </span>    // ignore if server shutdown at next tick
<span class="gi">+</span>
<span class="w"> </span>    if (IsStopped())
<span class="w"> </span>        return;

<span class="gu">@@ -1803,6 +1808,12 @@ void World::UpdateAreaDependentAuras()</span>
<span class="w"> </span>void World::ProcessQueryCallbacks()
<span class="w"> </span>{
<span class="w"> </span>    _queryProcessor.ProcessReadyCallbacks();
<span class="gi">+    _queryHolderProcessor.ProcessReadyCallbacks();</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+SQLQueryHolderCallback&amp; World::AddQueryHolderCallback(SQLQueryHolderCallback&amp;&amp; callback)</span>
<span class="gi">+{</span>
<span class="gi">+    return _queryHolderProcessor.AddCallback(std::move(callback));</span>
<span class="w"> </span>}

<span class="w"> </span>bool World::IsPvPRealm() const
<span class="gh">diff --git a/src/server/game/World/World.h b/src/server/game/World/World.h</span>
<span class="gh">index 942665b4df7a92..f42004e3019850 100644</span>
<span class="gd">--- a/src/server/game/World/World.h</span>
<span class="gi">+++ b/src/server/game/World/World.h</span>
<span class="gu">@@ -229,6 +229,9 @@ class World: public IWorld</span>
<span class="w"> </span>    // used World DB version
<span class="w"> </span>    void LoadDBVersion() override;
<span class="w"> </span>    [[nodiscard]] char const* GetDBVersion() const override { return _dbVersion.c_str(); }
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+    [[nodiscard]] char const* GetPlayerbotsDBRevision() const override { return m_PlayerbotsDBRevision.c_str(); }</span>
<span class="gi">+#endif</span>

<span class="w"> </span>    void UpdateAreaDependentAuras() override;

<span class="gu">@@ -256,6 +259,9 @@ class World: public IWorld</span>
<span class="w"> </span>    void ResetRandomBG();
<span class="w"> </span>    void CalendarDeleteOldEvents();
<span class="w"> </span>    void ResetGuildCap();
<span class="gi">+</span>
<span class="gi">+    SQLQueryHolderCallback&amp; AddQueryHolderCallback(SQLQueryHolderCallback&amp;&amp; callback) override;</span>
<span class="gi">+</span>
<span class="w"> </span>private:
<span class="w"> </span>    WorldConfig _worldConfig;

<span class="gu">@@ -300,9 +306,13 @@ class World: public IWorld</span>
<span class="w"> </span>    // used versions
<span class="w"> </span>    std::string _dbVersion;
<span class="w"> </span>    uint32 _dbClientCacheVersion;
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+    std::string m_PlayerbotsDBRevision;</span>
<span class="gi">+#endif</span>

<span class="w"> </span>    void ProcessQueryCallbacks();
<span class="w"> </span>    QueryCallbackProcessor _queryProcessor;
<span class="gi">+    AsyncCallbackProcessor&lt;SQLQueryHolderCallback&gt; _queryHolderProcessor;</span>

<span class="w"> </span>    /**
<span class="w"> </span>     * @brief Executed when a World Session is being finalized. Be it from a normal login or via queue popping.
<span class="gh">diff --git a/src/server/scripts/Commands/cs_server.cpp b/src/server/scripts/Commands/cs_server.cpp</span>
<span class="gh">index 98bfbbac3dd0ed..63815aeec14b18 100644</span>
<span class="gd">--- a/src/server/scripts/Commands/cs_server.cpp</span>
<span class="gi">+++ b/src/server/scripts/Commands/cs_server.cpp</span>
<span class="gu">@@ -213,6 +213,10 @@ class server_commandscript : public CommandScript</span>
<span class="w"> </span>        handler-&gt;PSendSysMessage(&quot;Default DBC locale: {}.\nAll available DBC locales: {}&quot;, localeNames[defaultLocale], availableLocales);

<span class="w"> </span>        handler-&gt;PSendSysMessage(&quot;Using World DB: {}&quot;, sWorld-&gt;GetDBVersion());
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+        handler-&gt;PSendSysMessage(&quot;Using Playerbots DB Revision: {}&quot;, sWorld-&gt;GetPlayerbotsDBRevision());</span>
<span class="gi">+#endif</span>
<span class="gi">+        </span>

<span class="w"> </span>        std::string lldb = &quot;No updates found!&quot;;
<span class="w"> </span>        if (QueryResult resL = LoginDatabase.Query(&quot;SELECT name FROM updates ORDER BY name DESC LIMIT 1&quot;))
<span class="gu">@@ -240,6 +244,10 @@ class server_commandscript : public CommandScript</span>
<span class="w"> </span>        handler-&gt;PSendSysMessage(&quot;LoginDatabase queue size: {}&quot;, LoginDatabase.QueueSize());
<span class="w"> </span>        handler-&gt;PSendSysMessage(&quot;CharacterDatabase queue size: {}&quot;, CharacterDatabase.QueueSize());
<span class="w"> </span>        handler-&gt;PSendSysMessage(&quot;WorldDatabase queue size: {}&quot;, WorldDatabase.QueueSize());
<span class="gi">+#ifdef MOD_PLAYERBOTS</span>
<span class="gi">+        handler-&gt;PSendSysMessage(&quot;PlayerbotsDatabase queue size: {}&quot;, PlayerbotsDatabase.QueueSize());</span>
<span class="gi">+#endif</span>
<span class="gi">+        </span>

<span class="w"> </span>        if (Acore::Module::GetEnableModulesList().empty())
<span class="w"> </span>            handler-&gt;PSendSysMessage(&quot;No modules are enabled&quot;);
<span class="gh">diff --git a/src/server/shared/DataStores/DBCDatabaseLoader.cpp b/src/server/shared/DataStores/DBCDatabaseLoader.cpp</span>
<span class="gh">index 44e65653d1a16a..883fe527f78cc6 100644</span>
<span class="gd">--- a/src/server/shared/DataStores/DBCDatabaseLoader.cpp</span>
<span class="gi">+++ b/src/server/shared/DataStores/DBCDatabaseLoader.cpp</span>
<span class="gu">@@ -29,8 +29,7 @@ DBCDatabaseLoader::DBCDatabaseLoader(char const* tableName, char const* dbcForma</span>
<span class="w"> </span>      _stringPool(stringPool)
<span class="w"> </span>{
<span class="w"> </span>    // Get sql index position
<span class="gd">-    int32 indexPos = -1;</span>
<span class="gd">-    _recordSize = DBCFileLoader::GetFormatRecordSize(_dbcFormat, &amp;indexPos);</span>
<span class="gi">+    _recordSize = DBCFileLoader::GetFormatRecordSize(_dbcFormat, &amp;_sqlIndexPos);</span>

<span class="w"> </span>    ASSERT(_recordSize);
<span class="w"> </span>}
<span class="gu">@@ -72,11 +71,11 @@ char* DBCDatabaseLoader::Load(uint32&amp; records, char**&amp; indexTable)</span>
<span class="w"> </span>    {
<span class="w"> </span>        Field* fields = result-&gt;Fetch();
<span class="w"> </span>        uint32 indexValue = fields[_sqlIndexPos].Get&lt;uint32&gt;();
<span class="gd">-        char* dataValue = indexTable[indexValue];</span>
<span class="gi">+        char* oldDataValue = indexTable[indexValue];</span>

<span class="w"> </span>        // If exist in DBC file override from DB
<span class="w"> </span>        newIndexes[newRecords] = indexValue;
<span class="gd">-        dataValue = &amp;dataTable[newRecords++ * _recordSize];</span>
<span class="gi">+        char* dataValue = &amp;dataTable[newRecords++ * _recordSize];</span>

<span class="w"> </span>        uint32 dataOffset = 0;
<span class="w"> </span>        uint32 sqlColumnNumber = 0;
<span class="gu">@@ -100,7 +99,15 @@ char* DBCDatabaseLoader::Load(uint32&amp; records, char**&amp; indexTable)</span>
<span class="w"> </span>                    dataOffset += sizeof(uint8);
<span class="w"> </span>                    break;
<span class="w"> </span>                case FT_STRING:
<span class="gd">-                    *reinterpret_cast&lt;char**&gt;(&amp;dataValue[dataOffset]) = CloneStringToPool(fields[sqlColumnNumber].Get&lt;std::string&gt;());</span>
<span class="gi">+                    // not override string if new string is empty</span>
<span class="gi">+                    if (fields[sqlColumnNumber].Get&lt;std::string&gt;().empty() &amp;&amp; oldDataValue)</span>
<span class="gi">+                    {</span>
<span class="gi">+                        *reinterpret_cast&lt;char**&gt;(&amp;dataValue[dataOffset]) = *reinterpret_cast&lt;char**&gt;(&amp;oldDataValue[dataOffset]);</span>
<span class="gi">+                    }</span>
<span class="gi">+                    else</span>
<span class="gi">+                    {</span>
<span class="gi">+                        *reinterpret_cast&lt;char**&gt;(&amp;dataValue[dataOffset]) = CloneStringToPool(fields[sqlColumnNumber].Get&lt;std::string&gt;());</span>
<span class="gi">+                    }</span>
<span class="w"> </span>                    dataOffset += sizeof(char*);
<span class="w"> </span>                    break;
<span class="w"> </span>                case FT_SORT:
<span class="gh">diff --git a/src/server/shared/DataStores/DBCStructure.h b/src/server/shared/DataStores/DBCStructure.h</span>
<span class="gh">index f72d4ead69cb90..06f3bf15375281 100644</span>
<span class="gd">--- a/src/server/shared/DataStores/DBCStructure.h</span>
<span class="gi">+++ b/src/server/shared/DataStores/DBCStructure.h</span>
<span class="gu">@@ -628,6 +628,33 @@ struct CharStartOutfitEntry</span>
<span class="w"> </span>    //int32 ItemInventorySlot[MAX_OUTFIT_ITEMS];            // 53-76 not required at server side
<span class="w"> </span>};

<span class="gi">+enum CharSectionFlags</span>
<span class="gi">+{</span>
<span class="gi">+   SECTION_FLAG_PLAYER         = 0x01,</span>
<span class="gi">+   SECTION_FLAG_DEATH_KNIGHT   = 0x04</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+enum CharSectionType</span>
<span class="gi">+{</span>
<span class="gi">+   SECTION_TYPE_SKIN           = 0,</span>
<span class="gi">+   SECTION_TYPE_FACE           = 1,</span>
<span class="gi">+   SECTION_TYPE_FACIAL_HAIR    = 2,</span>
<span class="gi">+   SECTION_TYPE_HAIR           = 3,</span>
<span class="gi">+   SECTION_TYPE_UNDERWEAR      = 4</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+struct CharSectionsEntry</span>
<span class="gi">+{</span>
<span class="gi">+   //uint32 Id;</span>
<span class="gi">+   uint32 Race;</span>
<span class="gi">+   uint32 Gender;</span>
<span class="gi">+   uint32 GenType;</span>
<span class="gi">+   //char* TexturePath[3];</span>
<span class="gi">+   uint32 Flags;</span>
<span class="gi">+   uint32 Type;</span>
<span class="gi">+   uint32 Color;</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="w"> </span>struct CharTitlesEntry
<span class="w"> </span>{
<span class="w"> </span>    uint32  ID;                                             // 0, title ids, for example in Quest::GetCharTitleId()
<span class="gu">@@ -903,6 +930,15 @@ struct EmotesTextEntry</span>
<span class="w"> </span>    uint32  textid;
<span class="w"> </span>};

<span class="gi">+struct EmotesTextSoundEntry</span>
<span class="gi">+{</span>
<span class="gi">+   uint32 Id;                                              // 0</span>
<span class="gi">+   uint32 EmotesTextId;                                    // 1</span>
<span class="gi">+   uint32 RaceId;                                          // 2</span>
<span class="gi">+   uint32 SexId;                                           // 3, 0 male / 1 female</span>
<span class="gi">+   uint32 SoundId;                                         // 4</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="w"> </span>struct FactionEntry
<span class="w"> </span>{
<span class="w"> </span>    uint32      ID;                                         // 0        m_ID
<span class="gh">diff --git a/src/server/shared/DataStores/DBCfmt.h b/src/server/shared/DataStores/DBCfmt.h</span>
<span class="gh">index 9a568d5bb1835d..b87dddb52a623e 100644</span>
<span class="gd">--- a/src/server/shared/DataStores/DBCfmt.h</span>
<span class="gi">+++ b/src/server/shared/DataStores/DBCfmt.h</span>
<span class="gu">@@ -29,6 +29,7 @@ char constexpr BankBagSlotPricesEntryfmt[] = &quot;ni&quot;;</span>
<span class="w"> </span>char constexpr BarberShopStyleEntryfmt[] = &quot;nixxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxiii&quot;;
<span class="w"> </span>char constexpr BattlemasterListEntryfmt[] = &quot;niiiiiiiiixssssssssssssssssxiixx&quot;;
<span class="w"> </span>char constexpr CharStartOutfitEntryfmt[] = &quot;dbbbXiiiiiiiiiiiiiiiiiiiiiiiixxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;;
<span class="gi">+char constexpr CharSectionsEntryfmt[] = &quot;diiixxxiii&quot;;</span>
<span class="w"> </span>char constexpr CharTitlesEntryfmt[] = &quot;nxssssssssssssssssxssssssssssssssssxi&quot;;
<span class="w"> </span>char constexpr ChatChannelsEntryfmt[] = &quot;nixssssssssssssssssxxxxxxxxxxxxxxxxxx&quot;; // ChatChannelsEntryfmt, index not used (more compact store)
<span class="w"> </span>char constexpr ChrClassesEntryfmt[] = &quot;nxixssssssssssssssssxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxixii&quot;;
<span class="gu">@@ -48,6 +49,7 @@ char constexpr DurabilityCostsfmt[] = &quot;niiiiiiiiiiiiiiiiiiiiiiiiiiiii&quot;;</span>
<span class="w"> </span>char constexpr DurabilityQualityfmt[] = &quot;nf&quot;;
<span class="w"> </span>char constexpr EmotesEntryfmt[] = &quot;nxxiiix&quot;;
<span class="w"> </span>char constexpr EmotesTextEntryfmt[] = &quot;nxixxxxxxxxxxxxxxxx&quot;;
<span class="gi">+char constexpr EmotesTextSoundEntryfmt[] = &quot;niiii&quot;;</span>
<span class="w"> </span>char constexpr FactionEntryfmt[] = &quot;niiiiiiiiiiiiiiiiiiffixssssssssssssssssxxxxxxxxxxxxxxxxxx&quot;;
<span class="w"> </span>char constexpr FactionTemplateEntryfmt[] = &quot;niiiiiiiiiiiii&quot;;
<span class="w"> </span>char constexpr GameObjectArtKitfmt[] = &quot;nxxxxxxx&quot;;
<span class="gh">diff --git a/src/server/shared/SharedDefines.h b/src/server/shared/SharedDefines.h</span>
<span class="gh">index b5a979dead96a3..527d5ae7b91dbe 100644</span>
<span class="gd">--- a/src/server/shared/SharedDefines.h</span>
<span class="gi">+++ b/src/server/shared/SharedDefines.h</span>
<span class="gu">@@ -1378,7 +1378,7 @@ enum Mechanics : uint32</span>
<span class="w"> </span>    (1&lt;&lt;MECHANIC_SAPPED))

<span class="w"> </span>// Spell dispel type
<span class="gd">-enum DispelType</span>
<span class="gi">+enum DispelType : uint8</span>
<span class="w"> </span>{
<span class="w"> </span>    DISPEL_NONE         = 0,
<span class="w"> </span>    DISPEL_MAGIC        = 1,
<span class="gu">@@ -1642,7 +1642,7 @@ enum GameObjectDestructibleState</span>
<span class="w"> </span>};

<span class="w"> </span>// EmotesText.dbc
<span class="gd">-enum TextEmotes</span>
<span class="gi">+enum TextEmotes : uint32</span>
<span class="w"> </span>{
<span class="w"> </span>    TEXT_EMOTE_AGREE                = 1,
<span class="w"> </span>    TEXT_EMOTE_AMAZE                = 2,
<span class="gu">@@ -3386,7 +3386,7 @@ enum WeatherType</span>
<span class="w"> </span>#define MAX_WEATHER_TYPE 4

<span class="w"> </span>// EnumUtils: DESCRIBE THIS
<span class="gd">-enum ChatMsg</span>
<span class="gi">+enum ChatMsg : uint32</span>
<span class="w"> </span>{
<span class="w"> </span>    CHAT_MSG_ADDON                  = 0xFFFFFFFF,
<span class="w"> </span>    CHAT_MSG_SYSTEM                 = 0x00,
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>